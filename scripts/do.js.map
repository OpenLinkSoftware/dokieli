{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 5fa4a61e6f834c45aa50","webpack:///./src/config.js","webpack:///./src/doc.js","webpack:///./src/uri.js","webpack:///./src/util.js","webpack:///./src/fetcher.js","webpack:///./src/graph.js","webpack:///(webpack)/buildin/global.js","webpack:///./src/storage.js","webpack:///./src/dokieli.js","webpack:///external \"fetch\"","webpack:///./src/inbox.js","webpack:///./src/auth.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,O;ACVA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;;AC7DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,oCAAoC;AAC/C,UAAU;AACV,GAAG;AACH;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,2DAA2D,0DAA0D;AACrH,qDAAqD,mEAAmE;AACxH,wDAAwD,iFAAiF;AACzI,wDAAwD,oFAAoF;AAC5I,wDAAwD,oFAAoF;AAC5I,2DAA2D,kGAAkG;AAC7J,2DAA2D;AAC3D,GAAG;AACH;AACA,uCAAuC,oIAAoI;AAC3K,2CAA2C;AAC3C,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA,gBAAgB,2FAA2F;AAC3G,iBAAiB,4EAA4E;AAC7F,gBAAgB,2EAA2E;AAC3F;AACA,kBAAkB,sDAAsD;AACxE,oBAAoB,wFAAwF;;AAE5G,kBAAkB,gFAAgF;;AAElG;AACA;AACA;AACA,qBAAqB,8DAA8D;AACnF,mBAAmB,4DAA4D;AAC/E,gBAAgB,yDAAyD;AACzE,sBAAsB,+DAA+D;AACrF;AACA,kBAAkB,2DAA2D;AAC7E,kBAAkB,2EAA2E;;AAE7F;AACA;AACA;AACA;AACA,iBAAiB,+DAA+D;AAChF,mBAAmB,iEAAiE;AACpF,sBAAsB,oEAAoE;;AAE1F;AACA;AACA;AACA,kBAAkB,iDAAiD;AACnE,oBAAoB,mDAAmD;AACvE,sBAAsB,qEAAqE;AAC3F,qBAAqB,oEAAoE;AACzF,0BAA0B,yEAAyE;AACnG,qBAAqB,oEAAoE;AACzF,sBAAsB,qDAAqD;AAC3E,uBAAuB,sEAAsE;AAC7F,oBAAoB,mEAAmE;AACvF;AACA;AACA;AACA;AACA,sBAAsB,qEAAqE;AAC3F,uBAAuB,sEAAsE;AAC7F,+BAA+B,8CAA8C;;AAE7E;AACA;AACA,uBAAuB,4EAA4E;AACnG;AACA;AACA;AACA,sBAAsB,2DAA2D;AACjF,0BAA0B,+DAA+D;AACzF,uBAAuB,4EAA4E;AACnG,wBAAwB,6EAA6E;;AAErG,sBAAsB,yFAAyF;;AAE/G;AACA;;AAEA,uBAAuB,oEAAoE;;AAE3F,mBAAmB,kFAAkF;AACrG,wBAAwB,0EAA0E;;AAElG,iBAAiB,0EAA0E;;AAE3F;;AAEA,qBAAqB,8DAA8D;AACnF,kBAAkB,2DAA2D;AAC7E,oBAAoB,6DAA6D;AACjF,oBAAoB,6DAA6D;AACjF,sBAAsB,+DAA+D;AACrF,oBAAoB,6DAA6D;AACjF;AACA;AACA;AACA,sBAAsB,+DAA+D;AACrF,4BAA4B,qFAAqF;;AAEjH,kBAAkB,yFAAyF;AAC3G,iBAAiB,wFAAwF;AACzG,iBAAiB,wFAAwF;AACzG,uBAAuB,8FAA8F;AACrH,kBAAkB,yFAAyF;AAC3G,oBAAoB,2FAA2F;AAC/G,gBAAgB,uEAAuE;AACvF;AACA;AACA;AACA;AACA,gBAAgB,uEAAuE;AACvF,iBAAiB,wFAAwF;AACzG,gBAAgB,uFAAuF;AACvG,uBAAuB,8FAA8F;AACrH;AACA,gBAAgB,uEAAuE;AACvF,eAAe,sEAAsE;AACrF,qBAAqB,4EAA4E;AACjG,4BAA4B,mFAAmF;;AAE/G,oBAAoB,4EAA4E;AAChG,mBAAmB,0DAA0D;;AAE7E,oBAAoB,6EAA6E;AACjG,oBAAoB,6DAA6D;AACjF,qBAAqB,8DAA8D;AACnF,qBAAqB,8DAA8D;AACnF,6BAA6B,sEAAsE;;AAEnG,4BAA4B,qEAAqE;AACjG,mBAAmB,4DAA4D;AAC/E,oBAAoB,6DAA6D;AACjF,mBAAmB,4DAA4D;AAC/E,oBAAoB,6DAA6D;AACjF,mBAAmB,4DAA4D;;AAE/E,8BAA8B,kGAAkG;AAChI,yBAAyB,6FAA6F;;AAEtH,iBAAiB,0DAA0D;AAC3E,qBAAqB;AACrB,GAAG;;AAEH;;AAEA,aAAa;AACb;;;;;;;;AC5VA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,wCAAwC;AACxC;;AAEA;AACA;AACA;AACA,KAAK;AACL;;AAEA;;AAEA;AACA;AACA;AACA,KAAK;AACL;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;;AAEA,8CAA8C,QAAQ;AACtD;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;;AAEA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC,kCAAkC;AAClC,kCAAkC;AAClC,oCAAoC;AACpC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;;AAEA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,uBAAuB,4BAA4B;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,+BAA+B,sBAAsB,sBAAsB;AAC3E,GAAG;AACH,yBAAyB;AACzB;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACxJA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,kBAAkB;AAClB;AACA,aAAa;AACb;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA;AACA;;AAEA;AACA;;AAEA,2CAA2C;AAC3C;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,C;;;;;;;AC3EA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa;AACb;AACA,aAAa;AACb;AACA;AACA;AACA;AACA,iBAAiB,cAAc;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,qBAAqB;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA,GAAG;AACH;AACA,GAAG;AACH;;AAEA;AACA;AACA,kCAAkC;AAClC;;AAEA;AACA;AACA,C;;;;;;;ACjFA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,wCAAwC;AACxC,0DAA0D;;AAE1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,mBAAmB;AACnB;AACA;AACA,GAAG;AACH;;AAEA;AACA,mDAAmD;AACnD,iBAAiB;AACjB;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,SAAS;AACT,KAAK;AACL;;AAEA;AACA,aAAa;AACb;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,eAAe;AACf,mBAAmB;AACnB;AACA,aAAa;AACb;AACA,0CAA0C;AAC1C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA,mCAAmC,wBAAwB;AAC3D;AACA;;AAEA,cAAc;AACd,KAAK;AACL;AACA;;AAEA;AACA;AACA,OAAO;AACP;AACA,OAAO;AACP;AACA,OAAO;AACP,mEAAmE;AACnE;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA,eAAe;AACf;AACA,mBAAmB;AACnB,0CAA0C;AAC1C;AACA,mBAAmB;AACnB;AACA,aAAa;AACb;AACA,uCAAuC,cAAc;AACrD;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,oCAAoC;;AAEpC;;AAEA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA,iBAAiB;AACjB;AACA,mBAAmB;AACnB,0BAA0B;AAC1B;AACA,aAAa,gBAAgB;AAC7B;AACA,2CAA2C;AAC3C;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,cAAc;AACd,KAAK;AACL;;AAEA,qDAAqD;AACrD,wBAAwB;AACxB;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,8CAA8C;;AAE9C;;AAEA;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA,iBAAiB,OAAO;AACxB;AACA,qBAAqB,GAAG;AACxB,4BAA4B,OAAO;AACnC,mCAAmC;AACnC;AACA,aAAa,QAAQ,iBAAiB,eAAe;AACrD;AACA,8CAA8C;AAC9C;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,2BAA2B;AAC3B,gBAAgB;AAChB;;AAEA,cAAc,4BAA4B;AAC1C,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA,gCAAgC,cAAc,aAAa,mBAAmB,aAAa;AAC3F,6BAA6B,aAAa,mBAAmB,aAAa;AAC1E;AACA;AACA,iBAAiB,oBAAoB;AACrC;AACA;AACA;AACA;AACA,mBAAmB,cAAc;AACjC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,+DAA+D;AAC/D;AACA;AACA,0CAA0C;AAC1C;AACA,EAAE;AACF;;AAEA,0CAA0C;AAC1C;AACA,EAAE;AACF;;;AAGA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA,+DAA+D;;AAE/D;;AAEA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,KAAK;AACL;;AAEA,wEAAwE;AACxE;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA,eAAe;AACf;AACA,gBAAgB;AAChB;AACA,8CAA8C;AAC9C;AACA,gCAAgC;AAChC;AACA,qBAAqB,GAAG;AACxB;AACA,aAAa;AACb;AACA,iEAAiE;AACjE;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA,oFAAoF;AACpF;AACA;;AAEA;AACA,UAAU,6EAA6E;AACvF,UAAU,mEAAmE;AAC7E,UAAU;AACV;;AAEA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;;AAEA;;AAEA;AACA,4BAA4B;AAC5B,sBAAsB,gCAAgC;AACtD,OAAO;AACP;;AAEA;AACA;AACA;AACA;AACA,8BAA8B;AAC9B,UAAU,wBAAwB;AAClC;AACA;;AAEA;AACA;;AAEA,gDAAgD;AAChD;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,0DAA0D;;AAE1D;AACA;;AAEA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,uDAAuD;;AAEvD;AACA,aAAa;AACb;AACA,KAAK;AACL;;;;;;;;8CChlBA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,6CAA6C;AAC7C;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,yCAAyC,cAAc;AACvD,cAAc,0BAA0B;;AAExC;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,0BAA0B,2BAA2B;AACrD;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,qBAAqB;AACrB;;AAEA,yCAAyC;AACzC;AACA,eAAe;;AAEf;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,WAAW;;AAEX;AACA;AACA,O;AACA,KAAK;AACL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA,aAAa;;AAEb;AACA,kCAAkC,gCAAgC;AAClE;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA,wCAAwC;AACxC;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,wEAAwE,sBAAsB;AAC9F;;AAEA;AACA,KAAK;AACL;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,iCAAiC,oDAAoD;AACrF,6CAA6C,uEAAuE;AACpH,2CAA2C,qEAAqE;AAChH;;AAEA;AACA;;AAEA;AACA;;AAEA,oBAAoB,cAAc;AAClC,sBAAsB,uBAAuB;AAC7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,G;;AAEA;AACA;;;;;;;;AC5SA;;AAEA;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;;AAEA;AACA;AACA,4CAA4C;;AAE5C;;;;;;;;ACpBA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,8CAA8C,6BAA6B;AAC3E;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,mBAAmB;;AAEhC;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,oCAAoC;AAC/D;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,4DAA4D,eAAe,EAAE;AAC7E;AACA;AACA;;AAEA,+CAA+C,gBAAgB,EAAE;;AAEjE;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,oCAAoC;AAC/D;AACA;;AAEA;AACA,kBAAkB,yBAAyB,iCAAiC,EAAE;;AAE9E;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;;AAEA;AACA;AACA,uCAAuC,cAAc;AACrD;AACA;AACA,sDAAsD,cAAc;AACpE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,oCAAoC;AAC/D;AACA;;AAEA;AACA;AACA,kDAAkD,QAAQ;;AAE1D;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AC3OA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,KAAK;;;AAGL;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,gBAAgB;AAChB;AACA;AACA;AACA;AACA;AACA,gBAAgB;AAChB;AACA;AACA;AACA;AACA;AACA,gBAAgB;;AAEhB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iB;AACA,eAAe;AACf,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA,KAAK;;;AAGL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA,4BAA4B;AAC5B;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;;AAEA;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,uDAAuD,4BAA4B;AACnF;AACA;AACA,WAAW;AACX;AACA;AACA,WAAW;AACX;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA,yBAAyB,mDAAmD;AAC5E;AACA;AACA;AACA;AACA,iBAAiB;AACjB;;AAEA;AACA;;AAEA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,qBAAqB,gCAAgC;;AAErD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,4BAA4B;AAC5B;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA,uBAAuB;AACvB;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA,qBAAqB;AACrB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA;AACA,0CAA0C,iDAAiD;AAC3F;AACA;AACA;AACA;AACA,wCAAwC,+CAA+C;AACvF;AACA,WAAW;AACX,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;AAGA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,uCAAuC,cAAc,mBAAmB,EAAE,QAAQ,YAAY,cAAc,EAAE;;AAE9G;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,oDAAoD,aAAa,EAAE;AACnE;AACA;;AAEA;AACA;AACA;AACA,uBAAuB;AACvB;AACA,wBAAwB,qBAAqB,GAAG,qBAAqB;AACrE;AACA,WAAW;;AAEX;AACA;AACA;AACA;;AAEA;AACA,4CAA4C,aAAa,EAAE;AAC3D;AACA;AACA;AACA,yCAAyC,uBAAuB,EAAE;AAClE;AACA;AACA;AACA;;AAEA;AACA,iCAAiC,aAAa,EAAE;;AAEhD;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,kCAAkC,6CAA6C;AAC/E;AACA;AACA;AACA,kCAAkC,4CAA4C;AAC9E;;AAEA,gCAAgC,qGAAqG;AACrI,aAAa;;AAEb;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA,uCAAuC,QAAQ;;AAE/C;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB;AAChB,WAAW;;AAEX;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,eAAe;;AAEf;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;;AAEA,+CAA+C,+BAA+B;AAC9E;AACA;AACA;AACA;AACA,iBAAiB;AACjB,aAAa;AACb,SAAS;AACT,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAAS;;AAET;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,sBAAsB,0CAA0C;AAChE;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;;AAEA;AACA;AACA,+D;;AAEA;AACA;AACA;AACA;AACA;;AAEA,sCAAsC;AACtC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC;AACxC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA,qBAAqB,6BAA6B;AAClD;AACA;AACA,KAAK;;AAEL;AACA,2SAA2S;AAC3S;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,qBAAqB,qBAAqB;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,kEAAkE;AAClE;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA,KAAK;;AAEL;AACA,qDAAqD,QAAQ;;AAE7D;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,uBAAuB,wBAAwB;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,qBAAqB,wBAAwB;AAC7C;AACA;AACA;;AAEA;AACA;AACA;AACA,uDAAuD,QAAQ;;AAE/D;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;;AAEA;AACA;AACA,SAAS;AACT;AACA,KAAK;;AAEL;AACA;;AAEA,qBAAqB,wBAAwB;AAC7C;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA,qBAAqB,wBAAwB;AAC7C;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,oBAAoB,eAAe;AACnC;AACA;;AAEA;;AAEA;AACA;AACA,sBAAsB,mBAAmB;AACzC;AACA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,yBAAyB,0BAA0B;AACnD;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,uBAAuB,mBAAmB;AAC1C;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA,yDAAyD,QAAQ;;AAEjE;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,wBAAwB,0BAA0B;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,sBAAsB,cAAc;AACpC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;;AAEA;AACA;AACA,SAAS;;AAET;AACA,uBAAuB,uBAAuB;AAC9C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,WAAW;AACX;AACA;;AAEA;AACA;AACA;AACA,KAAK;;AAEL;AACA,2CAA2C,sBAAsB,sBAAsB,wBAAwB;AAC/G,KAAK;;AAEL;AACA,wDAAwD,QAAQ;;AAEhE;AACA;AACA;;AAEA;AACA;AACA,qBAAqB;;AAErB;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;;AAEA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA,0BAA0B,kDAAkD,iBAAiB;AAC7F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkB,uEAAuE;AACzF;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA,yBAAyB,QAAQ;;AAEjC;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,wBAAwB,sBAAsB,GAAG,oBAAoB,GAAG,kBAAkB,GAAG,wBAAwB;AACrH;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,OAAO;;AAEP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,KAAK;;;AAGL;AACA,KAAK;;AAEL;AACA;AACA,6BAA6B,sCAAsC;;AAEnE,qBAAqB,qBAAqB;AAC1C;AACA;AACA,8IAA8I;AAC9I;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,mBAAmB,iCAAiC;;AAEpD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;;AAEA,6BAA6B,cAAc;AAC3C;AACA;AACA;AACA;AACA;AACA,6BAA6B,cAAc;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA,OAAO;;AAEP,iDAAiD,kBAAkB;AACnE,KAAK;;AAEL;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA,yBAAyB,QAAQ;AACjC;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;;AAGL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA,4BAA4B;AAC5B;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA,KAAK;;AAEL;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;;AAEA,oBAAoB,gBAAgB;AACpC;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA,SAAS;AACT;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,OAAO;;AAEP;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT,OAAO;AACP,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,mCAAmC,gBAAgB,eAAe;AAClE;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL,6FAA6F;AAC7F;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,8BAA8B,QAAQ;AACtC,cAAc,wBAAwB;;AAEtC;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,eAAe;AACf;AACA;AACA;;AAEA;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA;AACA,wBAAwB,QAAQ;AAChC,cAAc,mBAAmB;AACjC;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,gFAAgF,kCAAkC;AAClH;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA,gBAAgB,QAAQ;;AAExB;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,+CAA+C,mBAAmB;;AAElE;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,WAAW;;AAEX;;AAEA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA,KAAK;;AAEL;AACA,mDAAmD,QAAQ;;AAE3D;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,yCAAyC,mGAAmG;;AAE5I;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA,WAAW;AACX,WAAW;AACX;;AAEA,WAAW;AACX;AACA;AACA,aAAa;AACb;AACA;AACA,aAAa;AACb;AACA;;AAEA;;AAEA;AACA,WAAW;AACX,WAAW;AACX;;AAEA;AACA;AACA;;;AAGA;;;AAGA;AACA;AACA,gCAAgC,mGAAmG;;AAEnI,aAAa;AACb,aAAa;AACb;;AAEA,aAAa;AACb,aAAa;AACb;;AAEA;AACA,eAAe;AACf,eAAe;AACf;AACA;;AAEA;;AAEA,aAAa;AACb,aAAa;AACb;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,OAAO;;AAEP,kCAAkC,mBAAmB;AACrD,KAAK;;AAEL;AACA;;AAEA,8BAA8B,iFAAiF;;AAE/G;AACA;AACA;;AAEA;;AAEA,WAAW;AACX,WAAW;AACX;;AAEA,WAAW;AACX,WAAW;AACX;;AAEA;AACA,aAAa;AACb,aAAa;AACb;AACA;;AAEA;AACA;;;AAGA,WAAW;AACX,WAAW;AACX;;AAEA;AACA;AACA,oCAAoC,mBAAmB;AACvD,OAAO;AACP,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;;AAEA,8BAA8B,kHAAkH;AAChJ;;AAEA;AACA;AACA,oCAAoC,mBAAmB;AACvD,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,WAAW;;AAEX;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,eAAe;AACf,WAAW;;AAEX;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,eAAe;AACf,WAAW;;AAEX,uBAAuB;AACvB;AACA;AACA;AACA,WAAW;;AAEX;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,WAAW;;AAEX;AACA;AACA;AACA;;AAEA;AACA;AACA,0BAA0B,iBAAiB;AAC3C;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,sCAAsC,kDAAkD;AACxF;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB,mCAAmC;AACnC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB,mCAAmC;AACnC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,eAAe;AACf;AACA;AACA,eAAe;AACf;;AAEA;AACA;AACA,aAAa;;AAEb;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA,wCAAwC;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,wBAAwB,mBAAmB;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;;AAEA;AACA,sBAAsB,iBAAiB;AACvC;AACA;;AAEA;AACA;;AAEA;AACA,+BAA+B;AAC/B;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;;AAEX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAAS;AACT;AACA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;;AAEA,sBAAsB,oBAAoB;AAC1C;AACA;AACA;;AAEA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA,OAAO;AACP;AACA,OAAO;;AAEP;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA,0CAA0C;AAC1C,WAAW;AACX,SAAS;AACT;AACA;AACA,oCAAoC;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA,mEAAmE;AACnE;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,uDAAuD,mBAAmB;AAC1E;AACA;;AAEA;AACA,eAAe;AACf;AACA;AACA,oDAAoD;;AAEpD;AACA;AACA;AACA,mBAAmB;AACnB,eAAe;AACf;;AAEA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,oFAAoF,sBAAsB,sBAAsB;AAChI;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;;AAEX;AACA,8CAA8C,+CAA+C;;AAE7F;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB,6DAA6D;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;;AAGL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,2BAA2B;AACzE;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,WAAW;;AAEX;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,WAAW;AACX,OAAO;AACP,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,eAAe;AACf,eAAe;AACf;;AAEA,qCAAqC,yFAAyF;;AAE9H,eAAe;AACf,eAAe;AACf;AACA;;AAEA;AACA;AACA;AACA,eAAe;AACf,eAAe;AACf;AACA;;AAEA;AACA;AACA;AACA,eAAe;AACf,eAAe;AACf;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,2BAA2B;AACzE;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA,2DAA2D,uBAAuB;;AAElF;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,WAAW;;AAEX;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,WAAW;AACX,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,uBAAuB,kBAAkB;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA,qBAAqB,0BAA0B;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,mDAAmD,mCAAmC;AACtF;AACA;AACA;AACA;AACA,mDAAmD,mCAAmC;AACtF;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,2CAA2C;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA,qBAAqB,uBAAuB;AAC5C;AACA;AACA,yCAAyC,mCAAmC,EAAE;AAC9E;AACA,yBAAyB,wBAAwB;AACjD;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA,yCAAyC,mCAAmC,EAAE;AAC9E;AACA,yBAAyB,wBAAwB;AACjD;AACA;AACA,SAAS;AACT;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA,iBAAiB,cAAc;AAC/B;AACA;AACA,2BAA2B;AAC3B;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,mBAAmB,cAAc,OAAO,OAAO,yCAAyC;AACxF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oCAAoC;AACpC;AACA;AACA;AACA,GAAG,yCAAyC,gEAAgE,EAAE;AAC9G,oCAAoC;;AAEpC;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yDAAyD;AACzD;AACA;AACA,eAAe;AACf,kCAAkC;AAClC;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA,CAAC;AACD,OAAO;AACP;AACA;AACA;AACA;AACA,CAAC;AACD;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,CAAC;AACD,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;;AAED;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA,mdAAmd,kCAAkC,kBAAkB,EAAE,SAAS,aAAa,WAAW,EAAE;;AAE5iB;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,yCAAyC,oBAAoB,EAAE;AAC/D;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,OAAO;;AAEP;AACA;;AAEA;AACA,mBAAmB,kBAAkB;AACrC,gBAAgB;AAChB;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,OAAO;;AAEP;AACA,KAAK;;AAEL;AACA,4BAA4B;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,2BAA2B,kBAAkB;AAC7C;AACA;AACA;AACA;AACA,2BAA2B,oBAAoB;AAC/C;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,yCAAyC;AACzC,0CAA0C;AAC1C,0CAA0C;AAC1C,yCAAyC;AACzC,yCAAyC,O;AACzC,0CAA0C;AAC1C;;AAEA;AACA,KAAK;;AAEL;AACA;AACA,qBAAqB,iBAAiB;AACtC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB,iBAAiB;AAC1C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,eAAe;AACf;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,6GAA6G,aAAa;;AAE1H;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB;AACnB,eAAe;AACf;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA,mDAAmD,+BAA+B,EAAE;AACpF,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;;AAEA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAA0B,gBAAgB,6BAA6B,EAAE;;;AAGzE;AACA;AACA;AACA;AACA,OAAO;AACP;AACA,OAAO;AACP;AACA,OAAO;AACP;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,sFAAsF;AACtF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB;AACnB;AACA;;AAEA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA;;AAEA;AACA;AACA;AACA,+DAA+D,qCAAqC;AACpG;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;;AAEP;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA,OAAO;;AAEP;AACA,KAAK;;AAEL;AACA,gCAAgC,QAAQ;;AAExC;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA,6BAA6B,QAAQ;;AAErC;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA,iEAAiE,mBAAmB;AACpF;;AAEA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,oCAAoC,qHAAqH;AACzJ;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yFAAyF,WAAW;AACpG;;AAEA;AACA,KAAK;;AAEL;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,WAAW;;AAEX;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,OAAO;AACP,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA,4CAA4C,wBAAwB;AACpE,4CAA4C,wBAAwB;AACpE,4CAA4C,wBAAwB;AACpE,4CAA4C,wBAAwB;AACpE,gDAAgD,gCAAgC;AAChF,8CAA8C,4BAA4B;AAC1E,2CAA2C,sBAAsB;AACjE,iDAAiD,sCAAsC;AACvF,4CAA4C,4BAA4B;AACxE,4CAA4C,4BAA4B;AACxE,4CAA4C,4BAA4B;AACxE;AACA,WAAW;;AAEX;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA,gDAAgD,oCAAoC;AACpF,4CAA4C,+BAA+B;AAC3E,gDAAgD,oCAAoC;AACpF,6CAA6C,8BAA8B;AAC3E,+CAA+C,kCAAkC;AACjF;AACA,WAAW;;AAEX;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA,+CAA+C,kCAAkC;AACjF,kDAAkD,wCAAwC;AAC1F,mDAAmD,0CAA0C;AAC7F;AACA;AACA;;AAEA;AACA,4EAA4E,4BAA4B;AACxG;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,+KAA+K,iBAAiB;AAChM,0DAA0D,wBAAwB;;AAElF;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA,eAAe;AACf;;AAEA;AACA;AACA;AACA,+LAA+L,iBAAiB;AAChN,0DAA0D,uBAAuB;;AAEjF;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA,eAAe;AACf;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,WAAW;;AAEX;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,yKAAyK;AACzK,2EAA2E;AAC3E,6EAA6E;AAC7E,+EAA+E;AAC/E,iFAAiF;AACjF;AACA;;AAEA;AACA;;AAEA;AACA,aAAa;;AAEb;AACA;AACA;AACA,gBAAgB;;AAEhB,0CAA0C;AAC1C;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,mCAAmC,qCAAqC;AACxE;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,+BAA+B,gBAAgB;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,+BAA+B;AAC/B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA,0EAA0E;AAC1E;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,kDAAkD;AAClD,oCAAoC;;AAEpC;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,WAAW;AACX;AACA,OAAO;;AAEP;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,+BAA+B,+BAA+B;AAC9D;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,aAAa;;AAEb;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;;AAEA,8BAA8B;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA,qBAAqB;AACrB;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,sCAAsC;;AAEtC;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,2DAA2D,mBAAmB;AAC9E,mEAAmE,gDAAgD;AACnH,qBAAqB;AACrB;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,sBAAsB;AAC7D;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B;AAC/B;AACA;AACA;AACA,+BAA+B;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B;AAC3B,uBAAuB;AACvB,qBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,aAAa;;AAEb;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+DAA+D;AAC/D;AACA;AACA;AACA;AACA,uEAAuE;AACvE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,eAAe;;AAEf;AACA,aAAa;;AAEb;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,wGAAwG;AACxG;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,uBAAuB;;AAEvB;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA;AACA;;AAEA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA,yBAAyB;AACzB;AACA;AACA;AACA,yBAAyB;AACzB;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,yCAAyC;AACzC;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA,2BAA2B;AAC3B;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA,2BAA2B;AAC3B;AACA;AACA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2EAA2E,aAAa;AACxF;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,mBAAmB;AACnB;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA,yBAAyB;AACzB;AACA,mBAAmB;AACnB;;AAEA;AACA;AACA;AACA;;AAEA,+EAA+E,yBAAyB;;AAExG;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,uBAAuB;;AAEvB;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,wBAAwB;;AAExB;AACA;AACA;AACA;AACA,uBAAuB;;AAEvB,oCAAoC;AACpC;AACA;AACA;AACA,uBAAuB;AACvB,mBAAmB;AACnB;;AAEA;AACA,iDAAiD,SAAS;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,gDAAgD;AAChD;AACA;AACA;;AAEA;AACA;;AAEA,iDAAiD,SAAS;AAC1D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,6BAA6B;AAC7B;AACA,uBAAuB;AACvB;AACA;AACA;;AAEA;AACA;AACA,iDAAiD,SAAS;AAC1D;AACA;;AAEA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,aAAa;;AAEb;AACA;AACA,aAAa;;AAEb;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA,OAAO;;AAEP,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,GAAG;AACH,EAAE;;AAEF;AACA,6DAA6D,aAAa,EAAE;AAC5E;AACA;;AAEA;;;;;;;;ACvqOA,gD;;;;;;;ACAA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,OAAO;AACP;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;;AAEjB;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT,OAAO;AACP,GAAG;AACH;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,uCAAuC,8BAA8B;;AAErE;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,6CAA6C,+BAA+B;AAC5E;;AAEA;AACA;AACA,SAAS;AACT;AACA;AACA;;AAEA;AACA;;AAEA,wCAAwC,iBAAiB;AACzD;AACA;;AAEA;AACA;AACA;AACA,6BAA6B,iEAAiE;AAC9F,KAAK;AACL;AACA,6BAA6B,qCAAqC;AAClE;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;;;;;;AC5NA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,UAAU,gBAAgB;;AAE1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;;AAIA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,WAAW;AACX,OAAO;AACP;AACA;AACA,KAAK;AACL;AACA;;;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;;AAEA;AACA,UAAU;;AAEV;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;;AAEA;;AAEA;;AAEA;AACA,iDAAiD,uCAAuC;AACxF,GAAG;;AAEH;AACA;;AAEA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,KAAK;AACL;;;AAGA;AACA;;AAEA;;AAEA;AACA;AACA,mBAAmB,WAAW;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,aAAa;AACb;AACA,OAAO;AACP;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA,mBAAmB;AACnB;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL;AACA;AACA,KAAK;;AAEL;AACA,UAAU;;AAEV;AACA,iBAAiB,iBAAiB;AAClC;AACA;AACA;;AAEA;;AAEA,iBAAiB,yBAAyB;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,OAAO;AACP;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA,WAAW,QAAQ;;AAEnB;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,SAAS;AACT,KAAK;;AAEL;AACA;AACA;AACA,OAAO;AACP;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT;AACA;;AAEA,mCAAmC,gCAAgC,EAAE;AACrE;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,OAAO;AACP;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA","file":"do.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory(require(\"fetch\"));\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([\"fetch\"], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"DO\"] = factory(require(\"fetch\"));\n\telse\n\t\troot[\"DO\"] = factory(root[\"fetch\"]);\n})(typeof self !== 'undefined' ? self : this, function(__WEBPACK_EXTERNAL_MODULE_10__) {\nreturn \n\n\n// WEBPACK FOOTER //\n// webpack/universalModuleDefinition"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 8);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 5fa4a61e6f834c45aa50","'use strict'\n/**\n * Configuration\n */\nmodule.exports = {\n  Lang: document.documentElement.lang,\n  DocRefType: '',\n  RefType: {\n    LNCS: { InlineOpen: '[', InlineClose: ']' },\n    ACM: { InlineOpen: '[', InlineClose: ']' }\n  },\n  Stylesheets: [],\n  User: {\n    IRI: null,\n    Role: null,\n    UI: {},\n    OIDC: false,\n    WebIdDelegate: null\n  },\n  OidcPopupUrl: 'https://solid.openlinksw.com:8444/common/popup.html',\n  LocalDocument: (document.location.protocol == 'file:'),\n  UseStorage: false,\n  AutoSaveId: '',\n  AutoSaveTimer: 60000,\n  DisableStorageButtons: '<button class=\"local-storage-disable-html\" title=\"Disable local storage (temporary) in the browser\"><i class=\"fa fa-database fa-2x\"></i>Local Storage</button>',\n  EnableStorageButtons: '<button class=\"local-storage-enable-html\" title=\"Enable local storage (temporary) in the browser\"><i class=\"fa fa-database fa-2x\"></i>Local Storage</button>',\n  CDATAStart: '//<![CDATA[',\n  CDATAEnd: '//]]>',\n  SortableList: false,\n  GraphViewerAvailable: (typeof d3 !== 'undefined'),\n  MathAvailable: (typeof MathJax !== 'undefined'),\n  EditorAvailable: (typeof MediumEditor !== 'undefined'),\n  EditorEnabled: false,\n  ContentEditable: false,\n  WebExtension: ((window.chrome && chrome.runtime && chrome.runtime.id) || (typeof browser !== 'undefined' && browser.runtime && browser.runtime.id)),\n  Editor: {\n    headings: [\"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\"],\n    regexEmptyHTMLTags: /<[^\\/>][^>]*><\\/[^>]+>/gim,\n    ButtonLabelType: (((window.chrome && chrome.runtime && chrome.runtime.id) || (typeof browser !== 'undefined' && browser.runtime && browser.runtime.id)) ? 'fontawesome' : (document.querySelector('head link[rel~=\"stylesheet\"][href*=\"font-awesome\"]') ? (!navigator.onLine && document.querySelector('head link[rel~=\"stylesheet\"][href*=\"font-awesome\"][href^=\"http\"]') ? '': 'fontawesome') : '' )),\n    DisableReviewButton: '<button class=\"review-disable\" title=\"Disable review\"><i class=\"fa fa-balance-scale fa-2x\"></i>Review</button>',\n    EnableReviewButton: '<button class=\"review-enable\" title=\"Enable review\"><i class=\"fa fa-balance-scale fa-2x\"></i>Review</button>',\n    DisableEditorButton: '<button class=\"editor-disable\" title=\"Disable editor\"><i class=\"fa fa-i-cursor fa-2x\"></i>Edit</button>',\n    EnableEditorButton: '<button class=\"editor-enable\" title=\"Enable editor\"><i class=\"fa fa-i-cursor fa-2x\"></i>Edit</button>'\n  },\n  Button: {\n    Close: '<button class=\"close\" title=\"Close\"><i class=\"fa fa-close fa-2x\"></i></button>'\n  },\n  DOMNormalisation: {\n    'selfClosing': \"area base basefont br col colgroup embed hr img input isindex link meta metadata param source wbr\",\n    'skipAttributes': \"contenteditable spellcheck medium-editor-index data-medium-editor-element data-medium-editor-editor-index data-medium-focused data-placeholder role aria-multiline style\",\n    'sortAttributes': true,\n    'skipNodeWithClass': 'do',\n    'classWithChildText': {\n      'class': '.do.ref',\n      'element': 'mark'\n    },\n    'replaceClassItemWith': {\n      'source': \"on-document-menu medium-editor-element medium-editor-placeholder\",\n      'target': ''\n    },\n    'skipClassWithValue': ''\n  },\n\n  SelectorSign: {\n    \"*\": \"🔗\",\n    \"aside\": \"†\",\n    \"audio\": \"🔊\",\n    \"code\": \"#\",\n    \"dl\": \"☝\",\n    \"dl#document-annotation-service\": \"※\",\n    \"dl#document-created\": \"📅\",\n    \"dl#document-in-reply-to\": \"⮪\",\n    \"dl#document-identifier\": \"🚩\",\n    \"dl#document-inbox\": \"📥\",\n    \"dl#document-latest-version\": \"∼\",\n    \"dl#document-license\": \"🌻\",\n    \"dl#document-memento\": \"⛰\",\n    \"dl#document-modified\": \"📅\",\n    \"dl#document-original\": \"♁\",\n    \"dl#document-predecessor-version\": \"≺\",\n    \"dl#document-published\": \"📅\",\n    \"dl#document-rights\": \"📜\",\n    \"dl#document-resource-state\": \"🙊\",\n    \"dl#document-see-also\": \"🙈\",\n    \"dl#document-status\": \"🎆\",\n    \"dl#document-timemap\": \"⌚\",\n    \"dfn\": \"📇\",\n    \"figure\": \"❦\",\n    \"footer\": \"⸙\",\n    \"img\": \"🖼\",\n    \"nav\": \"☛\",\n    \"p\": \"¶\",\n    \"pre\": \"🖩\",\n    \"section\": \"§\",\n    \"section#acknowledgements\": \"☺\",\n    \"section#conclusions\": \"∴\",\n    \"section#keywords\": \"🏷\",\n    \"section#references\": \"☛\",\n    \"section#related-work\": \"⌘\",\n    \"section#results\": \"∞\",\n    \"table\": \"𝄜\",\n    \"video\": \"🎞\"\n  },\n\n  DocumentItems: [\n    'authors',\n    'document-identifier',\n    'document-created',\n    'document-modified',\n    'document-published',\n    'document-original',\n    'document-memento',\n    'document-latest-version',\n    'document-predecessor-version',\n    'document-timegate',\n    'document-timemap',\n    'document-derived-from',\n    'document-derived-on',\n    'document-license',\n    'document-inbox',\n    'document-annotation-service',\n    'document-in-reply-to',\n    'document-rights',\n    'document-resource-state',\n    'document-status',\n    'document-see-also',\n    'table-of-contents',\n    'table-of-figures',\n    'table-of-tables',\n    'table-of-abbrs',\n    'authors',\n    'abstract',\n    'categories-and-subject-descriptors',\n    'keywords',\n    'general-terms',\n\n    'introduction'\n  ],\n\n  CollectionItemsLimit: 20,\n  ContextLength: 32,\n  ProxyURL: ((window.location.hostname == 'localhost' || !navigator.onLine) ? window.location.protocol + '//' + window.location.host + '/proxy?uri=' : 'https://dokie.li/proxy?uri='),\n  AuthEndpoint: ((window.location.hostname == 'localhost' || !navigator.onLine) ? window.location.protocol + '//' + window.location.host + '/' : 'https://dokie.li/'),\n  NotificationLicense: 'https://creativecommons.org/publicdomain/zero/1.0/',\n  License: {\n    \"https://creativecommons.org/publicdomain/zero/1.0/\": {'name': 'CC0 1.0', 'description': 'Creative Commons Zero'},\n    \"https://creativecommons.org/licenses/by/4.0/\": {'name': 'CC BY 4.0', 'description': 'Creative Commons Attribution'},\n    \"https://creativecommons.org/licenses/by-sa/4.0/\": {'name': 'CC BY-SA 4.0', 'description': 'Creative Commons Attribution-ShareAlike'},\n    \"https://creativecommons.org/licenses/by-nc/4.0/\": {'name': 'CC BY-NC 4.0', 'description': 'Creative Commons Attribution-NonCommercial'},\n    \"https://creativecommons.org/licenses/by-nd/4.0/\": {'name': 'CC BY-ND 4.0', 'description': 'Creative Commons Attribution-NoDerivatives'},\n    \"https://creativecommons.org/licenses/by-nc-sa/4.0/\": {'name': 'CC BY-NC-SA 4.0', 'description': 'Creative Commons Attribution-NonCommercial-ShareAlike'},\n    \"https://creativecommons.org/licenses/by-nc-nd/4.0/\": {'name': 'CC BY-NC-ND 4.0', 'description': 'Creative Commons Attribution-NonCommercial-NoDerivates'}\n  },\n  PublicationStatus: {\n    \"http://purl.org/spar/pso/draft\": { 'name': 'Draft', 'description': 'The status of a work (for example a document or a dataset) prior to completion and publication.' },\n    \"http://purl.org/spar/pso/published\": { 'name': 'Published', 'description': 'The status of material (for example a document or a dataset) that has been published, i.e. made available for people to access, read or use, either freely or for a purchase price or an access fee.' }\n  },\n  Citation: {\n    'http://purl.org/spar/cito/agreesWith': 'agrees with',\n    'http://purl.org/spar/cito/cites': 'cites',\n    'http://purl.org/spar/cito/citesAsAuthority': 'cites as authority',\n    'http://purl.org/spar/cito/citesAsDataSource': 'cites as data source',\n    'http://purl.org/spar/cito/citesAsEvidence': 'cites as evidence',\n    'http://purl.org/spar/cito/citesAsMetadataDocument': 'cites as metadata document',\n    'http://purl.org/spar/cito/citesAsPotentialSolution': 'cites as potential solution',\n    'http://purl.org/spar/cito/citesAsRecommendedReading': 'cites as potential reading',\n    'http://purl.org/spar/cito/citesAsRelated': 'cites as related',\n    'http://purl.org/spar/cito/citesAsSourceDocument': 'cites as source document',\n    'http://purl.org/spar/cito/citesForInformation': 'cites for information',\n    'http://purl.org/spar/cito/compiles': 'compiles',\n    'http://purl.org/spar/cito/confirms': 'confirms',\n    'http://purl.org/spar/cito/containsAssertionFrom': 'contains assertion from',\n    'http://purl.org/spar/cito/corrects': 'corrects',\n    'http://purl.org/spar/cito/credits': 'credits',\n    'http://purl.org/spar/cito/critiques': 'critiques',\n    'http://purl.org/spar/cito/derides': 'derides',\n    'http://purl.org/spar/cito/describes': 'describes',\n    'http://purl.org/spar/cito/disagreesWith': 'disagrees with',\n    'http://purl.org/spar/cito/discusses': 'discusses',\n    'http://purl.org/spar/cito/disputes': 'disputes',\n    'http://purl.org/spar/cito/documents': 'documents',\n    'http://purl.org/spar/cito/extends': 'extends',\n    'http://purl.org/spar/cito/includesExcerptFrom': 'includes excerpt from',\n    'http://purl.org/spar/cito/includesQuotationFrom': 'includes quotation from',\n    'http://purl.org/spar/cito/linksTo': 'links to',\n    'http://purl.org/spar/cito/obtainsBackgroundFrom': 'obtains background from',\n    'http://purl.org/spar/cito/obtainsSupportFrom': 'obtains support from',\n    'http://purl.org/spar/cito/parodies': 'parodies',\n    'http://purl.org/spar/cito/plagiarizes': 'plagiarizes',\n    'http://purl.org/spar/cito/qualifies': 'qualifies',\n    'http://purl.org/spar/cito/refutes': 'refutes',\n    'http://purl.org/spar/cito/repliesTo': 'replies to',\n    'http://purl.org/spar/cito/retracts': 'retracts',\n    'http://purl.org/spar/cito/reviews': 'reviews',\n    'http://purl.org/spar/cito/ridicules': 'ridicules',\n    'http://purl.org/spar/cito/speculatesOn': 'speculates on',\n    'http://purl.org/spar/cito/supports': 'supports',\n    'http://purl.org/spar/cito/updates': 'updates',\n    'http://purl.org/spar/cito/usesConclusionsFrom': 'uses conclusions from',\n    'http://purl.org/spar/cito/usesDataFrom': 'uses data from',\n    'http://purl.org/spar/cito/usesMethodIn': 'uses method in'\n  },\n\n  AvailableMediaTypes: ['text/turtle', 'application/ld+json', 'application/rdf+xml', 'application/xhtml+xml', 'text/html'],\n\n  AcceptBinaryTypes: ['image/png', 'image/jpeg', 'image/gif'],\n\n  Prefixes: {\n    'xsd': 'http://www.w3.org/2001/XMLSchema#',\n    'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',\n    'as': 'https://www.w3.org/ns/activitystreams#',\n    'oa': 'http://www.w3.org/ns/oa#',\n    'schema': 'http://schema.org/'\n  },\n\n  Vocab: {\n    \"rdftype\": { \"@id\": \"http://www.w3.org/1999/02/22-rdf-syntax-ns#type\", \"@type\": \"@id\", \"@array\": true },\n    \"rdffirst\": { \"@id\": \"http://www.w3.org/1999/02/22-rdf-syntax-ns#first\", \"@type\": \"@id\" },\n    \"rdfrest\": { \"@id\": \"http://www.w3.org/1999/02/22-rdf-syntax-ns#rest\", \"@type\": \"@id\" },\n    \"rdfvalue\": \"http://www.w3.org/1999/02/22-rdf-syntax-ns#value\",\n    \"rdfslabel\": { \"@id\": \"http://www.w3.org/2000/01/rdf-schema#label\" },\n    \"rdfsseeAlso\": { \"@id\": \"http://www.w3.org/2000/01/rdf-schema#seeAlso\", \"@type\": \"@id\", \"@array\": true },\n\n    \"owlsameAs\": { \"@id\": \"http://www.w3.org/2002/07/owl#sameAs\", \"@type\": \"@id\", \"@array\": true },\n\n    \"foafname\": \"http://xmlns.com/foaf/0.1/name\",\n    \"foaffamilyName\": \"http://xmlns.com/foaf/0.1/familyName\",\n    \"foafgivenName\": \"http://xmlns.com/foaf/0.1/givenName\",\n    \"foafhomepage\": { \"@id\": \"http://xmlns.com/foaf/0.1/homepage\", \"@type\": \"@id\" },\n    \"foafweblog\": { \"@id\": \"http://xmlns.com/foaf/0.1/weblog\", \"@type\": \"@id\" },\n    \"foafimg\": { \"@id\": \"http://xmlns.com/foaf/0.1/img\", \"@type\": \"@id\" },\n    \"foafdepiction\": { \"@id\": \"http://xmlns.com/foaf/0.1/depiction\", \"@type\": \"@id\" },\n    \"foafnick\": \"http://xmlns.com/foaf/0.1/nick\",\n    \"foafmaker\": { \"@id\": \"http://xmlns.com/foaf/0.1/maker\", \"@type\": \"@id\" },\n    \"foafknows\": { \"@id\": \"http://xmlns.com/foaf/0.1/knows\", \"@type\": \"@id\", \"@array\": true },\n\n    \"vcardfn\": \"http://www.w3.org/2006/vcard/ns#fn\",\n    \"vcardfamilyname\": \"http://www.w3.org/2006/vcard/ns#family-name\",\n    \"vcardgivenname\": \"http://www.w3.org/2006/vcard/ns#given-name\",\n    \"vcardnickname\": \"http://www.w3.org/2006/vcard/ns#nickname\",\n    \"vcardurl\": { \"@id\": \"http://www.w3.org/2006/vcard/ns#url\", \"@type\": \"@id\" },\n    \"vcardphoto\": { \"@id\": \"http://www.w3.org/2006/vcard/ns#photo\", \"@type\": \"@id\" },\n    \"vcardhasPhoto\": { \"@id\": \"http://www.w3.org/2006/vcard/ns#hasPhoto\", \"@type\": \"@id\" },\n\n    \"schemaname\": \"http://schema.org/name\",\n    \"schemafamilyName\": \"http://schema.org/familyName\",\n    \"schemagivenName\": \"http://schema.org/givenName\",\n    \"schemaurl\": { \"@id\": \"http://schema.org/url\", \"@type\": \"@id\" },\n    \"schemaimage\": { \"@id\": \"http://schema.org/image\", \"@type\": \"@id\" },\n    \"schemacreator\": { \"@id\": \"http://schema.org/creator\", \"@type\": \"@id\", \"@array\": true },\n    \"schemaauthor\": { \"@id\": \"http://schema.org/author\", \"@type\": \"@id\", \"@array\": true },\n    \"schemacontributor\": { \"@id\": \"http://schema.org/contributor\", \"@type\": \"@id\", \"@array\": true },\n    \"schemaeditor\": { \"@id\": \"http://schema.org/editor\", \"@type\": \"@id\", \"@array\": true },\n    \"schemalicense\": { \"@id\": \"http://schema.org/license\", \"@type\": \"@id\" },\n    \"schemacitation\": { \"@id\": \"http://schema.org/citation\", \"@type\": \"@id\", \"@array\": true },\n    \"schemaknows\": { \"@id\": \"http://schema.org/knows\", \"@type\": \"@id\", \"@array\": true },\n    \"schemadateCreated\": \"http://schema.org/dateCreated\",\n    \"schemadateModified\": \"http://schema.org/dateModified\",\n    \"schemadatePublished\": \"http://schema.org/datePublished\",\n    \"schemadescription\": \"http://schema.org/description\",\n    \"schemahasPart\": { \"@id\": \"http://schema.org/hasPart\", \"@type\": \"@id\", \"@array\": true }, \n    \"schemaisPartOf\": { \"@id\": \"http://schema.org/isPartOf\", \"@type\": \"@id\", \"@array\": true },\n    \"schemaScholarlyArticle\": { \"@id\": \"http://schema.org/ScholarlyArticle\" },\n\n    \"dctermstitle\": \"http://purl.org/dc/terms/title\",\n    \"dctermsdescription\": \"http://purl.org/dc/terms/description\",\n    \"dctermscreator\": { \"@id\": \"http://purl.org/dc/terms/creator\", \"@type\": \"@id\", \"@array\": true },\n    \"dctermsdate\": \"http://purl.org/dc/terms/date\",\n    \"dctermsissued\": \"http://purl.org/dc/terms/issued\",\n    \"dctermscreated\": \"http://purl.org/dc/terms/created\",\n    \"dctermsrights\": { \"@id\": \"http://purl.org/dc/terms/rights\", \"@type\": \"@id\" },\n    \"dctermsconformsTo\": { \"@id\": \"http://purl.org/dc/terms/conformsTo\", \"@type\": \"@id\" },\n    \"dctermshasPart\": { \"@id\": \"http://purl.org/dc/terms/hasPart\", \"@type\": \"@id\", \"@array\": true },\n    \"dctermsisPartOf\": { \"@id\": \"http://purl.org/dc/terms/isPartOf\", \"@type\": \"@id\", \"@array\": true },\n\n    \"skosprefLabel\": { \"@id\": \"http://www.w3.org/2004/02/skos/core#prefLabel\", \"@type\": \"@id\", \"@array\": true },\n\n    \"refPeriod\": \"http://purl.org/linked-data/sdmx/2009/dimension#refPeriod\",\n    \"obsValue\": \"http://purl.org/linked-data/sdmx/2009/measure#obsValue\",\n\n    \"biboauthorList\": { \"@id\": \"http://purl.org/ontology/bibo/authorList\", \"@type\": \"@id\" },\n\n    \"pimstorage\": { \"@id\": \"http://www.w3.org/ns/pim/space#storage\", \"@type\": \"@id\", \"@array\": true },\n    \"preferencesFile\": { \"@id\": \"http://www.w3.org/ns/pim/space#preferencesFile\", \"@type\": \"@id\" },\n\n    \"ldpinbox\": { \"@id\": \"http://www.w3.org/ns/ldp#inbox\", \"@type\": \"@id\", \"@array\": true },\n\n    \"solidpreferredProxy\": \"http://www.w3.org/ns/solid/terms#preferredProxy\",\n\n    \"oaannotation\": { \"@id\": \"http://www.w3.org/ns/oa#Annotation\", \"@type\": \"@id\" },\n    \"oahasBody\": { \"@id\": \"http://www.w3.org/ns/oa#hasBody\", \"@type\": \"@id\" },\n    \"oahasTarget\": { \"@id\": \"http://www.w3.org/ns/oa#hasTarget\", \"@type\": \"@id\" },\n    \"oahasSource\": { \"@id\": \"http://www.w3.org/ns/oa#hasSource\", \"@type\": \"@id\" },\n    \"oahasSelector\": { \"@id\": \"http://www.w3.org/ns/oa#hasSelector\", \"@type\": \"@id\" },\n    \"oarefinedBy\": { \"@id\": \"http://www.w3.org/ns/oa#refinedBy\", \"@type\": \"@id\" },\n    \"oaexact\": \"http://www.w3.org/ns/oa#exact\",\n    \"oaprefix\": \"http://www.w3.org/ns/oa#prefix\",\n    \"oasuffix\": \"http://www.w3.org/ns/oa#suffix\",\n    \"oamotivatedBy\": { \"@id\": \"http://www.w3.org/ns/oa#motivatedBy\", \"@type\": \"@id\" },\n    \"oaannotationService\": { \"@id\": \"http://www.w3.org/ns/oa#annotationService\", \"@type\": \"@id\", \"@array\": true },\n\n    \"assubject\": { \"@id\": \"https://www.w3.org/ns/activitystreams#subject\", \"@type\": \"@id\", \"@array\": true },\n    \"asobject\": { \"@id\": \"https://www.w3.org/ns/activitystreams#object\", \"@type\": \"@id\", \"@array\": true },\n    \"astarget\": { \"@id\": \"https://www.w3.org/ns/activitystreams#target\", \"@type\": \"@id\", \"@array\": true },\n    \"asrelationship\": { \"@id\": \"https://www.w3.org/ns/activitystreams#relationship\", \"@type\": \"@id\", \"@array\": true },\n    \"ascontext\": { \"@id\": \"https://www.w3.org/ns/activitystreams#context\", \"@type\": \"@id\", \"@array\": true },\n    \"asinReplyTo\": { \"@id\": \"https://www.w3.org/ns/activitystreams#inReplyTo\", \"@type\": \"@id\", \"@array\": true },\n    \"asactor\": { \"@id\": \"https://www.w3.org/ns/activitystreams#actor\", \"@type\": \"@id\" },\n    \"asupdated\": \"https://www.w3.org/ns/activitystreams#updated\",\n    \"aspublished\": \"https://www.w3.org/ns/activitystreams#published\",\n    \"ascontent\": \"https://www.w3.org/ns/activitystreams#content\",\n    \"asname\": \"https://www.w3.org/ns/activitystreams#name\",\n    \"asimage\": { \"@id\": \"https://www.w3.org/ns/activitystreams#image\", \"@type\": \"@id\" },\n    \"asoutbox\": { \"@id\": \"https://www.w3.org/ns/activitystreams#outbox\", \"@type\": \"@id\", \"@array\": true },\n    \"asitems\": { \"@id\": \"https://www.w3.org/ns/activitystreams#items\", \"@type\": \"@id\", \"@array\": true },\n    \"asorderedItems\": { \"@id\": \"https://www.w3.org/ns/activitystreams#orderedItems\", \"@type\": \"@id\", \"@array\": true },\n    \"astotalItems\": \"https://www.w3.org/ns/activitystreams#totalItems\",\n    \"asfirst\": { \"@id\": \"https://www.w3.org/ns/activitystreams#first\", \"@type\": \"@id\" },\n    \"asnext\": { \"@id\": \"https://www.w3.org/ns/activitystreams#next\", \"@type\": \"@id\" },\n    \"asCollection\": { \"@id\": \"https://www.w3.org/ns/activitystreams#Collection\", \"@type\": \"@id\" },\n    \"asOrderedCollection\": { \"@id\": \"https://www.w3.org/ns/activitystreams#OrderedCollection\", \"@type\": \"@id\" },\n\n    \"siocreplyof\": { \"@id\": \"http://rdfs.org/sioc/ns#reply_of\", \"@type\": \"@id\", \"@array\": true },\n    \"siocavatar\": { \"@id\": \"http://rdfs.org/sioc/ns#avatar\", \"@type\": \"@id\" },\n\n    \"ldpcontains\": { \"@id\": \"http://www.w3.org/ns/ldp#contains\", \"@type\": \"@id\", \"@array\": true },\n    \"ldpResource\": { \"@id\": \"http://www.w3.org/ns/ldp#Resource\", \"@type\": \"@id\" },\n    \"ldpContainer\": { \"@id\": \"http://www.w3.org/ns/ldp#Container\", \"@type\": \"@id\" },\n    \"ldpRDFSource\": { \"@id\": \"http://www.w3.org/ns/ldp#RDFSource\", \"@type\": \"@id\" },\n    \"ldpImmutableResource\": { \"@id\": \"http://www.w3.org/ns/ldp#ImmutableResource\", \"@type\": \"@id\" },\n\n    \"memOriginalResource\": { \"@id\": \"http://mementoweb.org/ns#OriginalResource\", \"@type\": \"@id\" },\n    \"memMemento\": { \"@id\": \"http://mementoweb.org/ns#Memento\", \"@type\": \"@id\" },\n    \"memoriginal\": { \"@id\": \"http://mementoweb.org/ns#original\", \"@type\": \"@id\" },\n    \"memmemento\": { \"@id\": \"http://mementoweb.org/ns#memento\", \"@type\": \"@id\" },\n    \"memtimegate\": { \"@id\": \"http://mementoweb.org/ns#timegate\", \"@type\": \"@id\" },\n    \"memtimemap\": { \"@id\": \"http://mementoweb.org/ns#timemap\", \"@type\": \"@id\" },\n\n    \"relpredecessorversion\": { \"@id\": \"https://www.w3.org/ns/iana/link-relations/relation#predecessor-version\", \"@type\": \"@id\" },\n    \"rellatestversion\": { \"@id\": \"https://www.w3.org/ns/iana/link-relations/relation#latest-version\", \"@type\": \"@id\" },\n\n    \"psodraft\": { \"@id\": \"http://purl.org/spar/pso/draft\", \"@type\": \"@id\" },\n    \"psopublished\": { \"@id\": \"http://purl.org/spar/pso/published\", \"@type\": \"@id\" }\n  },\n\n  SecretAgentNames: ['Abraham Lincoln', 'Admiral Awesome', 'Anonymous Coward', 'Believe it or not', 'Creative Monkey', 'Senegoid', 'Dog from the Web', 'Ekrub', 'Elegant Banana', 'Foo Bar', 'Lbmit', 'Lunatic Scholar', 'NahuLcm', 'Noslen', 'Okie Dokie', 'Samurai Cat', 'Vegan Superstar'],\n\n  RefAreas: {\"AF\":\"Afghanistan\",\"A9\":\"Africa\",\"AL\":\"Albania\",\"DZ\":\"Algeria\",\"AS\":\"American Samoa\",\"L5\":\"Andean Region\",\"AD\":\"Andorra\",\"AO\":\"Angola\",\"AG\":\"Antigua and Barbuda\",\"1A\":\"Arab World\",\"AR\":\"Argentina\",\"AM\":\"Armenia\",\"AW\":\"Aruba\",\"AU\":\"Australia\",\"AT\":\"Austria\",\"AZ\":\"Azerbaijan\",\"BS\":\"Bahamas, The\",\"BH\":\"Bahrain\",\"BD\":\"Bangladesh\",\"BB\":\"Barbados\",\"BY\":\"Belarus\",\"BE\":\"Belgium\",\"BZ\":\"Belize\",\"BJ\":\"Benin\",\"BM\":\"Bermuda\",\"BT\":\"Bhutan\",\"BO\":\"Bolivia\",\"BA\":\"Bosnia and Herzegovina\",\"BW\":\"Botswana\",\"BR\":\"Brazil\",\"BN\":\"Brunei Darussalam\",\"BG\":\"Bulgaria\",\"BF\":\"Burkina Faso\",\"BI\":\"Burundi\",\"CV\":\"Cabo Verde\",\"KH\":\"Cambodia\",\"CM\":\"Cameroon\",\"CA\":\"Canada\",\"S3\":\"Caribbean small states\",\"KY\":\"Cayman Islands\",\"CF\":\"Central African Republic\",\"TD\":\"Chad\",\"JG\":\"Channel Islands\",\"CL\":\"Chile\",\"CN\":\"China\",\"CO\":\"Colombia\",\"KM\":\"Comoros\",\"CD\":\"Congo, Dem. Rep.\",\"CG\":\"Congo, Rep.\",\"CR\":\"Costa Rica\",\"CI\":\"Cote d'Ivoire\",\"HR\":\"Croatia\",\"CU\":\"Cuba\",\"CW\":\"Curacao\",\"CY\":\"Cyprus\",\"CZ\":\"Czech Republic\",\"DK\":\"Denmark\",\"DJ\":\"Djibouti\",\"DM\":\"Dominica\",\"DO\":\"Dominican Republic\",\"Z4\":\"East Asia & Pacific (all income levels)\",\"4E\":\"East Asia & Pacific (developing only)\",\"C4\":\"East Asia and the Pacific (IFC classification)\",\"EC\":\"Ecuador\",\"EG\":\"Egypt, Arab Rep.\",\"SV\":\"El Salvador\",\"GQ\":\"Equatorial Guinea\",\"ER\":\"Eritrea\",\"EE\":\"Estonia\",\"ET\":\"Ethiopia\",\"XC\":\"Euro area\",\"Z7\":\"Europe & Central Asia (all income levels)\",\"7E\":\"Europe & Central Asia (developing only)\",\"C5\":\"Europe and Central Asia (IFC classification)\",\"EU\":\"European Union\",\"FO\":\"Faeroe Islands\",\"FJ\":\"Fiji\",\"FI\":\"Finland\",\"FR\":\"France\",\"PF\":\"French Polynesia\",\"GA\":\"Gabon\",\"GM\":\"Gambia, The\",\"GE\":\"Georgia\",\"DE\":\"Germany\",\"GH\":\"Ghana\",\"GR\":\"Greece\",\"GL\":\"Greenland\",\"GD\":\"Grenada\",\"GU\":\"Guam\",\"GT\":\"Guatemala\",\"GN\":\"Guinea\",\"GW\":\"Guinea-Bissau\",\"GY\":\"Guyana\",\"HT\":\"Haiti\",\"XE\":\"Heavily indebted poor countries (HIPC)\",\"XD\":\"High income\",\"XS\":\"High income: OECD\",\"XR\":\"High income: nonOECD\",\"HN\":\"Honduras\",\"HK\":\"Hong Kong SAR, China\",\"HU\":\"Hungary\",\"IS\":\"Iceland\",\"IN\":\"India\",\"ID\":\"Indonesia\",\"IR\":\"Iran, Islamic Rep.\",\"IQ\":\"Iraq\",\"IE\":\"Ireland\",\"IM\":\"Isle of Man\",\"IL\":\"Israel\",\"IT\":\"Italy\",\"JM\":\"Jamaica\",\"JP\":\"Japan\",\"JO\":\"Jordan\",\"KZ\":\"Kazakhstan\",\"KE\":\"Kenya\",\"KI\":\"Kiribati\",\"KP\":\"Korea, Dem. Rep.\",\"KR\":\"Korea, Rep.\",\"KV\":\"Kosovo\",\"KW\":\"Kuwait\",\"KG\":\"Kyrgyz Republic\",\"LA\":\"Lao PDR\",\"ZJ\":\"Latin America & Caribbean (all income levels)\",\"XJ\":\"Latin America & Caribbean (developing only)\",\"L4\":\"Latin America and the Caribbean\",\"C6\":\"Latin America and the Caribbean (IFC classification)\",\"LV\":\"Latvia\",\"XL\":\"Least developed countries: UN classification\",\"LB\":\"Lebanon\",\"LS\":\"Lesotho\",\"LR\":\"Liberia\",\"LY\":\"Libya\",\"LI\":\"Liechtenstein\",\"LT\":\"Lithuania\",\"XO\":\"Low & middle income\",\"XM\":\"Low income\",\"XN\":\"Lower middle income\",\"LU\":\"Luxembourg\",\"MO\":\"Macao SAR, China\",\"MK\":\"Macedonia, FYR\",\"MG\":\"Madagascar\",\"MW\":\"Malawi\",\"MY\":\"Malaysia\",\"MV\":\"Maldives\",\"ML\":\"Mali\",\"MT\":\"Malta\",\"MH\":\"Marshall Islands\",\"MR\":\"Mauritania\",\"MU\":\"Mauritius\",\"MX\":\"Mexico\",\"L6\":\"Mexico and Central America\",\"FM\":\"Micronesia, Fed. Sts.\",\"ZQ\":\"Middle East & North Africa (all income levels)\",\"XQ\":\"Middle East & North Africa (developing only)\",\"C7\":\"Middle East and North Africa (IFC classification)\",\"XP\":\"Middle income\",\"MD\":\"Moldova\",\"MC\":\"Monaco\",\"MN\":\"Mongolia\",\"ME\":\"Montenegro\",\"MA\":\"Morocco\",\"MZ\":\"Mozambique\",\"MM\":\"Myanmar\",\"NA\":\"Namibia\",\"NP\":\"Nepal\",\"NL\":\"Netherlands\",\"NC\":\"New Caledonia\",\"NZ\":\"New Zealand\",\"NI\":\"Nicaragua\",\"NE\":\"Niger\",\"NG\":\"Nigeria\",\"M2\":\"North Africa\",\"XU\":\"North America\",\"MP\":\"Northern Mariana Islands\",\"NO\":\"Norway\",\"XY\":\"Not classified\",\"OE\":\"OECD members\",\"OM\":\"Oman\",\"S4\":\"Other small states\",\"S2\":\"Pacific island small states\",\"PK\":\"Pakistan\",\"PW\":\"Palau\",\"PA\":\"Panama\",\"PG\":\"Papua New Guinea\",\"PY\":\"Paraguay\",\"PE\":\"Peru\",\"PH\":\"Philippines\",\"PL\":\"Poland\",\"PT\":\"Portugal\",\"PR\":\"Puerto Rico\",\"QA\":\"Qatar\",\"RO\":\"Romania\",\"RU\":\"Russian Federation\",\"RW\":\"Rwanda\",\"WS\":\"Samoa\",\"SM\":\"San Marino\",\"ST\":\"Sao Tome and Principe\",\"SA\":\"Saudi Arabia\",\"SN\":\"Senegal\",\"RS\":\"Serbia\",\"SC\":\"Seychelles\",\"SL\":\"Sierra Leone\",\"SG\":\"Singapore\",\"SX\":\"Sint Maarten (Dutch part)\",\"SK\":\"Slovak Republic\",\"SI\":\"Slovenia\",\"S1\":\"Small states\",\"SB\":\"Solomon Islands\",\"SO\":\"Somalia\",\"ZA\":\"South Africa\",\"8S\":\"South Asia\",\"C8\":\"South Asia (IFC classification)\",\"SS\":\"South Sudan\",\"L7\":\"Southern Cone Extended\",\"ES\":\"Spain\",\"LK\":\"Sri Lanka\",\"KN\":\"St. Kitts and Nevis\",\"LC\":\"St. Lucia\",\"MF\":\"St. Martin (French part)\",\"VC\":\"St. Vincent and the Grenadines\",\"C9\":\"Sub-Saharan Africa (IFC classification)\",\"ZG\":\"Sub-Saharan Africa (all income levels)\",\"ZF\":\"Sub-Saharan Africa (developing only)\",\"A4\":\"Sub-Saharan Africa excluding South Africa\",\"A5\":\"Sub-Saharan Africa excluding South Africa and Nigeria\",\"SD\":\"Sudan\",\"SR\":\"Suriname\",\"SZ\":\"Swaziland\",\"SE\":\"Sweden\",\"CH\":\"Switzerland\",\"SY\":\"Syrian Arab Republic\",\"TJ\":\"Tajikistan\",\"TZ\":\"Tanzania\",\"TH\":\"Thailand\",\"TL\":\"Timor-Leste\",\"TG\":\"Togo\",\"TO\":\"Tonga\",\"TT\":\"Trinidad and Tobago\",\"TN\":\"Tunisia\",\"TR\":\"Turkey\",\"TM\":\"Turkmenistan\",\"TC\":\"Turks and Caicos Islands\",\"TV\":\"Tuvalu\",\"UG\":\"Uganda\",\"UA\":\"Ukraine\",\"AE\":\"United Arab Emirates\",\"GB\":\"United Kingdom\",\"US\":\"United States\",\"XT\":\"Upper middle income\",\"UY\":\"Uruguay\",\"UZ\":\"Uzbekistan\",\"VU\":\"Vanuatu\",\"VE\":\"Venezuela, RB\",\"VN\":\"Vietnam\",\"VI\":\"Virgin Islands (U.S.)\",\"PS\":\"West Bank and Gaza\",\"1W\":\"World\",\"YE\":\"Yemen, Rep.\",\"ZM\":\"Zambia\",\"ZW\":\"Zimbabwe\"}\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/config.js\n// module id = 0\n// module chunks = 0","'use strict'\n\nconst Config = require('./config')\n\nmodule.exports = {\n  domToString,\n  dumpNode,\n  getDoctype,\n  getDocument,\n  setHTMLBase\n}\n\nfunction domToString (node, options = {}) {\n  var selfClosing = []\n\n  if (options.selfClosing) {\n    options.selfClosing.split(' ').forEach(function (n) {\n      selfClosing[n] = true\n    })\n  }\n\n  var skipAttributes = []\n\n  if (options.skipAttributes) {\n    options.skipAttributes.split(' ').forEach(function (n) {\n      skipAttributes[n] = true\n    })\n  }\n\n  var noEsc = [ false ]\n\n  return dumpNode(node, options, skipAttributes, selfClosing, noEsc)\n}\n\nfunction dumpNode (node, options, skipAttributes, selfClosing, noEsc) {\n  var out = ''\n\n  if (typeof node.nodeType === 'undefined') return out\n\n  if (node.nodeType === 1) {\n    if (node.hasAttribute('class') && 'classWithChildText' in options &&\n        node.matches(options.classWithChildText.class)) {\n      out += node.querySelector(options.classWithChildText.element).textContent\n    } else if (!(options.skipNodeWithClass && node.matches('.' + options.skipNodeWithClass))) {\n      var ename = node.nodeName.toLowerCase()\n      out += '<' + ename\n\n      var attrList = []\n\n      for (let i = node.attributes.length - 1; i >= 0; i--) {\n        var atn = node.attributes[i]\n\n        if (skipAttributes[atn.name]) continue\n\n        if (/^\\d+$/.test(atn.name)) continue\n\n        if (atn.name === 'class' && 'replaceClassItemWith' in options) {\n          atn.value.split(' ').forEach(function (aValue) {\n            if (options.replaceClassItemWith.source.split(' ').indexOf(aValue) > -1) {\n              var re = new RegExp(aValue, 'g')\n              atn.value = atn.value.replace(re, options.replaceClassItemWith.target).trim()\n            }\n          })\n        }\n\n        if (!(atn.name === 'class' && 'skipClassWithValue' in options &&\n            options.skipClassWithValue === atn.value)) {\n          attrList.push(\n            atn.name + '=\"' +\n            atn.value\n              .replace(/&/g, '&amp;')\n              .replace(/</g, '&lt;')\n              .replace(/>/g, '&gt;')\n              .replace(/\"/g, '&quot;') +\n            '\"')\n        }\n      }\n\n      if (attrList.length > 0) {\n        if ('sortAttributes' in options && options.sortAttributes) {\n          attrList.sort(function (a, b) {\n            return a.toLowerCase().localeCompare(b.toLowerCase())\n          })\n        }\n        out += ' ' + attrList.join(' ')\n      }\n\n      if (selfClosing[ename]) {\n        out += ' />'\n      } else {\n        out += '>'\n        out += (ename === 'html') ? '\\n  ' : ''\n        noEsc.push(ename === 'style' || ename === 'script' || ename === 'pre')\n        for (var i = 0; i < node.childNodes.length; i++) {\n          out += dumpNode(node.childNodes[i], options, skipAttributes, selfClosing, noEsc)\n        }\n        noEsc.pop()\n        out += (ename === 'body' || ename === 'html') ? '</' + ename + '>' + '\\n' : '</' + ename + '>'\n      }\n    }\n  } else if (node.nodeType === 8) {\n    // FIXME: If comments are not tabbed in source, a new line is not prepended\n    out += '\\n\\\n<!--' + node.nodeValue + '-->'\n  } else if (node.nodeType === 3 || node.nodeType === 4) {\n    // XXX: Remove new lines which were added after DOM ready\n    let nl = node.nodeValue.replace(/\\n+$/, '')\n    out += noEsc[noEsc.length - 1]\n      ? nl\n      : nl.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')\n  } else {\n    console.log('Warning; Cannot handle serialising nodes of type: ' + node.nodeType)\n  }\n\n  return out\n}\n\nfunction getDoctype () {\n  /* Get DOCTYPE from http://stackoverflow.com/a/10162353 */\n  var node = document.doctype\n  var doctype = ''\n\n  if (node !== null) {\n    doctype = '<!DOCTYPE ' +\n      node.name +\n      (node.publicId ? ' PUBLIC \"' + node.publicId + '\"' : '') +\n      (!node.publicId && node.systemId ? ' SYSTEM' : '') +\n      (node.systemId ? ' \"' + node.systemId + '\"' : '') +\n      '>'\n  }\n  return doctype\n}\n\nfunction getDocument (cn, options) {\n  let node = cn || document.documentElement.cloneNode(true)\n  options = options || Config.DOMNormalisation\n\n  let doctype = getDoctype()\n  let s = (doctype.length > 0) ? doctype + '\\n' : ''\n  s += domToString(node, options)\n  return s\n}\n\nfunction setHTMLBase (data, baseURI) {\n  let template = document.implementation.createHTMLDocument()\n  template.documentElement.innerHTML = data\n  let base = template.querySelector('head base[href]')\n  if (!base) {\n    template.querySelector('head').insertAdjacentHTML('afterbegin', '<base href=\"' + baseURI + '\" />')\n    data = template.documentElement.outerHTML\n  }\n  return data\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/doc.js\n// module id = 1\n// module chunks = 0","'use strict'\n\nconst Config = require('./config')\n\nmodule.exports = {\n  encodeString,\n  decodeString,\n  getAbsoluteIRI,\n  getProxyableIRI,\n  stripFragmentFromString,\n  getFragmentFromString\n}\n\nfunction encodeString (string) {\n  return encodeURIComponent(string).replace(/'/g, '%27').replace(/\"/g, '%22')\n}\n\n/**\n * UNUSED\n *\n * @param string {string}\n *\n * @returns {string}\n */\nfunction decodeString (string) {\n  return decodeURIComponent(string.replace(/\\+/g, ' '))\n}\n\nfunction getAbsoluteIRI (base, location) {\n  var iri = location\n\n  if (location.toLowerCase().slice(0, 4) !== 'http') {\n    if (location.startsWith('/')) {\n      var x = base.toLowerCase().trim().split('/')\n\n      iri = x[0] + '//' + x[2] + location\n    } else if (!base.endsWith('/')) {\n      iri = base.substr(0, base.lastIndexOf('/') + 1) + location\n    } else {\n      iri = base + location\n    }\n  }\n\n  return iri\n}\n\nfunction getProxyableIRI (url, options = {}) {\n  var pIRI = stripFragmentFromString(url)\n\n  if ((typeof document !== 'undefined' && document.location.protocol === 'https:' && pIRI.slice(0, 5).toLowerCase() === 'http:') || 'forceProxy' in options) {\n    var proxyURL = ('proxyURL' in options) ? options.proxyURL : Config.ProxyURL\n    pIRI = proxyURL + encodeString(pIRI)\n  }\n\n  return pIRI\n}\n\nfunction stripFragmentFromString (string) {\n  if (typeof string === 'string') {\n    let stringIndexFragment = string.indexOf('#')\n\n    if (stringIndexFragment >= 0) {\n      string = string.substring(0, stringIndexFragment)\n    }\n  }\n  return string\n}\n\nfunction getFragmentFromString (string) {\n  if (typeof string === 'string') {\n    let match = string.split('#')[1]\n\n    string = (match) ? match : '';\n  }\n  return string \n}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/uri.js\n// module id = 2\n// module chunks = 0","'use strict'\n\nmodule.exports = {\n  uniqueArray,\n  getHash,\n  getDateTimeISO,\n  removeChildren,\n  copyTextToClipboard,\n  escapeRegExp,\n  sleep\n}\n\n/**\n * @param a {Array}\n *\n * @returns {Array}\n */\nfunction uniqueArray (a) {\n  var n = {}\n  var r = []\n  for (var i = 0; i < a.length; i++) {\n    if (!n[a[i]]) {\n      n[a[i]] = true\n      r.push(a[i])\n    }\n  }\n  return r\n}\n\n// https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest\nfunction getHash (message, algo = \"SHA-256\") {\n  var buffer = new TextEncoder(\"utf-8\").encode(message);\n  return window.crypto.subtle.digest(algo, buffer).then(function (hash) {\n    var hexCodes = [];\n    var view = new DataView(hash);\n    for (var i = 0; i < view.byteLength; i += 4) {\n      var value = view.getUint32(i)\n      var stringValue = value.toString(16)\n      var padding = '00000000'\n      var paddedValue = (padding + stringValue).slice(-padding.length)\n      hexCodes.push(paddedValue);\n    }\n    return hexCodes.join(\"\");\n  });\n}\n\nfunction getDateTimeISO() {\n  var date = new Date();\n  return date.toISOString();\n}\n\n\nfunction removeChildren (node) {\n  while (node.firstChild) {\n    node.removeChild(node.firstChild);\n  }\n}\n\nfunction copyTextToClipboard(text){\nconsole.log(text)\n  if (!navigator.clipboard) {\n    try {\n      var successful = document.execCommand('copy');\n    } catch (err) {}\n    return;\n  }\n\n  navigator.clipboard.writeText(text).then(function() {\n    // console.log('Async: Copying to clipboard was successful!');\n  }, function(err) {\n    // console.error('Async: Could not copy text: ', err);\n  });\n}\n\n//From https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions\nfunction escapeRegExp(string){\n  return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n}\n\nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/util.js\n// module id = 3\n// module chunks = 0","'use strict'\n\nconst Config = require('./config')\nconst doc = require('./doc')\nconst uri = require('./uri')\nconst graph = require('./graph')\nconst fetch = require('node-fetch')  // Uses native fetch() in the browser\n\nconst DEFAULT_CONTENT_TYPE = 'text/html; charset=utf-8'\nconst LDP_RESOURCE = '<http://www.w3.org/ns/ldp#Resource>; rel=\"type\"'\n\nmodule.exports = {\n  setAcceptRDFTypes,\n  copyResource,\n  currentLocation,\n  deleteResource,\n  getAcceptPostPreference,\n  getResource,\n  getResourceHead,\n  getResourceGraph,\n  getResourceOptions,\n  parseLinkHeader,\n  patchResource,\n  postResource,\n  putResource,\n  putResourceACL,\n  postActivity\n}\n\nfunction setAcceptRDFTypes(options) {\n  options = options || {};\n\n  return Config.AvailableMediaTypes.map(i => {\n    if (i == 'application/xhtml+xml' || i == 'text/html') {\n      // q = Number(Math.round((q-0.1)+'e2')+'e-2');\n      return i + ';q=0.9';\n    }\n    return i;\n  }).join(',');\n}\n\n// I want HTTP COPY and I want it now!\nfunction copyResource (fromURL, toURL, options = {}) {\n  let headers = { 'Accept': '*/*' }\n  let contentType\n\n  if (!fromURL || !toURL) {\n    return Promise.reject(new Error('Missing fromURL or toURL in copyResource'))\n  }\n\n  return getResource(fromURL, headers, options)\n    .then(response => {\n      contentType = response.headers.get('Content-Type')\n\n      return (Config.AcceptBinaryTypes.indexOf(contentType))\n        ? response.arrayBuffer()\n        : response.text()\n    })\n    .then(contents => {\n      return putResource(toURL, contents, contentType, null, options)\n        .catch(error => {\n          if (error.status === 0) {\n            // Retry with no credentials\n            options.noCredentials = true\n            return putResource(toURL, contents, contentType, null, options)\n          }\n\n          throw error  // re-throw error\n        })\n    })\n}\n\n/**\n * @returns {string}\n */\nfunction currentLocation () {\n  return window.location.origin + window.location.pathname\n}\n\n/**\n * deleteResource\n *\n * @param url {string}\n * @param options {object}\n *\n * @returns {Promise<Response>}\n */\nfunction deleteResource (url, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n\n  if (!url) {\n    return Promise.reject(new Error('Cannot DELETE resource - missing url'))\n  }\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  options.method = 'DELETE'\n\n  return _fetch(url, options)\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error deleting resource: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      return response\n    })\n}\n\nfunction getAcceptPostPreference (url) {\n  const pIRI = uri.getProxyableIRI(url)\n\n  return getResourceOptions(pIRI, {'header': 'Accept-Post'})\n    .catch(error => {\n      console.error(error)\n\n      return {'headers': 'application/ld+json'}\n    })\n    .then(result => {\n      let header = result.headers.trim().split(/\\s*,\\s*/)\n\n      if (header.indexOf('text/html') > -1 || header.indexOf('application/xhtml+xml') > -1) {\n        return 'text/html'\n      } else if (header.indexOf('text/turtle') > -1 || header.indexOf('*/*') > -1) {\n        return 'text/turtle'\n      } else if (header.indexOf('application/ld+json') > -1 || header.indexOf('application/json') > -1) {\n        return 'application/ld+json'\n      } else {\n        console.log('Accept-Post contains unrecognised media-range; ' + result.headers)\n        return result.headers\n      }\n    })\n}\n\n/**\n * getResource\n *\n * @param url {string}\n *\n * @param headers {object}\n * @param [headers.accept='text/turtle'] {string}\n *\n * @param options {object}\n *\n * @returns {Promise<string>|Promise<ArrayBuffer>}\n */\nfunction getResource (url, headers = {}, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n\n  url = url || currentLocation()\n  options.method = 'GET'\n\n  if (!headers['Accept']) {\n    headers['Accept'] = 'text/turtle'\n  }\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  options.headers = Object.assign({}, headers)\n\n  return _fetch(url, options)\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error fetching resource: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      return response\n    })\n}\n\n/**\n * getResourceHead\n *\n * @param [url] {string}\n *\n * @param options {object}\n * @param options.header {string}\n *\n * @returns {Promise<string>} Resolves with contents of specified header\n */\nfunction getResourceHead (url, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n  url = url || currentLocation()\n\n  if (!options.header) {\n    return Promise.reject(new Error('options.header not specified'))\n  }\n\n  options.method = 'HEAD'\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  return _fetch(url, options)\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error fetching resource HEAD: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      let header = response.headers.get(options.header)\n\n      if (!header) {\n        throw new Error(\"'\" + options.header + \"' header not found\")\n      }\n\n      return { 'headers': header }\n    })\n}\n\nfunction getResourceGraph (iri, headers, options = {}) {\n  let defaultHeaders = {'Accept': setAcceptRDFTypes()}\n  headers = headers || defaultHeaders\n  if (!('Accept' in headers)) {\n    Object.assign(headers, defaultHeaders)\n  }\n\n/***/\n  if (iri.slice(0, 5).toLowerCase() === 'http:') {\n    options['noCredentials'] = true\n\n    if (document.domain !== iri.split('/')[2]) {\n      options['forceProxy'] = true\n    }\n  }\n/***/\n\n  let pIRI = uri.getProxyableIRI(iri, options)\n\n  return getResource(pIRI, headers, options)\n    .then(response => {\n      let cT = response.headers.get('Content-Type')\n      options.contentType = (cT) ? cT.split(';')[ 0 ].trim() : 'text/turtle'\n\n      options.subjectURI = uri.stripFragmentFromString(iri)\n\n      return response.text()\n    })\n    .then(data => {\n      return graph.getGraphFromData(data, options)\n    })\n    .then(g => {\n      let fragment = (iri.lastIndexOf('#') >= 0) ? iri.substr(iri.lastIndexOf('#')) : ''\n\n      return SimpleRDF(Config.Vocab, options[ 'subjectURI' ], g, ld.store).child(pIRI + fragment)\n    })\n}\n\n/**\n * getResourceOptions\n *\n * @param [url] {string} Defaults to current url\n *\n * @param [options={}] {object}\n * @param [options.header] {string} Specific response header to return\n * @param [options.noCredentials] {boolean}\n *\n * @returns {Promise} Resolves with `{ headers: ... }` object\n */\nfunction getResourceOptions (url, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n  url = url || currentLocation()\n\n  options.method = 'OPTIONS'\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  return _fetch(url, options)\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error fetching resource OPTIONS: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n      else if (options.header && !response.headers.get(options.header)){\n        let error = new Error('OPTIONS without ' + options.header + ' header: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      if (options.header) {  // specific header requested\n        return { headers: response.headers.get(options.header) }\n      }\n\n      return { headers: response.headers }  // Not currently used anywhere\n    })\n}\n\nfunction parseLinkHeader (link) {\n  if (!link) {\n    return {}\n  }\n  var linkexp = /<[^>]*>\\s*(\\s*;\\s*[^\\(\\)<>@,;:\"\\/\\[\\]\\?={} \\t]+=(([^\\(\\)<>@,;:\"\\/\\[\\]\\?={} \\t]+)|(\"[^\"]*\")))*(,|$)/g\n  var paramexp = /[^\\(\\)<>@,;:\"\\/\\[\\]\\?={} \\t]+=(([^\\(\\)<>@,;:\"\\/\\[\\]\\?={} \\t]+)|(\"[^\"]*\"))/g;\n  var matches = link.match(linkexp)\n  var rels = {}\n  for (var i = 0; i < matches.length; i++) {\n    var split = matches[i].split('>')\n    var href = split[0].substring(1)\n    var ps = split[1]\n    var s = ps.match(paramexp)\n    for (var j = 0; j < s.length; j++) {\n      var p = s[j]\n      var paramsplit = p.split('=')\n      // var name = paramsplit[0]\n      var rel = paramsplit[1].replace(/[\"']/g, '')\n      if (!rels[rel]) {\n        rels[rel] = []\n      }\n      rels[rel].push(href)\n      if (rels[rel].length > 1) {\n        rels[rel].sort()\n      }\n    }\n  }\n  return rels\n}\n\nfunction patchResource (url, deleteBGP, insertBGP, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n  // insertBGP and deleteBGP are basic graph patterns.\n  deleteBGP = (deleteBGP) ? 'DELETE DATA {\\n\\\n' + deleteBGP + '\\n\\\n};\\n\\\n' : '';\n\n  insertBGP = (insertBGP) ? 'INSERT DATA {\\n\\\n' + insertBGP + '\\n\\\n};\\n\\\n' : '';\n\n\n  options.body = deleteBGP + insertBGP\n\n  options.method = 'PATCH'\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  options.headers = options.headers || {}\n\n  options.headers['Content-Type'] = 'application/sparql-update; charset=utf-8'\n\n  return _fetch(url, options)\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error patching resource: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      return response\n    })\n}\n\nfunction postResource (url, slug, data, contentType, links, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n  if (!url) {\n    return Promise.reject(new Error('Cannot POST resource - missing url'))\n  }\n\n  options.method = 'POST'\n\n  options.body = data\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  options.headers = options.headers || {}\n\n  options.headers['Content-Type'] = contentType || DEFAULT_CONTENT_TYPE\n\n  links = links\n    ? LDP_RESOURCE + ', ' + links\n    : LDP_RESOURCE\n\n  options.headers['Link'] = links\n\n  if (slug) {\n    options.headers['Slug'] = slug\n  }\n\n  return _fetch(url, options)\n\n    .catch(error => {\n      if (error.status === 0 && !options.noCredentials) {\n        // Possible CORS error, retry with no credentials\n        options.noCredentials = true\n        return postResource(url, slug, data, contentType, options)\n      }\n\n      throw error\n    })\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error creating resource: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      return response\n    })\n}\n\n/**\n * putResource\n *\n * @param url {string}\n *\n * @param data {string|object}\n *\n * @param [contentType=DEFAULT_CONTENT_TYPE] {string}\n *\n * @param [links=LDP_RESOURCE] {string}\n *\n * @param [options={}] {object}\n *\n * @returns {Promise<Response>}\n */\nfunction putResource (url, data, contentType, links, options = {}) {\n  var _fetch = Config.User.OIDC? solid.auth.fetch : fetch;\n  if (!url) {\n    return Promise.reject(new Error('Cannot PUT resource - missing url'))\n  }\n\n  options.method = 'PUT'\n\n  options.body = data\n\n  if (!options.noCredentials) {\n    options.credentials = 'include'\n  }\n\n  options.headers = options.headers || {}\n\n  options.headers['Content-Type'] = contentType || DEFAULT_CONTENT_TYPE\n\n  links = links\n    ? LDP_RESOURCE + ', ' + links\n    : LDP_RESOURCE\n\n  options.headers['Link'] = links\n\n  return _fetch(url, options)\n\n    .then(response => {\n      if (!response.ok) {  // not a 2xx level response\n        let error = new Error('Error writing resource: ' +\n          response.status + ' ' + response.statusText)\n        error.status = response.status\n        error.response = response\n\n        throw error\n      }\n\n      return response\n    })\n}\n\n/**\n * putResourceACL\n *\n * TODO: This doesn't seem to be used anywhere...\n *\n * @param accessToURL\n * @param aclURL\n * @param acl\n *\n * @returns {Promise<Response|null>}\n */\nfunction putResourceACL (accessToURL, aclURL, acl) {\n  if (!Config.User.IRI) {\n    console.log('Go through sign-in or do: DO.C.User.IRI = \"https://example.org/#i\";')\n    return Promise.resolve(null)\n  }\n\n  acl = acl || {\n    'u': { 'iri': [Config.User.IRI], 'mode': ['acl:Control', 'acl:Read', 'acl:Write'] },\n    'g': { 'iri': ['http://xmlns.com/foaf/0.1/Agent'], 'mode': ['acl:Read'] },\n    'o': { 'iri': [], 'mode': [] }\n  }\n\n  let agent, agentClass, mode\n\n  if ('u' in acl && 'iri' in acl.u && 'mode' in acl.u) {\n    agent = '<' + acl.u.iri.join('> , <') + '>'\n    mode = acl.u.mode.join(' , ')\n  } else {\n    agent = '<' + Config.User.IRI + '>'\n    mode = 'acl:Control , acl:Read , acl:Write'\n  }\n\n  let authorizations = []\n\n  authorizations.push(\n    '[ a acl:Authorization ; acl:accessTo <' +\n    accessToURL + '> ; acl:accessTo <' + aclURL + '> ; acl:mode ' + mode +\n    ' ; acl:agent ' + agent + ' ] .'\n  )\n\n  if ('g' in acl && 'iri' in acl.g && acl.g.iri.length >= 0) {\n    agentClass = '<' + acl.g.iri.join('> , <') + '>'\n    mode = acl.g.mode.join(' , ')\n    authorizations.push(\n      '[ a acl:Authorization ; acl:accessTo <' + accessToURL +\n      '> ; acl:mode ' + mode + ' ; acl:agentClass ' + agentClass + ' ] .'\n    )\n  }\n\n  let data = '@prefix acl: <http://www.w3.org/ns/auth/acl#> .\\n' +\n    authorizations.join('\\n') + '\\n'\n\n  return putResource(aclURL, data, 'text/turtle; charset=utf-8')\n}\n\nfunction postActivity(url, slug, data, options) {\n  return getAcceptPostPreference(url)\n    .then(preferredContentType => {\n      switch (preferredContentType) {\n        case 'text/html':\n        case 'application/xhtml+xml':\n          return postResource(url, slug, data, 'text/html; charset=utf-8')\n\n        case 'text/turtle':\n          // FIXME: proxyURL + http URL doesn't work. https://github.com/solid/node-solid-server/issues/351\n\n          return graph.serializeData(data, options['contentType'], 'text/turtle', options)\n            .then(data => {\n              return postResource(url, slug, data, 'text/turtle')\n            })\n\n        case 'application/ld+json':\n        case 'application/json':\n        case '*/*':\n        default:\n          return graph.serializeData(data, options['contentType'], 'application/ld+json', options)\n            .then(data => {\n              if (!options['canonical']) {\n                let x = JSON.parse(data)\n                if ('id' in x) {\n                  x[ \"via\" ] = x[ \"id\" ]\n                  x[ \"id\" ] = \"\"\n                  data = JSON.stringify(x)\n                }\n              }\n\n              var profile = ('profile' in options) ? '; profile=\"' + options.profile + '\"' : ''\n\n              return postResource(url, slug, data, preferredContentType + profile)\n            })\n      }\n    })\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/fetcher.js\n// module id = 4\n// module chunks = 0","'use strict'\n\nglobal.SimpleRDF = (typeof ld !== 'undefined') ? ld.SimpleRDF : undefined\n\nconst Config = require('./config')\nconst doc = require('./doc')\n\nmodule.exports = {\n  getGraph,\n  getGraphFromData,\n  getMatchFromData,\n  serializeData,\n  serializeGraph,\n  applyParserSerializerFixes\n}\n\nfunction getGraph (url) {\n  return SimpleRDF(Config.Vocab, url, null, ld.store).get()\n}\n\nfunction getGraphFromData (data, options = {}) {\n  if (!('contentType' in options)) {\n    options['contentType'] = 'text/turtle'\n  }\n\n  // FIXME: This is a dirty filthy fugly but a *fix* to get around the baseURI not being passed to the DOM parser. This injects the `base` element into the document so that the RDFa parse fallsback to that. The actual fix should happen upstream. See related issues:\n  // https://github.com/linkeddata/dokieli/issues/132\n  // https://github.com/rdf-ext/rdf-parser-dom/issues/2\n  // https://github.com/rdf-ext/rdf-parser-rdfa/issues/3\n  // https://github.com/simplerdf/simplerdf/issues/19\n\n  if (!('subjectURI' in options)) {\n    options['subjectURI'] = 'http://localhost/d79351f4-cdb8-4228-b24f-3e9ac74a840d'\n  }\n  if (options.contentType === 'text/html' || options.contentType === 'application/xhtml+xml') {\n    data = doc.setHTMLBase(data, options.subjectURI)\n  }\n\n  return SimpleRDF.parse(data, options['contentType'], options['subjectURI'])\n}\n\nfunction getMatchFromData (data, spo = {}, options = {}) {\n  if (!data) { return Promise.resolve({}) }\n\n  spo['subject'] = spo.subject || window.location.origin + window.location.pathname\n  spo['predicate'] = spo.predicate || Config.Vocab['rdfslabel']\n\n  options['contentType'] = options.contentType || 'text/html'\n  options['subjectURI'] = options.subjectURI || spo.subject\n\n  return getGraphFromData(data, options)\n    .then(g => {\n      let s = SimpleRDF(Config.Vocab, spo.subject, g, ld.store).child(spo.subject)\n\n      return s[spo.predicate]\n    })\n    .catch(() => {\n      return undefined\n    })\n}\n\n/**\n * @param data\n * @param fromContentType\n * @param toContentType\n * @param options\n *\n * @returns {Promise}\n */\nfunction serializeData (data, fromContentType, toContentType, options) {\n  if (fromContentType === toContentType) {\n    return Promise.resolve(data)\n  }\n\n  options.contentType = fromContentType\n\n// console.log(data)\n\n  return getGraphFromData(data, options)\n    .then(g => {\n\n      options.contentType = toContentType\n\n      switch (toContentType) {\n        case 'application/ld+json':\n// console.log(g)\n          return serializeGraph(g, options).then(subjectTriples => {\n            subjectTriples = JSON.parse(subjectTriples)\n\n            var data = {}\n            if (options[\"@context\"]) {\n              data[\"@context\"] = options[\"@context\"]\n            }\n\n            var subjectsChecked = []\n            var subjectsList = []\n            var rootIndex = 0\n\n            for(var i = 0; i < subjectTriples.length; i++) {\n              subjectsList.push(subjectTriples[i][\"@id\"])\n\n              if (\"@id\" in subjectTriples[i] && subjectTriples[i][\"@id\"] == options.subjectURI) {\n                Object.assign(data, subjectTriples[i])\n\n                subjectsChecked.push(options.subjectURI)\n\n                rootIndex = i\n              }\n            }\n\n            var processObject = function(subject) {\n              var properties = Object.keys(subject)\n              properties.forEach(property => {\n                if (typeof subject[property] === 'object') {\n                  if (\"@id\" in subject[property]\n                    && subjectsChecked.indexOf(subject[property][\"@id\"]) < 0\n                    && subjectsList.indexOf(subject[property][\"@id\"]) > -1) {\n\n                    subjectTriples.forEach(o => {\n                      if (o[\"@id\"] == subject[property][\"@id\"]) {\n                        subject[property] = o;\n\n                        subjectsChecked.push(subject[property][\"@id\"])\n                      }\n                    })\n                  }\n\n                  return Object.assign({}, processObject(subject[property]))\n                }\n              })\n\n              return subject\n            }\n\n            var subject = subjectTriples[rootIndex]\n\n            Object.assign(data, processObject(subject))\n\n// console.log(data)\n// console.log(JSON.stringify(data))\n            return JSON.stringify(data) + '\\n'\n          })\n\n        default:\n          return serializeGraph(g, options)\n      }     \n    })\n    .then(data => {\n      switch (toContentType) {\n        default:\n          break;\n\n        case 'application/ld+json':\n          //TODO: Lazy person's JSON-LD compacting. Expect errors!\n          if (options[\"@context\"]) {\n            var context = (typeof options[\"@context\"] === 'string') ? [options[\"@context\"]] : options['@context']\n\n            data = JSON.parse(data);\n            delete data[\"@context\"]\n            data = JSON.stringify(data)\n\n            data = data.replace(new RegExp('\"@id\"', 'g'), '\"id\"')\n            data = data.replace(new RegExp('\"@type\"', 'g'), '\"type\"')\n\n            context.forEach(function(c){\n              var search = '';\n              var replace = '';\n\n              if (typeof c === 'string') {\n                switch(c) {\n                  case 'http://www.w3.org/ns/anno.jsonld':\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#autoDirection', 'g'), 'auto')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#cachedSource', 'g'), 'cached')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasBody', 'g'), 'body')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasEndSelector', 'g'), 'endSelector')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasPurpose', 'g'), 'purpose')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasScope', 'g'), 'scope')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasSelector', 'g'), 'selector')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasSource', 'g'), 'source')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasStartSelector', 'g'), 'startSelector')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#hasTarget', 'g'), 'target')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#ltrDirection', 'g'), 'ltr')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#motivatedBy', 'g'), 'motivation')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#rtlDirection', 'g'), 'rtl')\n                    data = data.replace(new RegExp('http://www.w3.org/ns/oa#styledBy', 'g'), 'stylesheet')\n\n                    data = data.replace(new RegExp('\"oa:', 'g'), '\"')\n\n                    search = 'http://www.w3.org/ns/oa#'\n                    break\n\n                  case 'https://www.w3.org/ns/activitystreams':\n                    data = data.replace(new RegExp('\"as:', 'g'), '\"')\n\n                    search = 'https://www.w3.org/ns/activitystreams#'\n                    break\n\n                  case 'http://schema.org/':\n                    data = data.replace(new RegExp('\"schema:', 'g'), '\"')\n\n                    search = 'http:/schema.org/'\n                    break\n                }\n              }\n              else {\n                replace = Object.keys(c)[0];\n\n                switch(replace) {\n                  case 'oa':\n                    search = 'http://www.w3.org/ns/oa#'\n                    break\n\n                  case 'as':\n                    search = 'https://www.w3.org/ns/activitystreams#'\n                    break\n\n                  case 'schema':\n                    search = 'http://schema.org/'\n                    break\n                }\n\n                replace = replace + ':'\n              }\n\n              data = data.replace(new RegExp(search, 'g'), replace)\n\n            })\n\n            data = JSON.parse(data)\n            data = Object.assign({\"@context\": options[\"@context\"]}, data)\n            data = JSON.stringify(data)\n          }\n\n          break;\n      }\n// console.log(data)\n      return data\n    })\n}\n\nfunction serializeGraph (g, options = {}) {\n  if (!('contentType' in options)) {\n    options['contentType'] = 'text/turtle'\n  }\n\n  return ld.store.serializers[options.contentType].serialize(g._graph)\n    .then(data => {\n      data = applyParserSerializerFixes(data, options.contentType)\n\n      // XXX: .compact doesn't work as advertised\n      // if (options.contentType === 'application/ld+json' && '@context' in options) {\n      //   return jsonld.promises().compact(data, options['@context'], {'skipExpansion': true})\n      // }\n\n      return data\n    })\n}\n\nfunction applyParserSerializerFixes(data, contentType) {\n  // FIXME: FUGLY because parser defaults to localhost. Using UUID to minimise conflict\n  data = data.replace(/http:\\/\\/localhost\\/d79351f4-cdb8-4228-b24f-3e9ac74a840d/g, '');\n\n  switch(contentType) {\n    case 'text/turtle':\n      //XXX: Workaround for rdf-parser-rdfa bug that gives '@langauge' instead of @type when encountering datatype in HTML+RDFa . TODO: Link to bug here\n      data = data.replace(/Z\"@en;/, 'Z\"^^<http://www.w3.org/2001/XMLSchema#dateTime>;');\n      data = data.replace(/start> \"(\\d+)\"@en;/, 'start> \"$1\"^^<http://www.w3.org/2001/XMLSchema#nonNegativeInteger>;');\n      data = data.replace(/end> \"(\\d+)\"@en;/, 'end> \"$1\"^^<http://www.w3.org/2001/XMLSchema#nonNegativeInteger>;');\n      break;\n\n    case 'application/ld+json':\n      var x = JSON.parse(data);\n\n      //XXX: Workaround for rdf-parser-rdfa bug that gives '@language' instead of @type when encountering datatype in HTML+RDFa . See also https://github.com/rdf-ext/rdf-parser-rdfa/issues/5\n      var properties = ['https://www.w3.org/ns/activitystreams#published', 'https://www.w3.org/ns/activitystreams#updated', 'http://schema.org/dateCreated', 'http://schema.org/datePublished', 'http://schema.org/dateModified', 'http://www.w3.org/ns/oa#start', 'http://www.w3.org/ns/oa#end'];\n\n      for(var i = 0; i < x.length; i++){\n        for(var j = 0; j < properties.length; j++){\n          if(properties[j] in x[i]) {\n            if (properties[j] == 'http://www.w3.org/ns/oa#start' || properties[j] == 'http://www.w3.org/ns/oa#end') {\n              x[i][properties[j]] = {\n                '@type': 'http://www.w3.org/2001/XMLSchema#nonNegativeInteger',\n                '@value': x[i][properties[j]]['@value']\n              };\n            }\n            else {\n              x[i][properties[j]] = {\n                '@type': 'http://www.w3.org/2001/XMLSchema#dateTime',\n                '@value': x[i][properties[j]]['@value']\n              };\n            }\n          }\n        }\n      }\n\n      data = JSON.stringify(x);\n      break;\n  }        \n\n  return data;\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/graph.js\n// module id = 5\n// module chunks = 0","var g;\r\n\r\n// This works in non-strict mode\r\ng = (function() {\r\n\treturn this;\r\n})();\r\n\r\ntry {\r\n\t// This works if eval is allowed (see CSP)\r\n\tg = g || Function(\"return this\")() || (1,eval)(\"this\");\r\n} catch(e) {\r\n\t// This works if the window reference is available\r\n\tif(typeof window === \"object\")\r\n\t\tg = window;\r\n}\r\n\r\n// g can still be undefined, but nothing to do about it...\r\n// We return undefined, instead of nothing here, so it's\r\n// easier to handle this case. if(!global) { ...}\r\n\r\nmodule.exports = g;\r\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// (webpack)/buildin/global.js\n// module id = 6\n// module chunks = 0","'use strict'\n\nconst Config = require('./config')\nconst util = require('./util')\nconst uri = require('./uri')\nconst doc = require('./doc')\n\nmodule.exports = {\n  initStorage,\n  enableStorage,\n  disableStorage,\n  updateStorageDocument,\n  enableAutoSave,\n  disableAutoSave,\n  removeStorageItem,\n  removeStorageProfile,\n  getStorageProfile,\n  updateStorageProfile,\n  showStorage,\n  hideStorage\n}\n\n\nfunction initStorage(key) {\n  if (typeof window.localStorage != 'undefined') {\n    enableStorage(key);\n  }\n}\n\nfunction enableStorage(key) {\n  Config.UseStorage = true;\n  var o = localStorage.getItem(key);\n  try {\n    JSON.parse(o).object.Document;\n    document.documentElement.innerHTML = JSON.parse(o).object.content;\n    DO.U.init();\n  } catch(e){}\n  console.log(util.getDateTimeISO() + ': ' + key + ' storage enabled.');\n  enableAutoSave(key);\n}\n\nfunction disableStorage(key) {\n  Config.UseStorage = false;\n  localStorage.removeItem(key);\n  disableAutoSave(key);\n  console.log(util.getDateTimeISO() + ': ' + key + ' storage disabled.');\n}\n\nfunction updateStorageDocument(key) {\n  var content = doc.getDocument();\n\n  var id = DO.U.generateUUID();\n  var o = localStorage.getItem(key);\n\n  var datetime = util.getDateTimeISO();\n\n  var object = {\n    \"@context\": \"https://www.w3.org/ns/activitystreams\",\n    \"id\": id,\n    \"type\": \"Update\",\n    \"object\": {\n      \"id\": key,\n      \"type\": \"Document\",\n      \"updated\": datetime,\n      \"mediaType\": \"text/html\",\n      \"content\": content\n    }\n  };\n\n  localStorage.setItem(key, JSON.stringify(object));\n  console.log(datetime + ': Document saved.');\n}\n\nfunction enableAutoSave(key) {\n  Config.AutoSaveId = setInterval(function() { updateStorageDocument(key) }, Config.AutoSaveTimer);\n  console.log(util.getDateTimeISO() + ': ' + key + ' autosave enabled.');\n}\n\nfunction disableAutoSave(key) {\n  clearInterval(Config.AutoSaveId);\n  Config.AutoSaveId = '';\n  console.log(util.getDateTimeISO() + ': ' + key + ' autosave disabled.');\n}\n\nfunction removeStorageItem(key) {\n  if (!key) { Promise.resolve(); }\n\n  console.log(util.getDateTimeISO() + ': ' + key + ' removed.')\n\n  if (Config.WebExtension) {\n    var browser = (typeof browser !== 'undefined') ? browser : chrome;\n\n    return browser.storage.sync.remove(key);\n  }\n  else if (window.localStorage) {\n    return Promise.resolve(localStorage.removeItem(key));\n  }\n  else {\n    return Promise.reject({'message': 'storage is unavailable'})\n  }\n}\n\nfunction removeStorageProfile(key) {\n  key = key || 'DO.C.User';\n\n  return removeStorageItem(key)\n}\n\nfunction getStorageProfile(key) {\n  key = key || 'DO.C.User'\n\n  if (Config.WebExtension) {\n    if (typeof browser !== 'undefined') {\n      return browser.storage.sync.get(key).then(function(o){ return o[key]; });\n    }\n    else {\n      var value = {};\n\n      chrome.storage.sync.get(key, function(o){ value = o[key]; })\n\n      return new Promise(function(resolve, reject){\n        window.setTimeout(function() {\n          return resolve(value)\n        }, 50);\n      });\n    }\n  }\n  else if (window.localStorage) {\n    var o = localStorage.getItem(key);\n    return Promise.resolve(JSON.parse(o));\n  }\n  else {\n    return Promise.reject({'message': 'storage is unavailable'})\n  }\n}\n\nfunction updateStorageProfile(User) {\n  if (!User.IRI) { return Promise.resolve({'message': 'User.IRI is not set'}); }\n\n  var key = 'DO.C.User'\n\n  var id = DO.U.generateUUID();\n  var datetime = util.getDateTimeISO();\n\n  //because.. cyclic\n  if (User.Graph) {\n    delete User.Graph\n  }\n\n  if (User.Contacts) {\n    User.Contacts = {}\n  }\n\n  var object = {\n    \"@context\": \"https://www.w3.org/ns/activitystreams\",\n    \"id\": id,\n    \"type\": \"Update\",\n    \"object\": {\n      \"id\": key,\n      \"type\": \"Profile\",\n      \"describes\": User\n    },\n    \"datetime\": datetime,\n    \"actor\": User.IRI\n  };\n\n  if (Config.WebExtension) {\n    if (typeof browser !== 'undefined') {\n      return browser.storage.sync.set({[key]: object});\n    }\n    else {\n      return Promise.resolve(chrome.storage.sync.set({[key]: object}));\n    }\n  }\n  else if (window.localStorage) {\n    console.log(datetime + ': User ' + User.IRI + ' saved.');\n    return Promise.resolve(localStorage.setItem(key, JSON.stringify(object)));\n  }\n  else {\n    return Promise.reject({'message': 'storage is unavailable'})\n  }\n}\n\nfunction showStorage(node) {\n  if (window.localStorage) {\n    if(document.querySelector('#local-storage')) { return; }\n\n    var useStorage, checked;\n\n    if (Config.UseStorage) {\n      // if (Config.AutoSaveId) {\n      //   checked = ' checked=\"checked\"';\n      // }\n      // useStorage = Config.DisableStorageButtons + '<input id=\"local-storage-html-autosave\" class=\"autosave\" type=\"checkbox\"' + checked +' /> <label for=\"local-storage-html-autosave\"><i class=\"fa fa-clock-o\"></i> 1m autosave</label>';\n      useStorage = Config.DisableStorageButtons;\n\n    }\n    else {\n      useStorage = Config.EnableStorageButtons;\n    }\n\n    node.insertAdjacentHTML('beforeend', '<section id=\"local-storage\" class=\"do\"><h2>Local Storage</h2><ul><li>' + useStorage + '</li></ul></section>');\n\n    var key = uri.stripFragmentFromString(document.location.href);\n\n    document.getElementById('local-storage').addEventListener('click', function(e) {\n      if (e.target.closest('button.local-storage-enable-html')) {\n        e.target.outerHTML = Config.DisableStorageButtons;\n        enableStorage(key);\n      }\n\n      if (e.target.closest('button.local-storage-disable-html')) {\n        e.target.outerHTML = Config.EnableStorageButtons;\n        disableStorage(key);\n      }\n\n      // if (e.target.closest('input.autosave')) {\n      //   if (e.target.getAttribute('checked')) {\n      //     e.target.removeAttribute('checked');\n      //     disableAutoSave(key);\n      //   }\n      //   else {\n      //     e.target.setAttribute('checked', 'checked');\n      //     enableAutoSave(key);\n      //   }\n      // }\n    });\n  }\n}\n\nfunction hideStorage() {\n  if (Config.UseStorage) {\n    var ls = document.getElementById('local-storage');\n    ls.parentNode.removeChild(ls);\n  }\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/storage.js\n// module id = 7\n// module chunks = 0","/** dokieli\n *\n * Sarven Capadisli <info@csarven.ca> http://csarven.ca/#i\n * http://www.apache.org/licenses/LICENSE-2.0.html Apache License, Version 2.0\n * https://dokie.li/\n * https://github.com/linkeddata/dokieli\n */\n\nconst fetcher = require('./fetcher')\nconst doc = require('./doc')\nconst uri = require('./uri')\nconst graph = require('./graph')\nconst inbox = require('./inbox')\nconst util = require('./util')\nconst storage = require('./storage')\nglobal.auth = require('./auth')\n\nif(typeof DO === 'undefined'){\nglobal.SimpleRDF = (typeof ld !== 'undefined') ? ld.SimpleRDF : undefined;\nvar DO = {\n  fetcher,\n\n  C: require('./config'),\n\n  U: {\n    getResourceLabel: function(s) {\n      return s.dctermstitle || s['http://purl.org/dc/elements/1.1/title'] || auth.getAgentName(s) || undefined;\n    },\n\n\n    getItemsList: function(url, options) {\n      url = url || window.location.origin + window.location.pathname;\n      options = options || {};\n\n      DO.C['CollectionItems'] = ('CollectionItems' in DO.C && DO.C.CollectionItems.length > 0) ? DO.C.CollectionItems : [];\n      DO.C['CollectionPages'] = ('CollectionPages' in DO.C && DO.C.CollectionPages.length > 0) ? DO.C.CollectionPages : [];\n\n      var pIRI = uri.getProxyableIRI(url);\n\n      return fetcher.getResourceGraph(pIRI)\n        .then(\n          function(i) {\n            var s = i.child(url);\n\n            //XXX: First item is actually the Collection\n            DO.C.CollectionPages.push(url);\n\n            // s.ldpcontains.forEach(function(resource) {\n            //   var types = s.child(resource).rdftype;\n            //   if(types.indexOf(DO.C.Vocab['ldpContainer'][\"@id\"]) < 0 && types.indexOf(DO.C.Vocab['asCollection'][\"@id\"]) < 0) {\n            //     DO.C.CollectionItems.push(resource);\n            //   }\n            // });\n            // s.asitems.forEach(function(resource) {\n            //   var types = s.child(resource).rdftype;\n            //   if(types.indexOf(DO.C.Vocab['ldpContainer'][\"@id\"]) < 0 && types.indexOf(DO.C.Vocab['asCollection'][\"@id\"]) < 0) {\n            //     DO.C.CollectionItems.push(resource);\n            //   }\n            // });\n            // s.asorderedItems.forEach(function(resource) {\n            //   var types = s.child(resource).rdftype;\n            //   if(types.indexOf(DO.C.Vocab['ldpContainer'][\"@id\"]) < 0 && types.indexOf(DO.C.Vocab['asCollection'][\"@id\"]) < 0) {\n            //     DO.C.CollectionItems.push(resource);\n            //   }\n            // });\n\n            var items = [s.asitems, s.asorderedItems, s.ldpcontains];\n            Object.keys(items).forEach(function(i) {\n              items[i].forEach(function(resource){\n                var types = s.child(resource).rdftype;\n                if(types.indexOf(DO.C.Vocab['ldpContainer'][\"@id\"]) < 0 &&\n                   types.indexOf(DO.C.Vocab['asCollection'][\"@id\"]) < 0 &&\n                   types.indexOf(DO.C.Vocab['asOrderedCollection'][\"@id\"]) < 0) {\n                  DO.C.CollectionItems.push(resource);\n                }                \n              });\n            });\n\n            if (s.asfirst && DO.C.CollectionPages.indexOf(s.asfirst) < 0) {\n              return DO.U.getItemsList(s.asfirst, options);\n            }\n            else if (s.asnext && DO.C.CollectionPages.indexOf(s.asnext) < 0) {\n              return DO.U.getItemsList(s.asnext, options);\n            }\n            else {\n              return util.uniqueArray(DO.C.CollectionItems);\n            }\n          },\n          function(reason) {\n            console.log(reason);\n            return reason;\n          }\n        );\n    },\n\n\n    getNotifications: function(url) {\n      url = url || window.location.origin + window.location.pathname;\n      var notifications = [];\n      var pIRI = uri.getProxyableIRI(url);\n\n      return graph.getGraph(pIRI)\n        .then(\n          function(i) {\n            var s = i.child(url);\n            s.ldpcontains.forEach(function(resource) {\n// console.log(resource);\n              var types = s.child(resource).rdftype;\n// console.log(types);\n              if(types.indexOf(DO.C.Vocab['ldpContainer'][\"@id\"]) < 0) {\n                notifications.push(resource);\n              }\n            });\n// console.log(notifications);\n            if (notifications.length > 0) {\n              return notifications;\n            }\n            else {\n              var reason = {\"message\": \"There are no notifications.\"};\n              return Promise.reject(reason);\n            }\n          },\n          function(reason) {\n            console.log(reason);\n            return reason;\n          }\n        );\n    },\n\n    showInboxNotifications: function() {\n      if (typeof SimpleRDF !== 'undefined') {\n        inbox.getEndpoint(DO.C.Vocab['ldpinbox']['@id']).then(\n          function(i) {\n            i.forEach(function(inboxURL) {\n              DO.U.showNotificationSources(inboxURL);\n            });\n          },\n          function(reason) {\n// console.log(reason);\n          }\n        );\n      }\n    },\n\n    showNotificationSources: function(url) {\n      DO.U.getNotifications(url).then(\n        function(i) {\n          i.forEach(function(notification) {\n            var pIRI = uri.getProxyableIRI(notification);\n            DO.U.showActivities(pIRI);\n          });\n        },\n        function(reason) {\n          console.log('No notifications');\n          return reason;\n        }\n      );\n    },\n\n    showContactsActivities: function(e) {\n      var showProgress = function(e){\n        var rA = e.target.closest('.resource-activities')\n        var i = rA.querySelector('.fa-bolt')\n        rA.disabled = true;\n\n        if (i) {\n          i.classList.add('fa-circle-o-notch', 'fa-spin')\n          i.classList.remove('fa-bolt')\n        }\n      }\n\n      var removeProgress = function(e) {\n        var rA = e.target.closest('.resource-activities')\n        var i = rA.querySelector('.fa-spin')\n\n        if (i) {\n          i.classList.add('fa-circle-o')\n          i.classList.remove('fa-circle-o-notch', 'fa-spin')\n        }\n      }\n\n      if (e) {\n        showProgress(e)\n      }\n\n      var promises = []\n\n      if (DO.C.User.Outbox && DO.C.User.Outbox.length > 0) {\n        DO.U.showOutboxSources(DO.C.User.Outbox[0])\n      }\n\n      if (DO.C.User.Contacts && Object.keys(DO.C.User.Contacts).length > 0){\n        Object.keys(DO.C.User.Contacts).forEach(function(iri){\n          var o = DO.C.User.Contacts[iri].Outbox\n\n          if (o) {\n            var sOS = function(outbox) {\n              return DO.U.showOutboxSources(outbox)\n                .catch(() => {\n                  return Promise.resolve()\n                })\n            }\n\n            promises.push(sOS(o[0]))\n          }\n        })\n\n        return Promise.all(promises)\n          .then(r => {\n            removeProgress(e)\n          });\n      }\n      else {\n        return DO.U.updateContactsInfo(DO.C.User.IRI, { 'showOutboxSources': true })\n          .then(() => {\n            removeProgress(e)\n          })\n          .catch(() => {\n            removeProgress(e)\n          });\n      }\n    },\n\n    showOutboxSources: function(url) {\n      return DO.U.getOutboxActivities(url).then(\n        function(items) {\n          var promises = [];\n\n          for (var i = 0; i < items.length && i < DO.C.CollectionItemsLimit; i++) {\n            var pI = function(iri) {\n              return DO.U.showActivities(iri)\n                .catch(() => {\n                  return Promise.resolve()\n                })\n            }\n\n            promises.push(pI(items[i]));\n          }\n\n          return Promise.all(promises);\n        },\n        function(reason) {\n          console.log('No activities');\n          return reason;\n        }\n      );\n    },\n\n    getOutboxActivities: function(url) {\n      url = url || window.location.origin + window.location.pathname;\n      var pIRI = uri.getProxyableIRI(url);\n      var headers = { 'Accept': 'application/ld+json; profile=\"https://www.w3.org/ns/activitystreams\"'}\n\n      return fetcher.getResourceGraph(pIRI, headers)\n        .then(\n          function(i) {\n// console.log(i)\n            var s = i.child(url);\n            var items = Object.assign([], s.asitems._array);\n            items = Object.assign(items, s.asorderedItems._array);\n            items = util.uniqueArray(items);\n\n            if (items.length > 0) {\n              return items;\n            }\n            else {\n              var reason = {\"message\": \"There are no activities.\"};\n              return Promise.reject(reason);\n            }\n          },\n          function(reason) {\n            console.log(reason);\n            return reason;\n          }\n        );\n    },\n\n    showActivities: function(url) {\n      return graph.getGraph(url).then(\n        function(g) {\n// console.log(g);\n          var subjects = [];\n          g.graph().toArray().forEach(function(t){\n            subjects.push(t.subject.nominalValue);\n          });\n          subjects = util.uniqueArray(subjects);\n// console.log(subjects);\n          subjects.forEach(function(i){\n            var s = g.child(i)\n            var types = s.rdftype._array || [];\n\n            var currentPathURL = window.location.origin + window.location.pathname;\n\n            if (types.length > 0) {\n              var resourceTypes = types;\n              if(resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Like') > -1 ||\n                 resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Dislike') > -1){\n                if(s.asobject && s.asobject.at(0)) {\n                  if(s.ascontext && s.ascontext.at(0)){\n                    if(DO.U.getPathURL(s.asobject.at(0)) == currentPathURL) {\n                      var context = s.ascontext.at(0);\n                      return DO.U.positionInteraction(context).then(\n                        function(iri){\n                          return iri;\n                        },\n                        function(reason){\n                          console.log(context + ': Context is unreachable');\n                        });\n                    }\n                  }\n                  else {\n                    var iri = s.iri().toString();\n                    var targetIRI = s.asobject.at(0);\n                    var motivatedBy = 'oa:assessing';\n                    var id = String(Math.abs(DO.U.hashCode(iri)));\n                    var refId = 'r-' + id;\n                    var refLabel = id;\n\n                    var bodyText = (resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Like') > -1) ? 'Liked' : 'Disliked';\n\n                    var noteData = {\n                      \"type\": 'article',\n                      \"mode\": \"read\",\n                      \"motivatedByIRI\": motivatedBy,\n                      \"id\": id,\n                      \"refId\": refId,\n                      \"refLabel\": refLabel,\n                      // \"iri\": iri,\n                      \"creator\": {},\n                      \"target\": {\n                        \"iri\": targetIRI\n                      },\n                      \"body\": bodyText,\n                      \"license\": {}\n                    };\n\n                    if (s.asactor){\n                      noteData['creator'] = {\n                        'iri': s.asactor\n                      }\n                      var a = g.child(noteData['creator']['iri']);\n                      var actorName = auth.getAgentName(a);\n                      var actorImage = auth.getAgentImage(a);\n\n                      if(typeof actorName != 'undefined') {\n                        noteData['creator']['name'] = actorName;\n                      }\n                      if(typeof actorImage != 'undefined') {\n                        noteData['creator']['image'] = actorImage;\n                      }\n                    }\n                    else if(type == 'https://www.w3.org/ns/activitystreams#Dislike'){\n                      noteData['creator'] = {\n                        'name': 'Anonymous Coward'\n                      }\n                    }\n                    if (s.asupdated){\n                      noteData['datetime'] = s.asupdated;\n                    }\n                    if (s.schemalicense){\n                      noteData.license[\"iri\"] = s.schemalicense;\n                      noteData.license[\"name\"] = DO.C.License[noteData.license[\"iri\"]].name;\n                    }\n\n                    DO.U.addInteraction(noteData);\n                  }\n                }\n              }\n              else if(resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Relationship') > -1){\n                if(s.assubject && s.assubject.at(0) && s.asrelationship && s.asrelationship.at(0) && s.asobject && s.asobject.at(0) && DO.U.getPathURL(s.asobject.at(0)) == currentPathURL) {\n                  var subject = s.assubject.at(0);\n                  return DO.U.positionInteraction(subject).then(\n                    function(iri){\n                      return iri;\n                    },\n                    function(reason){\n                      console.log(subject + ': subject is unreachable');\n                    });\n                }\n              }\n              else if(resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Announce') > -1 || resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Create') > -1) {\n                if(s.asobject && s.asobject.at(0) && s.astarget && s.astarget.at(0) && DO.U.getPathURL(s.astarget.at(0)) == currentPathURL) {\n                  var object = s.asobject.at(0);\n\n                  if (object.startsWith(url)) {\n                    return DO.U.showAnnotation(object, s);\n                  }\n                  else {\n                    return DO.U.positionInteraction(object).then(\n                      function(iri){\n                        return iri;\n                      },\n                      function(reason){\n                        console.log(object + ': object is unreachable');\n                      });\n                  }\n                }\n              }\n              else if(resourceTypes.indexOf('https://www.w3.org/ns/activitystreams#Add') > -1) {\n                if(s.asobject && s.asobject.at(0)) {\n                  var object = s.asobject.at(0);\n\n                  if (object.startsWith(url)) {\n                    return DO.U.showAnnotation(object, s);\n                  }\n                  else {\n                    return DO.U.positionInteraction(object).then(\n                      function(iri){\n                        return iri;\n                      },\n                      function(reason){\n                        console.log(object + ': object is unreachable');\n                      });\n                  }\n                }\n              }\n              else {\n                // console.log(i + ' has unrecognised types: ' + resourceTypes);\n                // return Promise.reject({'message': 'Unrecognised types ' + resourceTypes});\n              }\n            }\n            else {\n              // console.log('Skipping ' + i + ': No type.');\n              // return Promise.reject({'message': 'Activity has no type. What to do?'});\n            }\n          });\n        },\n        function(reason) {\n          console.log(url + ': is unreachable. ' + reason);\n          return reason;\n        }\n      );\n    },\n\n    //Borrowed the d3 parts from https://bl.ocks.org/mbostock/4600693\n    showVisualisationGraph: function(url, data, selector, options) {\n      url = url || window.location.origin + window.location.pathname;\n      data = data || doc.getDocument();\n      selector = selector || 'body';\n      options = options || {};\n      options['contentType'] = options.contentType || 'text/html';\n      options['subjectURI'] = options.subjectURI || url;\n      options['license'] = options.license || 'https://creativecommons.org/licenses/by/4.0/';\n      var width = options.width || '100%';\n      var height = options.height || '100%';\n\n      var id = DO.U.generateAttributeId();\n\n\n      function positionLink(d) {\n        return \"M\" + d[0].x + \",\" + d[0].y\n             + \"S\" + d[1].x + \",\" + d[1].y\n             + \" \" + d[2].x + \",\" + d[2].y;\n      }\n\n      function positionNode(d) {\n        return \"translate(\" + d.x + \",\" + d.y + \")\";\n      }\n\n      function dragstarted(d) {\n        if (!d3.event.active) simulation.alphaTarget(0.3).restart();\n        d.fx = d.x, d.fy = d.y;\n      }\n\n      function dragged(d) {\n        d.fx = d3.event.x, d.fy = d3.event.y;\n      }\n\n      function dragended(d) {\n        if (!d3.event.active) simulation.alphaTarget(0);\n        d.fx = null, d.fy = null;\n      }\n\n      var svg = d3.select(selector).append('svg')\n        .attr('width', width)\n        .attr('height', height)\n        .attr('id', id)\n        .attr('class', 'graph')\n        .attr('xmlns', 'http://www.w3.org/2000/svg')\n        .attr('version', '1.1')\n        .attr('xml:lang', 'en')\n        .attr('prefix', 'rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns# rdfs: http://www.w3.org/2000/01/rdf-schema# xsd: http://www.w3.org/2001/XMLSchema# schema: http://schema.org/');\n\n      var s = document.getElementById(id);\n      width = options.width || parseInt(s.ownerDocument.defaultView.getComputedStyle(s, null)[\"width\"]);\n      height = options.height || parseInt(s.ownerDocument.defaultView.getComputedStyle(s, null)[\"height\"]);\n\n      svg.append('metadata')\n        .append('tspan')\n          .attr('rel', 'schema:creator')\n          .attr('resource', 'https://dokie.li/');\n\n      if('license' in options) {\n        svg.select('metadata')\n          .append('tspan')\n            .attr('rel', 'schema:license')\n            .attr('resource', options.license);\n      }\n\n      if('title' in options) {\n        svg.append('title')\n          .attr('property', 'schema:name')\n          .text(options.title);\n      }\n\n      svg.append('style').text('.node { stroke: #fff; stroke-width: 1px; } .link { fill: none; stroke: #bbb; }');\n\n      var color = d3.scaleOrdinal(d3.schemeCategory20);\n\n      var simulation = d3.forceSimulation()\n          .force(\"link\", d3.forceLink().distance(10).strength(0.25))\n          .force('collide', d3.forceCollide().radius(5).strength(0.25))\n          // .force(\"charge\", d3.forceManyBody())\n          // .force(\"center\", d3.forceCenter());\n          .force(\"center\", d3.forceCenter(width / 2, height / 2));\n\n      DO.U.getVisualisationGraphData(url, data, options).then(\n        function(graph){\n// console.log(graph);\n          var nodes = graph.nodes,\n              nodeById = d3.map(nodes, function(d) { return d.id; }),\n              links = graph.links,\n              bilinks = [];\n\n          links.forEach(function(link) {\n            var s = link.source = nodeById.get(link.source),\n                t = link.target = nodeById.get(link.target),\n                i = {}; // intermediate node\n            nodes.push(i);\n            links.push({source: s, target: i}, {source: i, target: t});\n            bilinks.push([s, i, t]);\n          });\n\n          var link = svg.selectAll(\".link\")\n            .data(bilinks)\n            .enter().append(\"path\")\n              .attr(\"class\", \"link\");\n\n          var node = svg.selectAll(\".node\")\n            .data(nodes.filter(function(d) { return d.id; }))\n            .enter().append(\"circle\")\n              .attr(\"class\", \"node\")\n              .attr(\"r\", 5)\n              .attr(\"fill\", function(d) { return color(d.group); })\n              .call(d3.drag()\n                  .on(\"start\", dragstarted)\n                  .on(\"drag\", dragged)\n                  .on(\"end\", dragended));\n\n          node.append(\"title\")\n              .text(function(d) { return d.id; });\n\n          simulation\n              .nodes(nodes)\n              .on(\"tick\", ticked);\n\n          simulation.force(\"link\")\n              .links(links);\n\n          function ticked() {\n            link.attr(\"d\", positionLink);\n            node.attr(\"transform\", positionNode);\n          }\n        });\n    },\n\n    getVisualisationGraphData: function(url, data, options) {\n      return new Promise(function(resolve, reject) {\n        graph.getGraphFromData(data, options).then(\n          function(g){\n// console.log(g);\n            var g = SimpleRDF(DO.C.Vocab, options['subjectURI'], g, ld.store).child(url);\n            var graph = {\"nodes\":[], \"links\": []};\n            var graphNodes = [];\n\n            g.graph().toArray().forEach(function(t){\n              var group = 1;\n              switch(t.predicate.nominalValue){\n                default:\n                  group = 1;\n                  break;\n                // case DO.C.Vocab['rdftype']['@id']:\n                //   group = 2;\n                //   break;\n              }\n\n              if(graphNodes.indexOf(t.subject.nominalValue + ' ' + group) == -1) {\n                graphNodes.push(t.subject.nominalValue + ' ' + group);\n                graph.nodes.push({\"id\": t.subject.nominalValue, \"group\": group});\n              }\n              if(graphNodes.indexOf(t.object.nominalValue + ' ' + group) == -1) {\n                graphNodes.push(t.object.nominalValue + ' ' + group);\n                graph.nodes.push({\"id\": t.object.nominalValue, \"group\": group});\n              }\n\n              graph.links.push({\"source\": t.subject.nominalValue, \"target\": t.object.nominalValue, \"value\": t.predicate.nominalValue});\n            });\n\n            delete graphNodes;\n            return resolve(graph);\n          }\n        );\n      });\n    },\n\n    showGraph: function(resources, selector, options){\n      if (!DO.C.GraphViewerAvailable) { return; }\n\n      options = options || {};\n      options['contentType'] = options.contentType || 'text/html';\n      options['subjectURI'] = location.href.split(location.search||location.hash||/[?#]/)[0];\n\n      if (Array.isArray(resources)) {\n        DO.U.showGraphResources(resources, selector, options);\n      }\n      else {\n        var property = (resources && 'filter' in options && 'predicates' in options.filter && options.filter.predicates.length > 0) ? options.filter.predicates[0] : DO.C.Vocab['ldpinbox']['@id'];\n        var iri = (resources) ? resources : location.href.split(location.search||location.hash||/[?#]/)[0];\n\n        inbox.getEndpoint(property, iri).then(\n          function(resources) {\n            DO.U.showGraphResources(resources[0], selector, options);\n          },\n          function(reason) {\n            console.log(reason);\n          }\n        );\n      }\n    },\n\n    showGraphResources: function(resources, selector, options) {\n      selector = selector || document.body;\n      options = options || {};\n\n      var processResources = function(resources, options) {\n        if (Array.isArray(resources)) {\n          return Promise.resolve(resources);\n        }\n        else {\n          return DO.U.getItemsList(resources, options);\n        }\n      }\n\n      processResources(resources, options).then(\n        function(url) {\n          var promises = [];\n          url.forEach(function(u) {\n            // console.log(u);\n            // window.setTimeout(function () {\n              var pIRI = uri.getProxyableIRI(u);\n              promises.push(fetcher.getResourceGraph(pIRI));\n            // }, 1000)\n          });\n\n          var dataGraph = SimpleRDF();\n\n          var filterPredicates = false;\n          if ('filter' in options && 'predicates' in options.filter && options.filter.predicates.length > 0) {\n            filterPredicates = true;\n          }\n\n          Promise.all(promises)\n            .then(function(graphs) {\n              graphs.forEach(function(graph){\n                graph = graph.graph();\n\n                dataGraph.graph().addAll(graph);\n              });\n\n              if (filterPredicates) {\n                dataGraph = dataGraph.graph().filter(function(g) {\n                  if (options.filter.predicates.indexOf(g.predicate.nominalValue) >= 0) {\n                    return g;\n                  }\n                });\n              }\n\n              graph.serializeGraph(dataGraph, { 'contentType': 'text/turtle' })\n                .then(function(data){\n                  options['contentType'] = 'text/turtle';\n                  // options['subjectURI'] = url;\n                  DO.U.showVisualisationGraph(options.subjectURI, data, selector, options);\n                });\n            });\n        });\n    },\n\n    urlParam: function(name) {\n      var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);\n      if (results===null){\n         return null;\n      }\n      else{\n         return results[1] || 0;\n      }\n    },\n\n    getTextQuoteSelectorFromLocation: function(location) {\n      var regexp = /#selector\\(type=TextQuoteSelector,(.*)\\)/;\n      matches = location.hash.match(regexp);\n\n      if (matches) {\n        var selectorsArray = matches[1].split(',')\n        var selector = {};\n\n        selectorsArray.forEach(function(s){\n          var kv = s.split('=');\n\n          if (kv.length == 2) {\n            switch(kv[0]) {\n              case 'prefix':\n                selector['prefix'] = decodeURIComponent(kv[1]);\n                break;\n              case 'exact':\n                selector['exact'] = decodeURIComponent(kv[1]);\n                break;\n              case 'suffix':\n                selector['suffix'] = decodeURIComponent(kv[1]);\n                break;\n            }\n          }\n\n        })\n\n        return selector;\n      }\n    },\n\n    showTextQuoteSelector: function(containerNode) {\n      var selector = DO.U.getTextQuoteSelectorFromLocation(document.location);\n      if (selector && selector.exact && selector.exact.length > 0) {\n        //XXX: TODO: Copied from showAnnotation\n\n        // refId = String(Math.abs(DO.U.hashCode(document.location.href)));\n        var refId = document.location.hash.substring(1);\n        var refLabel = DO.U.getReferenceLabel('oa:highlighting');\n\n        containerNode = containerNode || document.body;\n\n        var docRefType = '<sup class=\"ref-highlighting\">' + refLabel + '</sup>';\n\n        var options = {\n          'do': true,\n          'mode': '#selector'\n        };\n\n        DO.U.importTextQuoteSelector(containerNode, selector, refId, docRefType, options)\n      }\n    },\n\n    importTextQuoteSelector: function(containerNode, selector, refId, docRefType, options) {\n      var containerNodeTextContent = containerNode.textContent;\n      //XXX: Seems better?\n      // var containerNodeTextContent = DO.U.fragmentFromString(doc.getDocument(containerNode)).textContent.trim();\n\n\n// console.log(containerNodeTextContent);\n      options = options || {};\n\n// console.log(selector)\n      var prefix = selector.prefix || '';\n      var exact = selector.exact || '';\n      var suffix = selector.suffix || '';\n\n      var phrase = util.escapeRegExp(prefix.toString() + exact.toString() + suffix.toString());\n// console.log(phrase);\n\n      var selectedParentNode;\n\n      var textMatches = containerNodeTextContent.matchAll(new RegExp(phrase, 'g'));\n// console.log(textMatches)\n\n      textMatches.forEach(function(item) {\n// console.log('phrase:')\n// console.log(phrase)\n// console.log(item)\n        var selectorIndex = item.index;\n// console.log('selectorIndex:')\n// console.log(selectorIndex)\n      // var selectorIndex = containerNodeTextContent.indexOf(prefix + exact + suffix);\n// console.log(selectorIndex);\n      // if (selectorIndex >= 0) {\n        var exactStart = selectorIndex + prefix.length\n        var exactEnd = selectorIndex + prefix.length + exact.length;\n        var selection = { start: exactStart, end: exactEnd };\n// console.log('selection:')\n// console.log(selection)\n        var ref = DO.U.getTextQuoteHTML(refId, exact, docRefType, options);\n// console.log('containerNode:')\n// console.log(containerNode)\n        MediumEditor.selection.importSelection(selection, containerNode, document);\n\n        //XXX: Review\n        var selection = window.getSelection();\n// console.log(selection)\n        var r = selection.getRangeAt(0);\n        selection.removeAllRanges();\n        selection.addRange(r);\n        r.collapse(true);\n// console.log(r)\n// console.log('r.commonAncestorContainer:')\n// console.log(r.commonAncestorContainer)\n        selectedParentNode = r.commonAncestorContainer.parentNode;\n// console.log('selectedParentNode:')\n// console.log(selectedParentNode)\n        var selectedParentNodeValue = r.commonAncestorContainer.nodeValue;\n// console.log(selectedParentNodeValue)\n\n// console.log(selectedParentNodeValue.substr(0, r.startOffset) + ref + selectedParentNodeValue.substr(r.startOffset + exact.length))\n        var selectionUpdated = DO.U.fragmentFromString(selectedParentNodeValue.substr(0, r.startOffset) + ref + selectedParentNodeValue.substr(r.startOffset + exact.length));\n// console.log(selectionUpdated)\n\n        //XXX: Review. This feels a bit dirty\n        for(var i = 0; i < selectedParentNode.childNodes.length; i++) {\n          var n = selectedParentNode.childNodes[i];\n          if (n.nodeType === 3 && n.nodeValue === selectedParentNodeValue) {\n            selectedParentNode.replaceChild(selectionUpdated, n);\n          }\n        }\n// console.log('---')\n      })\n\n      return selectedParentNode;\n    },\n\n    initUser: function() {\n      storage.getStorageProfile().then(user => {\n        if (user && 'object' in user) {\n          DO.C['User'] = user.object.describes;\n        }\n      })\n    },\n\n    setDocumentMode: function(mode) {\n      var style = DO.U.urlParam('style');\n\n      if (style) {\n        var title = style.lastIndexOf('/');\n        title = (title > -1) ? style.substr(title + 1) : style; \n\n        if (style.startsWith('http')) {\n          var pIRI = uri.getProxyableIRI(style);\n          var link = '<link class=\"do\" href=\"' + pIRI + '\" media=\"all\" rel=\"stylesheet\" title=\"' + title + '\" />'\n          document.querySelector('head').insertAdjacentHTML('beforeend', link);\n        }\n\n        window.history.replaceState({}, null, document.location.href.substr(0, document.location.href.lastIndexOf('?')));\n        var stylesheets = document.querySelectorAll('head link[rel~=\"stylesheet\"][title]:not([href$=\"do.css\"])');\n        DO.U.updateSelectedStylesheets(stylesheets, title);\n      }\n\n      if (DO.C.EditorAvailable) {\n        if (DO.U.urlParam('author') == 'true' || DO.U.urlParam('social') == 'true' || DO.U.urlParam('review') == 'true') {\n          if (DO.U.urlParam('social') == 'true') {\n            mode = 'social';\n          }\n          else if (DO.U.urlParam('author') == 'true') {\n            mode = 'author';\n          }\n          else if (DO.U.urlParam('review') == 'true') {\n            mode = 'review';\n          }\n          var url = document.location.href;\n          window.history.replaceState({}, null, url.substr(0, url.lastIndexOf('?')));\n        }\n\n        if (mode !== 'author') {\n          var content = DO.U.selectArticleNode(document);\n          content = DO.U.fragmentFromString(doc.domToString(content)).textContent.trim();\n          if (content.length == 0) {\n            mode = 'author';\n          }\n        }\n\n        switch(mode || '') {\n          case 'social': default:\n            DO.U.Editor.enableEditor('social');\n            break;\n          case 'author':\n            DO.U.Editor.enableEditor('author');\n            break;\n          case 'review':\n            DO.U.Editor.enableEditor('review');\n            break;\n        }\n      }\n    },\n\n    initDocumentActions: function() {\n      document.addEventListener('click', function(e) {\n        if (e.target.closest('[about=\"#document-menu\"][typeof=\"schema:ActivateAction\"], [href=\"#document-menu\"][typeof=\"schema:ActivateAction\"], [resource=\"#document-menu\"][typeof=\"schema:ActivateAction\"]')) {\n          e.preventDefault();\n          e.stopPropagation();\n\n          if (document.body.classList.contains('on-document-menu')) {\n            DO.U.hideDocumentMenu(e);\n          }\n          else {\n            DO.U.showDocumentMenu(e);\n          }\n        }\n      });\n\n      var annotationRights = document.querySelectorAll('[about=\"#annotation-rights\"][typeof=\"schema:ChooseAction\"], [href=\"#annotation-rights\"][typeof=\"schema:ChooseAction\"], [resource=\"#annotation-rights\"][typeof=\"schema:ChooseAction\"]');\n      for (var i = 0; i < annotationRights.length; i++){\n        annotationRights[i].parentNode.replaceChild(DO.U.fragmentFromString('<select>' + DO.U.getLicenseOptionsHTML() + '</select>'), annotationRights[i]);\n      }\n    },\n\n    showDocumentInfo: function() {\n      document.documentElement.appendChild(DO.U.fragmentFromString('<menu id=\"document-menu\" class=\"do\"><button class=\"show\" title=\"Open Menu\"><i class=\"fa fa-bars\"></i></button><header></header><div></div><footer><dl><dt>About</dt><dd id=\"about-dokieli\"><img alt=\"\" height=\"16\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAAn1BMVEUAAAAAjwAAkAAAjwAAjwAAjwAAjwAAjwAAkAAAdwAAjwAAjQAAcAAAjwAAjwAAiQAAjwAAjAAAjwAAjwAAjwAAjwAAkAAAjwAAjwAAjwAAjQAAjQAAhQAAhQAAkAAAkAAAkAAAjgAAjwAAiQAAhAAAkAAAjwAAjwAAkAAAjwAAjgAAjgAAjQAAjwAAjQAAjwAAkAAAjwAAjQAAiwAAkABp3EJyAAAANHRSTlMA+fH89enaabMF4iADxJ4SiSa+uXztyoNvQDcsDgvl3pRiXBcH1M+ppJlWUUpFMq6OdjwbMc1+ZgAABAhJREFUeNrt29nSmkAQBeAGZBMUxH3f993/vP+zJZVKVZKCRhibyc3/XVt6SimYPjPSt28Vmt5W/fu2T/9B9HIf7Tp+0RsgDC6DY6OLvzxJj8341DnsakgZUNUmo2XsORYYS6rOeugukhnyragiq56JIs5UEQ/FXKgidRTzompEKOhG1biioDFV44mCAqrGAQWtqRptA8VMqCpR6zpo9iy84VO1opWHPBZVb9QAzyQN/D1YNungJ+DMSYsbOFvSIwGjR3p0wGiQHkMw2qRHC4w76RGBcSA9NmAcSY8QjAdpYiFbTJoYyNYnTWrI1iFNusj2JE1sZBuQJtyE5pImc3Y21cRhZ1NNtsh2Ik127HCsSY8djjVpINuVhPnjVefobee2adXqu2S/6FyivABDEjQ9Lxo1pDlNd5wg24ikRK5ngKGhHhg1DSgZk4RrD6pa9LlRAnUBfWp6xCe+6EOvOT6yrmrigZaCZHPAp6b0gaiBFKvRd0/D1rr1OrvxDqiyoZmmPt9onib0t/VybyEXqdu0Cw16rUNVAfZFlzdjr5KOaoAUK6JsrgWGQapuBlIS4gy70gEmTrk1fuAgU40UxWXv6wvZAC2Dqfx0BfBK1z1H0aJ0WH7Ub4oG8JDlpBCgK1l5tSjHQSoAf0HVfMqxF+yqpzVk2ZGuAGdk8ijPHZlmpOCg0vh5cgE2JtN3qQSoU3lXpbKlLRegrzTpt+U2TNpKY2YiFiA0kS1Q6QccweZ/oinASm2B3RML0AGDNAU4qq3udmIXYVttD3YrFsBR24N1xG5EJpTeaiYWwILS5WRKBfChFsCSehpOwKi/yS0V4AsMWym3TWUFgMqIsRYL8AVOSDlaYgEitbZnDKll+UatchyJBSC1c3lDuQA2VHYAL3KneHpgLCjHSS7AHYyEciwh1g88wDB94rlyAVxwhsR7ygW4gRMTry8XwDdUDkXFgjVdD5wRsRaCAWJwPGI1Baval8Ie3Hqn8AjjhHbZr2DzrInumDTBGlCG8xy8QPY3MNLX4TiRP1q+BWs2pn9ECwu5+qTABc+80h++28UbTkjlTW3wrM6Ufrtu8d5J9Svg1Vch/RTcUYQdUHm+g1z1x2gSGyjGGVN5F7xjoTCjE0ndC3jJMzfCftmiciZ1lNGe3vCGufOWVMLIQHHehi3X1O8JJxR236SalUzninbu937BlwfV/I3k4KdGk2xm+MHuLa8Z0i9TC280qLRrF+8cw9RSjrOg8oIG8j2YgULsbGPomsgR0x9nsOzkOLh+kZr1owZGbfC2JJl78fIV0Wei/gxZDl85XWVtt++cxhuSEQ6bdfzLjlvM86PbaD4vQUjSglV8385My7CdXtO9+ZSyrLcf7nBN376V8gMpRztyq6RXYQAAAABJRU5ErkJggg==\" width=\"16\" /><a href=\"https://dokie.li/\" target=\"_blank\">dokieli</a> is an <i class=\"fa fa-github\"></i> <a href=\"https://github.com/linkeddata/dokieli\" target=\"_blank\">open source</a> project. There is <i class=\"fa fa-flask\"></i> <a href=\"https://dokie.li/docs\" target=\"_blank\">documentation</a> and public <i class=\"fa fa-comments-o\"></i> <a href=\"https://gitter.im/linkeddata/dokieli\" target=\"_blank\">chat</a> available. Made with fun.</dd></dl></footer></menu>'));\n      document.querySelector('#document-menu').addEventListener('click', function(e) {\n        var button = e.target.closest('button');\n        if(button){\n          if (button.classList.contains('show')) {\n            DO.U.showDocumentMenu(e);\n          }\n          else if (button.classList.contains('hide')) {\n            DO.U.hideDocumentMenu(e);\n          }\n        }\n      });\n    },\n\n    showDocumentMenu: function showDocumentMenu (e) {\n      if (e) {\n        e.preventDefault();\n        e.stopPropagation();\n      }\n\n      var menu = document.querySelector('#document-menu');\n      if (menu && menu.classList && menu.classList.contains(\"on\")) {\n        DO.U.hideDocumentMenu();\n      }\n\n      DO.U.getResourceInfo().then(function(resourceInfo){\n        var body = document.body;\n        var dMenu = document.querySelector('#document-menu.do');\n\n        if(dMenu) {\n          var dMenuButton = dMenu.querySelector('button');\n          var dHead = dMenu.querySelector('header');\n          var dInfo = dMenu.querySelector('div');\n\n          dMenuButton.classList.remove('show');\n          dMenuButton.classList.add('hide');\n          dMenuButton.setAttribute('title', 'Hide Menu');\n          dMenuButton.innerHTML = '<i class=\"fa fa-minus\"></i>';\n          dMenu.classList.add('on');\n          body.classList.add('on-document-menu');\n\n          auth.showUserSigninSignout(dHead);\n          DO.U.showDocumentDo(dInfo);\n          DO.U.showEmbedData(dInfo);\n          storage.showStorage(dInfo);\n          DO.U.showViews(dInfo);\n          DO.U.showDocumentMetadata(dInfo);\n          if(!body.classList.contains('on-slideshow')) {\n            DO.U.showDocumentItems();\n          }\n\n          document.addEventListener('click', DO.U.eventLeaveDocumentMenu);\n        }\n        else {\n          DO.U.showDocumentInfo();\n          DO.U.showDocumentMenu();\n        }\n      });\n    },\n\n    hideDocumentMenu: function(e) {\n      document.removeEventListener('click', DO.U.eventLeaveDocumentMenu);\n\n      var body = document.body;\n      var dMenu = document.querySelector('#document-menu.do');\n      var dMenuButton = dMenu.querySelector('button');\n\n      dMenu.classList.remove('on');\n      var sections = dMenu.querySelectorAll('section');\n      for (var i = 0; i < sections.length; i++) {\n        if(sections[i].id != 'user-info' && !sections[i].querySelector('button.signin-user')) {\n          sections[i].parentNode.removeChild(sections[i]);\n        }\n      };\n      var buttonSigninUser = dMenu.querySelector('button.signin-user');\n      if(buttonSigninUser) {\n        dMenu.querySelector('button.signin-user').disabled = false;\n      }\n      body.classList.remove('on-document-menu');\n      dMenuButton.classList.remove('hide');\n      dMenuButton.classList.add('show');\n      dMenuButton.setAttribute('title', 'Open Menu');\n      dMenuButton.innerHTML = '<i class=\"fa fa-bars\"></i>';\n\n      var removeElementsList = ['document-items', 'embed-data-entry', 'create-new-document', 'open-document', 'source-view', 'save-as-document', 'user-identity-input', 'resource-browser', 'share-resource', 'reply-to-resource', 'memento-document', 'graph-view'];\n      removeElementsList.forEach(function(id) {\n        var element = document.getElementById(id);\n        if(element) {\n          element.parentNode.removeChild(element);\n        }\n      });\n    },\n\n    setPolyfill: function() {\n      if (!Element.prototype.matches) {\n        Element.prototype.matches = Element.prototype.msMatchesSelector;\n      }\n\n      if (!Element.prototype.closest) {\n        Element.prototype.closest = function (selector) {\n          var el = this;\n          while (el) {\n            if (el.matches(selector)) {\n              return el;\n            }\n            el = el.parentElement;\n          }\n        };\n      }\n\n\n      //From https://web.archive.org/web/20180407184826/http://cwestblog.com/2013/02/26/javascript-string-prototype-matchall/\n      if (!String.prototype.matchAll) {\n        String.prototype.matchAll = function(regexp) {\n          var matches = [];\n          this.replace(regexp, function() {\n            var arr = ([]).slice.call(arguments, 0);\n            var extras = arr.splice(-2);\n            arr.index = extras[0];\n            arr.input = extras[1];\n            matches.push(arr);\n          });\n          return matches.length ? matches : null;\n        };\n      }\n    },\n\n    showXHRProgressHTML: function(http, options) {\n      if ('progress' in options) {\n        http.upload.onprogress = function(e) {\n          if (e.lengthComputable) {\n            options.progress.value = (e.loaded / e.total) * 100;\n            options.progress.textContent = options.progress.value; // Fallback for unsupported browsers.\n          }\n        };\n      }\n    },\n\n    setDocRefType: function() {\n      var link = document.querySelector('head link[rel=\"stylesheet\"][title]');\n      if (link) {\n        DO.C.DocRefType = link.getAttribute('title');\n      }\n      if (Object.keys(DO.C.RefType).indexOf(DO.C.DocRefType) == -1) {\n        DO.C.DocRefType = 'LNCS';\n      }\n    },\n\n    getCurrentLinkStylesheet: function() {\n      return document.querySelector('head link[rel=\"stylesheet\"][title]:not([href$=\"do.css\"]):not([disabled])');\n    },\n\n    showViews: function(node) {\n      if(document.querySelector('#document-views')) { return; }\n\n      var stylesheets = document.querySelectorAll('head link[rel~=\"stylesheet\"][title]:not([href$=\"do.css\"])');\n\n      var s = '<section id=\"document-views\" class=\"do\"><h2>Views</h2><i class=\"fa fa-magic\"></i><ul>';\n      if (DO.C.GraphViewerAvailable) {\n        s += '<li><button class=\"resource-visualise\" title=\"Change to graph view\">Graph</button></li>';\n      }\n      s += '<li><button title=\"Change to native device/browser view\">Native</button></li>';\n\n      if (stylesheets.length > 0) {\n        for (var i = 0; i < stylesheets.length; i++) {\n          var stylesheet = stylesheets[i];\n          var view = stylesheet.getAttribute('title');\n          if(stylesheet.closest('[rel~=\"alternate\"]')) {\n            s += '<li><button title=\"Change to ‘' + view + '’ view\">' + view + '</button></li>';\n          }\n          else {\n            s += '<li><button disabled=\"disabled\">' + view + '</button></li>';\n          }\n        }\n      }\n\n      s += '</ul></section>';\n      node.insertAdjacentHTML('beforeend', s);\n\n      var viewButtons = document.querySelectorAll('#document-views.do button:not([class~=\"resource-visualise\"])');\n      for (var i = 0; i < viewButtons.length; i++) {\n        viewButtons[i].removeEventListener('click', DO.U.initCurrentStylesheet);\n        viewButtons[i].addEventListener('click', DO.U.initCurrentStylesheet);\n      }\n\n      if(DO.C.GraphViewerAvailable) {\n        document.querySelector('#document-views.do').addEventListener('click', function(e){\n          if (e.target.closest('.resource-visualise')) {\n            if(document.querySelector('#graph-view')) { return; }\n\n            if (e) {\n              e.target.disabled = true;\n            }\n\n            document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"graph-view\" class=\"do on\">' + DO.C.Button.Close + '<h2>Graph view</h2></aside>'));\n\n            var graphView = document.getElementById('graph-view');\n            graphView.addEventListener('click', function(e) {\n              if (e.target.closest('button.close')) {\n                var rv = document.querySelector('#document-views .resource-visualise');\n                if (rv) {\n                  rv.disabled = false;\n                }\n              }\n            });\n\n            var optionsNormalisation = DO.C.DOMNormalisation;\n            delete optionsNormalisation['skipNodeWithClass'];\n\n            DO.U.showVisualisationGraph(document.location.href, doc.getDocument(null, optionsNormalisation), '#graph-view');\n          }\n        });\n      }\n    },\n\n    updateSelectedStylesheets: function(stylesheets, selected) {\n      var selected = selected.toLowerCase();\n\n      for (var j = 0; j < stylesheets.length; j++) {\n        (function(stylesheet) {\n          if (stylesheet.getAttribute('title').toLowerCase() != selected) {\n              stylesheet.disabled = true;\n              stylesheet.setAttribute('rel', 'stylesheet alternate');\n          }\n        })(stylesheets[j]);\n      };\n      for (var j = 0; j < stylesheets.length; j++) {\n        (function(stylesheet) {\n          if (stylesheet.getAttribute('title').toLowerCase() == selected) {\n              stylesheet.setAttribute('rel', 'stylesheet');\n              stylesheet.disabled = false;\n          }\n        })(stylesheets[j]);\n      }\n    },\n\n    initCurrentStylesheet: function(e) {\n      var currentStylesheet = DO.U.getCurrentLinkStylesheet();\n      currentStylesheet = (currentStylesheet) ? currentStylesheet.getAttribute('title') : '';\n      var selected = (e && e.target) ? e.target.textContent.toLowerCase() : currentStylesheet.toLowerCase();\n      var stylesheets = document.querySelectorAll('head link[rel~=\"stylesheet\"][title]:not([href$=\"do.css\"])');\n\n      DO.U.updateSelectedStylesheets(stylesheets, selected);\n\n      var bd = document.querySelectorAll('#document-views.do button');\n      for(var j = 0; j < bd.length; j++) {\n        bd[j].disabled = (e && e.target && (e.target.textContent == bd[j].textContent)) ? true : false;\n      }\n\n      DO.U.showRefs();\n\n      if (selected == 'shower') {\n        var slides = document.querySelectorAll('.slide');\n        for(var j = 0; j < slides.length; j++) {\n          slides[j].classList.add('do');\n        }\n        document.body.classList.add('on-slideshow', 'list');\n        document.querySelector('head').insertAdjacentHTML('beforeend', '<meta name=\"viewport\" content=\"width=792, user-scalable=no\" />');\n\n\n        var body = document.body;\n        var dMenu = document.querySelector('#document-menu.do');\n\n        if(dMenu) {\n          var dMenuButton = dMenu.querySelector('button');\n          var dHead = dMenu.querySelector('header');\n          var dInfo = dMenu.querySelector('div');\n\n          dMenuButton.classList.remove('show');\n          dMenuButton.classList.add('hide');\n          dMenuButton.setAttribute('title', 'Open Menu');\n          dMenuButton.innerHTML = '<i class=\"fa fa-minus\"></i>';\n          dMenu.classList.remove('on');\n          body.classList.remove('on-document-menu');\n\n          var dMenuSections = dMenu.querySelectorAll('section');\n          for (var j = 0; j < dMenuSections.length; j++) {\n            dMenuSections[j].parentNode.removeChild(dMSections[j]);\n          }\n        }\n\n        var toc = document.getElementById('table-of-contents');\n        toc = (toc) ? toc.parentNode.removeChild(toc) : false;\n\n        storage.hideStorage();\n\n        shower.initRun();\n      }\n      if (currentStylesheet.toLowerCase() == 'shower') {\n        var slides = document.querySelectorAll('.slide');\n        for (var c = 0; c < slides.length; c++){\n          slides[c].classList.remove('do');\n        }\n        document.body.classList.remove('on-slideshow', 'list', 'full');\n        document.body.removeAttribute('style');\n        var mV = document.querySelector('head meta[name=\"viewport\"][content=\"width=792, user-scalable=no\"]');\n        mV = (mV) ? mV.parentNode.removeChild(mV) : false;\n\n        history.pushState(null, null, window.location.pathname);\n\n        shower.removeEvents();\n      }\n    },\n\n    showEmbedData: function(node) {\n      if(document.querySelector('#embed-data-in-html')) { return; }\n\n      node.insertAdjacentHTML('beforeend', '<section id=\"embed-data-in-html\" class=\"do\"><h2>Data</h2><ul><li><button class=\"embed-data-meta\" title=\"Embed structured data (Turtle, JSON-LD, TriG)\"><i class=\"fa fa-table fa-2x\"></i>Embed Data</button></li></ul></section>');\n\n      var eventEmbedData = function(e) {\n        e.target.setAttribute('disabled', 'disabled');\n        var scriptCurrent = document.querySelectorAll('head script[id^=\"meta-\"]');\n\n        var scriptType = {\n          'meta-turtle': {\n            scriptStart: '<script id=\"meta-turtle\" title=\"Turtle\" type=\"text/turtle\">',\n            cdataStart: DO.C.CDATAStart + '\\n',\n            cdataEnd: '\\n' + DO.C.CDATAEnd,\n            scriptEnd: '</script>'\n          },\n          'meta-json-ld': {\n            scriptStart: '<script id=\"meta-json-ld\" title=\"JSON-LD\" type=\"application/ld+json\">',\n            cdataStart: DO.C.CDATAStart + '\\n',\n            cdataEnd: '\\n' + DO.C.CDATAEnd,\n            scriptEnd: '</script>'\n          },\n          'meta-trig': {\n            scriptStart: '<script id=\"meta-trig\" title=\"TriG\" type=\"application/trig\">',\n            cdataStart: DO.C.CDATAStart + '\\n',\n            cdataEnd: '\\n' + DO.C.CDATAEnd,\n            scriptEnd: '</script>'\n          }\n        }\n\n        var scriptCurrentData = {};\n        if (scriptCurrent.length > 0) {\n          for(var i = 0; i < scriptCurrent.length; i++) {\n            var v = scriptCurrent[i];\n            var id = v.id;\n            scriptCurrentData[id] = v.innerHTML.split(/\\r\\n|\\r|\\n/);\n            scriptCurrentData[id].shift();\n            scriptCurrentData[id].pop();\n            scriptCurrentData[id] = {\n              'type': v.getAttribute('type') || '',\n              'title': v.getAttribute('title') || '',\n              'content' : scriptCurrentData[id].join('\\n')\n            };\n          }\n        }\n\n        var embedMenu = '<aside id=\"embed-data-entry\" class=\"do on tabs\">' + DO.C.Button.Close + '\\n\\\n        <h2>Embed Data</h2>\\n\\\n        <nav><ul><li class=\"selected\"><a href=\"#embed-data-turtle\">Turtle</a></li><li><a href=\"#embed-data-json-ld\">JSON-LD</a></li><li><a href=\"#embed-data-trig\">TriG</a></li></ul></nav>\\n\\\n        <div id=\"embed-data-turtle\" class=\"selected\"><textarea placeholder=\"Enter data in Turtle\" name=\"meta-turtle\" cols=\"80\" rows=\"24\">' + ((scriptCurrentData['meta-turtle']) ? scriptCurrentData['meta-turtle'].content : '') + '</textarea><button class=\"save\">Save</button></div>\\n\\\n        <div id=\"embed-data-json-ld\"><textarea placeholder=\"Enter data in JSON-LD\" name=\"meta-json-ld\" cols=\"80\" rows=\"24\">' + ((scriptCurrentData['meta-json-ld']) ? scriptCurrentData['meta-json-ld'].content : '') + '</textarea><button class=\"save\">Save</button></div>\\n\\\n        <div id=\"embed-data-trig\"><textarea placeholder=\"Enter data in TriG\" name=\"meta-trig\" cols=\"80\" rows=\"24\">' + ((scriptCurrentData['meta-trig']) ? scriptCurrentData['meta-trig'].content : '') + '</textarea><button class=\"save\">Save</button></div>\\n\\\n        </aside>';\n\n        document.documentElement.appendChild(DO.U.fragmentFromString(embedMenu));\n        document.querySelector('#embed-data-turtle textarea').focus();\n        var a = document.querySelectorAll('#embed-data-entry nav a');\n        for(var i = 0; i < a.length; i++) {\n          a[i].addEventListener('click', function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n\n            var li = e.target.parentNode;\n            if(!li.classList.contains('selected')) {\n              document.querySelector('#embed-data-entry nav li.selected').classList.remove('selected');\n              li.classList.add('selected');\n              document.querySelector('#embed-data-entry > div.selected').classList.remove('selected');\n              var d = document.querySelector('#embed-data-entry > div' + e.target.hash);\n              d.classList.add('selected');\n              d.querySelector('textarea').focus();\n            }\n          });\n        }\n\n        document.querySelector('#embed-data-entry button.close').addEventListener('click', function(e) {\n          document.querySelector('#embed-data-in-html .embed-data-meta').removeAttribute('disabled');\n        });\n\n        var buttonSave = document.querySelectorAll('#embed-data-entry button.save');\n        for (var i = 0; i < buttonSave.length; i++) {\n          buttonSave[i].addEventListener('click', function(e) {\n            var textarea = e.target.parentNode.querySelector('textarea');\n            var name = textarea.getAttribute('name');\n            var scriptEntry = textarea.value;\n            var script = document.getElementById(name);\n\n            if (scriptEntry.length > 0) {\n              //If there was a script already\n              if (script) {\n                var scriptContent = scriptType[name].cdataStart + scriptEntry + scriptType[name].cdataEnd;\n                script.innerHTML = scriptContent;\n              }\n              else {\n                var scriptContent = '  ' + scriptType[name].scriptStart + scriptType[name].cdataStart + scriptEntry + scriptType[name].cdataEnd + scriptType[name].scriptEnd;\n                document.querySelector('head').insertAdjacentHTML('beforeend', scriptContent);\n              }\n            }\n            else {\n              //Remove if no longer used\n              script.parentNode.removeChild(script);\n            }\n\n            var ede = document.getElementById('embed-data-entry');\n            ede.parentNode.removeChild(ede);\n            document.querySelector('#embed-data-in-html .embed-data-meta').removeAttribute('disabled');\n          });\n        };\n      };\n\n      var edih = document.querySelector('#embed-data-in-html button');\n      edih.removeEventListener('click', eventEmbedData);\n      edih.addEventListener('click', eventEmbedData);\n    },\n\n    htmlEntities: function(s) {\n      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n    },\n\n    showDocumentMetadata: function(node) {\n      if(document.querySelector('#document-metadata')) { return; }\n\n      var content = DO.U.selectArticleNode(document);\n      var count = DO.U.contentCount(content);\n      var authors = [], contributors = [], editors = [];\n\n      var data = doc.getDocument();\n      var subjectURI = window.location.origin + window.location.pathname;\n      var options = {'contentType': 'text/html', 'subjectURI': subjectURI };\n\n      graph.getGraphFromData(data, options).then(\n        function(i){\n          var g = SimpleRDF(DO.C.Vocab, options['subjectURI'], i, ld.store).child(options['subjectURI']);\n\n          if(g.schemaeditor._array.length > 0) {\n            g.schemaeditor.forEach(function(s){\n              var label = DO.U.getResourceLabel(g.child(s));\n              if(typeof label !== 'undefined'){\n                editors.push('<li>' + label + '</li>');\n              }\n            });\n            if(editors.length > 0){\n              editors = '<tr class=\"people\"><th>Editors</th><td><ul class=\"editors\">' + editors.join('') + '</ul></td></tr>';\n            }\n          }\n\n          if(g.schemaauthor._array.length > 0) {\n            g.schemaauthor.forEach(function(s){\n              var label = DO.U.getResourceLabel(g.child(s));\n              if(typeof label !== 'undefined'){\n                authors.push('<li>' + label + '</li>');\n              }\n            });\n            if(authors.length > 0){\n              authors = '<tr class=\"people\"><th>Authors</th><td><ul class=\"authors\">' + authors.join('') + '</ul></td></tr>';\n            }\n          }\n\n          if(g.schemacontributor._array.length > 0) {\n            g.schemacontributor.forEach(function(s){\n              var label = DO.U.getResourceLabel(g.child(s));\n              if(typeof label !== 'undefined'){\n                contributors.push('<li>' + label + '</li>');\n              }\n            });\n            if(contributors.length > 0){\n              contributors = '<tr class=\"people\"><th>Contributors</th><td><ul class=\"contributors\">' + contributors.join('') + '</ul></td></tr>';\n            }\n          }\n\n          return authors + contributors;\n        }).then(\n        function(people){\n          var s = '<section id=\"document-metadata\" class=\"do\"><table>\\n\\\n            <caption>Document Metadata</caption>\\n\\\n            <tbody>\\n\\\n              ' + people + '\\n\\\n              <tr><th>Reading time</th><td>' + count.readingTime + ' minutes</td></tr>\\n\\\n              <tr><th>Characters</th><td>' + count.chars + '</td></tr>\\n\\\n              <tr><th>Words</th><td>' + count.words + '</td></tr>\\n\\\n              <tr><th>Lines</th><td>' + count.lines + '</td></tr>\\n\\\n              <tr><th>A4 Pages</th><td>' + count.pages.A4 + '</td></tr>\\n\\\n              <tr><th>US Letter</th><td>' + count.pages.USLetter + '</td></tr>\\n\\\n              <tr><th>Bytes</th><td>' + count.bytes + '</td></tr>\\n\\\n            </tbody>\\n\\\n          </table></section>';\n\n          node.insertAdjacentHTML('beforeend', s);\n        });\n    },\n\n    contentCount: function contentCount (c) {\n      var content = DO.U.fragmentFromString(doc.domToString(c)).textContent.trim();\n      var contentCount = { readingTime:1, words:0, chars:0, lines:0, pages:{A4:1, USLetter:1}, bytes:0 };\n      if (content.length > 0) {\n        var lineHeight = c.ownerDocument.defaultView.getComputedStyle(c, null)[\"line-height\"];\n        var linesCount = Math.ceil(c.clientHeight / parseInt(lineHeight));\n        contentCount = {\n          readingTime: Math.ceil(content.split(' ').length / 200),\n          words: content.match(/\\S+/g).length,\n          chars: content.length,\n          lines: linesCount,\n          pages: { A4: Math.ceil(linesCount / 47), USLetter: Math.ceil(linesCount / 63) },\n          bytes: encodeURI(document.documentElement.outerHTML).split(/%..|./).length - 1\n        };\n      }\n      return contentCount;\n    },\n\n    showDocumentItems: function() {\n      var documentItems = document.getElementById('document-items');\n\n      if(documentItems) { return; }\n\n      var sections = document.querySelectorAll('h1 ~ div > section:not([class~=\"slide\"]):not([id^=table-of])');\n      if (sections.length > 0) {\n        DO.U.showTableOfStuff(documentItems);\n\n        DO.U.showTableOfContents(documentItems, sections)\n\n        if(DO.C.SortableList && DO.C.EditorEnabled) {\n          DO.U.sortToC();\n        }\n      }\n    },\n\n    showTableOfStuff: function(node) {\n      if (!node) {\n        node = document.getElementById('document-items');\n        if (!node) {\n          document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"document-items\" class=\"do on\">' + DO.C.Button.Close + '</aside>'));\n          node = document.getElementById('document-items');\n        }\n      }\n\n      var disabledInput = '', s = [];\n      if (!DO.C.EditorEnabled) {\n        disabledInput = ' disabled=\"disabled\"';\n      }\n\n      var tableList = [{'content': 'Contents'}, {'figure': 'Figures'}, {'table': 'Tables'}, {'abbr': 'Abbreviations'}];\n      tableList.forEach(function(i) {\n        var key = Object.keys(i)[0];\n        var value = i[key];\n        var checkedInput = '';\n\n        var tL = document.getElementById('table-of-'+ key +'s');\n\n        if(tL) {\n          checkedInput = ' checked=\"checked\"';\n\n          DO.U.buildTableOfStuff(key);\n        }\n\n        s.push('<li><input id=\"t-o-' + key +'\" type=\"checkbox\"' + disabledInput + checkedInput + '/><label for=\"t-o-' + key + '\">' + value + '</label></li>');\n      });\n\n      if (s.length > 0) {\n        node.insertAdjacentHTML('beforeend', '<section id=\"table-of-stuff\" class=\"do\"><h2>Table of Stuff</h2><ul>' + s.join('') + '</ul></section>');\n\n        if(DO.C.EditorEnabled) {\n          document.getElementById('table-of-stuff').addEventListener('click', function(e){\n            if (e.target.closest('input')) {\n              var id = e.target.id;\n              var listType = id.slice(4, id.length);\n              if(!e.target.getAttribute('checked')) {\n                DO.U.buildTableOfStuff(listType);\n                e.target.setAttribute('checked', 'checked');\n              }\n              else {\n                var tol = document.getElementById('table-of-'+listType+'s');\n                if(tol) {\n                  tol.parentNode.removeChild(tol);\n                }\n                e.target.removeAttribute('checked');\n              }\n            }\n          });\n        }\n      }\n    },\n\n    showTableOfContents: function(node, sections, options) {\n      options = options || {}\n      var sortable = (DO.C.SortableList && DO.C.EditorEnabled) ? ' sortable' : '';\n\n      if (!node) {\n        node = document.getElementById('document-items');\n        if (!node) {\n          document.body.insertAdjacentHTML('beforeend', '<aside id=\"document-items\" class=\"do on\">' + DO.C.Button.Close + '</aside>');\n          node = document.getElementById('document-items');\n        }\n      }\n\n      var toc = '<section id=\"table-of-contents-i\" class=\"do\"' + sortable + '><h2>Table of Contents</h2><ol class=\"toc' + sortable + '\">';\n      toc += DO.U.getListOfSections(sections, DO.C.SortableList);\n      toc += '</ol></section>';\n\n      node.insertAdjacentHTML('beforeend', toc);\n    },\n\n\n    sortToC: function() {\n    },\n\n    getListOfSections: function(sections, sortable) {\n      var s = '', attributeClass = '';\n      if (sortable == true) { attributeClass = ' class=\"sortable\"'; }\n\n      for (var i = 0; i < sections.length; i++) {\n        var section = sections[i];\n        if(section.id) {\n          var heading = section.querySelector('h1, h2, h3, h4, h5, h6, header h1, header h2, header h3, header h4, header h5, header h6') || { 'textContent': section.id };\n          if (heading) {\n            s += '<li data-id=\"' + section.id +'\"><a href=\"#' + section.id + '\">' + heading.textContent + '</a>';\n            var subsections = section.parentNode.querySelectorAll('[id=\"' + section.id + '\"] > div > section[rel*=\"hasPart\"]:not([class~=\"slide\"]), [id=\"' + section.id + '\"] > section[rel*=\"hasPart\"]:not([class~=\"slide\"])');\n\n            if (subsections.length > 0) {\n              s += '<ol'+ attributeClass +'>';\n              s += DO.U.getListOfSections(subsections, sortable);\n              s += '</ol>';\n            }\n            s += '</li>';\n          }\n        }\n      }\n\n      return s;\n    },\n\n    buildTableOfStuff: function(listType) {\n      var s = elementId = elementTitle = titleType = tableHeading = '';\n      var tableList = [];\n\n      tableList = (listType) ? [listType] : ['content', 'figure', 'table', 'abbr'];\n\n      tableList.forEach(function(element) {\n        var e = document.querySelectorAll('section:not([class~=\"do\"]) ' + element);\n        if (element == 'content' || e.length > 0) {\n          switch(element) {\n            case 'figure':\n              titleType = 'figcaption';\n              tableHeading = 'Table of Figures';\n              break;\n            case 'table':\n              titleType = 'caption';\n              tableHeading = 'Table of Tables';\n              break;\n            case 'abbr':\n              titleType = 'title';\n              tableHeading = 'Table of Abbreviations';\n              break;\n            case 'content': default:\n              titleType = '';\n              tableHeading = 'Table of Contents';\n              break;\n          }\n\n          elementId = 'table-of-' + element + 's';\n\n          //Refresh\n          var tId = document.getElementById(elementId);\n          if(tId) { tId.parentNode.removeChild(tId); }\n\n          if (element == 'abbr') {\n            s += '<section id=\"' + elementId + '\">';\n          }\n          else {\n            s += '<nav id=\"' + elementId + '\">';\n          }\n          s += '<h2>' + tableHeading + '</h2>';\n          s += '<div><ol class=\"toc\">';\n\n          if (element == 'content') {\n            s += DO.U.getListOfSections(document.querySelectorAll('h1 ~ div > section:not([class~=\"slide\"])'), false);\n          }\n          else {\n            if (element == 'abbr') {\n              if (e.length > 0) {\n                e = [].slice.call(e);\n                e.sort(function(a, b) {\n                  return a.textContent.toLowerCase().localeCompare(b.textContent.toLowerCase());\n                });\n              }\n\n              for (var i = 0; i < e.length; i++) {\n                s += '<dt>' + e[i].textContent + '</dt>';\n                s += '<dd>' + e[i].getAttribute(titleType) + '</dd>';\n              };\n            }\n            else {\n              for (var i = 0; i < e.length; i++) {\n                var title = e[i].querySelector(titleType);\n                if(title) {\n                  if(e[i].id){\n                    s += '<li><a href=\"#' + e[i].id +'\">' + title.textContent +'</a></li>';\n                  }\n                  else {\n                    s += '<li>' + title.textContent +'</li>';\n                  }\n                }\n              };\n            }\n          }\n\n          if (element == 'abbr'){\n            s += '</dl></div>';\n            s += '</section>';\n          } else {\n            s += '</ol></div>';\n            s += '</nav>';\n          }\n        }\n      });\n\n      DO.U.insertDocumentLevelHTML(document, s, { 'id': elementId });\n    },\n\n    setDocumentStatus: function(rootNode, options) {\n      rootNode = rootNode || document;\n      options = options || {};\n\n      var s = DO.U.getDocumentStatusHTML(rootNode, options);\n\n      rootNode = DO.U.insertDocumentLevelHTML(rootNode, s, options);\n\n      return rootNode;\n    },\n\n    getDocumentStatusHTML: function(rootNode, options) {\n      rootNode = rootNode || document;\n      options = options || {};\n      options['mode'] = ('mode' in options) ? options.mode : '';\n      options['id'] = ('id' in options) ? options.id : 'document-status';\n      var subjectURI = ('subjectURI' in options) ? ' about=\"' + options.subjectURI + '\"' : '';\n      var typeLabel = '', typeOf = '';\n\n      switch(options.type) {\n        default:\n          definitionTitle = 'Document Status';\n          break;\n        case 'ldp:ImmutableResource':\n          definitionTitle = 'Resource State';\n          typeLabel = 'Immutable';\n          typeOf = ' typeof=\"' + options.type + '\"';\n          break;\n      }\n\n      var id = ' id=\"' + options.id + '\"';\n      var c = ('class' in options && options.class.length > 0) ? ' class=\"' + options.class + '\"' : '';\n      // var datetime = ('datetime' in options) ? options.datetime : util.getDateTimeISO();\n\n      var dd = '<dd><span' + subjectURI + typeOf + '>' + typeLabel + '</span></dd>';\n\n      var s = '';\n      var dl = rootNode.querySelector('#' + options.id);\n\n      //FIXME: mode should be an array of operations.\n\n      //TODO: s/update/append\n      switch (options.mode) {\n        case 'create': default:\n          s = '<dl'+c+id+'><dt>' + definitionTitle + '</dt>' + dd + '</dl>';\n          break;\n\n        case 'update':\n          if(dl) {\n            var clone = dl.cloneNode(true);\n            dl.parentNode.removeChild(dl);\n            clone.insertAdjacentHTML('beforeend', dd);\n            s = clone.outerHTML;\n          }\n          else  {\n            s = '<dl'+c+id+'><dt>' + definitionTitle + '</dt>' + dd + '</dl>';\n          }\n          break;\n\n        case 'delete':\n          if(dl) {\n            var clone = dl.cloneNode(true);\n            dl.parentNode.removeChild(dl);\n\n            var t = clone.querySelector('[typeof=\"' + options.type + '\"]');\n            if (t) {\n              t.closest('dl').removeChild(t.parentNode);\n            }\n\n            var cloneDD = clone.querySelectorAll('#' + options.id + ' dd');\n            if (cloneDD.length > 0) {\n              s = clone.outerHTML;\n            }\n          }\n          break;\n      }\n\n// console.log(s);\n      return s;\n    },\n\n    insertDocumentLevelHTML: function(rootNode, h, options) {\n      rootNode = rootNode || document;\n      options = options || {};\n\n      options['id'] = ('id' in options) ? options.id : DO.C.DocumentItems[DO.C.DocumentItems.length-1];\n\n      var item = DO.C.DocumentItems.indexOf(options.id);\n\n      var article = DO.U.selectArticleNode(rootNode);\n\n      h = '\\n\\\n' + h;\n\n      if(item > -1) {\n        for(var i = item; i >= 0; i--) {\n          var node = rootNode.querySelector('#' + DO.C.DocumentItems[i]);\n\n          if (node) {\n            node.insertAdjacentHTML('afterend', h);\n            break;\n          }\n          else if (i == 0) {\n            var a = article.querySelector('h1');\n\n            if (a) {\n              a.insertAdjacentHTML('afterend', h);\n            }\n            else {\n              article.insertAdjacentHTML('afterbegin', h);\n            }\n            break;\n          }\n        }\n      }\n      else {\n        article.insertAdjacentHTML('afterbegin', h);\n      }\n\n      return rootNode;\n    },\n\n\n    selectArticleNode: function(node) {\n      var selectors;\n\n      if (DO.C.WebExtension)\n        selectors = [\n          'main.article',\n          'main',\n          'body'\n        ];\n      else\n        selectors = [\n          'main > article',\n          'main',\n          'body'\n        ];\n\n      var x = node.querySelectorAll(selectors.join(','));\n      return x[x.length - 1];\n    },\n\n    buttonClose: function() {\n      document.addEventListener('click', function(e) {\n        var button = e.target.closest('button.close')\n        if (button) {\n          var parent = button.parentNode;\n          parent.parentNode.removeChild(parent);\n        }\n      });\n    },\n\n    eventEscapeDocumentMenu: function(e) {\n      if (e.keyCode == 27) { // Escape\n        DO.U.hideDocumentMenu(e);\n      }\n    },\n\n    eventLeaveDocumentMenu: function(e) {\n      if (!e.target.closest('.do.on')) {\n        DO.U.hideDocumentMenu(e);\n      }\n    },\n\n    updateDocumentTitle: function(e) {\n      if (!e.target.closest('h1')) {\n        var h1 = document.querySelector('h1');\n        if (h1) {\n          document.title = h1.textContent.trim();\n        }\n      }\n    },\n\n    utf8Tob64: function(s) {\n      return window.btoa(encodeURIComponent(s));\n    },\n\n    b64Toutf8: function(s) {\n      return unescape(decodeURIComponent(window.atob(s)));\n    },\n\n    getSelectorSign: function(node) {\n      if(!node) {\n        return DO.C.SelectorSign[\"*\"];\n      }\n\n      if (typeof node === 'object') {\n        var nodeName = node.nodeName.toLowerCase();\n        var nodeId = '';\n\n        if(node.id) {\n          switch(nodeName) {\n            default: break;\n            case 'section': case 'dl':\n              nodeId = '#' + node.id;\n              break;\n          }\n        }\n\n        return DO.C.SelectorSign[nodeName + nodeId] || DO.C.SelectorSign[nodeName] || DO.C.SelectorSign[\"*\"];\n      }\n\n      return DO.C.SelectorSign[\"*\"];\n    },\n\n    showFragment: function(selector) {\n      var ids = (selector) ? document.querySelectorAll(selector) : document.querySelectorAll('main *[id]:not(input):not(textarea):not(select):not(#content)');\n\n      for(var i = 0; i < ids.length; i++){\n        ids[i].addEventListener('mouseenter', function(e){\n          var fragment = document.querySelector('*[id=\"' + e.target.id + '\"] > .do.fragment');\n          if (!fragment && e.target.parentNode.nodeName.toLowerCase() != 'aside'){\n            sign = DO.U.getSelectorSign(e.target);\n\n            e.target.insertAdjacentHTML('afterbegin', '<span class=\"do fragment\"><a href=\"#' + e.target.id + '\">' + sign + '</a></span>');\n            fragment = document.querySelector('[id=\"' + e.target.id + '\"] > .do.fragment');\n            var fragmentClientWidth = fragment.clientWidth;\n\n            var fragmentOffsetLeft = DO.U.getOffset(e.target).left;\n            var bodyOffsetLeft = DO.U.getOffset(document.body).left;\n\n            var offsetLeft = 0;\n            if ((fragmentOffsetLeft - bodyOffsetLeft) > 200) {\n              offsetLeft = e.target.offsetLeft;\n            }\n\n            fragment.style.top = Math.ceil(e.target.offsetTop) + 'px';\n            fragment.style.left = (offsetLeft - fragmentClientWidth) + 'px';\n            fragment.style.height = e.target.clientHeight + 'px';\n            fragment.style.width = (fragmentClientWidth - 10) + 'px';\n          }\n        });\n\n        ids[i].addEventListener('mouseleave', function(e){\n          var fragment = document.querySelector('[id=\"' + e.target.id + '\"] > .do.fragment');\n          fragment.parentNode.removeChild(fragment);\n        });\n      }\n    },\n\n    showRobustLinks: function() {\n      document.querySelectorAll('[data-versionurl], [data-originalurl]').forEach(function(i){\n        if (i.nextElementSibling && i.nextElementSibling.classList.contains('do') && i.nextElementSibling.classList.contains('robustlinks')) {\n          return;\n        }\n\n        var href = i.getAttribute('href');\n\n        var originalurl = i.getAttribute('data-originalurl');\n        originalurl = (originalurl) ? originalurl.trim() : undefined;\n        originalurl = (originalurl) ? '<dt>Original</dt><dd><a href=\"' + originalurl + '\" target=\"_blank\">' + originalurl + '</a></dd>' : '';\n\n        var versionurl = i.getAttribute('data-versionurl');\n        verionurl = (versionurl) ? versionurl.trim() : undefined;\n        var versiondate = i.getAttribute('data-versiondate');\n        var nearlinkdateurl = '';\n        if (versiondate) {\n          versiondate = versiondate.trim();\n          versiondateNumeric = versiondate.replace(/\\D/g, '');\n          nearlinkdateurl = 'http://timetravel.mementoweb.org/memento/' + versiondateNumeric + '/' + href;\n          nearlinkdateurl = '<dt>Near Link Date</dt><dd><a href=\"' + nearlinkdateurl + '\" target=\"_blank\">' + versiondate + '</a></dd>'\n        }\n        else if (versionurl) {\n          versiondate = versionurl;\n        }\n\n        versionurl = (versionurl) ? '<dt>Version</dt><dd><a href=\"' + versionurl + '\" target=\"_blank\">' + versiondate + '</a></dd>' : '';\n\n        i.insertAdjacentHTML('afterend', '<span class=\"do robustlinks\"><button title=\"Robust Links\">🔗<span></span></button><dl>' + originalurl + versionurl + nearlinkdateurl + '</dl></span>');\n      });\n\n      document.querySelectorAll('.do.robustlinks').forEach(function(i){\n        i.addEventListener('mouseenter', function(e){\n          e.target.classList.add('on');\n        });\n        i.addEventListener('mouseleave', function(e){\n          e.target.classList.remove('on');\n        });\n      });\n    },\n\n    getOffset: function(el) {\n      var box = el.getBoundingClientRect();\n\n      return {\n        top: box.top + window.pageYOffset - document.documentElement.clientTop,\n        left: box.left + window.pageXOffset - document.documentElement.clientLeft\n      }\n    },\n\n    forceTrailingSlash: function(aString) {\n      if (aString.slice(-1) == \"/\") return aString;\n      return aString + \"/\";\n    },\n\n    getUrlPath: function(aString) {\n      return aString.split(\"/\");\n    },\n\n    exportAsHTML: function() {\n      var data = doc.getDocument();\n      //XXX: Encodes strings as UTF-8. Consider storing bytes instead?\n      var blob = new Blob([data], {type:'text/html;charset=utf-8'});\n      var pattern = /[^\\w]+/ig;\n      var h1 = document.querySelector('h1');\n      var title = (h1) ? h1.textContent.toLowerCase().replace(pattern, '-') : \"index\";\n      var timestamp = util.getDateTimeISO().replace(pattern, '') || \"now\";\n\n      var fileName = title + '.' + timestamp + '.html';\n\n      var a = document.createElement(\"a\");\n      a.download = fileName;\n\n      a.href = window.URL.createObjectURL(blob);\n      a.style.display = \"none\";\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n    },\n\n    snapshotAtEndpoint: function snapshotAtEndpoint (e, iri, endpoint, noteData, options = {}) {\n      iri = iri || window.location.origin + window.location.pathname;\n      endpoint = endpoint || 'https://pragma.archivelab.org';\n\n      if(!('contentType' in options)){\n        options['contentType'] = 'application/json';\n      }\n\n      noteData = noteData || {\n        \"url\": iri,\n        \"annotation\": {\n          \"@context\": \"http://www.w3.org/ns/anno.jsonld\",\n          \"@type\": \"Annotation\",\n          \"motivation\": \"linking\",\n          \"target\": iri,\n          \"rights\": \"https://creativecommons.org/publicdomain/zero/1.0/\"\n        }\n      };\n\n      if (DO.C.User.IRI) {\n        noteData.annotation['creator'] = {};\n        noteData.annotation.creator[\"@id\"] = DO.C.User.IRI;\n      }\n      if (DO.C.User.Name) {\n        noteData.annotation.creator[\"http://schema.org/name\"] = DO.C.User.Name;\n      }\n      if (DO.C.User.Image) {\n        noteData.annotation.creator[\"http://schema.org/image\"] = DO.C.User.Image;\n      }\n      if (DO.C.User.URL) {\n        noteData.annotation.creator[\"http://schema.org/url\"] = DO.C.User.URL;\n      }\n\n      // if(note.length > 0) {\n      //   noteData.annotation[\"message\"] = note;\n      // }\n\n      var button = e.target.closest('button');\n\n      if (typeof e !== 'undefined' && button) {\n        if (button.disabled) { return; }\n        else { button.disabled = true; }\n\n        var archiveNode = button.parentNode;\n        archiveNode.insertAdjacentHTML('beforeend', ' <span class=\"progress\"><i class=\"fa fa-circle-o-notch fa-spin fa-fw\"></i> Archiving in progress.</span>');\n      }\n\n      options.noCredentials = true\n\n      var progress = archiveNode.querySelector('.progress')\n\n      return fetcher.postResource(endpoint, '', JSON.stringify(noteData), options.contentType, null, options)\n\n        .then(response => response.json())\n\n        .then(response => {\n          switch (endpoint) {\n            case 'https://pragma.archivelab.org':\n            default:\n              if (response['wayback_id']) {\n                let location = 'https://web.archive.org' + response.wayback_id\n\n                progress\n                  .innerHTML = '<i class=\"fa fa-archive fa-fw\"></i> Archived at <a target=\"_blank\" href=\"' +\n                  location + '\">' + location + '</a>'\n              } else {\n                progress\n                  .innerHTML = '<i class=\"fa fa-times-circle fa-fw \"></i> Archive unavailable. Please try later.'\n              }\n\n              break\n          }\n        })\n\n        .catch(() => {\n          progress\n            .innerHTML = '<i class=\"fa fa-times-circle fa-fw \"></i> Archive unavailable. Please try later.'\n        })\n    },\n\n    mementoDocument: function(e) {\n      if(typeof e !== 'undefined') {\n        var b = e.target.closest('button');\n        if(b.disabled) { return; }\n        else { b.disabled = true; }\n      }\n\n      var buttonDisabled = '';\n      if (document.location.protocol === 'file:') {\n        buttonDisabled = ' disabled=\"disabled\"';\n      }\n\n      var iri = uri.stripFragmentFromString(document.location.href);\n\n      var li = [];\n      li.push('<li><button class=\"create-version\"' + buttonDisabled +\n        ' title=\"Version this article\"><i class=\"fa fa-code-fork fa-2x\"></i>Version</button></li>');\n      li.push('<li><button class=\"create-immutable\"' + buttonDisabled +\n        ' title=\"Make this article immutable and version it\"><i class=\"fa fa-snowflake-o fa-2x\"></i>Immutable</button></li>');\n      li.push('<li><button class=\"snapshot-internet-archive\"' + buttonDisabled +\n        ' title=\"Capture with Internet Archive\"><i class=\"fa fa-archive fa-2x\"></i>Internet Archive</button></li>');\n      li.push('<li><button class=\"export-as-html\" title=\"Export and save to file\"><i class=\"fa fa-external-link fa-2x\"></i>Export</button></li>');\n\n      e.target.closest('button').insertAdjacentHTML('afterend', '<ul id=\"memento-items\" class=\"on\">' + li.join('') + '</ul>');\n\n      var mementoItems = document.getElementById('memento-items');\n\n      DO.U.showTimeMap();\n\n      mementoItems.addEventListener('click', function(e) {\n        if (e.target.closest('button.resource-save') ||\n            e.target.closest('button.create-version') || \n            e.target.closest('button.create-immutable')) {\n          DO.U.resourceSave(e);\n        }\n\n        if (e.target.closest('button.export-as-html')) {\n          DO.U.exportAsHTML(e);\n        }\n\n        if (e.target.closest('button.snapshot-internet-archive')){\n          DO.U.snapshotAtEndpoint(e, iri, 'https://pragma.archivelab.org', '', {'contentType': 'application/json'});\n        }\n      });\n    },\n\n    showTimeMap: function(node, url) {\n      url = url || DO.C.OriginalResourceInfo['timemap']\n      if(!url) { return; }\n\n      var elementId = 'memento-document';\n\n      var displayMemento = '';\n\n      DO.U.getTriplesFromGraph(url)\n        .then(triples => {\n// console.log(triples)\n          if (!node) {\n            node = document.getElementById(elementId);\n            if(!node) {\n              document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"' + elementId + '\" class=\"do on\"><h2>Memento</h2>' + DO.C.Button.Close + '</aside>'));\n              node = document.getElementById(elementId);\n            }\n          }\n\n          var timemap = node.querySelector('.timemap');\n          if (timemap) {\n            node.removeChild(timemap);\n          }\n\n          triples = DO.U.sortTriples(triples, { sortBy: 'object' });\n\n          var items = [];\n          triples.forEach(function(t){\n            var s = t.subject.nominalValue;\n            var p = t.predicate.nominalValue;\n            var o = t.object.nominalValue;\n\n            if(p === DO.C.Vocab['schemadateCreated']) {\n              items.push('<li><a href=\"' + s + '\" target=\"_blank\">' + o + '</a></li>');\n            }\n          });\n\n          var html = '<dl class=\"timemap\"><dt>TimeMap</dt><dd><ul>' + items.join('') + '</ul></dd></dl>';\n\n          node.insertAdjacentHTML('beforeend', html);\n        })\n        .catch(error => {\n// console.error(error)\n        });\n    },\n\n    updateTimeMap: function(url, insertBGP, options) {\n      return fetcher.patchResource(url, null, insertBGP);\n    },\n\n    showDocumentDo: function showDocumentDo (node) {\n      if (document.getElementById('document-do')) { return; }\n\n      var buttonDisabled = '';\n\n      var s = '<section id=\"document-do\" class=\"do\"><h2>Do</h2><ul>';\n      s += '<li><button class=\"resource-share\" title=\"Share resource\"><i class=\"fa fa-bullhorn fa-2x\"></i>Share</button></li>';\n      s += '<li><button class=\"resource-reply\" title=\"Reply\"><i class=\"fa fa-reply fa-2x\"></i>Reply</button></li>';\n\n      if (DO.C.EditorAvailable) {\n        var reviewArticle = (DO.C.EditorEnabled && DO.C.User.Role == 'review')\n          ? DO.C.Editor.DisableReviewButton\n          : DO.C.Editor.EnableReviewButton;\n        s += '<li>' + reviewArticle + '</li>';\n      }\n\n      buttonDisabled = (DO.C.User.IRI) ? '' : ' disabled=\"disabled\"';\n\n      var activitiesIcon = 'fa-bolt';\n\n      if (DO.C.User['ContactsOutboxChecked']) {\n        activitiesIcon = 'fa-circle-o';\n        buttonDisabled = ' disabled=\"disabled\"';\n      }\n\n      s += '<li><button class=\"resource-activities\"' + buttonDisabled +\n        ' title=\"Show activities\"><i class=\"fa ' + activitiesIcon + ' fa-2x\"></i></i>Activities</button></li>';\n      s += '<li><button class=\"resource-new\" title=\"Create new article\"><i class=\"fa fa-lightbulb-o fa-2x\"></i></i>New</button></li>';\n      s += '<li><button class=\"resource-open\" title=\"Open article\"><i class=\"fa fa-coffee fa-2x\"></i></i>Open</button></li>';\n\n      buttonDisabled = (document.location.protocol === 'file:') ? ' disabled=\"disabled\"' : '';\n\n      s += '<li><button class=\"resource-save\"' + buttonDisabled +\n        ' title=\"Save article\"><i class=\"fa fa-life-ring fa-2x\"></i>Save</button></li>';\n\n      s += '<li><button class=\"resource-save-as\" title=\"Save as article\"><i class=\"fa fa-paper-plane-o fa-2x\"></i>Save As</button></li>';\n      s += '<li><button class=\"resource-memento\" title=\"Memento article\"><i class=\"fa fa-clock-o fa-2x\"></i>Memento</button></li>';\n\n      if (DO.C.EditorAvailable) {\n        var editFile = (DO.C.EditorEnabled && DO.C.User.Role == 'author')\n          ? DO.C.Editor.DisableEditorButton\n          : DO.C.Editor.EnableEditorButton;\n        s += '<li>' + editFile + '</li>';\n      }\n\n      s += '<li><button class=\"resource-source\"' + buttonDisabled +\n        ' title=\"Edit article source code\"><i class=\"fa fa-code fa-2x\"></i>Source</button></li>';\n      s += '</ul></section>';\n\n      node.insertAdjacentHTML('beforeend', s);\n\n      var dd = document.getElementById('document-do');\n\n      dd.addEventListener('click', e => {\n        if (e.target.closest('.resource-share')) {\n          DO.U.shareResource(e);\n        }\n\n        if (e.target.closest('.resource-reply')) {\n          DO.U.replyToResource(e);\n        }\n\n        if (DO.C.EditorAvailable) {\n          if (e.target.closest('button.editor-disable') ||\n            e.target.closest('button.review-disable')) {\n            e.target.parentNode.innerHTML = DO.C.Editor.EnableEditorButton;\n            DO.U.Editor.enableEditor('social', e);\n          }\n          else {\n            if (e.target.closest('button.editor-enable')) {\n              e.target.parentNode.innerHTML = DO.C.Editor.DisableEditorButton;\n              DO.U.Editor.enableEditor('author', e);\n            }\n            else if (e.target.closest('button.review-enable')) {\n              e.target.parentNode.innerHTML = DO.C.Editor.DisableEditorButton;\n              DO.U.Editor.enableEditor('review', e);\n            }\n          }\n        }\n\n        if (e.target.closest('.resource-activities')) {\n          DO.U.showContactsActivities(e);\n        }\n\n        if (e.target.closest('.resource-new')) {\n          DO.U.createNewDocument(e);\n        }\n\n        if (e.target.closest('.resource-open')) {\n          DO.U.openDocument(e);\n        }\n\n        if (e.target.closest('.resource-source')) {\n          DO.U.viewSource(e);\n        }\n\n        if (e.target.closest('.resource-save')){\n          DO.U.resourceSave(e);\n        }\n\n        if (e.target.closest('.resource-save-as')) {\n          DO.U.saveAsDocument(e);\n        }\n\n        if (e.target.closest('.resource-memento')) {\n          DO.U.mementoDocument(e);\n        }\n      });\n    },\n\n    resourceSave: function(e, options) {\n      var url = window.location.origin + window.location.pathname;\n      var data = doc.getDocument();\n      options = options || {};\n\n      DO.U.getResourceInfo(data, options).then(function(i) {\n        if (e.target.closest('.create-version')) {\n          DO.U.createMutableResource(url);\n        }\n        else if (e.target.closest('.create-immutable')) {\n          DO.U.createImmutableResource(url);\n        }\n        else if (e.target.closest('.resource-save')) {\n          DO.U.updateMutableResource(url);\n        }\n      });\n    },\n\n    createImmutableResource: function(url, data, options) {\n      if(!url) return;\n\n      var uuid = DO.U.generateUUID();\n      var containerIRI = url.substr(0, url.lastIndexOf('/') + 1);\n      var immutableURL = containerIRI + uuid;\n\n      var rootNode = document.documentElement.cloneNode(true);\n\n      var date = new Date();\n      rootNode = DO.U.setDate(rootNode, { 'id': 'document-created', 'property': 'schema:dateCreated', 'title': 'Created', 'datetime': date });\n\n      var resourceState = rootNode.querySelector('#' + 'document-resource-state');\n      if(!resourceState){\n        var rSO = {\n          'id': 'document-resource-state',\n          'subjectURI': '',\n          'type': 'ldp:ImmutableResource',\n          'mode': 'create'\n        }\n\n        rootNode = DO.U.setDocumentStatus(rootNode, rSO);\n      }\n\n      var r, o;\n\n      o = { 'id': 'document-identifier', 'title': 'Identifier' };\n      r = { 'rel': 'owl:sameAs', 'href': immutableURL };\n      rootNode = DO.U.setDocumentRelation(rootNode, [r], o);\n\n      o = { 'id': 'document-original', 'title': 'Original resource' };\n      if (DO.C.OriginalResourceInfo['state'] == DO.C.Vocab['ldpImmutableResource']['@id']\n        && DO.C.OriginalResourceInfo['profile'] == DO.C.Vocab['memOriginalResource']['@id']) {\n        r = { 'rel': 'mem:original', 'href': immutableURL };\n      }\n      else {\n        r = { 'rel': 'mem:original', 'href': url };\n      }\n      rootNode = DO.U.setDocumentRelation(rootNode, [r], o);\n\n      //TODO document-timegate\n\n      var timeMapURL = DO.C.OriginalResourceInfo['timemap'] || url + '.timemap';\n      o = { 'id': 'document-timemap', 'title': 'TimeMap' };\n      r = { 'rel': 'mem:timemap', 'href': timeMapURL };\n      rootNode = DO.U.setDocumentRelation(rootNode, [r], o);\n\n      // Create URI-M\n      data = doc.getDocument(rootNode);\n      DO.U.processSave(containerIRI, uuid, data, options);\n\n\n      var timeMapURL = DO.C.OriginalResourceInfo['timemap'] || url + '.timemap';\n\n\n      //Update URI-R\n      if (DO.C.OriginalResourceInfo['state'] != DO.C.Vocab['ldpImmutableResource']['@id']) {\n        DO.U.setDate(document, { 'id': 'document-created', 'property': 'schema:dateCreated', 'title': 'Created', 'datetime': date });\n\n        o = { 'id': 'document-identifier', 'title': 'Identifier' };\n        r = { 'rel': 'owl:sameAs', 'href': url };\n        DO.U.setDocumentRelation(document, [r], o);\n\n        o = { 'id': 'document-latest-version', 'title': 'Latest Version' };\n        r = { 'rel': 'mem:memento rel:latest-version', 'href': immutableURL };\n        DO.U.setDocumentRelation(document, [r], o);\n\n        if(DO.C.OriginalResourceInfo['latest-version']) {\n          o = { 'id': 'document-predecessor-version', 'title': 'Predecessor Version' };\n          r = { 'rel': 'mem:memento rel:predecessor-version', 'href': DO.C.OriginalResourceInfo['latest-version'] };\n          DO.U.setDocumentRelation(document, [r], o);\n        }\n\n        //TODO document-timegate\n\n        o = { 'id': 'document-timemap', 'title': 'TimeMap' };\n        r = { 'rel': 'mem:timemap', 'href': timeMapURL };\n        DO.U.setDocumentRelation(document, [r], o);\n\n        // Create URI-R\n        data = doc.getDocument();\n        DO.U.processSave(url, null, data, options);\n      }\n\n\n      //Update URI-T\n      var insertBGP = '@prefix mem: <http://mementoweb.org/ns#> .\\n\\\n@prefix schema: <http://schema.org/> .\\n\\\n@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\\n\\\n<' + url + '> mem:memento <' + immutableURL + '> .\\n\\\n<' + immutableURL + '> schema:dateCreated \"' + date.toISOString() + '\"^^xsd:dateTime .';\n\n      DO.U.updateTimeMap(timeMapURL, insertBGP).then(() =>{\n        DO.U.showTimeMap(null, timeMapURL)\n      });\n\n      DO.U.getResourceInfo(null, { 'mode': 'update' });\n    },\n\n    createMutableResource: function(url, data, options) {\n      if(!url) return;\n\n      DO.U.setDate(document, { 'id': 'document-created', 'property': 'schema:dateCreated', 'title': 'Created' } );\n\n      var uuid = DO.U.generateUUID();\n      var containerIRI = url.substr(0, url.lastIndexOf('/') + 1);\n      var mutableURL = containerIRI + uuid;\n\n      var r, o;\n\n      o = { 'id': 'document-identifier', 'title': 'Identifier' };\n      r = { 'rel': 'owl:sameAs', 'href': mutableURL };\n      DO.U.setDocumentRelation(document, [r], o);\n\n      o = { 'id': 'document-latest-version', 'title': 'Latest Version' };\n      r = { 'rel': 'rel:latest-version', 'href': mutableURL };\n      DO.U.setDocumentRelation(document, [r], o);\n\n      if(DO.C.OriginalResourceInfo['latest-version']) {\n        o = { 'id': 'document-predecessor-version', 'title': 'Predecessor Version' };\n        r = { 'rel': 'rel:predecessor-version', 'href': DO.C.OriginalResourceInfo['latest-version'] };\n        DO.U.setDocumentRelation(document, [r], o);\n      }\n\n      data = doc.getDocument();\n      DO.U.processSave(containerIRI, uuid, data, options);\n\n\n      o = { 'id': 'document-identifier', 'title': 'Identifier' };\n      r = { 'rel': 'owl:sameAs', 'href': url };\n      DO.U.setDocumentRelation(document, [r], o);\n\n      data = doc.getDocument();\n      DO.U.processSave(url, null, data, options).then(() => {\n        DO.U.getResourceInfo(null, { 'mode': 'update' });\n      });\n    },\n\n    updateMutableResource: function(url, data, options) {\n      if(!url) return;\n      options = options || {};\n\n      if (!('datetime' in options)) {\n        options['datetime'] = new Date();\n      }\n\n      DO.U.setDate(document, { 'id': 'document-modified', 'property': 'schema:dateModified', 'title': 'Modified', 'datetime': options.datetime } );\n      DO.U.setEditSelections(options);\n\n      data = doc.getDocument();\n      DO.U.processSave(url, null, data, options).then(() => {\n        DO.U.getResourceInfo(null, { 'mode': 'update' });\n      });\n    },\n\n    processSave: function(url, slug, data, options) {\n      options = options || {};\n      var request = (slug)\n                    ? fetcher.postResource(url, slug, data)\n                    : fetcher.putResource(url, data)\n\n      return request\n        .then(response => {\n          DO.U.showActionMessage(document.documentElement, 'Saved')\n          return response\n        })\n        .catch(error => {\n          console.log(error)\n\n          let message\n\n          switch (error.status) {\n            case 401:\n              message = 'Need to authenticate before saving'\n              break\n\n            case 403:\n              message = 'You are not authorized to save'\n              break\n\n            case 405:\n            default:\n              message = 'Server doesn\\'t allow this resource to be rewritten'\n              break\n          }\n\n          DO.U.showActionMessage(document.documentElement, message)\n        })\n    },\n\n    replyToResource: function replyToResource (e, iri) {\n      iri = iri || fetcher.currentLocation()\n\n      e.target.closest('button').disabled = true\n\n      document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"reply-to-resource\" class=\"do on\">' + DO.C.Button.Close + '<h2>Reply to this</h2><div id=\"reply-to-resource-input\"><p>Reply to <code>' +\n        iri +'</code></p><ul><li><p><label for=\"reply-to-resource-note\">Quick reply (plain text note)</label></p><p><textarea id=\"reply-to-resource-note\" rows=\"10\" cols=\"40\" name=\"reply-to-resource-note\" placeholder=\"Great article!\"></textarea></p></li><li><label for=\"reply-to-resource-license\">License</label> <select id=\"reply-to-resource-license\" name=\"reply-to-resource-license\">' +\n        DO.U.getLicenseOptionsHTML() + '</select></li></ul></div>'))\n\n      // TODO: License\n      // TODO: ACL - can choose whether to make this reply private (to self), visible only to article author(s), visible to own contacts, public\n      // TODO: Show name and face of signed in user reply is from, or 'anon' if article can host replies\n\n      var replyToResource = document.getElementById('reply-to-resource')\n\n      var id = 'location-reply-to'\n      var action = 'write'\n\n      DO.U.setupResourceBrowser(replyToResource, id, action)\n      document.getElementById(id).insertAdjacentHTML('afterbegin', '<p>Choose a location to save your reply.</p>')\n\n      replyToResource.insertAdjacentHTML('beforeend', '<p>Your reply will be saved at <samp id=\"' + id +'-' + action +\n        '\">https://example.org/path/to/article</samp></p>')\n\n      var bli = document.getElementById(id + '-input')\n      bli.focus()\n      bli.placeholder = 'https://example.org/path/to/article'\n      replyToResource.insertAdjacentHTML('beforeend', '<button class=\"reply\">Send now</button>')\n\n      // replyToResource.insertAdjacentHTML('beforeend', 'or <button class=\"reply-new\"><i class=\"fa fa-paper-plane-o\"></i> Write reply in new window</button>');\n\n      replyToResource.addEventListener('click', e => {\n        if (e.target.closest('button.close')) {\n          document.querySelector('#document-do .resource-reply').disabled = false\n        }\n\n        if (e.target.closest('button.reply')) {\n          var note = document\n            .querySelector('#reply-to-resource #reply-to-resource-note')\n            .value.trim()\n\n          var rm = replyToResource.querySelector('.response-message')\n          if (rm) {\n            rm.parentNode.removeChild(rm)\n          }\n        }\n\n        replyToResource.insertAdjacentHTML('beforeend', '<div class=\"response-message\"></div>')\n\n        if (!iri || !note) {\n          document.querySelector('#reply-to-resource .response-message')\n            .innerHTML = '<p class=\"error\">Need a note and a location to save it.</p>'\n          return\n        }\n\n        var datetime = util.getDateTimeISO()\n        var attributeId = DO.U.generateAttributeId()\n        var noteIRI = document.querySelector('#reply-to-resource #' + id +\n          '-' + action).innerText.trim()\n        var motivatedBy = \"oa:replying\"\n        var noteData = {\n          \"type\": 'article',\n          \"mode\": \"write\",\n          \"motivatedByIRI\": motivatedBy,\n          \"id\": attributeId,\n          // \"iri\": noteIRI, //e.g., https://example.org/path/to/article\n          \"creator\": {},\n          \"datetime\": datetime,\n          \"target\": {\n            \"iri\": iri\n          },\n          \"body\": note, // content\n          \"license\": {}\n        }\n        if (DO.C.User.IRI) {\n          noteData.creator[\"iri\"] = DO.C.User.IRI\n        }\n        if (DO.C.User.Name) {\n          noteData.creator[\"name\"] = DO.C.User.Name\n        }\n        if (DO.C.User.Image) {\n          noteData.creator[\"image\"] = DO.C.User.Image\n        }\n        if (DO.C.User.URL) {\n          noteData.creator[\"url\"] = DO.C.User.URL\n        }\n\n        var license = document.querySelector('#reply-to-resource-license')\n        if (license && license.length > 0) {\n          noteData.license[\"iri\"] = license.value.trim()\n          noteData.license[\"name\"] = DO.C.License[license.value.trim()].name\n        }\n\n        var note = DO.U.createNoteDataHTML(noteData)\n\n        var data = DO.U.createHTML('', note)\n\n        fetcher.putResource(noteIRI, data)\n\n          .catch(error => {\n            console.error('Could not save reply:', error)\n\n            let errorMessage\n\n            switch (error.status) {\n              case 0:\n              case 405:\n                errorMessage = 'this location is not writable'\n                break\n              case 401:\n              case 403:\n                errorMessage = 'you do not have permission to write here'\n                break\n              case 406:\n                errorMessage = 'enter a name for your resource'\n                break\n              default:\n                // some other reason\n                errorMessage = error.message\n                break\n            }\n\n            // re-throw, to break out of the promise chain\n            throw new Error('Cannot save your reply:', errorMessage)\n          })\n\n          .then(response => {\n            replyToResource\n              .querySelector('.response-message')\n              .innerHTML = '<p class=\"success\"><a href=\"' + response.url + '\">Reply saved!</a></p>'\n\n            // Determine the inbox endpoint, to send the notification to\n            return inbox.getEndpoint(DO.C.Vocab['ldpinbox']['@id'])\n              .catch(error => {\n                console.error('Could not fetch inbox endpoint:', error)\n\n                // re-throw\n                throw new Error('Could not determine the author inbox endpoint')\n              })\n          })\n\n          .then(inboxes => {\n            if (!inboxes) {\n              throw new Error('Author inbox endpoint is empty or missing')\n            }\n\n            var inboxURL = inboxes[0]\n\n            let notificationStatements = '    <dl about=\"' + noteIRI +\n              '\">\\n<dt>Object type</dt><dd><a about=\"' +\n              noteIRI + '\" typeof=\"oa:Annotation\" href=\"' +\n              DO.C.Vocab['oaannotation']['@id'] +\n              '\">Annotation</a></dd>\\n<dt>Motivation</dt><dd><a href=\"' +\n              DO.C.Prefixes[motivatedBy.split(':')[0]] +\n              motivatedBy.split(':')[1] + '\" property=\"oa:motivation\">' +\n              motivatedBy.split(':')[1] + '</a></dd>\\n</dl>\\n'\n\n            let notificationData = {\n              \"type\": ['as:Announce'],\n              \"inbox\": inboxURL,\n              \"object\": noteIRI,\n              \"target\": iri,\n              \"license\": noteData.license[\"iri\"],\n              \"statements\": notificationStatements\n            }\n\n            inbox.notifyInbox(notificationData)\n              .catch(error => {\n                console.error('Failed sending notification to ' + inboxURL + ' :', error)\n\n                throw new Error('Failed sending notification to author inbox')\n              })\n          })\n\n          .then(() => {  // Success!\n            replyToResource\n              .querySelector('.response-message')\n              .innerHTML += '<p class=\"success\">Notification sent</p>';\n          })\n\n          .catch(error => {\n            // Catch-all error, actually notify the user\n            replyToResource\n              .querySelector('.response-message')\n              .innerHTML += '<p class=\"error\">' +\n                'We could not notify the author of your reply:' +\n                error.message + '</p>'\n          })\n      })\n    },\n\n    showActionMessage: function(node, message) {\n      var message = '<aside id=\"document-action-message\" class=\"do on\"><p>' + message + '</p></aside>';\n      node.appendChild(DO.U.fragmentFromString(message));\n      window.setTimeout(function () {\n        var dam = document.getElementById('document-action-message');\n        dam.parentNode.removeChild(dam);\n      }, 1500);\n    },\n\n    shareResource: function shareResource (e, iri) {\n      iri = iri || fetcher.currentLocation();\n      if (e) {\n        e.target.disabled = true;\n      }\n\n      var addContactsButtonDisable = '', noContactsText = '';\n      if (!DO.C.User.IRI && !(DO.C.User.Graph && ((DO.C.User.Knows && DO.C.User.Knows.length > 0) || (DO.C.User.Graph.owlsameAs && DO.C.User.Graph.owlsameAs._array.length > 0)))) {\n        addContactsButtonDisable = ' disabled=\"disabled\"';\n        noContactsText = '<p>Sign in to select from your list of contacts, alternatively, enter contacts individually:</p>';\n      }\n\n      var shareResourceLinkedResearch = '';\n      if (DO.C.User.IRI && DO.C.OriginalResourceInfo['rdftype'] && DO.C.OriginalResourceInfo.rdftype.indexOf(DO.C.Vocab['schemaScholarlyArticle']['@id']) > -1) {\n        shareResourceLinkedResearch = '<li><input id=\"share-resource-linked-research\" type=\"checkbox\" value=\"https://linkedresearch.org/cloud\" /><label for=\"share-resource-linked-research\">Notify <a href=\"https://linkedresearch.org/cloud\">Linked Open Research Cloud</a></label></li>';\n      }\n\n      document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"share-resource\" class=\"do on\">' + DO.C.Button.Close + '<h2>Share resource</h2><div id=\"share-resource-input\"><p>Send a notification about <code>' + iri +'</code></p><ul><li id=\"share-resource-address-book\"></li>' + shareResourceLinkedResearch + '<li><label for=\"share-resource-to\">To</label> <textarea id=\"share-resource-to\" rows=\"2\" cols=\"40\" name=\"share-resource-to\" placeholder=\"WebID or article IRI (one per line)\"></textarea></li><li><label for=\"share-resource-note\">Note</label> <textarea id=\"share-resource-note\" rows=\"2\" cols=\"40\" name=\"share-resource-note\" placeholder=\"Check this out!\"></textarea></li></ul></div><button class=\"share\">Share</button></aside>'));\n\n      var li = document.getElementById('share-resource-address-book');\n\n      if (DO.C.User.Contacts && Object.keys(DO.C.User.Contacts).length > 0) {\n        DO.U.selectContacts(li, DO.C.User.IRI);\n      }\n      else {\n        li.insertAdjacentHTML('beforeend', '<button class=\"add\"' + addContactsButtonDisable + '><i class=\"fa fa-address-book\"></i> Add from contacts</button>' + noContactsText);\n      }\n\n      var shareResource = document.getElementById('share-resource');\n      shareResource.addEventListener('click', function (e) {\n        if (e.target.closest('button.close')) {\n          var rs = document.querySelector('#document-do .resource-share');\n          if (rs) {\n            rs.disabled = false;\n          }\n        }\n\n        if (DO.C.User.IRI && e.target.closest('button.add')) {\n          e.preventDefault();\n          e.stopPropagation();\n          var li = e.target.closest('li');\n          li.insertAdjacentHTML('beforeend', '<i class=\"fa fa-circle-o-notch fa-spin fa-fw\"></i>');\n          DO.U.selectContacts(li, DO.C.User.IRI);\n        }\n\n        if (e.target.closest('button.share')) {\n          var tos = document.querySelector('#share-resource #share-resource-to').value.trim();\n          tos = (tos.length > 0) ? tos.split(/\\r\\n|\\r|\\n/) : [];\n          var note = document.querySelector('#share-resource #share-resource-note').value.trim();\n\n          var ps = document.querySelectorAll('#share-resource-contacts .progress');\n          ps.forEach(function(p){\n            p.parentNode.removeChild(p);\n          });\n\n          var srlr = document.querySelector('#share-resource-linked-research:checked');\n          if(srlr) {\n            tos.push(srlr.value);\n          }\n\n          var srci = document.querySelectorAll('#share-resource-contacts input:checked');\n          if (srci.length > 0) {\n            for(var i = 0; i < srci.length; i++) {\n              tos.push(srci[i].value);\n            }\n          }\n\n          if (!iri) {\n            return\n          }\n\n          // var rm = shareResource.querySelector('.response-message');\n          // if (rm) {\n          //   rm.parentNode.removeChild(rm);\n          // }\n          // shareResource.insertAdjacentHTML('beforeend', '<div class=\"response-message\"></div>');\n\n          return inbox.sendNotifications(tos, note, iri, shareResource)\n        }\n      });\n    },\n\n    selectContacts: function(node, url) {\n      node.innerHTML = '<p>Select from contacts</p><ul id=\"share-resource-contacts\"></ul>';\n      var shareResourceNode = document.getElementById('share-resource-contacts');\n\n      if (DO.C.User.Contacts && Object.keys(DO.C.User.Contacts).length > 0){\n        Object.keys(DO.C.User.Contacts).forEach(function(iri){\n          if (DO.C.User.Contacts[iri].Inbox) {\n            DO.U.addShareResourceContactInput(shareResourceNode, DO.C.User.Contacts[iri].Graph);\n          }\n        });\n      }\n      else {\n        DO.U.updateContactsInfo(url, {'addShareResourceContactInput': shareResourceNode});\n      }\n    },\n\n    updateContactsInfo: function(url, options) {\n      options = options || {};\n\n      return auth.getUserContacts(url).then(\n        function(contacts) {\n          if(contacts.length > 0) {\n            var promises = [];\n\n            var gC = function(url) {\n              return fetcher.getResourceGraph(url).then(i => {\n                // console.log(i);\n                var s = i.child(url);\n\n                DO.C.User.Contacts[url] = {};\n                DO.C.User.Contacts[url]['Graph'] = s;\n\n                var uCO = function(url, s) {\n                  return DO.U.updateContactsOutbox(url, s)\n                    .then(() => {\n                      if ('showOutboxSources' in options) {\n                        return DO.U.showOutboxSources(DO.C.User.Contacts[url].Outbox[0])\n                      }\n                      return Promise.resolve();\n                    })\n                    .catch(() => {})\n                }\n\n                var uCI = function(url, s) {\n                  return DO.U.updateContactsInbox(url, s)\n                    .then(() => {\n                      if ('addShareResourceContactInput' in options) {\n                        DO.U.addShareResourceContactInput(options.addShareResourceContactInput, s);\n                      }\n                      return Promise.resolve();\n                    })\n                    .catch(() => {})\n                }\n\n                //XXX: Holy crap this is fugly.\n                if ('showOutboxSources' in options) {\n                  uCI(url, s);\n                  return uCO(url, s)\n                }\n                else if ('addShareResourceContactInput' in options) {\n                  uCO(url, s)\n                  return uCI(url, s)\n                }\n\n              }).catch(err => {\n// console.log(err)\n                return Promise.resolve();\n              });\n            }\n\n            contacts.forEach(function(url) {\n              promises.push(gC(url))\n            });\n\n            DO.C.User['ContactsOutboxChecked'] = true;\n\n            return Promise.all(promises)\n          }\n          else {\n            if ('addShareResourceContactInput' in options) {\n              options.addShareResourceContactInput.innerHTML = 'No contacts with <i class=\"fa fa-inbox\"></i> inbox found in your profile, but you can enter contacts individually:';\n            }\n\n            return Promise.resolve()\n          }\n        },\n        function(reason) {\nconsole.log(reason);\n        }\n      )\n    },\n\n    addShareResourceContactInput: function(node, s) {\n      var iri = s.iri().toString();\n// console.log(iri.toString());\n      var id = encodeURIComponent(iri);\n      var name = auth.getAgentName(s) || iri;\n      var img = auth.getAgentImage(s);\n      img = (img && img.length > 0) ? '<img alt=\"\" height=\"32\" src=\"' + img + '\" width=\"32\" />' : '';\n      var input = '<li><input id=\"share-resource-contact-' + id + '\" type=\"checkbox\" value=\"' + iri + '\" /><label for=\"share-resource-contact-' + id + '\">' + img + '<a href=\"' + iri + '\" target=\"_blank\">' + name + '</a></label></li>';\n\n      node.insertAdjacentHTML('beforeend', input);\n    },\n\n    updateContactsInbox: function(iri, s) {\n      var checkInbox = function(s) {\n        var aI = auth.getAgentInbox(s);\n\n        if (aI) {\n          return Promise.resolve(aI);\n        }\n        else {\n          return inbox.getEndpointFromHead(DO.C.Vocab['ldpinbox']['@id'], iri);\n        }\n      }\n\n      return checkInbox(s)\n        .then(inboxes => {\n          DO.C.User.Contacts[iri]['Inbox'] = inboxes;\n        })\n    },\n\n    updateContactsOutbox: function(iri, s) {\n      var checkOutbox = function(s) {\n        var outbox = auth.getAgentOutbox(s);\n\n        if (outbox) {\n          return Promise.resolve(outbox)\n        }\n        else {\n          return Promise.reject()\n        }\n      }\n\n      return checkOutbox(s)\n        .then(outboxes => {\n          DO.C.User.Contacts[iri]['Outbox'] = outboxes;\n        })\n    },\n\n    nextLevelButton: function(button, url, id, action) {\n      var actionNode = document.getElementById(id + '-' + action);\n\n      button.addEventListener('click', function(){\n        if(button.parentNode.classList.contains('container')){\n          fetcher.getResourceGraph(url).then(\n            function(g){\n              actionNode.textContent = (action == 'write') ? url + DO.U.generateAttributeId() : url;\n              return DO.U.generateBrowserList(g, url, id, action);\n            },\n            function(reason){\n              var inputBox = document.getElementById(id);\n              switch(reason.slice(-3)) { // TODO: simplerdf needs to pass status codes better than in a string.\n                default:\n                  inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">Unable to access ('+ reason +').</p>');\n                  break;\n                case '404':\n                  inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">Not found.</p></div>');\n                  break;\n                case '401': case '403':\n                  var msg = 'You don\\'t have permission to access this location.';\n                  if(!DO.C.User.IRI){\n                    msg += '</p><p>Try signing in to access your datastore.';\n                  }\n                  inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">' + msg + '</p></div>');\n                  break;\n              }\n            }\n          );\n        }\n        else {\n          document.getElementById(id + '-input').value = url;\n          var alreadyChecked = button.parentNode.querySelector('input[type=\"radio\"]').checked;\n          var radios = button.parentNode.parentNode.querySelectorAll('input[checked=\"true\"]');\n\n          actionNode.textContent =  url;\n\n          for(var i = 0; i < radios.length; i++){\n            radios[i].removeAttribute('checked');\n          }\n          if(alreadyChecked){\n            button.parentNode.querySelector('input[type=\"radio\"]').removeAttribute('checked');\n          }\n          else{\n            button.parentNode.querySelector('input[type=\"radio\"]').setAttribute('checked', 'true');\n          }\n        }\n      }, false);\n    },\n\n    generateBrowserList: function(g, url, id, action) {\n      return new Promise(function(resolve, reject){\n        document.getElementById(id + '-input').value = url;\n\n        var msgs = document.getElementById(id).querySelectorAll('.response-message');\n        for(var i = 0; i < msgs.length; i++){\n          msgs[i].parentNode.removeChild(msgs[i]);\n        }\n\n        var list = document.getElementById(id + '-ul');\n        list.innerHTML = '';\n\n        var urlPath = DO.U.getUrlPath(url);\n        if(urlPath.length > 4){ // This means it's not the base URL\n          urlPath.splice(-2,2);\n          var prevUrl = DO.U.forceTrailingSlash(urlPath.join(\"/\"));\n          var upBtn = '<li class=\"container\"><input type=\"radio\" name=\"containers\" value=\"' + prevUrl + '\" id=\"' + prevUrl + '\" /><label for=\"' + prevUrl + '\" id=\"browser-up\">..</label></li>';\n          list.insertAdjacentHTML('afterbegin', upBtn);\n        }\n\n        var current = g.child(url);\n        var contains = current.ldpcontains;\n        var containersLi = Array();\n        var resourcesLi = Array();\n        contains.forEach(function(c){\n          var cg = g.child(c);\n          var types = cg.rdftype;\n          var resourceTypes = [];\n          types.forEach(function(type){\n            resourceTypes.push(type);\n          });\n\n          var path = DO.U.getUrlPath(c);\n          if(resourceTypes.indexOf('http://www.w3.org/ns/ldp#Container') > -1){\n            var slug = path[path.length-2];\n            containersLi.push('<li class=\"container\"><input type=\"radio\" name=\"resources\" value=\"' + c + '\" id=\"' + slug + '\"/><label for=\"' + slug + '\">' + slug + '</label></li>');\n          }\n          else {\n            var slug = path[path.length-1];\n            resourcesLi.push('<li><input type=\"radio\" name=\"resources\" value=\"' + c + '\" id=\"' + slug + '\"/><label for=\"' + slug + '\">' + slug + '</label></li>');\n          }\n\n        });\n        containersLi.sort(function (a, b) {\n          return a.toLowerCase().localeCompare(b.toLowerCase());\n        });\n        resourcesLi.sort(function (a, b) {\n          return a.toLowerCase().localeCompare(b.toLowerCase());\n        });\n        var liHTML = containersLi.join('\\n') + resourcesLi.join('\\n');\n        list.insertAdjacentHTML('beforeend', liHTML);\n\n        var buttons = list.querySelectorAll('label');\n        if(buttons.length <= 1){\n          list.insertAdjacentHTML('beforeend', '<p><em>(empty)</em></p>');\n        }\n\n        for(var i = 0; i < buttons.length; i++) {\n          var nextUrl = buttons[i].parentNode.querySelector('input').value;\n          DO.U.nextLevelButton(buttons[i], nextUrl, id, action);\n        }\n\n        return resolve(list);\n      });\n    },\n\n    initBrowse: function(storageUrl, input, browseButton, id, action){\n      input.value = storageUrl;\n      fetcher.getResourceGraph(storageUrl).then(function(g){\n        DO.U.generateBrowserList(g, storageUrl, id, action);\n      }).then(function(i){\n        document.getElementById(id + '-' + action).textContent = (action == 'write') ? input.value + DO.U.generateAttributeId() : input.value;\n      });\n\n      browseButton.addEventListener('click', function(){\n        DO.U.triggerBrowse(input.value, id, action);\n      }, false);\n    },\n\n    triggerBrowse: function(url, id, action){\n      var inputBox = document.getElementById(id);\n      if (url.length > 10 && url.match(/^https?:\\/\\//g) && url.slice(-1) == \"/\"){\n        fetcher.getResourceGraph(url).then(function(g){\n          DO.U.generateBrowserList(g, url, id, action).then(function(l){\n            return l;\n          },\n          function(reason){\n            console.log('???? ' + reason); // Probably no reason for it to get to here\n          });\n        },\n        function(reason){\n          var list = document.getElementById(id + '-ul');\n          switch(reason.slice(-3)) { // TODO: simplerdf needs to pass status codes better than in a string.\n            default:\n              inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">Unable to access ('+ reason +').</p>');\n              break;\n            case '404':\n              inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">Not found.</p></div>');\n              break;\n            case '401': case '403':\n              var msg = 'You don\\'t have permission to access this location.';\n              if(!DO.C.User.IRI){\n                msg += '</p><p>Try signing in to access your datastore.';\n              }\n              inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">' + msg + '</p></div>');\n              break;\n          }\n        });\n      }\n      else{\n        inputBox.insertAdjacentHTML('beforeend', '<div class=\"response-message\"><p class=\"error\">This is not a valid location.</p></div>');\n      }\n    },\n\n    setupResourceBrowser: function(parent, id, action){\n      id = id || 'browser-location';\n      action = action || 'write';\n\n      parent.insertAdjacentHTML('beforeend', '<div id=\"' + id + '\"><label for=\"' + id +'-input\">URL</label> <input type=\"text\" id=\"' + id +'-input\" name=\"' + id + '-input\" placeholder=\"https://example.org/path/to/\" /><button id=\"' + id +'-update\" disabled=\"disabled\">Browse</button></div>\\n\\\n      <div id=\"' + id +'-contents\"></div>');\n\n      var inputBox = document.getElementById(id);\n      var storageBox = document.getElementById(id + '-contents');\n      var input = document.getElementById(id + '-input');\n      var browseButton = document.getElementById(id + '-update');\n\n      input.addEventListener('keyup', function(e){\n        var actionNode = document.getElementById(id + '-' + action);\n        if (input.value.length > 10 && input.value.match(/^https?:\\/\\//g) && input.value.slice(-1) == \"/\") {\n          browseButton.removeAttribute('disabled');\n          if(e.which == 13){\n            DO.U.triggerBrowse(input.value, id, action);\n          }\n          if(action){\n            action.textContent = input.value + DO.U.generateAttributeId();\n          }\n        }\n        else {\n          browseButton.disabled = 'disabled';\n          if(actionNode) {\n            actionNode.textContent = input.value;\n          }\n        }\n      }, false);\n\n      var browserul = document.getElementById(id + '-ul');\n      if(!browserul){\n        browserul = document.createElement('ul');\n        browserul.id = id + '-ul';\n\n        storageBox.appendChild(browserul);\n      }\n\n      var storageUrl;\n\n      if(DO.C.User.Storage && DO.C.User.Storage.length > 0) {\n        storageUrl = DO.U.forceTrailingSlash(DO.C.User.Storage[0]); // TODO: options for multiple storage\n      }\n\n      if(storageUrl){\n        DO.U.initBrowse(storageUrl, input, browseButton, id, action);\n      }\n      else {\n        inbox.getEndpoint(DO.C.Vocab['oaannotationService']['@id']).then(\n          function(storageUrl) {\n            DO.U.initBrowse(storageUrl[0], input, browseButton, id, action);\n          },\n          function(){\n            browseButton.addEventListener('click', function(){\n              DO.U.triggerBrowse(input.value, id, action);\n            }, false);\n          }\n        )\n      }\n    },\n\n    showResourceBrowser: function(id, action) {\n      id = id || 'location-' + DO.U.generateAttributeId();\n      action = action || 'write';\n\n      var browserHTML = '<aside id=\"resource-browser-' + id + '\" class=\"do on\">' + DO.C.Button.Close + '<h2>Resource Browser</h2></aside>';\n      document.documentElement.appendChild(DO.U.fragmentFromString(browserHTML));\n\n      DO.U.setupResourceBrowser(document.getElementById('resource-browser-' + id), id, action);\n      document.getElementById('resource-browser-' + id).insertAdjacentHTML('beforeend', '<p><samp id=\"' + id + '-' + action + '\"></samp></p>');\n    },\n\n    openInputFile: function(e) {\n      var file = e.target.files[0];\n// console.log(file);\n      var contentType = file.type;\n\n      var reader = new FileReader();\n      reader.onload = function(){\n// console.log(reader);\n\n        DO.U.spawnDokieli(reader.result, contentType, 'file:' + file.name);\n      };\n      reader.readAsText(file);\n    },\n\n    openDocument: function (e) {\n      if(typeof e !== 'undefined') {\n        e.target.disabled = true;\n      }\n      document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"open-document\" class=\"do on\">' + DO.C.Button.Close + '<h2>Open Document</h2><p><label for=\"open-local-file\">Open local file</label> <input type=\"file\" id=\"open-local-file\" name=\"open-local-file\" /></p></aside>'));\n\n      var id = 'location-open-document';\n      var action = 'read';\n\n      var openDocument = document.getElementById('open-document');\n      DO.U.setupResourceBrowser(openDocument , id, action);\n      var idSamp = (typeof DO.C.User.Storage == 'undefined') ? '' : '<p><samp id=\"' + id + '-' + action + '\">https://example.org/path/to/article</samp></p>';\n      openDocument.insertAdjacentHTML('beforeend', idSamp + '<button class=\"open\">Open</button>');\n\n      openDocument.addEventListener('click', function (e) {\n        if (e.target.closest('button.close')) {\n          document.querySelector('#document-do .resource-open').disabled = false;\n        }\n\n        if (e.target.closest('#open-local-file')){\n          e.target.addEventListener('change', DO.U.openInputFile, false);\n        }\n\n        if (e.target.closest('button.open')) {\n          var openDocument = document.getElementById('open-document');\n          var rm = openDocument.querySelector('.response-message');\n          if (rm) {\n            rm.parentNode.removeChild(rm);\n          }\n\n          var bli = document.getElementById(id + '-input');\n          var iri = bli.value;\n          var headers = { 'Accept': fetcher.setAcceptRDFTypes() };\n          var options = {};\n          var pIRI = uri.getProxyableIRI(iri);\n          if (pIRI.slice(0, 5).toLowerCase() == 'http:') {\n            options['noCredentials'] = true;\n          }\n\n          var handleResource = function handleResource (pIRI, headers, options) {\n            return fetcher.getResource(pIRI, headers, options)\n              .catch(error => {\n                if (error.status === 0) {\n                  // retry with proxied uri\n                  var pIRI = uri.getProxyableIRI(iri, {'forceProxy': true});\n                  return handleResource(pIRI, headers, options);\n                }\n\n                throw error  // else, re-throw the error\n              })\n              .then(response => {\n                var cT = response.headers.get('Content-Type');\n                var contentType = (cT) ? cT.split(';')[0].trim() : 'text/turtle';\n\n                return response.text()\n                  .then(responseText => {\n                    DO.U.spawnDokieli(responseText, contentType, iri);\n                  })\n              })\n          }\n\n          handleResource(pIRI, headers, options);\n        }\n      });\n    },\n\n    spawnDokieli: function(data, contentType, iri){\n      if(DO.C.AvailableMediaTypes.indexOf(contentType) > -1) {\n        var template = document.implementation.createHTMLDocument('template');\n// console.log(template);\n\n        switch(contentType){\n          case 'text/html': case 'application/xhtml+xml':\n            template.documentElement.innerHTML = data;\n            break;\n\n          default:\n            template.documentElement.innerHTML = '<pre>' + data.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';\n            break;\n        }\n\n// console.log(template);\n\n        var documentHasDokieli = template.querySelectorAll('head script[src$=\"/do.js\"]');\n// console.log(documentHasDokieli);\n// console.log(documentHasDokieli.length)\n        if(documentHasDokieli.length == 0) {\n          var doFiles = ['font-awesome.min.css', 'do.css', 'simplerdf.js', 'medium-editor.min.js', 'do.js'];\n          doFiles.forEach(function(i){\n// console.log(i);\n            var media = i.endsWith('.css') ? template.querySelectorAll('head link[rel~=\"stylesheet\"][href$=\"/' + i + '\"]') : template.querySelectorAll('head script[src$=\"/' + i + '\"]');\n// console.log(media);\n// console.log(media.length)\n            if (media.length == 0) {\n              switch(i) {\n                case 'font-awesome.min.css':\n                  template.querySelector('head').insertAdjacentHTML('beforeend', '<link href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\" media=\"all\" rel=\"stylesheet\" />');\n                  break;\n                case 'do.css':\n                  template.querySelector('head').insertAdjacentHTML('beforeend', '<link href=\"https://dokie.li/media/css/' + i + '\" media=\"all\" rel=\"stylesheet\" />');\n                  break;\n                case 'simplerdf.js': case 'medium-editor.min.js': case 'do.js':\n                  template.querySelector('head').insertAdjacentHTML('beforeend', '<script src=\"https://dokie.li/scripts/' + i + '\"></script>')\n                  break;\n              }\n            }\n// console.log(template)\n          });\n\n          var nodes = template.querySelectorAll('head link, [src], object[data]');\n          nodes = DO.U.rewriteBaseURL(nodes, {'baseURLType': 'base-url-absolute', 'iri': iri});\n\n          document.documentElement.removeAttribute('id');\n          document.documentElement.removeAttribute('class');\n        }\n        else if(!iri.startsWith('file:')) {\n          window.open(iri, '_blank');\n          return;\n        }\n\n        document.documentElement.innerHTML = template.documentElement.innerHTML;\n\n// console.log(document.location.protocol);\n        if(!iri.startsWith('file:')){\n          var iriHost = iri.split('//')[1].split('/')[0];\n          var iriProtocol = iri.split('//')[0];\n// console.log(iriHost);\n// console.log(iriProtocol);\n          if(document.location.protocol == iriProtocol && document.location.host == iriHost) {\n            try {\n              history.pushState(null, null, iri);\n            }\n            catch(e) { console.log('Cannot change pushState due to cross-origin.'); }\n          }\n        }\n        DO.U.init();\n      }\n      else {\nconsole.log('//TODO: Handle server returning wrong Response/Content-Type for the Request/Accept');\n      }\n    },\n\n\n    createNewDocument: function createNewDocument (e) {\n      e.target.disabled = true\n      document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"create-new-document\" class=\"do on\">' + DO.C.Button.Close + '<h2>Create New Document</h2></aside>'))\n\n      var newDocument = document.getElementById('create-new-document')\n      newDocument.addEventListener('click', e => {\n        if (e.target.closest('button.close')) {\n          document.querySelector('#document-do .resource-new').disabled = false\n        }\n      })\n\n      var id = 'location-new'\n      var action = 'write'\n\n      DO.U.setupResourceBrowser(newDocument, id, action)\n      document.getElementById(id).insertAdjacentHTML('afterbegin', '<p>Choose a location to save your new article.</p>')\n      var baseURLSelection = (document.location.protocol == 'file:') ? '' : DO.U.getBaseURLSelection()\n\n      newDocument.insertAdjacentHTML('beforeend', baseURLSelection +\n        '<p>Your new document will be saved at <samp id=\"' + id + '-' + action +\n        '\">https://example.org/path/to/article</samp></p><button class=\"create\">Create</button>')\n\n      var bli = document.getElementById(id + '-input')\n      bli.focus()\n      bli.placeholder = 'https://example.org/path/to/article'\n\n      newDocument.addEventListener('click', e => {\n        if (!e.target.closest('button.create')) {\n          return\n        }\n\n        var newDocument = document.getElementById('create-new-document')\n        var storageIRI = newDocument.querySelector('#' + id + '-' + action).innerText.trim()\n        var rm = newDocument.querySelector('.response-message')\n        if (rm) {\n          rm.parentNode.removeChild(rm)\n        }\n\n        var html = document.documentElement.cloneNode(true)\n        var baseURLSelectionChecked = newDocument.querySelector('select[name=\"base-url\"]')\n        // console.log(baseURLSelectionChecked);\n\n        if (baseURLSelectionChecked.length > 0) {\n          var baseURLType = baseURLSelectionChecked.value\n          var nodes = html.querySelectorAll('head link, [src], object[data]')\n          if (baseURLType == 'base-url-relative') {\n            DO.U.copyRelativeResources(storageIRI, nodes)\n          }\n          nodes = DO.U.rewriteBaseURL(nodes, {'baseURLType': baseURLType})\n        }\n\n        if (DO.C.WebExtension)\n          html.querySelector('body').innerHTML = '<main class=\"article\" id=\"content\" about=\"\" typeof=\"schema:Article\"></main>';\n        else\n          html.querySelector('body').innerHTML = '<main><article about=\"\" typeof=\"schema:Article\"></article></main>';\n\n        html.querySelector('head title').innerHTML = ''\n        html = doc.getDocument(html)\n\n        fetcher.putResource(storageIRI, html)\n          .then(() => {\n            var documentMode = (DO.C.WebExtension) ? '' : '?author=true'\n\n            newDocument.insertAdjacentHTML('beforeend',\n              '<div class=\"response-message\"><p class=\"success\">' +\n              'New document created at <a href=\"' + storageIRI +\n              documentMode + '\">' + storageIRI + '</a></p></div>'\n            )\n\n            window.open(storageIRI + documentMode, '_blank')\n          })\n\n          .catch(error => {\n            console.error('Error creating a new document:', error)\n\n            let message\n\n            switch (error.status) {\n              case 0:\n              case 405:\n                message = 'this location is not writable'\n                break\n              case 401:\n              case 403:\n                message = 'you do not have permission to write here'\n                break\n              case 406:\n                message = 'enter a name for your resource'\n                break\n              default:\n                message = error.message\n                break\n            }\n\n            newDocument.insertAdjacentHTML('beforeend',\n              '<div class=\"response-message\"><p class=\"error\">' +\n              'Could not create new document: ' + message + '</p>'\n            )\n          })\n      })\n    },\n\n    saveAsDocument: function saveAsDocument (e) {\n      e.target.disabled = true;\n      document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"save-as-document\" class=\"do on\">' + DO.C.Button.Close + '<h2>Save As Document</h2></aside>'));\n\n      var saveAsDocument = document.getElementById('save-as-document');\n      saveAsDocument.addEventListener('click', function(e) {\n        if (e.target.closest('button.close')) {\n          document.querySelector('#document-do .resource-save-as').disabled = false;\n        }\n      });\n\n      var fieldset = '';\n\n      locationInboxId = 'location-inbox';\n      locationInboxAction = 'read';\n      saveAsDocument.insertAdjacentHTML('beforeend', '<div><input id=\"' + locationInboxId + '-set\" name=\"' + locationInboxId + '-set\" type=\"checkbox\" /> <label for=\"' + locationInboxId + '-set\">Set Inbox</label></div>');\n\n      saveAsDocument.addEventListener('click', function(e) {\n        if (e.target.closest('input#' + locationInboxId + '-set')) {\n          if (e.target.getAttribute('checked')) {\n            e.target.removeAttribute('checked');\n\n            fieldset = saveAsDocument.querySelector('#' + locationInboxId + '-fieldset');\n            fieldset.parentNode.removeChild(fieldset);\n          }\n          else {\n            e.target.setAttribute('checked', 'checked');\n\n            e.target.nextElementSibling.insertAdjacentHTML('afterend', '<fieldset id=\"' + locationInboxId + '-fieldset\"></fieldset>');\n            fieldset = saveAsDocument.querySelector('#' + locationInboxId + '-fieldset');\n            DO.U.setupResourceBrowser(fieldset, locationInboxId, locationInboxAction);\n            fieldset.insertAdjacentHTML('beforeend', '<p>Article\\'s <em>inbox</em> will be set to: <samp id=\"' + locationInboxId + '-' + locationInboxAction + '\"></samp></p>');\n            var lii = document.getElementById(locationInboxId + '-input');\n            lii.focus();\n            lii.placeholder = 'https://example.org/path/to/inbox/';\n          }\n        }\n      });\n\n      locationAnnotationServiceId = 'location-annotation-service';\n      locationAnnotationServiceAction = 'read';\n      saveAsDocument.insertAdjacentHTML('beforeend', '<div><input id=\"' + locationAnnotationServiceId + '-set\" name=\"' + locationAnnotationServiceId + '-set\" type=\"checkbox\" /> <label for=\"' + locationAnnotationServiceId + '-set\">Set Annotation Service</label></div>');\n\n      saveAsDocument.addEventListener('click', function(e) {\n        if (e.target.closest('input#' + locationAnnotationServiceId + '-set')) {\n          if (e.target.getAttribute('checked')) {\n            e.target.removeAttribute('checked');\n\n            fieldset = saveAsDocument.querySelector('#' + locationAnnotationServiceId + '-fieldset');\n            fieldset.parentNode.removeChild(fieldset);\n          }\n          else {\n            e.target.setAttribute('checked', 'checked');\n\n            e.target.nextElementSibling.insertAdjacentHTML('afterend', '<fieldset id=\"' + locationAnnotationServiceId + '-fieldset\"></fieldset>');\n            fieldset = saveAsDocument.querySelector('#' + locationAnnotationServiceId + '-fieldset');\n            DO.U.setupResourceBrowser(fieldset, locationAnnotationServiceId, locationAnnotationServiceAction);\n            fieldset.insertAdjacentHTML('beforeend', '<p>Article\\'s <em>annotation service</em> will be set to: <samp id=\"' + locationAnnotationServiceId + '-' + locationAnnotationServiceAction + '\"></samp></p>');\n            var lasi = document.getElementById(locationAnnotationServiceId + '-input');\n            lasi.focus();\n            lasi.placeholder = 'https://example.org/path/to/annotation/';\n          }\n        }\n      });\n\n      var id = 'location-save-as';\n      var action = 'write';\n      saveAsDocument.insertAdjacentHTML('beforeend', '<fieldset id=\"' + id + '-fieldset\"><legend>Save to</legend></fieldset>');\n      fieldset = saveAsDocument.querySelector('fieldset#' + id + '-fieldset');\n      DO.U.setupResourceBrowser(fieldset, id, action);\n      fieldset.insertAdjacentHTML('beforeend', '<p>Article will be saved at: <samp id=\"' + id + '-' + action + '\"></samp></p>' + DO.U.getBaseURLSelection() + '<p><input type=\"checkbox\" id=\"derivation-data\" name=\"derivation-data\" checked=\"checked\" /><label for=\"derivation-data\">Derivation data</label></p><button class=\"create\">Save</button>');\n      var bli = document.getElementById(id + '-input');\n      bli.focus();\n      bli.placeholder = 'https://example.org/path/to/article';\n\n\n      saveAsDocument.addEventListener('click', e => {\n        if (!e.target.closest('button.create')) {\n          return\n        }\n\n        var currentDocumentURL = uri.stripFragmentFromString(document.location.href)\n        var saveAsDocument = document.getElementById('save-as-document')\n        var storageIRI = saveAsDocument.querySelector('#' + id + '-' + action).innerText.trim()\n\n        var rm = saveAsDocument.querySelector('.response-message')\n        if (rm) {\n          rm.parentNode.removeChild(rm)\n        }\n\n        if(!storageIRI.length) {\n          saveAsDocument.insertAdjacentHTML('beforeend',\n            '<div class=\"response-message\"><p class=\"error\">' +\n            'Specify the location to save the article to, and optionally set its <em>inbox</em> or <em>annotation service</em>.</p></div>'\n          )\n\n          return\n        }\n\n        var html = document.documentElement.cloneNode(true)\n        var o, r\n\n        var wasDerived = document.querySelector('#derivation-data')\n        if (wasDerived.checked) {\n          o = { 'id': 'document-derived-from', 'title': 'Derived From' };\n          r = { 'rel': 'prov:wasDerivedFrom', 'href': currentDocumentURL };\n          html = DO.U.setDocumentRelation(html, [r], o);\n\n          html = DO.U.setDate(html, { 'id': 'document-derived-on', 'property': 'prov:generatedAtTime', 'title': 'Derived On' });\n\n          o = { 'id': 'document-identifier', 'title': 'Identifier' };\n          r = { 'rel': 'owl:sameAs', 'href': storageIRI };\n          html = DO.U.setDocumentRelation(html, [r], o);\n        }\n\n        var inboxLocation = saveAsDocument.querySelector('#' + locationInboxId + '-' + locationInboxAction);\n        if (inboxLocation) {\n          inboxLocation = inboxLocation.innerText.trim();\n          o = { 'id': 'document-inbox', 'title': 'Notifications Inbox' };\n          r = { 'rel': 'ldp:inbox', 'href': inboxLocation };\n          html = DO.U.setDocumentRelation(html, [r], o);\n        }\n\n        var annotationServiceLocation = saveAsDocument.querySelector('#' + locationAnnotationServiceId + '-' + locationAnnotationServiceAction)\n        if (annotationServiceLocation) {\n          annotationServiceLocation = annotationServiceLocation.innerText.trim();\n          o = { 'id': 'document-annotation-service', 'title': 'Annotation Service' };\n          r = { 'rel': 'oa:annotationService', 'href': annotationServiceLocation };\n          html = DO.U.setDocumentRelation(html, [r], o);\n        }\n\n        var baseURLSelectionChecked = saveAsDocument.querySelector('select[name=\"base-url\"]')\n        if (baseURLSelectionChecked.length > 0) {\n          var baseURLType = baseURLSelectionChecked.value\n          var nodes = html.querySelectorAll('head link, [src], object[data]')\n          if (baseURLType == 'base-url-relative') {\n            DO.U.copyRelativeResources(storageIRI, nodes)\n          }\n          nodes = DO.U.rewriteBaseURL(nodes, {'baseURLType': baseURLType})\n        }\n\n        html = doc.getDocument(html)\n\n        var progress = saveAsDocument.querySelector('progress')\n        if(progress) {\n          progress.parentNode.removeChild(progress)\n        }\n        e.target.insertAdjacentHTML('afterend', '<progress min=\"0\" max=\"100\" value=\"0\"></progress>')\n        progress = saveAsDocument.querySelector('progress')\n\n        fetcher.putResource(storageIRI, html, null, null, { 'progress': progress })\n\n          .then(response => {\n            progress.parentNode.removeChild(progress)\n\n            let url = response.url || storageIRI\n\n            var documentMode = (DO.C.WebExtension) ? '' : '?author=true'\n\n            saveAsDocument.insertAdjacentHTML('beforeend',\n              '<div class=\"response-message\"><p class=\"success\">' +\n              'Document saved at <a href=\"' + url + documentMode + '\">' + url + '</a></p></div>'\n            )\n\n            window.open(url + documentMode, '_blank')\n          })\n\n          .catch(error => {\n            console.error('Error saving document', error)\n\n            let message\n\n            switch (error.status) {\n              case 0:\n              case 405:\n                message = 'this location is not writable'\n                break\n              case 401:\n              case 403:\n                message = 'you do not have permission to write here'\n                break\n              case 406:\n                message = 'enter a name for your resource'\n                break\n              default:\n                message = error.message\n                break\n            }\n\n            saveAsDocument.insertAdjacentHTML('beforeend',\n              '<div class=\"response-message\"><p class=\"error\">' +\n              'Unable to save:' + message + '</p></div>'\n            )\n          })\n      })\n    },\n\n    viewSource: function(e) {\n      e.target.disabled = true;\n      document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"source-view\" class=\"do on\">' + DO.C.Button.Close + '<h2>Source</h2><textarea id=\"source-edit\" rows=\"24\" cols=\"80\"></textarea><p><button class=\"create\">Update</button></p></aside>'));\n      var sourceBox = document.getElementById('source-view');\n      var input = document.getElementById('source-edit');\n      input.value = doc.getDocument();\n\n      sourceBox.addEventListener('click', function(e) {\n        if (e.target.closest('button.create')) {\n          var url = window.location.origin + window.location.pathname;\n          var data = document.getElementById('source-edit').value;\n          document.documentElement.innerHTML = data;\n          DO.U.showDocumentInfo();\n          DO.U.showDocumentMenu(e);\n          DO.U.viewSource();\n          document.querySelector('#document-do .resource-source').disabled = true;\n        }\n\n        if (e.target.closest('button.close')) {\n          document.querySelector('#document-do .resource-source').disabled = false;\n        }\n      });\n    },\n\n    getBaseURLSelection: function() {\n      return '<div id=\"base-url-selection\"><label>Location of media resources:</label>\\n\\\n      <select name=\"base-url\">\\n\\\n      <option id=\"base-url-absolute\" value=\"base-url-absolute\" selected=\"selected\">Use references as is</option>\\n\\\n      <option id=\"base-url-relative\" value=\"base-url-relative\">Copy to your storage</option>\\n\\\n      </select>\\n\\\n      </div>';\n    },\n\n    rewriteBaseURL: function(nodes, options) {\n      options = options || {};\n      if (typeof nodes === 'object' && nodes.length > 0) {\n        for (var i = 0; i < nodes.length; i++) {\n          var node = nodes[i];\n          var url, ref;\n          switch(node.tagName.toLowerCase()) {\n            default:\n              url = node.getAttribute('src');\n              ref = 'src';\n              break;\n            case 'link':\n              url = node.getAttribute('href');\n              ref = 'href';\n              break;\n            case 'object':\n              url = node.getAttribute('data');\n              ref = 'data';\n              break;\n          }\n\n          var s = url.split(':')[0];\n          if (s != 'http' && s != 'https' && s != 'file' && s != 'data' && s != 'urn' && document.location.protocol != 'file:') {\n            url = DO.U.setBaseURL(url, options);\n          }\n          else if (url.startsWith('http:') && node.tagName.toLowerCase()) {\n            var proxyURL = ('proxyURL' in options) ? options.proxyURL : DO.C.ProxyURL\n            url = proxyURL + uri.encodeString(url)\n          }\n          node.setAttribute(ref, url);\n        };\n      }\n\n      return nodes;\n    },\n\n    setBaseURL: function(url, options) {\n      options = options || {};\n      var urlType = ('baseURLType' in options) ? options.baseURLType : 'base-url-absolute';\n\n      var matches = [];\n      var regexp = /(https?:\\/\\/([^\\/]*)\\/|file:\\/\\/\\/|data:|urn:|\\/\\/)?(.*)/;\n\n      matches = url.match(regexp);\n\n      if (matches) {\n        switch(urlType) {\n          case 'base-url-absolute': default:\n            if(matches[1] == '//' && 'iri' in options){\n              url = options.iri.split(':')[0] + ':' + url;\n            }\n            else {\n              href = ('iri' in options) ? uri.getProxyableIRI(options.iri) : document.location.href;\n              url = DO.U.getBaseURL(href) + matches[3].replace(/^\\//g, '');\n            }\n            break;\n          case 'base-url-relative':\n            url = matches[3].replace(/^\\//g, '');\n            break;\n        }\n      }\n\n      return url;\n    },\n\n    getBaseURL: function(url) {\n      if(typeof url === 'string') {\n        url = url.substr(0, url.lastIndexOf('/') + 1);\n      }\n\n      return url;\n    },\n\n    getPathURL: function(url) {\n      if(typeof url === 'string') {\n        var i  = url.indexOf('?');\n        if(i > -1) {\n          url = url.substr(0, i);\n        }\n        i = url.indexOf('#');\n        if(i > -1) {\n          url = url.substr(0, i);\n        }\n      }\n\n      return url;\n    },\n\n    copyRelativeResources: function copyRelativeResources (storageIRI, relativeNodes) {\n      var ref = '';\n      var baseURL = DO.U.getBaseURL(storageIRI);\n\n      for (var i = 0; i < relativeNodes.length; i++) {\n        var node = relativeNodes[i];\n        switch(node.tagName.toLowerCase()) {\n          default:\n            ref = 'src';\n            break;\n          case 'link':\n            ref = 'href';\n            break;\n          case 'object':\n            ref = 'data';\n            break;\n        }\n\n        var fromURL = x = node.getAttribute(ref).trim();\n        var pathToFile = '';\n        var s = fromURL.split(':')[0];\n\n        if (s != 'http' && s != 'https' && s != 'file' && s != 'data' && s != 'urn' && s != 'urn') {\n          if (fromURL.startsWith('//')) {\n            fromURL = document.location.protocol + fromURL\n            toURL = baseURL + fromURL.substr(2)\n          }\n          else if (fromURL.startsWith('/')) {\n            pathToFile = DO.U.setBaseURL(fromURL, {'baseURLType': 'base-url-relative'});\n            fromURL = document.location.origin + fromURL\n            toURL = baseURL + pathToFile\n          }\n          else {\n            pathToFile = DO.U.setBaseURL(fromURL, {'baseURLType': 'base-url-relative'});\n            fromURL = DO.U.getBaseURL(document.location.href) + fromURL\n            toURL = baseURL + pathToFile\n          }\n\n          fetcher.copyResource(fromURL, toURL);\n        }\n      };\n    },\n\n    createAttributeDateTime: function(element) {\n      //Creates datetime attribute.\n      //TODO: Include @data-author for the signed in user e.g., WebID or URL.\n      var a = util.getDateTimeISO();\n\n      switch(element) {\n        case 'mark': case 'article':\n          a = 'data-datetime=\"' + a + '\"';\n          break;\n        case 'del': case 'ins':\n          a = 'datetime=\"' + a + '\"';\n          break;\n        default:\n          a = '';\n          break;\n      }\n\n      return a;\n    },\n\n    getCitation: function(i, options) {\n      options = options || {};\n      var iri = i;\n      // if (typeof options !== 'undefined' && 'type' in options && options.type == 'doi') {\n      if (i.toLowerCase().slice(0,4) !== 'http') {\n//        iri = 'http://dx.doi.org/' + i.trim();\n        iri = 'http://data.crossref.org/' + i.trim();\n      }\n      else {\n        var x = iri.toLowerCase().trim().split('/');\n        if (x[2] == 'doi.org' || x[2] == 'dx.doi.org') {\n          var y = x[0] + '//' + x[2] + '/';\n          iri = 'http://data.crossref.org/' + iri.substr(y.length, iri.length);\n        }\n      }\n//console.log(iri);\n\n      return fetcher.getResourceGraph(iri);\n    },\n\n    getCitationHTML: function(citationGraph, citationURI, options) {\n      options = options || {};\n      // var citationId = ('citationId' in options) ? options.citationId : citationURI;\n      var subject = citationGraph.child(citationURI);\n// console.log(citationGraph);\n// console.log('citationGraph.iri().toString(): ' + citationGraph.iri().toString());\n// console.log('citationGraph.toString(): ' + citationGraph.toString());\n// console.log('options.citationId: ' + options.citationId);\n// console.log('citationURI: ' + citationURI);\n// console.log('subject.iri().toString(): ' + subject.iri().toString());\n\n      var title = DO.U.getResourceLabel(subject);\n      //FIXME: This is a stupid hack because RDFa parser is not setting the base properly.\n      if(typeof title == 'undefined') {\n        subject = citationGraph.child(options.citationId);\n\n        title = DO.U.getResourceLabel(subject) || '';\n      }\n      title = title.replace(/ & /g, \" &amp; \");\n      title = (title.length > 0) ? '<cite>' + title + '</cite>, ' : '';\n      var datePublished = subject.schemadatePublished || subject.dctermsissued || subject.dctermsdate || subject.schemadateCreated || subject.dctermscreated || '';\n      var dateVersion = subject.schemadateModified || datePublished;\n      datePublished = (datePublished) ? datePublished.substr(0,4) + ', ' : '';\n      var dateAccessed = 'Accessed: ' + util.getDateTimeISO();\n      var authors = [], authorList = [];\n// console.log(subject);\n// console.log(subject.biboauthorList);\n// console.log(subject.schemaauthor);\n// console.log(subject.dctermscreator);\n\n      //XXX: FIXME: Putting this off for now because SimpleRDF is not finding the bnode for some reason in citationGraph.child(item), or at least authorItem.rdffirst (undefined)\n//       if (subject.biboauthorList) {\n//         var traverseRDFList = function(item) {\n//           var authorItem = citationGraph.child(item);\n// // console.log(authorItem);\n// // console.log(authorItem.iri().toString());\n// // console.log(authorItem.rdffirst);\n// // console.log(authorItem.rdfrest);\n//           if (authorItem.rdffirst) {\n//             authorList.push(authorItem.rdffirst);\n//           }\n//           if (authorItem.rdfrest && authorItem.rdfrest !== 'http://www.w3.org/1999/02/22-rdf-syntax-ns#nil') {\n//             traverseRDFList(authorItem.rdfrest);\n//           }\n//         };\n\n//         traverseRDFList(subject.biboauthorList);\n//       }\n//       else\n      if (subject.schemaauthor && subject.schemaauthor._array.length > 0) {\n        subject.schemaauthor.forEach(function(a) {\n          authorList.push(a);\n        });\n      }\n      else if (subject.dctermscreator && subject.dctermscreator._array.length > 0) {\n        subject.dctermscreator.forEach(function(a) {\n          authorList.push(a);\n        });\n      }\n      else if (subject.asactor && subject.asactor._array.length > 0) {\n        subject.asactor.forEach(function(a) {\n          authorList.push(a);\n        });\n      }\n// console.log(authorList);\n\n      if(authorList.length > 0) {\n        authorList.forEach(function(authorIRI) {\n          var s = subject.child(authorIRI);\n          var author = auth.getAgentName(s);\n\n          if (s.schemafamilyName && s.schemafamilyName.length > 0 && s.schemagivenName && s.schemagivenName.length > 0) {\n            author = DO.U.createRefName(s.schemafamilyName, s.schemagivenName);\n          }\n          else if (s.foaffamilyName && s.foaffamilyName.length > 0 && s.foafgivenName && s.foafgivenName.length > 0) {\n            author = DO.U.createRefName(s.foaffamilyName, s.foafgivenName);\n          }\n\n          if (author !== '') {\n            authors.push(author);\n          }\n          else {\n            authors.push(authorIRI);\n          }\n        });\n        authors = authors.join(', ') + ': ';\n      }\n\n      var dataVersionURL;\n      if (subject.memmemento) {\n        dataVersionURL = subject.memmemento;\n      }\n      else if (subject.rellatestversion) {\n        dataVersionURL = subject.rellatestversion;\n      }\n\n      if (dataVersionURL) {\n        dataVersionURL = ' data-versionurl=\"' + dataVersionURL + '\"';\n      }\n      var dataVersionDate;\n      if (dateVersion) {\n        dataVersionDate = ' data-versiondate=\"' + dateVersion + '\"';\n      }\n\n      var content = ('content' in options && options.content.length > 0) ? options.content + ', ' : '';\n\n      var citationReason = 'Reason: ' + DO.C.Citation[options.citationRelation];\n\n      var citationHTML = authors + title + datePublished + content + '<a about=\"#' + options.refId + '\"' + dataVersionDate + dataVersionURL + ' href=\"' + options.citationId + '\" rel=\"schema:citation ' + options.citationRelation  + '\">' + options.citationId + '</a> [' + dateAccessed + ', ' + citationReason + ']';\n//console.log(citationHTML);\n      return citationHTML;\n    },\n\n    createRefName: function(familyName, givenName, refType) {\n      refType = refType || DO.C.DocRefType;\n      switch(refType) {\n        case 'LNCS': default:\n          return familyName + ', ' + givenName.slice(0,1) + '.';\n          break;\n        case 'ACM':\n          return givenName.slice(0,1) + '. ' + familyName;\n          break;\n        case 'fullName':\n          return givenName + ' ' + familyName;\n          break;\n      }\n    },\n\n    highlightItems: function() {\n      var highlights = document.body.querySelectorAll('*[class*=\"highlight-\"]');\n      for (var i = 0; i < highlights.length; i++) {\n        highlights[i].addEventListener('mouseenter', function(e) {\n          var c = e.target.getAttribute('class').split(' ')\n                    .filter(function(s) { return s.startsWith('highlight-'); });\n          var highlightsX = document.body.querySelectorAll('*[class~=\"'+ c[0] +'\"]');\n          for (var j = 0; j < highlightsX.length; j++) {\n            highlightsX[j].classList.add('do', 'highlight');\n          }\n        });\n\n        highlights[i].addEventListener('mouseleave', function(e) {\n          var c = e.target.getAttribute('class');\n          var c = e.target.getAttribute('class').split(' ')\n                    .filter(function(s) { return s.startsWith('highlight-'); });\n          var highlightsX = document.body.querySelectorAll('*[class~=\"'+ c[0] +'\"]');\n          for (var j = 0; j < highlightsX.length; j++) {\n            highlightsX[j].classList.remove('do', 'highlight');\n          }\n        });\n      }\n    },\n\n    //From http://werxltd.com/wp/2010/05/13/javascript-implementation-of-javas-string-hashcode-method/\n    hashCode: function(s){\n      var hash = 0;\n      if (s.length == 0) return hash;\n      for (i = 0; i < s.length; i++) {\n        var char = s.charCodeAt(i);\n        hash = ((hash<<5)-hash)+char;\n        hash = hash & hash; // Convert to 32bit integer\n      }\n      return hash;\n    },\n\n    generateAttributeId: function(prefix, string) {\n      prefix = prefix || '';\n\n      if (string) {\n        //XXX: I think we want to trim.\n        string = string.trim();\n        string = string.replace(/\\W/g,'-');\n        s1 = string.substr(0, 1);\n        string = (prefix === '' && s1 == parseInt(s1)) ? 'x-' + string : prefix + string;\n        return (document.getElementById(string)) ? string + '-x' : string;\n      }\n      else {\n        return DO.U.generateUUID();\n      }\n    },\n\n    // MIT license\n    // http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript/21963136#21963136\n    generateUUID: function() {\n      var lut = []; for (var i=0; i<256; i++) { lut[i] = (i<16?'0':'')+(i).toString(16); }\n      var s = function() {\n        var d0 = Math.random()*0xffffffff|0;\n        var d1 = Math.random()*0xffffffff|0;\n        var d2 = Math.random()*0xffffffff|0;\n        var d3 = Math.random()*0xffffffff|0;\n        return lut[d0&0xff]+lut[d0>>8&0xff]+lut[d0>>16&0xff]+lut[d0>>24&0xff]+'-'+\n        lut[d1&0xff]+lut[d1>>8&0xff]+'-'+lut[d1>>16&0x0f|0x40]+lut[d1>>24&0xff]+'-'+\n        lut[d2&0x3f|0x80]+lut[d2>>8&0xff]+'-'+lut[d2>>16&0xff]+lut[d2>>24&0xff]+\n        lut[d3&0xff]+lut[d3>>8&0xff]+lut[d3>>16&0xff]+lut[d3>>24&0xff];\n      };\n      return s();\n    },\n\n    //http://stackoverflow.com/a/25214113\n    fragmentFromString: function(strHTML) {\n      return document.createRange().createContextualFragment(strHTML);\n    },\n\n    SPARQLQueryURL: {\n      getResourcesOfTypeWithLabel: function(sparqlEndpoint, resourceType, textInput, options) {\n        options = options || {};\n        var labelsPattern = '', resourcePattern = '';\n\n        if(!('lang' in options)) {\n          options['lang'] = 'en';\n        }\n\n        if ('filter' in options) {\n          if(resourceType == '<http://purl.org/linked-data/cube#DataSet>' || resourceType == 'qb:DataSet'\n            && 'dimensionRefAreaNotation' in options.filter) {\n              var dimensionPattern, dimensionDefault = '';\n              var dataSetPattern = \"\\n\\\n    [] qb:dataSet ?resource\";\n            if ('dimensionProperty' in options.filter) {\n              dimensionPattern = \" ; \" + options.filter.dimensionProperty;\n            }\n            else {\n              var dimensionDefault = \" .\\n\\\n  { SELECT DISTINCT ?propertyRefArea WHERE { ?propertyRefArea rdfs:subPropertyOf* sdmx-dimension:refArea . } }\";\n              dimensionPattern = \" ; ?propertyRefArea \";\n\n            }\n            var notationPattern = \" [ skos:notation '\" + options.filter.dimensionRefAreaNotation.toUpperCase() + \"' ] .\"\n          }\n          resourcePattern = dimensionDefault + dataSetPattern + dimensionPattern + notationPattern;\n        }\n\n        labelsPattern = \"\\n\\\n  \";\n        if ('optional' in options) {\n          if('prefLabels' in options.optional) {\n            if (options.optional.prefLabels.length == 1) {\n              labelsPattern += \"  ?resource \" + options.optional.prefLabels[0] + \" ?prefLabel .\";\n            }\n            else {\n              labelsPattern += \"  VALUES ?labelProperty {\";\n              options.optional.prefLabels.forEach(function(property){\n                labelsPattern += ' ' + property;\n              });\n              labelsPattern += \" } ?resource ?labelProperty ?prefLabel .\";\n            }\n          }\n        }\n        else {\n          labelsPattern += \"  ?resource rdfs:label ?prefLabel .\";\n        }\n\n\n//  FILTER (!STRSTARTS(STR(?resource), 'http://purl.org/linked-data/sdmx/'))\\n\\\n      var query = \"PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\\n\\\nPREFIX skos: <http://www.w3.org/2004/02/skos/core#>\\n\\\nPREFIX dcterms: <http://purl.org/dc/terms/>\\n\\\nPREFIX qb: <http://purl.org/linked-data/cube#>\\n\\\nPREFIX sdmx-dimension: <http://purl.org/linked-data/sdmx/2009/dimension#>\\n\\\nPREFIX sdmx-measure: <http://purl.org/linked-data/sdmx/2009/measure#>\\n\\\nCONSTRUCT {\\n\\\n  ?resource skos:prefLabel ?prefLabel .\\n\\\n}\\n\\\nWHERE {\\n\\\n  ?resource a \" + resourceType + \" .\"\n+ labelsPattern + \"\\n\\\n  FILTER (CONTAINS(LCASE(?prefLabel), '\" + textInput + \"') && (LANG(?prefLabel) = '' || LANGMATCHES(LANG(?prefLabel), '\" + options.lang + \"')))\"\n+ resourcePattern + \"\\n\\\n}\";\n       return sparqlEndpoint + \"?query=\" + uri.encodeString(query);\n      },\n\n      getObservationsWithDimension: function(sparqlEndpoint, dataset, paramDimension, options) {\n        var query = \"PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\\n\\\nPREFIX skos: <http://www.w3.org/2004/02/skos/core#>\\n\\\nPREFIX dcterms: <http://purl.org/dc/terms/>\\n\\\nPREFIX qb: <http://purl.org/linked-data/cube#>\\n\\\nPREFIX sdmx-dimension: <http://purl.org/linked-data/sdmx/2009/dimension#>\\n\\\nPREFIX sdmx-measure: <http://purl.org/linked-data/sdmx/2009/measure#>\\n\\\nCONSTRUCT {\\n\\\n  ?observation sdmx-dimension:refPeriod ?refPeriod .\\n\\\n  ?observation sdmx-measure:obsValue ?obsValue .\\n\\\n}\\n\\\nWHERE {\\n\\\n  ?observation qb:dataSet <\" + dataset + \"> .\\n\\\n  \" + paramDimension + \"\\n\\\n  ?propertyRefPeriod rdfs:subPropertyOf* sdmx-dimension:refPeriod .\\n\\\n  ?observation ?propertyRefPeriod ?refPeriod .\\n\\\n  ?propertyMeasure rdfs:subPropertyOf* sdmx-measure:obsValue .\\n\\\n  ?observation ?propertyMeasure ?obsValue .\\n\\\n}\";\n\n        return sparqlEndpoint + \"?query=\" + uri.encodeString(query);\n      },\n    },\n\n    getSparkline: function(data, options) {\n      options = options || {};\n      if(!('cssStroke' in options)) {\n        options['cssStroke'] = '#333';\n      }\n\n      var svg = '<svg height=\"100%\" prefix=\"rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns# rdfs: http://www.w3.org/2000/01/rdf-schema# xsd: http://www.w3.org/2001/XMLSchema# qb: http://purl.org/linked-data/cube# prov: http://www.w3.org/ns/prov# schema: http://schema.org/\" version=\"1.1\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:ev=\"http://www.w3.org/2001/xml-events\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><style type=\"text/css\">/*<![CDATA[*/line { stroke:' + options.cssStroke + '; stroke-width:1px; } circle { stroke:#f00; fill:#f00; }/*]]>*/</style>';\n\n      svg += DO.U.drawSparklineGraph(data, options);\n      svg += '</svg>';\n\n      return svg;\n    },\n\n    drawSparklineGraph: function(data, options) {\n      options = options || {};\n      if(!('cssStroke' in options)) {\n        options['cssStroke'] = '#333';\n      }\n      var svg= '';\n\n      var obsValue = 'http://purl.org/linked-data/sdmx/2009/measure#obsValue';\n      var observation = 'http://purl.org/linked-data/cube#Observation';\n\n      var dotSize = 1;\n      var values = data.map(function(n) { return n[obsValue]; }),\n        min = Math.min.apply(null, values),\n        max = Math.max.apply(null, values);\n\n      var new_max = 98;\n      var new_min = 0;\n      var range = new_max - new_min;\n\n      var parts = values.map(function (v) {\n        return (new_max - new_min) / (max - min) * (v - min) + new_min || 0;\n      });\n\n      var div = 100 / parts.length;\n      var x1 = 0, y1 = 0, x2 = div / 2, y2 = range - parts[0];\n\n      var lines = '';\n      for (var i=0; i < parts.length; i++) {\n        x1 = x2; y1 = y2;\n        x2 = range * (i / parts.length) + (div / 2);\n        y2 = range - parts[i];\n\n        lines += '<a rel=\"rdfs:seeAlso\" resource=\"' + data[i][observation] + '\" target=\"_blank\" xlink:href=\"' + data[i][observation] + '\"><line' +\n          ' x1=\"' + x1 + '%\"' +\n          ' x2=\"' + x2 + '%\"' +\n          ' y1=\"' + y1 + '%\"' +\n          ' y2=\"' + y2 + '%\"' +\n          ' /></a>';\n\n        //Last data item\n        if(i+1 === parts.length) {\n          lines += '<a target=\"_blank\" xlink:href=\"' + data[i][observation] + '\"><circle' +\n            ' cx=\"' + x2 + '%\"' +\n            ' cy=\"' + y2 + '%\"' +\n            ' r=\"' + dotSize + '\"' +\n            ' /></a>';\n        }\n      }\n\n      var wasDerivedFrom = '';\n      if(options && 'url' in options) {\n        wasDerivedFrom = ' rel=\"prov:wasDerivedFrom\" resource=\"' + options.url + '\"';\n      }\n      svg += '<g' + wasDerivedFrom + '>';\n      svg += '<metadata rel=\"schema:license\" resource=\"https://creativecommons.org/publicdomain/zero/1.0/\" />';\n      if (options && 'title' in options) {\n        svg += '<title property=\"schema:name\">' + options['title'] + '</title>';\n      }\n      svg += lines + '</g>';\n\n      return svg;\n    },\n\n    getTriplesFromGraph: function(url) {\n      return graph.getGraph(url)\n        .then(function(i){\n          return i.graph();\n        })\n        .catch(function(error){\n          // console.log(error);\n          throw error;\n        });\n    },\n\n    sortTriples: function(triples, options) {\n      options = options || {};\n      if(!('sortBy' in options)) {\n        options['sortBy'] = 'object';\n      }\n\n      triples._graph.sort(function (a, b) {\n        return a[options.sortBy].nominalValue.toLowerCase().localeCompare(b[options.sortBy].nominalValue.toLowerCase());\n      });\n\n      return triples;\n    },\n\n    getListHTMLFromTriples: function(triples, options) {\n      options = options || {element: 'ul'};\n      var elementId = ('elementId' in options) ? ' id=\"' + options.elementId + '\"' : '';\n      var elementName = ('elementId' in options) ? ' name=\"' + options.elementId + '\"' : '';\n      var elementTitle = ('elementId' in options) ? options.elementId : '';\n      var items = '';\n      triples.forEach(function(t){\n        var s = t.subject.nominalValue;\n        var o = t.object.nominalValue;\n        switch(options.element) {\n          case 'ol': case 'ul': default:\n            items += '<li><a href=\"' + s + '\">' + o + '</a></li>';\n            break;\n          case 'dl':\n            items += '<dd><a href=\"' + s + '\">' + o + '</a></dd>';\n            break;\n          case 'select':\n            items += '<option value=\"' +   s + '\">' + o + '</option>';\n            break;\n        }\n      });\n\n      switch(options.element) {\n        case 'ul': default:\n          return '<ul' + elementId + '>' + items + '</ul>';\n        case 'ol':\n          return '<ol' + elementId + '>' + items + '</ol>';\n        case 'dl':\n          return '<dl' + elementId + '><dt>' + elementTitle + '</dt>' + items + '</dl>';\n        case 'select':\n          return '<select' + elementId + elementName + '>' + items + '</select>';\n      }\n    },\n\n    showAsTabs: function(id) {\n      document.querySelector('#' + id + ' nav').addEventListener('click', function(e) {\n        var a = e.target;\n        if (a.closest('a')) {\n          e.preventDefault();\n          e.stopPropagation();\n\n          var li = a.parentNode;\n          if(!li.classList.contains('class')) {\n            var navLi = document.querySelectorAll('#' + id + ' nav li');\n            for (var i = 0; i < navLi.length; i++) {\n              navLi[i].classList.remove('selected');\n            }\n            li.classList.add('selected');\n            var figures = document.querySelectorAll('#' + id + ' > figure');\n            for (var i = 0; i < figures.length; i++) {\n              figures[i].classList.remove('selected');\n            }\n            document.querySelector('#' + id + ' > figure' + a.hash).classList.add('selected');\n          }\n        }\n      });\n    },\n\n    getReferenceLabel: function(motivatedBy) {\n      var s = '🗨';\n      motivatedBy = motivatedBy || '';\n      //TODO: uriToPrefix\n      motivatedBy = (motivatedBy.length > 0 && motivatedBy.slice(0, 4) == 'http' && motivatedBy.indexOf('#') > -1) ? 'oa:' + motivatedBy.substr(motivatedBy.lastIndexOf('#') + 1) : motivatedBy;\n\n      switch(motivatedBy) {\n        default: break;\n        case 'oa:assessing':     s = '✪'; break;\n        case 'oa:bookmarking':   s = '🔖'; break;\n        case 'oa:commenting':    s = '🗨'; break;\n        case 'oa:describing':    s = '※'; break;\n        case 'oa:highlighting':  s = '#'; break;        \n        case 'oa:replying':      s = '💬'; break;\n      }\n\n      return s;\n    },\n\n    showRefs: function() {\n      var refs = document.querySelectorAll('span.ref');\n      for (var i = 0; i < refs.length; i++) {\n// console.log(this);\n        var ref = refs[i].querySelector('mark[id]');\n// console.log(ref);\n        if (ref) {\n          var refId = ref.id;\n// console.log(refId);\n          var refA = refs[i].querySelectorAll('[class*=ref-] a');\n// console.log(refA);\n          for (var j = 0; j < refA.length; j++) {\n            //XXX: Assuming this is always an internal anchor?\n            var noteId = refA[j].getAttribute('href').substr(1);\n// console.log(noteId);\n            var refLabel = refA[j].textContent;\n// console.log(refLabel);\n\n// console.log(refId + ' ' +  refLabel + ' ' + noteId);\n            DO.U.positionNote(refId, refLabel, noteId);\n          }\n        }\n      }\n    },\n\n    getTextQuoteHTML: function(refId, exact, docRefType, options){\n      options = options || {};\n\n      var doMode = (options.do) ? ' do' : '';\n\n      return '<span class=\"ref' + doMode + '\" rel=\"schema:hasPart\" resource=\"#' + refId + '\" typeof=\"dctypes:Text\"><mark datatype=\"rdf:HTML\" id=\"'+ refId +'\" property=\"rdf:value\">' + exact + '</mark>' + docRefType + '</span>';\n    },\n\n    positionNote: function(refId, refLabel, noteId) {\n      var ref = document.getElementById(refId);\n      var note = document.getElementById(noteId);\n\n      if (note.hasAttribute('style')) {\n        note.removeAttribute('style');\n      }\n\n      //TODO: If there are articles already in the aside.note , the subsequent top values should come after one another\n      var style = [\n        'top: ' + Math.ceil(ref.parentNode.offsetTop) + 'px'\n      ].join('; ');\n      note.setAttribute('style', style);\n    },\n\n    positionInteraction: function(noteIRI, containerNode) {\n      containerNode = containerNode || document.body;\n\n      return fetcher.getResourceGraph(noteIRI).then(\n        function(g){\n          DO.U.showAnnotation(noteIRI, g, containerNode);\n        });\n    },\n\n    showAnnotation: function(noteIRI, g, containerNode) {\n      containerNode = containerNode || document.body;\n\n      var documentURL = uri.stripFragmentFromString(document.location.href);\n\n      var note = g.child(noteIRI);\n\n      if (note.asobject && note.asobject.at(0)) {\n        note = g.child(note.asobject.at(0))\n      }\n\n      var id = String(Math.abs(DO.U.hashCode(noteIRI)));\n      var refId = 'r-' + id;\n      var refLabel = id;\n\n      var datetime = note.schemadatePublished || note.dctermscreated || note.aspublished;\n// console.log(datetime);\n      var annotatedBy = note.schemacreator || note.dctermscreator || note.asactor;\n      var annotatedByIRI;\n// console.log(annotatedBy);\n      if (annotatedBy && annotatedBy.at(0)) {\n        annotatedByIRI = annotatedBy.at(0);\n// console.log(annotatedByIRI);\n        annotatedBy = g.child(annotatedByIRI);\n// console.log(annotatedBy);\n      }\n      var annotatedByName = auth.getAgentName(annotatedBy);\n// console.log(annotatedByName);\n      var annotatedByImage = auth.getAgentImage(annotatedBy);\n// console.log(annotatedByImage);\n      var annotatedByURL = annotatedBy.schemaurl || '';\n      annotatedByURL = (annotatedByURL) ? annotatedByURL : undefined;\n\n      var licenseIRI = note.schemalicense || note.dctermsrights || undefined;\n// console.log(licenseIRI);\n\n      var motivatedBy = 'oa:replying';\n\n      var bodyText = note.schemadescription;\n      if(!bodyText) {\n        bodyText = note.dctermsdescription;\n        if(!bodyText)  {\n          bodyText = note.ascontent;\n        }\n      }\n\n      var types = note.rdftype;\n// console.log(types);\n      var resourceTypes = [];\n      types.forEach(function(type){\n        resourceTypes.push(type);\n// console.log(type);\n      });\n\n      if(resourceTypes.indexOf('http://www.w3.org/ns/oa#Annotation') > -1) {\n        var body = g.child(note.oahasBody);\n// console.log(body);\n        var bodyLicenseIRI = body.schemalicense || body.dctermsrights || undefined;\n// console.log(bodyLicenseIRI);\n        bodyText = body.rdfvalue;\n// console.log(bodyText);\n\n\n        if (note.oahasTarget && !note.oahasTarget.startsWith(documentURL)) {\n          return Promise.reject();\n        }\n\n        var target = g.child(note.oahasTarget);\n// console.log(target);\n        var targetIRI = target.iri().toString();\n// console.log(targetIRI);\n\n        var source = target.oahasSource;\n// console.log(source);\n// console.log(note.oamotivatedBy);\n\n        if(note.oamotivatedBy) {\n          motivatedBy = note.oamotivatedBy;\n          refLabel = DO.U.getReferenceLabel(motivatedBy);\n        }\n\n        var exact, prefix, suffix;\n        var selector = target.oahasSelector;\n        if(selector) {\n          selector = g.child(selector);\n// console.log(selector);\n\n// console.log(selector.rdftype);\n// console.log(selector.rdftype._array);\n          //FIXME: This is taking the first rdf:type. There could be multiple.\n          var selectorTypes;\n          if (selector.rdftype && selector.rdftype.at(0)) {\n            selectorTypes = selector.rdftype.at(0);\n          }\n// console.log(selectorTypes == 'http://www.w3.org/ns/oa#FragmentSelector');\n          if(selectorTypes == 'http://www.w3.org/ns/oa#TextQuoteSelector') {\n            exact = selector.oaexact;\n            prefix = selector.oaprefix;\n            suffix = selector.oasuffix;\n          }\n          else if (selectorTypes == 'http://www.w3.org/ns/oa#FragmentSelector') {\n            var refinedBy = g.child(selector.oarefinedBy);\n// console.log(refinedBy)\n            exact = refinedBy.oaexact;\n            prefix = refinedBy.oaprefix;\n            suffix = refinedBy.oasuffix;\n// console.log(selector.rdfvalue)\n            if (selector.rdfvalue && selector.rdfvalue !== '' && selector.dctermsconformsTo && selector.dctermsconformsTo.endsWith('://tools.ietf.org/html/rfc3987')) {\n              var fragment = selector.rdfvalue;\n              fragment = (fragment.indexOf == 0) ? uri.getFragmentFromString(fragment) : fragment;\n// console.log(fragment)\n              if (fragment !== '') {\n                containerNode = document.querySelector('#' + selector.rdfvalue) || document;\n              }\n            }\n          }\n        }\n// console.log(exact);\n// console.log(prefix);\n// console.log(suffix);\n// console.log('----')\n        var docRefType = '<sup class=\"ref-annotation\"><a rel=\"cito:hasReplyFrom\" href=\"#' + id + '\" resource=\"' + noteIRI + '\">' + refLabel + '</a></sup>';\n\n        var containerNodeTextContent = containerNode.textContent;\n        //XXX: Seems better?\n        // var containerNodeTextContent = DO.U.fragmentFromString(doc.getDocument(containerNode)).textContent.trim();\n\n//console.log(containerNodeTextContent);\n// console.log(prefix + exact + suffix);\n        var selectorIndex = containerNodeTextContent.indexOf(prefix + exact + suffix);\n// console.log(selectorIndex);\n        if (selectorIndex >= 0) {\n          var selector =  {\n            \"prefix\": prefix,\n            \"exact\": exact,\n            \"suffix\": suffix\n          };\n\n          var selectedParentNode = DO.U.importTextQuoteSelector(containerNode, selector, refId, docRefType, { 'do': true });\n\n          var parentNodeWithId = selectedParentNode.closest('[id]');\n          var targetIRI = (parentNodeWithId) ? documentURL + '#' + parentNodeWithId.id : documentURL;\n\n          var noteData = {\n            \"type\": 'article',\n            \"mode\": \"read\",\n            \"motivatedByIRI\": motivatedBy,\n            \"id\": id,\n            \"refId\": refId,\n            \"iri\": noteIRI, //e.g., https://example.org/path/to/article\n            \"creator\": {},\n            \"datetime\": datetime,\n            \"target\": {\n              \"iri\": targetIRI,\n              \"source\": source,\n              \"selector\": {\n                \"exact\": exact,\n                \"prefix\": prefix,\n                \"suffix\": suffix\n              }\n              //TODO: state\n            },\n            \"body\": bodyText,\n            \"license\": {}\n          }\n          if (annotatedByIRI) {\n            noteData.creator[\"iri\"] = annotatedByIRI;\n          }\n          if (annotatedByName) {\n            noteData.creator[\"name\"] = annotatedByName;\n          }\n          if (annotatedByImage) {\n            noteData.creator[\"image\"] = annotatedByImage;\n          }\n          if (annotatedByURL) {\n            noteData.creator[\"url\"] = annotatedByURL;\n          }\n\n          if (licenseIRI) {\n            noteData.license[\"iri\"] = licenseIRI;\n          }\n// console.log(noteData);\n          var note = DO.U.createNoteDataHTML(noteData);\n          var nES = selectedParentNode.nextElementSibling;\n          var asideNote = '\\n\\\n<aside class=\"note do\">\\n\\\n<blockquote cite=\"' + noteIRI + '\">'+ note + '</blockquote>\\n\\\n</aside>\\n\\\n';\n          var asideNode = DO.U.fragmentFromString(asideNote);\n          var parentSection = MediumEditor.util.getClosestTag(selectedParentNode, 'section')\n          || MediumEditor.util.getClosestTag(selectedParentNode, 'div') || MediumEditor.util.getClosestTag(selectedParentNode, 'article') || MediumEditor.util.getClosestTag(selectedParentNode, 'main') || MediumEditor.util.getClosestTag(selectedParentNode, 'body');\n          parentSection.appendChild(asideNode);\n          //XXX: Keeping this comment around for emergency\n//                selectedParentNode.parentNode.insertBefore(asideNode, selectedParentNode.nextSibling);\n\n          if(DO.C.User.IRI) {\n            var noteDelete = document.querySelector('aside.do blockquote[cite=\"' + noteIRI + '\"] article button.delete');\n            if (noteDelete) {\n              noteDelete.addEventListener('click', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n\n                fetcher.deleteResource(noteIRI)\n                  .then(() => {\n                    var aside = noteDelete.closest('aside.do')\n                    aside.parentNode.removeChild(aside)\n                    var span = document.querySelector('span[about=\"#' + refId + '\"]')\n                    span.outerHTML = span.querySelector('mark').textContent\n                    // TODO: Delete notification or send delete activity\n                  })\n              });\n            }\n          }\n          DO.U.positionNote(refId, refLabel, id);\n\n          //Perhaps return something more useful?\n          return noteIRI;\n        }\n\n        //XXX: Annotation without a selection\n        else {\n          var noteData = {\n            \"type\": 'article',\n            \"mode\": \"read\",\n            \"motivatedByIRI\": motivatedBy,\n            \"id\": id,\n            \"refId\": refId,\n            \"refLabel\": refLabel,\n            \"iri\": noteIRI,\n            \"creator\": {},\n            \"datetime\": datetime,\n            \"target\": {\n              \"iri\": targetIRI\n            },\n            \"body\": bodyText,\n            \"license\": {}\n          };\n\n          if (annotatedByIRI) {\n            noteData.creator[\"iri\"] = annotatedByIRI;\n          }\n          if (annotatedByName) {\n            noteData.creator[\"name\"] = annotatedByName;\n          }\n          if (annotatedByImage) {\n            noteData.creator[\"image\"] = annotatedByImage;\n          }\n          if (licenseIRI) {\n            noteData.license[\"iri\"] = licenseIRI;\n            noteData.license[\"name\"] = DO.C.License[noteData.license[\"iri\"]].name;\n          }\n          if (datetime) {\n            noteData.datetime = datetime;\n          }\n// console.log(noteData)\n          DO.U.addInteraction(noteData);\n        }\n      }\n      else {\n        var inReplyTo, inReplyToRel;\n        if (note.asinReplyTo && note.asinReplyTo.at(0)) {\n          inReplyTo = note.asinReplyTo.at(0);\n          inReplyToRel = 'as:inReplyTo';\n        }\n        else if(note.siocreplyof && note.siocreplyof.at(0)) {\n          inReplyTo = note.siocreplyof.at(0);\n          inReplyToRel = 'sioc:reply_of';\n        }\n\n        if(inReplyTo && inReplyTo.indexOf(window.location.origin + window.location.pathname) >= 0) {\n          var noteData = {\n            \"type\": 'article',\n            \"mode\": \"read\",\n            \"motivatedByIRI\": motivatedBy,\n            \"id\": id,\n            \"refId\": refId,\n            \"refLabel\": refLabel,\n            \"iri\": noteIRI,\n            \"creator\": {},\n            \"inReplyTo\": {\n              'iri': inReplyTo,\n              'rel': inReplyToRel\n            },\n            \"body\": bodyText,\n            \"license\": {}\n          };\n          if (annotatedByIRI) {\n            noteData.creator[\"iri\"] = annotatedByIRI;\n          }\n          if (annotatedByName) {\n            noteData.creator[\"name\"] = annotatedByName;\n          }\n          if (annotatedByImage) {\n            noteData.creator[\"image\"] = annotatedByImage;\n          }\n          if (licenseIRI) {\n            noteData.license[\"iri\"] = licenseIRI;\n          }\n          if (datetime) {\n            noteData.datetime = datetime;\n          }\n          DO.U.addInteraction(noteData);\n        }\n        else {\n          console.log('Source is not an oa:Annotation and it is not a reply to');\n        }\n      }\n    },\n\n    addInteraction: function(noteData) {\n      var interaction = DO.U.createNoteDataHTML(noteData);\n      var interactions = document.getElementById('document-interactions');\n\n      if(!interactions) {\n        interactions = DO.U.selectArticleNode(document);\n        var interactionsSection = '<section id=\"document-interactions\"><h2>Interactions</h2><div>';\n// interactionsSection += '<p class=\"count\"><data about=\"\" datatype=\"xsd:nonNegativeInteger\" property=\"sioc:num_replies\" value=\"' + interactionsCount + '\">' + interactionsCount + '</data> interactions</p>';\n        interactionsSection += '</div></section>';\n        interactions.insertAdjacentHTML('beforeend', interactionsSection);\n      }\n\n      interactions = document.querySelector('#document-interactions > div');\n      interactions.insertAdjacentHTML('beforeend', interaction);\n    },\n\n    getRDFaPrefixHTML: function(prefixes){\n      return Object.keys(prefixes).map(function(i){ return i + ': ' + prefixes[i]; }).join(' ');\n    },\n\n    createHTML: function(title, main, options) {\n      title = title || '';\n      options = options || {};\n      var prefix = ('prefixes' in options && Object.keys(options.prefixes).length > 0) ? ' prefix=\"' + DO.U.getRDFaPrefixHTML(options.prefixes) + '\"' : '';\n\n      return '<!DOCTYPE html>\\n\\\n<html lang=\"en\" xml:lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\">\\n\\\n  <head>\\n\\\n    <meta charset=\"utf-8\" />\\n\\\n    <title>' + title + '</title>\\n\\\n  </head>\\n\\\n  <body' + prefix + '>\\n\\\n    <main>\\n\\\n' + main + '\\n\\\n    </main>\\n\\\n  </body>\\n\\\n</html>\\n\\\n';\n    },\n\n    createActivityHTML: function(o) {\n      var prefixes = ' prefix=\"rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns# schema: http://schema.org/ oa: http://www.w3.org/ns/oa# as: https://www.w3.org/ns/activitystreams#\"';\n\n      var types = '<dt>Types</dt>'\n\n      o.type.forEach(function (t) {\n        types += '<dd><a about=\"\" href=\"' + DO.C.Prefixes[t.split(':')[0]] + t.split(':')[1] + '\" typeof=\"'+ t +'\">' + t.split(':')[1] + '</a></dd>'\n      })\n\n      var asObjectTypes = ''\n      if ('object' in o && 'objectTypes' in o && o.objectTypes.length > 0) {\n        asObjectTypes = '<dl><dt>Types</dt>'\n        o.objectTypes.forEach(function(t){\n          asObjectTypes += '<dd><a about=\"' + o.object + '\" href=\"' + t + '\" typeof=\"'+ t +'\">' + t + '</a></dd>'\n        })\n        asObjectTypes += '</dl>'\n      }\n\n      var asObjectLicense = ''\n      if ('object' in o && 'objectLicense' in o && o.objectLicense.length > 0) {\n        asObjectLicense = '<dl><dt>License</dt><dd><a about=\"' + o.object + '\" href=\"' + o.objectLicense + '\" property=\"schema:license\">' + o.objectLicense + '</a></dd></dl>'\n      }\n\n      var asobject = ('object' in o) ? '<dt>Object</dt><dd><a href=\"' + o.object + '\" property=\"as:object\">' + o.object + '</a>' + asObjectTypes + asObjectLicense + '</dd>' : ''\n\n      var asinReplyTo = ('inReplyTo' in o) ? '<dt>In reply to</dt><dd><a href=\"' + o.inReplyTo + '\" property=\"as:inReplyTo\">' + o.inReplyTo + '</a></dd>' : ''\n\n      var ascontext = ('context' in o && o.context.length > 0) ? '<dt>Context</dt><dd><a href=\"' + o.context + '\" property=\"as:context\">' + o.context + '</a></dd>' : ''\n\n      var astarget = ('target' in o && o.target.length > 0) ? '<dt>Target</dt><dd><a href=\"' + o.target + '\" property=\"as:target\">' + o.target + '</a></dd>' : ''\n\n      var datetime = util.getDateTimeISO()\n      var asupdated = '<dt>Updated</dt><dd><time datetime=\"' + datetime + '\" datatype=\"xsd:dateTime\" property=\"as:updated\" content=\"' + datetime + '\">' + datetime.substr(0,19).replace('T', ' ') + '</time></dd>'\n\n      var assummary = ('summary' in o && o.summary.length > 0) ? '<dt>Summary</dt><dd property=\"as:summary\" datatype=\"rdf:HTML\">' + o.summary + '</dd>' : ''\n\n      var ascontent = ('content' in o && o.content.length > 0) ? '<dt>Content</dt><dd property=\"as:content\" datatype=\"rdf:HTML\">' + o.content + '</dd>' : ''\n\n      var asactor = (DO.C.User.IRI) ? '<dt>Actor</dt><dd><a href=\"' + DO.C.User.IRI + '\" property=\"as:actor\">' + DO.C.User.IRI + '</a></dd>' : ''\n\n      var license = '<dt>License</dt><dd><a href=\"' + DO.C.NotificationLicense + '\" property=\"schema:license\">' + DO.C.NotificationLicense + '</a></dd>'\n\n      var asto = ('to' in o && o.to.length > 0 && !o.to.match(/\\s/g) && o.to.match(/^https?:\\/\\//gi)) ? '<dt>To</dt><dd><a href=\"' + o.to + '\" property=\"as:to\">' + o.to + '</a></dd>' : ''\n\n      var statements = ('statements' in o) ? o.statements : ''\n\n      var dl = [\n        types,\n        asobject,\n        ascontext,\n        astarget,\n        asupdated,\n        assummary,\n        ascontent,\n        asactor,\n        license,\n        asto\n      ].map(function (n) { if (n !== '') { return '      ' + n + '\\n' } }).join('')\n\n\n      // TODO: Come up with a better title. reuse `types` e.g., Activity Created, Announced..\n      var title = 'Notification'\n      if(types.indexOf('as:Announce') > -1){\n        title += ': Announced'\n      } else if (types.indexOf('as:Create') > -1){\n        title += ': Created'\n      } else if (types.indexOf('as:Like') > -1){\n        title += ': Liked'\n      } else if (types.indexOf('as:Dislike') > -1){\n        title += ': Disliked'\n      } else if (types.indexOf('as:Add') > -1){\n        title += ': Added'\n      }\n\n      var data = '<article'+prefixes+'>\\n\\\n  <h1>' + title + '</h1>\\n\\\n  <section>\\n\\\n    <dl about=\"\">\\n\\\n' + dl +\n'    </dl>\\n\\\n  </section>\\n\\\n  <section>\\n\\\n' + statements + '\\n\\\n  </section>\\n\\\n</article>'\n\n      return data\n    },\n\n    createNoteDataHTML: function(n) {\n// console.log(n);\n      var published = '';\n      var license = '';\n      var creator = '', authors = '', creatorImage = '', creatorNameIRI = '', creatorURLNameIRI = '';\n      var hasTarget = '', annotationTextSelector = '', target = '';\n      var heading, hX;\n      var aAbout = '', aPrefix = '';\n      var noteType = '';\n      var body = '';\n      var buttonDelete = '';\n      var note = '';\n      var targetLabel = '';\n      var articleClass = '';\n      var prefixes = ' prefix=\"rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns# schema: http://schema.org/ dcterms: http://purl.org/dc/terms/ oa: http://www.w3.org/ns/oa# as: https://www.w3.org/ns/activitystreams#\"';\n\n      var canonicalId = n.canonical || 'urn:uuid:' + DO.U.generateUUID();\n\n      var motivatedByIRI = n.motivatedByIRI || '';\n      var motivatedByLabel = '';\n      switch(motivatedByIRI) {\n        case 'oa:replying': default:\n          motivatedByIRI = 'oa:replying';\n          motivatedByLabel = 'replies';\n          targetLabel = 'In reply to';\n          aAbout = ('mode' in n && n.mode == 'object') ? '#' + n.id : '';\n          aPrefix = prefixes;\n          break;\n        case 'oa:assessing':\n          motivatedByLabel = 'reviews';\n          targetLabel = 'Review of';\n          aAbout = ('mode' in n && n.mode == 'object') ? '#' + n.id : '';\n          aPrefix = prefixes;\n          break;\n        case 'oa:describing':\n          motivatedByLabel = 'describes';\n          targetLabel = 'Describes';\n          aAbout = '#' + n.id;\n          break;\n        case 'oa:commenting':\n          motivatedByLabel = 'comments';\n          targetLabel = 'Comments on';\n          aAbout = '#' + n.id;\n          break;\n        case 'oa:bookmarking':\n          motivatedByLabel = 'bookmarks';\n          targetLabel = 'Bookmarked';\n          aAbout = ('mode' in n && n.mode == 'object') ? '#' + n.id : '';\n          aPrefix = prefixes;\n          break;\n      }\n\n      switch(n.mode) {\n        default:\n          hX = 3;\n          if ('creator' in n && 'iri' in n.creator && n.creator.iri == DO.C.User.IRI) {\n            buttonDelete = '<button class=\"delete\"><i class=\"fa fa-trash\"></i></button>' ;\n          }\n          articleClass = ' class=\"do\"';\n          break;\n        case 'write':\n          hX = 1;\n          break;\n        case 'object':\n          hX = 2;\n          break;\n      }\n\n      var creatorName = '';\n      var creatorIRI = '#agent';\n      if ('creator' in n) {\n        if ('image' in n.creator) {\n          var img = (n.mode == 'read') ? uri.getProxyableIRI(n.creator.image) : n.creator.image;\n          creatorImage = '<img alt=\"\" height=\"48\" rel=\"schema:image\" src=\"' + img + '\" width=\"48\" /> ';\n        }\n        if('iri' in n.creator) {\n          creatorIRI = n.creator.iri;\n        }\n        if('name' in n.creator) {\n          creatorName = n.creator.name;\n          creatorNameIRI = '<span about=\"' + creatorIRI + '\" property=\"schema:name\">' + creatorName + '</span>';\n        }\n        else {\n          creatorNameIRI = DO.C.SecretAgentNames[Math.floor(Math.random() * DO.C.SecretAgentNames.length)];\n        }\n\n        creatorURLNameIRI = ('url' in n.creator) ? '<a href=\"' + n.creator.url + '\" rel=\"schema:url\">' + creatorNameIRI + '</a>' : '<a href=\"' + creatorIRI + '\">' + creatorNameIRI + '</a>';\n\n        creator = '<span about=\"' + creatorIRI + '\" typeof=\"schema:Person\">' + creatorImage + creatorURLNameIRI + '</span>';\n\n        authors = '<dl class=\"author-name\"><dt>Authors</dt><dd><span rel=\"schema:creator\">' + creator + '</span></dd></dl>';\n      }\n\n      heading = '<h' + hX + ' property=\"schema:name\">' + creatorName + ' <span rel=\"oa:motivatedBy\" resource=\"' + motivatedByIRI + '\">' + motivatedByLabel + '</span></h' + hX + '>';\n\n      if ('datetime' in n && typeof n.datetime !== 'undefined'){\n        var time = '<time datetime=\"' + n.datetime + '\" datatype=\"xsd:dateTime\" property=\"schema:datePublished\" content=\"' + n.datetime + '\">' + n.datetime.substr(0,19).replace('T', ' ') + '</time>';\n        var timeLinked = ('iri' in n) ? '<a href=\"' + n.iri + '\">' + time + '</a>' : time;\n        published = '<dl class=\"published\"><dt>Published</dt><dd>' + timeLinked + '</dd></dl>';\n      }\n\n      if (n.license && 'iri' in n.license) {\n        license = DO.U.createLicenseHTML(n.license);\n      }\n\n      switch(n.type) {\n        case 'article': case 'note': case 'bookmark': case 'approve': case 'disapprove': case 'specificity':\n          if (typeof n.target !== 'undefined' || typeof n.inReplyTo !== 'undefined') { //note, annotation, reply\n            //FIXME: Could resourceIRI be a fragment URI or *make sure* it is the document URL without the fragment?\n            //TODO: Use n.target.iri?\n\n            if (typeof n.body !== 'undefined') {\n              if(typeof n.body === 'object' && 'purpose' in n.body) {\n                if ('describing' in n.body.purpose && 'text' in n.body.purpose.describing) {\n                  body += '<section id=\"note-' + n.id + '\" rel=\"oa:hasBody\" resource=\"#note-' + n.id + '\"><h' + (hX+1) + ' property=\"schema:name\" rel=\"oa:hasPurpose\" resource=\"oa:describing\">Note</h' + (hX+1) + '><div datatype=\"rdf:HTML\" property=\"rdf:value schema:description\" resource=\"#note-' + n.id + '\" typeof=\"oa:TextualBody\">' + n.body.purpose.describing.text + '</div></section>';\n                }\n                if ('tagging' in n.body.purpose && 'text' in n.body.purpose.tagging) {\n                  var tagsArray = [];\n                  n.body.purpose.tagging.text.split(',').forEach(function(i){\n                    var tag = DO.U.htmlEntities(i.trim());\n                    if(tag.length > 0) {\n                      tagsArray.push(tag);\n                    }\n                  });\n                  if (tagsArray.length > 0){\n                    tagsArray = util.uniqueArray(tagsArray);\n\n                    body += '<dl id=\"tags\" class=\"tags\"><dt>Tags</dt><dd><ul rel=\"oa:hasBody\">';\n                    tagsArray.forEach(function(i){\n                      body += '<li about=\"#tag-' + DO.U.generateAttributeId(null, i) + '\" typeof=\"oa:TextualBody\" property=\"rdf:value\" rel=\"oa:hasPurpose\" resource=\"oa:tagging\" datatype=\"rdf:HTML\">' + i + '</li>';\n                    })\n                    body += '</ul></dd></dl>';\n                  }\n                }\n\n              }\n              else if (n.body.length > 0) {\n                if (n.license && 'iri' in n.license) {\n                  license = DO.U.createLicenseHTML(n.license, {rel:'dcterms:rights', label:'Rights'});\n                }\n\n                body += '<section id=\"note-' + n.id + '\" rel=\"oa:hasBody\" resource=\"#note-' + n.id + '\"><h' + (hX+1) + ' property=\"schema:name\">Note</h' + (hX+1) + '>' + license + '<div datatype=\"rdf:HTML\" property=\"rdf:value schema:description\" resource=\"#note-' + n.id + '\" typeof=\"oa:TextualBody\">' + n.body + '</div></section>';\n              }\n            }\n\n            var targetIRI = '';\n            var targetRelation = 'oa:hasTarget';\n            if (typeof n.target !== 'undefined' && 'iri' in n.target) {\n              targetIRI = n.target.iri;\n              var targetIRIFragment = uri.getFragmentFromString(n.target.iri);\n              //TODO: Handle when there is no fragment\n              if (typeof n.target.selector !== 'undefined') {\n                annotationTextSelector = '<div rel=\"oa:hasSelector\" resource=\"#fragment-selector\" typeof=\"oa:FragmentSelector\"><dl class=\"conformsto\"><dt>Fragment selector conforms to</dt><dd><a content=\"' + targetIRIFragment + '\" lang=\"\" property=\"rdf:value\" rel=\"dcterms:conformsTo\" resource=\"https://tools.ietf.org/html/rfc3987\" xml:lang=\"\">RFC 3987</a></dd></dl><dl rel=\"oa:refinedBy\" resource=\"#text-quote-selector\" typeof=\"oa:TextQuoteSelector\"><dt>Refined by</dt><dd><span lang=\"en\" property=\"oa:prefix\" xml:lang=\"en\">' + n.target.selector.prefix + '</span><mark lang=\"en\" property=\"oa:exact\" xml:lang=\"en\">' + n.target.selector.exact + '</mark><span lang=\"en\" property=\"oa:suffix\" xml:lang=\"en\">' + n.target.selector.suffix + '</span></dd></dl></div>';\n              }\n            }\n            else if(typeof n.inReplyTo !== 'undefined' && 'iri' in n.inReplyTo) {\n              targetIRI = n.inReplyTo.iri;\n              targetRelation = ('rel' in n.inReplyTo) ? n.inReplyTo.rel : 'as:inReplyTo';\n              // TODO: pass document title and maybe author so they can be displayed on the reply too.\n            }\n\n            hasTarget = '<a href=\"' + targetIRI + '\" rel=\"' + targetRelation + '\">' + targetLabel + '</a>';\n            if (typeof n.target !== 'undefined' && typeof n.target.source !== 'undefined') {\n              hasTarget += ' (<a about=\"' + n.target.iri + '\" href=\"' + n.target.source +'\" rel=\"oa:hasSource\" typeof=\"oa:SpecificResource\">part of</a>)';\n            }\n\n            target ='<dl class=\"target\"><dt>' + hasTarget + '</dt>';\n            if (typeof n.target !== 'undefined' && typeof n.target.selector !== 'undefined') {\n              target += '<dd><blockquote about=\"' + targetIRI + '\" cite=\"' + targetIRI + '\">' + annotationTextSelector + '</blockquote></dd>';\n            }\n            target += '</dl>';\n\n            target += '<dl class=\"renderedvia\"><dt>Rendered via</dt><dd><a about=\"' + targetIRI + '\" href=\"https://dokie.li/\" rel=\"oa:renderedVia\">dokieli</a></dd></dl>';\n\n            var canonical = '<dl class=\"canonical\"><dt>Canonical</dt><dd rel=\"oa:canonical\" resource=\"' + canonicalId + '\">' + canonicalId + '</dd></dl>';\n\n            note = '<article about=\"' + aAbout + '\" id=\"' + n.id + '\" typeof=\"oa:Annotation' + noteType + '\"' + aPrefix + articleClass + '>'+buttonDelete+'\\n\\\n  ' + heading + '\\n\\\n  ' + authors + '\\n\\\n  ' + published + '\\n\\\n  ' + license + '\\n\\\n  ' + canonical + '\\n\\\n  ' + target + '\\n\\\n  ' + body + '\\n\\\n</article>';\n          }\n          break;\n\n        case 'ref-footnote':\n          var citationURL = (typeof n.citationURL !== 'undefined' && n.citationURL != '') ? '<a href=\"' + n.citationURL + '\" rel=\"rdfs:seeAlso\">' + n.citationURL + '</a>' : '';\n          var body = (typeof n.body !== 'undefined' && n.body != '') ? ((citationURL) ? ', ' + n.body : n.body) : '';\n\n          note = '\\n\\\n<dl about=\"#' + n.id +'\" id=\"' + n.id +'\" typeof=\"oa:Annotation\">\\n\\\n  <dt><a href=\"#' + n.refId + '\" rel=\"oa:hasTarget\">' + n.refLabel + '</a><meta rel=\"oa:motivation\" resource=\"' + motivatedByIRI + '\" /></dt>\\n\\\n  <dd rel=\"oa:hasBody\" resource=\"#n-' + n.id + '\"><div datatype=\"rdf:HTML\" property=\"rdf:value\" resource=\"#n-' + n.id + '\" typeof=\"oa:TextualBody\">' + citationURL + body + '</div></dd>\\n\\\n</dl>\\n\\\n';\n          break;\n\n        default:\n          break;\n      }\n\n      return note;\n    },\n\n    createLicenseHTML: function(n, options) {\n      var license = '';\n      var rel = (options && options.rel) ? options.rel : 'schema:license';\n      var label = (options && options.label) ? options.label : 'License';\n\n      if (typeof n.iri !== 'undefined') {\n        license = '<dl class=\"' + label.toLowerCase() + '\"><dt>' + label + '</dt><dd>';\n        if('name' in n) {\n          var title = ('description' in n) ? ' title=\"' + n.description + '\"' : '';\n          license += '<a href=\"' + n.iri + '\" rel=\"' + rel + '\"' + title + '>' + n.name + '</a>';\n        }\n        else {\n          var licenseName = n.iri, licenseDescription = n.iri;\n          if (n.iri in DO.C.License) {\n            licenseName = DO.C.License[n.iri].name;\n            licenseDescription = DO.C.License[n.iri].description;\n          }\n          license += '<a href=\"' + n.iri + '\" rel=\"' + rel + '\" title=\"' + licenseDescription + '\">' + licenseName + '</a>';\n        }\n        license += '</dd></dl>';\n      }\n\n      return license;\n    },\n\n    createRDFaHTML: function(r, mode) {\n      var s = '', about = '', property = '', rel = '', resource = '', href = '', content = '', langDatatype = '', typeOf = '', idValue = '', id = '';\n\n      if ('rel' in r && r.rel != '') {\n        rel = ' rel=\"' + r.rel + '\"';\n      }\n\n      if ('href' in r && r.href != '') {\n        href = ' href=\"' + r.href + '\"';\n      }\n\n      if(mode == 'expanded') {\n        idValue = DO.U.generateAttributeId();\n        id = ' id=\"' + idValue + '\"';\n\n        if ('about' in r && r.about != '') {\n          about = ' about=\"' + r.about + '\"';\n        }\n        else {\n          about = ' about=\"#' + idValue + '\"';\n        }\n\n        if ('property' in r && r.property != '') {\n          property = ' property=\"' + r.property + '\"';\n        }\n        else {\n          //TODO: Figure out how to use user's preferred vocabulary.\n          property = ' property=\"rdfs:label\"';\n        }\n\n        if ('resource' in r && r.resource != '') {\n          resource = ' resource=\"' + r.resource + '\"';\n        }\n\n        if ('content' in r && r.content != '') {\n          content = ' content=\"' + r.content + '\"';\n        }\n\n        if ('lang' in r && r.lang != '') {\n          langDatatype = ' xml:lang=\"' + r.lang + '\" lang=\"' + r.lang + '\"';\n        }\n        else {\n          if ('datatype' in r && r.datatype != '') {\n            langDatatype = ' datatype=\"' + r.datatype + '\"';\n          }\n        }\n\n        if ('typeOf' in r && r.typeOf != '') {\n          typeOf = ' typeof=\"' + r.typeOf + '\"';\n        }\n      }\n\n      var element = ('datatype' in r && r.datatype == 'xsd:dateTime') ? 'time' : ((href == '') ? 'span' : 'a');\n      var textContent = r.textContent || r.href || '';\n\n      s = '<' + element + about + content + href + id + langDatatype + property + rel + resource + typeOf + '>' + textContent + '</' + element + '>';\n\n      return s;\n    },\n\n    getAnnotationLocationHTML: function() {\n      var s = '', inputs = [], checked = '';\n      if(typeof DO.C.AnnotationService !== 'undefined') {\n        if (DO.C.User.Storage && DO.C.User.Storage.length > 0 || DO.C.User.Outbox && DO.C.User.Outbox.length > 0) {\n          if (DO.C.User.UI && DO.C.User.UI['annotationLocationService'] && DO.C.User.UI.annotationLocationService['checked']) {\n            checked = ' checked=\"checked\"';\n          }\n        }\n        else {\n          checked = ' checked=\"checked\" disabled=\"disabled\"';\n        }\n\n        inputs.push('<input type=\"checkbox\" id=\"annotation-location-service\" name=\"annotation-location-service\"' + checked + ' /><label for=\"annotation-location-service\">Annotation service</label>');\n      }\n\n      checked = ' checked=\"checked\"';\n      if(DO.C.User.Storage && DO.C.User.Storage.length > 0 || DO.C.User.Outbox && DO.C.User.Outbox.length > 0) {\n        if (DO.C.User.UI && DO.C.User.UI['annotationLocationPersonalStorage'] && !DO.C.User.UI.annotationLocationPersonalStorage['checked']) {\n            checked = '';\n        }\n\n        inputs.push('<input type=\"checkbox\" id=\"annotation-location-personal-storage\" name=\"annotation-location-personal-storage\"' + checked + ' /><label for=\"annotation-location-personal-storage\">Personal storage</label>');\n      }\n      s = 'Store at: ' + inputs.join('');\n      return s;\n    },\n\n    getPublicationStatusOptionsHTML: function(options) {\n      options = options || {};\n      var s = '', selectedIRI = '';\n\n      if ('selected' in options) {\n        selectedIRI = options.selected;\n        if (selectedIRI == '') {\n          s += '<option selected=\"selected\" value=\"\">Choose a publication status</option>';\n        }\n      }\n      else {\n        selectedIRI = DO.C.Vocab['psodraft']['@id'];\n      }\n\n      Object.keys(DO.C.PublicationStatus).forEach(function(iri){\n        var selected = (iri == selectedIRI) ? ' selected=\"selected\"' : '';\n        s += '<option value=\"' + iri + '\" title=\"' + DO.C.PublicationStatus[iri].description  + '\"' + selected + '>' + DO.C.PublicationStatus[iri].name  + '</option>';\n      })\n\n      return s;\n    },\n\n    getLicenseOptionsHTML: function(options) {\n      options = options || {};\n      var s = '', selectedIRI = '';\n\n      if ('selected' in options) {\n        selectedIRI = options.selected;\n        if (selectedIRI == '') {\n          s += '<option selected=\"selected\" value=\"\">Choose a license</option>';\n        }\n      }\n      else if(typeof DO.C.User.UI.License !== 'undefined') {\n        selectedIRI = DO.C.User.UI.License;\n      }\n      else {\n        selectedIRI = 'https://creativecommons.org/licenses/by/4.0/';\n      }\n\n      Object.keys(DO.C.License).forEach(function(iri){\n        if(iri != 'NoLicense') {\n          var selected = (iri == selectedIRI) ? ' selected=\"selected\"' : '';\n          s += '<option value=\"' + iri + '\" title=\"' + DO.C.License[iri].description  + '\"' + selected + '>' + DO.C.License[iri].name  + '</option>';\n        }\n      })\n\n      return s;\n    },\n\n    getCitationOptionsHTML: function(type) {\n      var type = type || 'cites';\n\n      var s = '';\n      Object.keys(DO.C.Citation).forEach(function(iri){\n        s += '<option value=\"' + iri + '\">' + DO.C.Citation[iri]  + '</option>';\n      })\n\n      return s;\n    },\n\n    initMath: function(config) {\n      if (!DO.C.MathAvailable) { return; }\n\n      config = config || {\n        skipTags: [\"script\",\"noscript\",\"style\",\"textarea\",\"pre\",\"code\", \"math\"],\n        ignoreClass: \"equation\",\n        MathML: {\n          useMathMLspacing: true\n        },\n        tex2jax: {\n          inlineMath: [[\"$\",\"$\"],[\"\\\\(\",\"\\\\)\"]],\n          processEscapes: true\n        },\n        asciimath2jax: {\n          delimiters: [['$','$'], ['`','`']]\n        }\n      }\n\n      MathJax.Hub.Config(config);\n\n      MathJax.Hub.Register.StartupHook(\"End Jax\",function () {\n        var BROWSER = MathJax.Hub.Browser;\n        var jax = \"SVG\";\n        if (BROWSER.isMSIE && BROWSER.hasMathPlayer) jax = \"NativeMML\";\n        if (BROWSER.isFirefox) jax = \"NativeMML\";\n        if (BROWSER.isSafari && BROWSER.versionAtLeast(\"5.0\")) jax = \"NativeMML\";\n\n        MathJax.Hub.setRenderer(jax);\n      });\n    },\n\n    setDocumentRelation: function(rootNode, data, options) {\n      rootNode = rootNode || document;\n      if(!data || !options) { return; }\n\n      var h = [];\n\n      var dl = rootNode.querySelector('#' + options.id);\n\n      data.forEach(function(d){\n        var documentRelation = '<dd>' + DO.U.createRDFaHTML(d) + '</dd>';\n\n        if(dl) {\n          if (DO.C.DocumentItems.indexOf(options.id) > -1) {\n            dd = dl.querySelector('dd');\n            dl.removeChild(dd);\n          }\n          else {\n            var relation = dl.querySelector('[rel=\"' + d.rel +  '\"][href=\"' + d.href  + '\"]');\n\n            if(relation) {\n              dd = relation.closest('dd');\n              if(dd) {\n                dl.removeChild(dd);\n              }\n            }\n          }\n          dl.insertAdjacentHTML('beforeend', documentRelation);\n        }\n        else {\n          h.push(documentRelation);\n        }\n      });\n\n      if(h.length > 0) {\n        var html = '<dl id=\"' + options.id + '\"><dt>' + options.title + '</dt>' + h.join('') + '</dl>';\n        rootNode = DO.U.insertDocumentLevelHTML(rootNode, html, { 'id': options.id });\n      }\n\n      return rootNode;\n    },\n\n    setEditSelections: function(options) {\n      var options = options || {};\n\n      if (!('datetime' in options)) {\n        options['datetime'] = new Date();\n      }\n\n      var documentLicense = 'document-license';\n      var dLS = document.querySelector('#' + documentLicense + ' option:checked');\n\n      if (dLS) {\n        var licenseIRI = dLS.value;\n\n        var dl = dLS.closest('#' + documentLicense);\n        dl.removeAttribute('contenteditable');\n\n        if(licenseIRI == '') {\n          dl.parentNode.removeChild(dl);\n        }\n        else {\n          dl.removeAttribute('class');\n          var dd = dLS.closest('dd');\n          dd.parentNode.removeChild(dd);\n          dd = '<dd><a href=\"' + licenseIRI+ '\" rel=\"schema:license\" title=\"' + DO.C.License[licenseIRI].description + '\">' + DO.C.License[licenseIRI].name + '</a></dd>';\n          dl.insertAdjacentHTML('beforeend', dd);\n        }\n      }\n\n\n      var documentStatus = 'document-status';\n      var dLS = document.querySelector('#' + documentStatus + ' option:checked');\n\n      if (dLS) {\n        var statusIRI = dLS.value;\n\n        var dl = dLS.closest('#' + documentStatus);\n        dl.removeAttribute('contenteditable');\n\n        if(statusIRI == '') {\n          dl.parentNode.removeChild(dl);\n        }\n        else {\n          dl.removeAttribute('class');\n          var dd = dLS.closest('dd');\n          dd.parentNode.removeChild(dd);\n          dd = '<dd prefix=\"pso: http://purl.org/spar/pso/\" rel=\"pso:holdsStatusInTime\" resource=\"#' + DO.U.generateAttributeId() + '\"><span rel=\"pso:withStatus\" resource=\"' + statusIRI  + '\" typeof=\"pso:PublicationStatus\">' + DO.C.PublicationStatus[statusIRI].name + '</span></dd>';\n\n          dl.insertAdjacentHTML('beforeend', dd);\n\n          if (statusIRI == 'http://purl.org/spar/pso/published') {\n            DO.U.setDate(document, { 'id': 'document-published', 'property': 'schema:datePublished', 'title': 'Published', 'datetime': options.datetime });\n          }\n        }\n      }\n    },\n\n    setDate: function(rootNode, options) {\n      rootNode = rootNode || document;\n      options = options || {};\n\n      var title = ('title' in options) ? options.title : 'Created';\n\n      var id = (options.id) ? options.id : 'document-' + title.toLowerCase().replace(/\\W/g, '-');\n\n      var node = ('property' in options) ? rootNode.querySelector('#' + id + ' [property=\"' + options.property + '\"]') : rootNode.querySelector('#' + id + ' time');\n\n      if(node) {\n        var datetime = ('datetime' in options) ? options.datetime.toISOString() : util.getDateTimeISO();\n\n        if(node.getAttribute('datetime')) {\n          node.setAttribute('datetime', datetime);\n        }\n        if(node.getAttribute('content')) {\n          node.setAttribute('content', datetime);\n        }\n        node.textContent = datetime.substr(0, datetime.indexOf('T'));\n      }\n      else {\n        rootNode = DO.U.insertDocumentLevelHTML(rootNode, DO.U.createDateHTML(options), { 'id': id });\n      }\n\n      return rootNode;\n    },\n\n    createDateHTML: function(options) {\n      options = options || {};\n\n      var title = ('title' in options) ? options.title : 'Created';\n\n      var id = ('id' in options && options.id.length > 0) ? ' id=\"' + options.id + '\"' : ' id=\"document-' + title.toLowerCase().replace(/\\W/g, '-') + '\"';\n\n      var c = ('class' in options && options.class.length > 0) ? ' class=\"' + options.class + '\"' : '';\n\n      var datetime = ('datetime' in options) ? options.datetime.toISOString() : util.getDateTimeISO();\n      var datetimeLabel = datetime.substr(0, datetime.indexOf('T'));\n\n      var time = ('property' in options)\n        ? '<time content=\"' + datetime + '\" datatype=\"xsd:dateTime\" datetime=\"' + datetime + '\" property=\"' + options.property + '\">' + datetimeLabel + '</time>'\n        : '<time datetime=\"' + datetime + '\">' + datetimeLabel + '</time>';\n\n      var date = '        <dl'+c+id+'>\\n\\\n          <dt>' + title + '</dt>\\n\\\n          <dd>' + time + '</dd>\\n\\\n        </dl>\\n\\\n';\n\n      return date;\n    },\n\n    getResourceInfo: function(data, options) {\n      data = data || doc.getDocument();\n\n      var info = {\n        'state': DO.C.Vocab['ldpRDFSource']['@id'],\n        'profile': DO.C.Vocab['ldpRDFSource']['@id']\n      };\n\n      options = options || {};\n\n      options['contentType'] = ('contentType' in options) ? options.contentType : 'text/html';\n      options['subjectURI'] = ('subjectURI' in options) ? options.subjectURI : uri.stripFragmentFromString(document.location.href);\n\n      return graph.getGraphFromData(data, options).then(\n        function(i){\n          var s = SimpleRDF(DO.C.Vocab, options['subjectURI'], i, ld.store).child(options['subjectURI']);\n// console.log(s);\n\n          info['rdftype'] = s.rdftype._array;\n          info['profile'] = DO.C.Vocab['ldpRDFSource']['@id'];\n\n          //Check if the resource is immutable\n          s.rdftype.forEach(function(resource) {\n            if (resource == DO.C.Vocab['ldpImmutableResource']['@id']) {\n              info['state'] = DO.C.Vocab['ldpImmutableResource']['@id'];\n            }\n          });\n\n          if (s.reloriginal) {\n            info['state'] = DO.C.Vocab['ldpImmutableResource']['@id'];\n            info['original'] = s.memoriginal;\n\n            if (s.reloriginal == options['subjectURI']) {\n              //URI-R (The Original Resource is a Fixed Resource)\n\n              info['profile'] = DO.C.Vocab['memOriginalResource']['@id'];\n            }\n            else {\n              //URI-M\n  \n              info['profile'] = DO.C.Vocab['memMemento']['@id'];\n            }\n          }\n\n          if (s.memmemento) {\n            //URI-R\n\n            info['profile'] = DO.C.Vocab['memOriginalResource']['@id'];\n            info['memento'] = s.memmemento;\n          }\n\n          if(s.memoriginal && s.memmemento && s.memoriginal != s.memmemento) {\n            //URI-M (Memento without a TimeGate)\n\n            info['profile'] = DO.C.Vocab['memMemento']['@id'];\n            info['original'] = s.memoriginal;\n            info['memento'] = s.memmement;\n          }\n\n          if(s.rellatestversion) {\n            info['latest-version'] = s.rellatestversion;\n          }\n\n          if(s.relpredecessorversion) {\n            info['predecessor-version'] = s.relpredecessorversion;\n          }\n\n          if(s.memtimemap) {\n            info['timemap'] = s.memtimemap;\n          }\n\n          if(s.memtimegate) {\n            info['timegate'] = s.memtimegate;\n          }\n\n// console.log(info);\n\n          if(!DO.C.OriginalResourceInfo || ('mode' in options && options.mode == 'update' )) {\n            DO.C['OriginalResourceInfo'] = info;\n          }\n\n          DO.C['ResourceInfo'] = info;\n\n          return info;\n      });\n    },\n\n    Editor: {\n      disableEditor: function(e) {\n    //    _mediumEditors[1].destroy();\n        DO.C.EditorEnabled = false;\n        document.removeEventListener('click', DO.U.updateDocumentTitle);\n        return DO.U.Editor.MediumEditor.destroy();\n      },\n\n      enableEditor: function(editorMode, e, selector) {\n        if (typeof DO.U.Editor.MediumEditor !== 'undefined') {\n          DO.U.Editor.disableEditor();\n        }\n\n        if (!document.getElementById('document-editor')) {\n          document.documentElement.appendChild(DO.U.fragmentFromString('<aside id=\"document-editor\" class=\"do\"></aside>'))\n        }\n\n        var editorOptions = {\n          author: {\n            id: 'author',\n            elementsContainer: document.getElementById('document-editor'),\n            placeholder: {\n              text: [\"Make it so!\", \"This is not a Paper\", \"Cogito Ergo Sum\", \"Do One Thing and Do It Well\", \"Free Your Mind\", \"Do or Do Not\"][Math.floor(Math.random() * 6)]\n            },\n            disableDoubleReturn: true,\n            paste: {\n              forcePlainText: false,\n              cleanPastedHTML: true,\n              cleanReplacements: [],\n              cleanAttrs: ['class', 'style', 'dir'],\n              cleanTags: ['area', 'basefont', 'br', 'font', 'hr', 'isindex', 'link', 'script', 'style', 'wbr']\n            },\n            buttonLabels: DO.C.Editor.ButtonLabelType,\n            toolbar: {\n              buttons: ['h2', 'h3', 'h4', 'em', 'strong', 'orderedlist', 'unorderedlist', 'code', 'pre', 'image', 'anchor', 'q', 'sparkline', 'rdfa', 'cite', 'note'],\n              diffLeft: 0,\n              diffTop: -10,\n              allowMultiParagraphSelection: false\n            },\n            anchorPreview: false,\n            extensions: {\n              'h2': new DO.U.Editor.Button({action:'h2', label:'h2'}),\n              'h3': new DO.U.Editor.Button({action:'h3', label:'h3'}),\n              'h4': new DO.U.Editor.Button({action:'h4', label:'h4'}),\n              'em': new DO.U.Editor.Button({action:'em', label:'em'}),\n              'strong': new DO.U.Editor.Button({action:'strong', label:'strong'}),\n              'code': new DO.U.Editor.Button({action:'code', label:'code'}),\n              'q': new DO.U.Editor.Button({action:'q', label:'q'}),\n              'sparkline': new DO.U.Editor.Note({action:'sparkline', label:'sparkline'}),\n              'rdfa': new DO.U.Editor.Note({action:'rdfa', label:'rdfa'}),\n              'cite': new DO.U.Editor.Note({action:'cite', label:'cite'}),\n              'note': new DO.U.Editor.Note({action:'note', label:'note'})\n            }\n          },\n\n          social: {\n            id: 'social',\n            elementsContainer: document.getElementById('document-editor'),\n            buttonLabels: DO.C.Editor.ButtonLabelType,\n            toolbar: {\n              buttons: ['selector', 'share', 'approve', 'bookmark', 'note'],\n              allowMultiParagraphSelection: false\n            },\n            disableEditing: true,\n            anchorPreview: false,\n            extensions: {\n              'selector': new DO.U.Editor.Note({action:'selector', label:'selector'}),\n              'note': new DO.U.Editor.Note({action:'article', label:'note'}),\n              'bookmark': new DO.U.Editor.Note({action:'bookmark', label:'bookmark'}),\n              'share': new DO.U.Editor.Note({action:'share', label:'share'}),\n              'approve': new DO.U.Editor.Note({action:'approve', label:'approve'})\n            }\n          },\n\n          review: {\n            id: 'review',\n            elementsContainer: document.getElementById('document-editor'),\n            buttonLabels: DO.C.Editor.ButtonLabelType,\n            toolbar: {\n              buttons: ['approve', 'disapprove', 'specificity'],\n              allowMultiParagraphSelection: false\n            },\n            disableEditing: true,\n            anchorPreview: false,\n            extensions: {\n              'approve': new DO.U.Editor.Note({action:'approve', label:'approve'}),\n              'disapprove': new DO.U.Editor.Note({action:'disapprove', label:'disapprove'}),\n              'specificity': new DO.U.Editor.Note({action:'specificity', label:'specificity'})\n            }\n          }\n        };\n\n        if('MathJax' in window) {\n          editorOptions.author.extensions['math'] = new DO.U.Editor.Button({action:'math', label:'math'});\n          editorOptions.author.toolbar.buttons.splice(7, 0, 'math');\n        }\n\n        if('MediumEditorTable' in window) {\n          editorOptions.author.extensions['table'] = new MediumEditorTable();\n          editorOptions.author.toolbar.buttons.splice(10, 0, 'table');\n        }\n\n        var eNodes = selector || DO.U.selectArticleNode(document);\n        var eOptions = editorOptions[editorMode];\n        DO.C.User.Role = editorMode;\n\n        if (typeof MediumEditor !== 'undefined') {\n          DO.U.Editor.MediumEditor = new MediumEditor(eNodes, eOptions);\n          DO.C.EditorEnabled = true;\n\n          if (e && e.target.closest('button.editor-enable')) {\n            DO.C.ContentEditable = true;\n            document.addEventListener('click', DO.U.updateDocumentTitle);\n\n            var documentLicense = 'document-license';\n            var license = document.getElementById(documentLicense);\n            if(!license) {\n              var dl = '        <dl class=\"do\" id=\"' + documentLicense + '\"><dt>License</dt><dd><select contenteditable=\"false\" name=\"license\">' + DO.U.getLicenseOptionsHTML({ 'selected': '' }) + '</select></dd></dl>';\n              DO.U.insertDocumentLevelHTML(document, dl, { 'id': documentLicense });\n\n              var dLS = document.querySelector('#' + documentLicense + ' select');\n              dLS.addEventListener('change', function(e){\n                dLS.querySelectorAll('option').forEach(function(o){\n                  o.removeAttribute('selected');\n                });\n                dLS.querySelector('option[value=\"' + e.target.value + '\"]').setAttribute('selected', 'selected');\n              });\n            }\n\n            var documentStatus = 'document-status';\n            var status = document.getElementById(documentStatus);\n            if(!status) {\n              var dl = '        <dl class=\"do\" id=\"' + documentStatus + '\"><dt>Document Status</dt><dd><select contenteditable=\"false\" name=\"status\">' + DO.U.getPublicationStatusOptionsHTML({ 'selected': '' }) + '</select></dd></dl>';\n              DO.U.insertDocumentLevelHTML(document, dl, { 'id': documentStatus });\n\n              var dSS = document.querySelector('#' + documentStatus + ' select');\n              dSS.addEventListener('change', function(e){\n                dSS.querySelectorAll('option').forEach(function(o){\n                  o.removeAttribute('selected');\n                });\n                dSS.querySelector('option[value=\"' + e.target.value + '\"]').setAttribute('selected', 'selected');\n              });\n            }\n\n          }\n          else if (e && (e.target.closest('button.editor-disable') || e.target.closest('button.review-enable'))) {\n            DO.C.ContentEditable = false;\n\n            DO.U.setEditSelections();\n          }\n\n          document.querySelectorAll('.do').forEach(function(node){\n            node.setAttribute('contenteditable', 'false');\n          })\n\n          return DO.U.Editor.MediumEditor;\n        }\n      },\n\n      Button: (function () {\n        if (typeof MediumEditor !== 'undefined') {\n          return MediumEditor.extensions.button.extend({\n            init: function () {\n              this.name = this.label;\n              this.action = this.action;\n              this.aria = this.label;\n              this.tagNames = [this.action];\n              this.useQueryState = true;\n              this.contentDefault = '<b>' + this.label + '</b>';\n\n              switch(this.action) {\n                case 'h1': case 'h2': case 'h3': case 'h4': case 'h5': case 'h6': this.contentFA = '<i class=\"fa fa-header\">' + parseInt(this.action.slice(-1)) + '</i>'; break;\n                case 'em': this.contentFA = '<i class=\"fa fa-italic\"></i>'; break;\n                case 'strong': this.contentFA = '<i class=\"fa fa-bold\"></i>'; break;\n                case 'q': this.contentFA = '<i class=\"fa fa-quote-right\"></i>'; break;\n                case 'math': this.contentFA = '<i class=\"fa fa-calculator\"></i>'; break;\n                default: break;\n              }\n\n              this.button = this.createButton();\n              this.on(this.button, 'click', this.handleClick.bind(this));\n\n              //TODO: Listen to section hX changes and update section @id and span @class do.fragment\n            },\n\n            // getButton: function() {\n            //   console.log('DO.U.Editor.Button.Note.getButton()');\n            //   return this.button;\n            // },\n\n            handleClick: function(event) { //, editable\n        //console.log('DO.U.Editor.Button.handleClick()');\n// console.log(this);\n              event.preventDefault();\n              event.stopPropagation();\n\n              var action = this.getAction();\n              var tagNames = this.getTagNames();\n              var button = this.getButton();\n\n              if (this.isActive()) {\n                return this.base.execAction('removeFormat');\n              }\n              else {\n                var datetime = ' ' + DO.U.createAttributeDateTime(this.action);\n\n                this.base.selectedDocument = this.document;\n                this.base.selection = MediumEditor.selection.getSelectionHtml(this.base.selectedDocument);\n                //.replace(DO.C.Editor.regexEmptyHTMLTags, '');\n// console.log('this.base.selection:');\n// console.log(this.base.selection);\n\n                var selectedParentElement = this.base.getSelectedParentElement();\n// console.log('getSelectedParentElement:');\n// console.log(selectedParentElement);\n                var parentSection = MediumEditor.util.getClosestTag(selectedParentElement, 'section');\n// console.log(parentSection);\n\n                //XXX: DO NOT REMOVE. Saving the selection should be before inserting/updating HTML.\n                this.base.saveSelection();\n\n                switch(this.action) {\n                  case 'h2': case 'h3': case 'h4': case 'h5': case 'h6':\n                    //XXX: Which heading level are we at?\n                    var parentSectionHeading = '';\n                    for (var i = 0; i < parentSection.childNodes.length; i++) {\n                      parentSectionHeading = parentSection.childNodes[i].nodeName.toLowerCase();\n                      if(DO.C.Editor.headings.indexOf(parentSectionHeading) > 0) {\n// console.log(parentSectionHeading);\n                        break;\n                      }\n                    }\n                    var pSH = parseInt(parentSectionHeading.slice(-1));\n\n                    //XXX: Which heading level is the action?\n                    var cSH = parseInt(this.action.slice(-1));\n// console.log(\"parentH: \" + pSH);\n// console.log(\"currentH: \" + cSH);\n// console.log(cSH-pSH);\n\n                    var closePreviousSections = '';\n                    // if (cSH > pSH) {}\n                    for (i = 0; i <= (pSH-cSH); i++) {\n                      console.log(\"i: \" + i);\n                      closePreviousSections += '</div></section>';\n                    }\n// console.log(closePreviousSections);\n// console.log(this.base.selection);\n// var doc = this.document;\n                    var selection = window.getSelection();\n// console.log(this.base.selection);\n// console.log(selection);\n\n                    if (selection.rangeCount) {\n                      range = selection.getRangeAt(0);\n                      parent = selectedParentElement;\n\n// console.log(range);\n                      //Section\n                      var sectionId = DO.U.generateAttributeId(null, this.base.selection);\n                      var section = document.createElement('section');\n                      section.id = sectionId;\n                      section.setAttribute('rel', 'schema:hasPart');\n                      section.setAttribute('resource', '#' + sectionId);\n// console.log(section);\n\n\n                      //Heading\n                      var heading = document.createElement(tagNames[0]);\n                      heading.setAttribute('property', 'schema:name');\n                      heading.innerHTML = this.base.selection;\n// console.log(heading);\n// console.log(selection);\n\n\n                      var divDescription = parentSection.getElementsByTagName('div')[0];\n// console.log(divDescription);\n// console.log(divDescription.innerHTML);\n// console.log(divDescription.childNodes);\n// console.log(divDescription.length);\n// console.log(selectedParentElement);\n// console.log(selectedParentElement.childNodes);\n// console.log(selectedParentElement.lastChild);\n// console.log(selectedParentElement.lastChild.length);\n\n                      r = selection.getRangeAt(0);\n// console.log(r);\n// console.log(r.startContainer);\n// console.log(r.startOffset);\n// console.log(r.endOffset);\n                      //Remaining nodes\n                      var r = document.createRange();\n                      r.setStart(selection.focusNode, selection.focusOffset);\n                      r.setEnd(selectedParentElement.lastChild, selectedParentElement.lastChild.length);\n// console.log(r.commonAncestorContainer.nodeType);\n\n// console.log(r.startContainer);\n// console.log(r.endContainer);\n// console.log(selection.anchorNode);\n// selection.removeAllRanges(); //XXX: is this doing anything?\n// selection.addRange(r);\n\n// console.log(selection.anchorNode);\n                      var fragment = r.extractContents();\n// console.log(fragment);\n// console.log(selection);\n// r = selection.getRangeAt(0);\n// console.log(r);\n// console.log(r.startContainer);\n// console.log(r.startOffset);\n// console.log(r.endOffset);\n                      if (fragment.firstChild.nodeType === 3) {\n                        //TODO: trim only if there is one child which is a textnode\n                        // fragment.firstChild.nodeValue = fragment.firstChild.nodeValue.trim();\n\n// console.log(fragment);\n                        var sPE = selectedParentElement.nodeName.toLowerCase();\n                        switch(sPE) {\n                          case \"p\": default:\n                            var xSPE = document.createElement(sPE);\n                            xSPE.appendChild(fragment.cloneNode(true));\n                            fragment = DO.U.fragmentFromString(xSPE.outerHTML);\n                            break;\n                          //TODO: Other cases?\n                        }\n                      }\n// console.log(fragment);\n// console.log(selection);\n\n                      r = selection.getRangeAt(0);\n// console.log(r);\n// console.log(r.startContainer);\n// console.log(r.startOffset);\n// console.log(r.endOffset);\n// var remainingNodes = document.createElement('div');\n// remainingNodes.appendChild(fragment.cloneNode(true));\n// console.log(remainingNodes);\n\n\n                      //Description\n                      var div = document.createElement('div');\n                      div.setAttribute('property', 'schema:description');\n                      div.appendChild(fragment.cloneNode(true));\n\n                      //Put it together\n                      section.appendChild(heading);\n                      section.appendChild(div);\n// console.log(range.startContainer);\n\n                      var selectionUpdated = document.createElement('div');\n                      selectionUpdated.appendChild(section);\n                      selectionUpdated = selectionUpdated.innerHTML;\n// console.log(selectionUpdated);\n// range.deleteContents();\n// MediumEditor.util.insertHTMLCommand(this.document, closePreviousSections);\n// MediumEditor.extensions.paste(closePreviousSections);\n\n                      //Sub-section\n                      if (cSH-pSH > 0) {\n                        MediumEditor.util.insertHTMLCommand(this.base.selectedDocument, selectionUpdated);\n\n                        // This doesn't seem to be needed anymore?\n                        // MediumEditor.selection.select(this.base.selectedDocument, heading, 0);\n                      }\n                      else {\n// console.log(selection);\n// console.log(parentSection);\n                        MediumEditor.selection.selectNode(parentSection, document);\n                        r = selection.getRangeAt(0);\n// console.log(r);\n// console.log(r.startOffset);\n// console.log(r.endOffset);\n\n\n                        //This selection is based off previous operations; handling remaining Nodes after the selection. So, this is not accurate per se.. the range might be accurate.\n                        selection = window.getSelection();\n// console.log(selection);\n                        r = selection.getRangeAt(0);\n// console.log(r);\n// console.log(r.startOffset);\n// console.log(r.endOffset);\n\n\n                        r = document.createRange();\n                        r.setStartAfter(parentSection);\n// console.log(r);\n                        r.setEndAfter(parentSection);\n// console.log(r);\n                        r.collapse(true);\n                        selection.removeAllRanges();\n                        selection.addRange(r);\n// console.log(selection);\n                        var foo = document.createElement('div');\n                        foo.appendChild(parentSection);\n                        parentSection = foo.innerHTML;\n// console.log(parentSection + selectionUpdated);\n                        MediumEditor.util.insertHTMLCommand(this.base.selectedDocument, parentSection + selectionUpdated);\n\n                        // MediumEditor.selection.select(this.base.selectedDocument, heading, 0);\n                        // parentSection.parentNode.insertBefore(section, parentSection.nextSibling);\n                      }\n                    }\n\n                    this.base.restoreSelection();\n                    this.base.checkSelection();\n                    break;\n\n                  case 'math':\n                    var QUEUE = MathJax.Hub.Queue;  // shorthand for the queue\n                    var math = null;                // the element jax for the math output.\n\n                    var selection = this.base.selection;\n\n                    var selectionId = DO.U.generateAttributeId();\n\n                    var selectionUpdated = '<span id=\"' + selectionId + '\">$$</span>';\n\n                    MediumEditor.util.insertHTMLCommand(this.base.selectedDocument, selectionUpdated);\n\n                    MathJax.Hub.Queue([\"Typeset\", MathJax.Hub, selectionId]);\n                    var math = MathJax.Hub.getAllJax(selectionId)[0];\n                    MathJax.Hub.Queue([\"Text\", math, selection]);\n\n                    MediumEditor.selection.selectNode(document.getElementById(selectionId), document);\n                    break;\n\n                  default:\n                    var selectionUpdated = '<' + tagNames[0] + datetime + '>' + this.base.selection + '</' + tagNames[0] + '>';\n                    MediumEditor.util.insertHTMLCommand(this.base.selectedDocument, selectionUpdated);\n                    this.base.restoreSelection();\n                    this.base.checkSelection();\n\n                    break;\n                }\n\n                this.setActive();\n              }\n            }\n          });\n        }\n      })(),\n\n      //Adapted from MediumEditor's Anchor Form\n      Note: (function() {\n        if (typeof MediumEditor !== 'undefined') {\n          return MediumEditor.extensions.form.extend({\n            /* Textarea Form Options */\n\n            /* customClassOption: [string]  (previously options.anchorButton + options.anchorButtonClass)\n             * Custom class name the user can optionally have added to their created links (ie 'button').\n             * If passed as a non-empty string, a checkbox will be displayed allowing the user to choose\n             * whether to have the class added to the created link or not.\n             */\n            customClassOption: null,\n\n            /* customClassOptionText: [string]\n             * text to be shown in the checkbox when the __customClassOption__ is being used.\n             */\n            customClassOptionText: 'Button',\n\n            /* linkValidation: [boolean]  (previously options.checkLinkFormat)\n             * enables/disables check for common URL protocols on anchor links.\n             */\n            linkValidation: false,\n\n            /* placeholderText: [string]  (previously options.anchorInputPlaceholder)\n             * text to be shown as placeholder of the anchor input.\n             */\n            placeholderText: \"What’s up?\",\n\n            /* targetCheckbox: [boolean]  (previously options.anchorTarget)\n             * enables/disables displaying a \"Open in new window\" checkbox, which when checked\n             * changes the `target` attribute of the created link.\n             */\n            targetCheckbox: false,\n\n            /* targetCheckboxText: [string]  (previously options.anchorInputCheckboxLabel)\n             * text to be shown in the checkbox enabled via the __targetCheckbox__ option.\n             */\n            targetCheckboxText: 'Open in new window',\n\n            // Options for the Button base class\n            // name: this.name,\n            // action: 'createLink',\n            // aria: 'link',\n            // tagNames: ['a'],\n            // contentDefault: '<b>#</b>',\n            // contentFA: '<i class=\"fa fa-sticky-note\"></i>',\n\n            init: function () {\n              this.name = this.label;\n              this.action = this.action;\n              this.aria = this.label;\n              this.tagNames = [this.action];\n              this.useQueryState = true;\n              this.contentDefault = '<b>' + this.label + '</b>';\n              this.signInRequired = false;\n\n              switch(this.action) {\n                case 'cite': default:\n                  this.contentFA = '<i class=\"fa fa-hashtag\"></i>';\n                  break;\n                case 'article':\n                  this.contentFA = '<i class=\"fa fa-sticky-note\"></i>';\n                  this.signInRequired = true;\n                  break;\n                case 'note':\n                  this.contentFA = '<i class=\"fa fa-sticky-note\"></i>';\n                  break;\n                case 'rdfa':\n                  this.contentFA = '<i class=\"fa fa-rocket\"></i>';\n                  break;\n                case 'selector':\n                  this.contentFA = '<i class=\"fa fa-anchor\"></i>';\n                  break;\n                case 'bookmark':\n                  this.contentFA = '<i class=\"fa fa-bookmark\"></i>';\n                  this.signInRequired = true;\n                  break;\n                case 'share':\n                  this.contentFA = '<i class=\"fa fa-bullhorn\"></i>';\n                  this.signInRequired = true;\n                  break;\n                case 'approve':\n                  this.contentFA = '<i class=\"fa fa-thumbs-up\"></i>';\n                  this.signInRequired = true;\n                  break;\n                case 'disapprove':\n                  this.contentFA = '<i class=\"fa fa-thumbs-down\"></i>';\n                  this.signInRequired = true;\n                  break;\n                case 'specificity':\n                  this.contentFA = '<i class=\"fa fa-crosshairs\"></i>';\n                  this.signInRequired = true;\n                  break;\n                case 'sparkline':\n                  this.contentFA = '<i class=\"fa fa-line-chart\"></i>';\n                  break;\n              }\n              MediumEditor.extensions.form.prototype.init.apply(this, arguments);\n\n        //TODO: Change this bind key\n        //      this.subscribe('editableKeydown', this.handleKeydown.bind(this));\n        //      this.on(this.button, 'click', this.handleClick.bind(this));\n            },\n\n            // Called when the button the toolbar is clicked\n            // Overrides ButtonExtension.handleClick\n            handleClick: function (event) {\n              event.preventDefault();\n              event.stopPropagation();\n              var _this = this;\n              var showAction = function() {\n                switch(_this.action) {\n                  default:\n                    var range = MediumEditor.selection.getSelectionRange(_this.document);\n\n                    if (range.startContainer.nodeName.toLowerCase() === 'a' ||\n                      range.endContainer.nodeName.toLowerCase() === 'a' ||\n                      MediumEditor.util.getClosestTag(MediumEditor.selection.getSelectedParentElement(range), 'a')) {\n                      return _this.execAction('unlink');\n                    }\n\n                    if (DO.U.Editor.MediumEditor.options.id == 'social' && (_this.action == 'selector' || _this.action == 'approve')){\n                      var opts = {\n                        license: 'https://creativecommons.org/licenses/by/4.0/',\n                        content: 'Liked'\n                      }\n                      _this.completeFormSave(opts);\n                    }\n                    else if (!_this.isDisplayed()) {\n                      _this.showForm();\n                    }\n                    break;\n\n                  case 'share':\n                    _this.base.restoreSelection();\n                    var resourceIRI = uri.stripFragmentFromString(document.location.href);\n                    var id = _this.base.getSelectedParentElement().closest('[id]').id;\n                    resourceIRI = (id) ? resourceIRI + '#' + id : resourceIRI;\n                    _this.window.getSelection().removeAllRanges();\n                    _this.base.checkSelection();\n                    DO.U.shareResource(null, resourceIRI);\n                    break;\n                }\n              };\n\n              var updateAnnotationServiceForm = function() {\n                var annotationServices = document.querySelectorAll('.annotation-location-selection');\n                for (var i = 0; i < annotationServices.length; i++) {\n                  annotationServices[i].innerHTML = DO.U.getAnnotationLocationHTML();\n                }\n              };\n\n              return inbox.getEndpoint(DO.C.Vocab['oaannotationService']['@id']).then(\n                function(url) {\n                  DO.C.AnnotationService = url[0];\n                  updateAnnotationServiceForm();\n                  showAction();\n                },\n                function(reason) {\n                  if(_this.signInRequired && !DO.C.User.IRI) {\n                    auth.showUserIdentityInput();\n                  }\n                  else {\n                    updateAnnotationServiceForm();\n                    showAction();\n                  }\n                }\n              );\n            },\n\n            // Called when user hits the defined shortcut (CTRL / COMMAND + K)\n            handleKeydown: function (event) {\n              if (MediumEditor.util.isKey(event, MediumEditor.util.keyCode.K) && MediumEditor.util.isMetaCtrlKey(event) && !event.shiftKey) {\n                this.handleClick(event);\n              }\n            },\n\n            // Called by medium-editor to append form to the toolbar\n            getForm: function () {\n              if (!this.form) {\n                this.form = this.createForm();\n              }\n              return this.form;\n            },\n\n            getTemplate: function () {\n              var template = [];\n              switch(this.action) {\n                case 'rdfa':\n                  template = [\n                  '<label for=\"rdfa-about\">about</label><input id=\"rdfa-about\" class=\"medium-editor-toolbar-input\" placeholder=\"https://example.org/foo#bar\" /><br/>',\n                  '<label for=\"rdfa-resource\">resource</label><input id=\"rdfa-resource\" class=\"medium-editor-toolbar-input\" placeholder=\"https://example.net/baz\" /><br/>',\n                  '<label for=\"rdfa-typeof\">typeof</label><input id=\"rdfa-typeof\" class=\"medium-editor-toolbar-input\" placeholder=\"https://example.net/baz\" /><br/>',\n                  '<label for=\"rdfa-rel\">rel</label><input id=\"rdfa-rel\" class=\"medium-editor-toolbar-input\" placeholder=\"schema:url\"><br/>',\n                  '<label for=\"rdfa-property\">property</label><input id=\"rdfa-property\" class=\"medium-editor-toolbar-input\" placeholder=\"schema:name\" /><br/>',\n                  '<label for=\"rdfa-href\">href</label><input id=\"rdfa-href\" class=\"medium-editor-toolbar-input\" placeholder=\"https://example.net/baz\" /><br/>',\n                  '<label for=\"rdfa-content\">content</label><input id=\"rdfa-content\" class=\"medium-editor-toolbar-input\" placeholder=\"Baz\" /><br/>',\n                  '<label for=\"rdfa-datatype\">datatype</label><input id=\"rdfa-datatype\" class=\"medium-editor-toolbar-input\" placeholder=\"https://example.net/baz\" /><br/>'\n                  ];\n                  break;\n                case 'article':\n                  template = [\n                  '<textarea id=\"article-content\" name=\"content\" cols=\"20\" rows=\"5\" class=\"medium-editor-toolbar-textarea\" placeholder=\"', this.placeholderText, '\"></textarea>',\n                  '<select id=\"article-license\" name=\"license\" class=\"medium-editor-toolbar-select\">',\n                  DO.U.getLicenseOptionsHTML(),\n                  '</select>',\n                  '<span class=\"annotation-location-selection\">' + DO.U.getAnnotationLocationHTML() + '</span>'\n                  ];\n                  break;\n                case 'note':\n                  template = [\n                  '<label for=\"bookmark-tagging\">Tags</label> <input id=\"bookmark-tagging\" class=\"medium-editor-toolbar-input\" placeholder=\"Separate tags with commas\" /><br/>',\n                  '<textarea id=\"article-content\" name=\"content\" cols=\"20\" rows=\"1\" class=\"medium-editor-toolbar-textarea\" placeholder=\"', this.placeholderText, '\"></textarea>',\n                  '<select id=\"article-license\" name=\"license\" class=\"medium-editor-toolbar-select\">',\n                  DO.U.getLicenseOptionsHTML(),\n                  '</select>'\n                  ];\n                  break;\n                case 'approve':\n                  template = [\n                  '<textarea id=\"approve-content\" name=\"content\" cols=\"20\" rows=\"2\" class=\"medium-editor-toolbar-textarea\" placeholder=\"Strong point? Convincing argument?\"></textarea>',\n                  '<select id=\"approve-license\" name=\"license\" class=\"medium-editor-toolbar-select\">',\n                  DO.U.getLicenseOptionsHTML(),\n                  '</select>',\n                  '<span class=\"annotation-location-selection\">' + DO.U.getAnnotationLocationHTML() + '</span>'\n                  ];\n                  break;\n                case 'disapprove':\n                  template = [\n                  '<textarea id=\"disapprove-content\" name=\"content\" cols=\"20\" rows=\"2\" class=\"medium-editor-toolbar-textarea\" placeholder=\"Weak point? Error? Inaccurate?\"></textarea>',\n                  '<select id=\"disapprove-license\" name=\"license\" class=\"medium-editor-toolbar-select\">',\n                  DO.U.getLicenseOptionsHTML(),\n                  '</select>',\n                  '<span class=\"annotation-location-selection\">' + DO.U.getAnnotationLocationHTML() + '</span>'\n                  ];\n                  break;\n                case 'specificity':\n                  template = [\n                  '<textarea id=\"specificity-content\" name=\"content\" cols=\"20\" rows=\"2\" class=\"medium-editor-toolbar-textarea\" placeholder=\"Citation or specificity needed?\"></textarea>',\n                  '<select id=\"specificity-license\" name=\"license\" class=\"medium-editor-toolbar-select\">',\n                  DO.U.getLicenseOptionsHTML(),\n                  '</select>',\n                  '<span class=\"annotation-location-selection\">' + DO.U.getAnnotationLocationHTML() + '</span>'\n                  ];\n                  break;\n                case 'cite':\n                  template = [\n                  '<input type=\"radio\" name=\"citation-type\" value=\"ref-footnote\" id=\"ref-footnote\" /> <label for=\"ref-footnote\">Footnote</label>',\n                  '<input type=\"radio\" name=\"citation-type\" value=\"ref-reference\" id=\"ref-reference\" /> <label for=\"ref-reference\">Reference</label>',\n                  '<select id=\"citation-relation\" name=\"citation-relation\" class=\"medium-editor-toolbar-select\">',\n                  DO.U.getCitationOptionsHTML(),\n                  '</select>',\n                  '<input type=\"text\" name=\"citation-url\" value=\"\" id=\"citation-url\" class=\"medium-editor-toolbar-input\" placeholder=\"http://example.org/article#results\" />',\n                  '<textarea id=\"citation-content\" cols=\"20\" rows=\"1\" class=\"medium-editor-toolbar-textarea\" placeholder=\"', this.placeholderText, '\"></textarea>'\n                  ];\n                  break;\n                case 'bookmark':\n                  template = [\n                  '<label for=\"bookmark-tagging\">Tags</label> <input id=\"bookmark-tagging\" class=\"medium-editor-toolbar-input\" placeholder=\"Separate tags with commas\" /><br/>',\n                  '<textarea id=\"bookmark-content\" name=\"content\" cols=\"20\" rows=\"2\" class=\"medium-editor-toolbar-textarea\" placeholder=\"Description\"></textarea>'\n                  ];\n                  break;\n                case 'sparkline':\n                  template = [\n                  '<input type=\"text\" name=\"sparkline-search\" value=\"\" id=\"sparkline-search\" class=\"medium-editor-toolbar-input\" placeholder=\"Enter search terms\" /><br/>',\n                  '<input type=\"hidden\" name=\"sparkline-selection-dataset\" value=\"\" id=\"sparkline-selection-dataset\" />',\n                  '<input type=\"hidden\" name=\"sparkline-selection-refarea\" value=\"\" id=\"sparkline-selection-refarea\" />'\n                  ];\n                  break;\n                default:\n                  template = [\n                  '<textarea cols=\"20\" rows=\"1\" class=\"medium-editor-toolbar-textarea\" placeholder=\"', this.placeholderText, '\"></textarea>'\n                  ];\n                  break;\n              }\n\n              template.push(\n                '<a href=\"#\" class=\"medium-editor-toolbar-save\" title=\"Save\">',\n                this.getEditorOption('buttonLabels') === 'fontawesome' ? '<i class=\"fa fa-check\"></i>' : this.formSaveLabel,\n                '</a>'\n              );\n\n              template.push(\n                '<a href=\"#\" class=\"medium-editor-toolbar-close\" title=\"Close\">',\n                this.getEditorOption('buttonLabels') === 'fontawesome' ? '<i class=\"fa fa-times\"></i>' : this.formCloseLabel,\n                '</a>'\n              );\n\n              // both of these options are slightly moot with the ability to\n              // override the various form buildup/serialize functions.\n\n              if (this.targetCheckbox) {\n                // fixme: ideally, this targetCheckboxText would be a formLabel too,\n                // figure out how to deprecate? also consider `fa-` icon default implcations.\n                template.push(\n                  '<div class=\"medium-editor-toolbar-form-row\">',\n                  '<input type=\"checkbox\" class=\"medium-editor-toolbar-textarea-target\">',\n                  '<label>',\n                  this.targetCheckboxText,\n                  '</label>',\n                  '</div>'\n                );\n              }\n\n              if (this.customClassOption) {\n                // fixme: expose this `Button` text as a formLabel property, too\n                // and provide similar access to a `fa-` icon default.\n                template.push(\n                  '<div class=\"medium-editor-toolbar-form-row\">',\n                  '<input type=\"checkbox\" class=\"medium-editor-toolbar-textarea-button\">',\n                  '<label>',\n                  this.customClassOptionText,\n                  '</label>',\n                  '</div>'\n                );\n              }\n\n              return template.join('');\n\n            },\n\n            // Used by medium-editor when the default toolbar is to be displayed\n            isDisplayed: function () {\n              return this.getForm().style.display === 'block';\n            },\n\n            hideForm: function () {\n              this.getForm().style.display = 'none';\n              this.getInput().value = '';\n            },\n\n            showForm: function (opts) {\n              var _this = this;\n              var input = this.getInput(),\n                targetCheckbox = this.getAnchorTargetCheckbox(),\n                buttonCheckbox = this.getAnchorButtonCheckbox();\n\n              opts = opts || { url: '' };\n              // TODO: This is for backwards compatability\n              // We don't need to support the 'string' argument in 6.0.0\n              if (typeof opts === 'string') {\n                opts = {\n                  url: opts\n                };\n              }\n\n              var initialSelectedParentElement = this.base.getSelectedParentElement();\n              var initialSelectionState = MediumEditor.selection.exportSelection(initialSelectedParentElement, this.document);\n\n              //XXX: Get this before getForm.\n              var selection = MediumEditor.selection.getSelectionHtml(this.document).trim();\n              this.base.saveSelection();\n              this.hideToolbarDefaultActions();\n              var form = this.getForm();\n              form.style.display = 'block';\n              this.setToolbarPosition();\n\n              input.value = opts.url;\n\n              switch(this.action) {\n                case 'rdfa':\n                  input.about.focus();\n                  break;\n                case 'article': case 'note': case 'approve': case 'disapprove': case 'specificity':\n                  input.content.focus();\n                  break;\n                case 'cite':\n                  input.url.focus();\n                  document.querySelector('.medium-editor-toolbar-form input[name=\"citation-type\"]').checked = true;\n                  break;\n                case 'sparkline':\n                  input.search.focus();\n                  input.search.value = selection;\n\n                  var inputSearch = function(e){\n                    if(e.which == 13) {\n                      e.preventDefault();\n                      e.stopPropagation();\n                      _this.base.restoreSelection();\n                      MediumEditor.util.insertHTMLCommand(document, e.target.value);\n                      var selection = { start: initialSelectionState.start, end: (initialSelectionState.start + e.target.value.length) };\n                      MediumEditor.selection.importSelection(selection, initialSelectedParentElement, document);\n                      _this.base.checkSelection();\n                      e.target.setAttribute('data-event-keyup-enter', true);\n                      _this.showForm();\n                      return;\n                    }\n                  }\n                  if(!input.search.getAttribute('data-event-keyup-enter')) {\n                    input.search.addEventListener('keyup', inputSearch, false);\n                  }\n\n                  var sparqlEndpoint = 'http://worldbank.270a.info/';\n                  var resourceType = '<http://purl.org/linked-data/cube#DataSet>';\n                  var sparklineGraphId = 'sparkline-graph';\n                  var resultContainerId = 'sparkline-select';\n                  //TODO: This should be from user's preference?\n                  var lang = 'en';\n\n                  //TODO: What's the best way for user input? ' of '\n                  var textInputA = selection.split(' of ')[0];\n                  var textInputB = selection.substr(selection.indexOf(' of ') + 4);\n\n                  if(!DO.C.RefAreas[textInputB.toUpperCase()]) {\n                    Object.keys(DO.C.RefAreas).forEach(function(key) {\n                      if(DO.C.RefAreas[key].toLowerCase() == textInputB.toLowerCase()) {\n                        textInputB = key;\n                      }\n                    });\n                  }\n\n                  var sG = document.getElementById(sparklineGraphId);\n                  if(sG) {\n                    sG.parentNode.removeChild(sG);\n                  }\n\n                  if(!DO.C.RefAreas[textInputB.toUpperCase()]) {\n                    var refAreas;\n                    Object.keys(DO.C.RefAreas).forEach(function(key) {\n                      refAreas += '<option value=\"' + key + '\">' + key + ' - ' + DO.C.RefAreas[key] + '</option>';\n                    });\n                    form.querySelector('.medium-editor-toolbar-save').insertAdjacentHTML('beforebegin', '<div id=\"' + sparklineGraphId + '\">`' + textInputB + '` is not available. Try: ' + '<select name=\"refAreas\"><option>Select a reference area</option>' + refAreas + '</select></div>');\n                    var rA = document.querySelector('#' + sparklineGraphId + ' select[name=\"refAreas\"]');\n                    rA.addEventListener('change', function(e) {\n                      e.preventDefault();\n                      e.stopPropagation();\n                      textInputB = e.target.value;\n                      input.search.value = textInputA + ' of ' + textInputB;\n                      form.querySelector('#sparkline-selection-dataset').value = textInputA;\n                      form.querySelector('#sparkline-selection-refarea').value = textInputB;\n\n                      _this.base.restoreSelection();\n                      MediumEditor.util.insertHTMLCommand(document, input.search.value);\n                      var selection = { start: initialSelectionState.start, end: (initialSelectionState.start + input.search.value.length) };\n                      MediumEditor.selection.importSelection(selection, initialSelectedParentElement, document);\n                      _this.base.checkSelection();\n                      _this.showForm();\n                    });\n                    return;\n                  }\n\n                  var options = {};\n                  options.filter = {\n                    dimensionProperty: 'sdmx-dimension:refArea',\n                    dimensionRefAreaNotation: textInputB\n                  };\n                  options.optional = { prefLabels: [\"dcterms:title\"] };\n\n                  var queryURL = DO.U.SPARQLQueryURL.getResourcesOfTypeWithLabel(sparqlEndpoint, resourceType, textInputA.toLowerCase(), options);\n\n                  queryURL = uri.getProxyableIRI(queryURL);\n\n                  form.querySelector('.medium-editor-toolbar-save').insertAdjacentHTML('beforebegin', '<div id=\"' + sparklineGraphId + '\"></div><i class=\"fa fa-circle-o-notch fa-spin fa-fw\"></i>');\n                  sG = document.getElementById(sparklineGraphId);\n\n                  DO.U.getTriplesFromGraph(queryURL)\n                    .then(function(triples){\n                      sG.removeAttribute('class');\n                      triples = DO.U.sortTriples(triples, { sortBy: 'object' });\n                      return DO.U.getListHTMLFromTriples(triples, {element: 'select', elementId: resultContainerId});\n                    })\n                    .then(function(listHTML){\n                      sG.innerHTML = listHTML;\n                      form.removeChild(form.querySelector('.fa.fa-circle-o-notch.fa-spin'));\n                    })\n                    .then(function(x){\n                      var rC = document.getElementById(resultContainerId);\n                      rC.addEventListener('change', function(e) {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        var sparkline = sG.querySelectorAll('.sparkline, .sparkline-info');\n                        for (var i = 0; i < sparkline.length; i++) {\n                          sparkline[i].parentNode.removeChild(sparkline[i]);\n                        }\n                        form.querySelector('.medium-editor-toolbar-save').insertAdjacentHTML('beforebegin', '<i class=\"fa fa-circle-o-notch fa-spin fa-fw\"></i>');\n\n                        var dataset = e.target.value;\n                        var title = e.target.querySelector('*[value=\"' + e.target.value + '\"]').textContent.trim();\n                        //XXX: Should this replace the initial search term?\n                        form.querySelector('#sparkline-selection-dataset').value = title;\n                        form.querySelector('#sparkline-selection-refarea').value = textInputB.toUpperCase();\n\n                        var refArea = textInputB.toUpperCase();\n                        var paramDimension = \"\\n\\\n  ?propertyRefArea rdfs:subPropertyOf* sdmx-dimension:refArea .\\n\\\n  ?observation ?propertyRefArea [ skos:notation '\" + refArea + \"' ] .\";\n\n// console.log(dataset);\n// console.log(refArea);\n                        var queryURL = DO.U.SPARQLQueryURL.getObservationsWithDimension(sparqlEndpoint, dataset, paramDimension);\n// console.log(queryURL);\n                        queryURL = uri.getProxyableIRI(queryURL);\n\n                        DO.U.getTriplesFromGraph(queryURL)\n                          .then(function(triples){\n// console.log(triples);\n                            if(triples.length > 0) {\n                              var observations = {};\n                              triples.forEach(function(t){\n                                var s = t.subject.nominalValue;\n                                var p = t.predicate.nominalValue;\n                                var o = t.object.nominalValue;\n                                observations[s] = observations[s] || {};\n                                observations[s][p] = o;\n                              });\n// console.log(observations);\n                              var list = [], item;\n                              Object.keys(observations).forEach(function(key) {\n                                item = {};\n                                observations[key]['http://purl.org/linked-data/cube#Observation'] = key;\n                                item[key] = observations[key];\n                                list.push(item[key]);\n                              });\n                              var sortByKey = 'http://purl.org/linked-data/sdmx/2009/dimension#refPeriod';\n                              list.sort(function (a, b) {\n                                return a[sortByKey].toLowerCase().localeCompare(b[sortByKey].toLowerCase());\n                              });\n// console.log(list);\n                              var options = {\n                                url: dataset,\n                                title: title ,\n                                cssStroke: '#000'\n                              };\n                              var sparkline = DO.U.getSparkline(list, options);\n                              sG.insertAdjacentHTML('beforeend', '<span class=\"sparkline\">' + sparkline + '</span> <span class=\"sparkline-info\">' + triples.length + ' observations</span>');\n                                form.removeChild(form.querySelector('.fa.fa-circle-o-notch.fa-spin'));\n                            }\n                            else {\n                              //This shouldn't happen.\n                              sG.insertAdjacentHTML('beforeend', '<span class=\"sparkline-info\">0 observations. Select another.</span>');\n                            }\n                          });\n                      });\n                    });\n                  break;\n                case 'bookmark':\n                  input.content.focus();\n                  break;\n                default:\n                  input.focus();\n                  break;\n              }\n\n              // If we have a target checkbox, we want it to be checked/unchecked\n              // based on whether the existing link has target=_blank\n              if (targetCheckbox) {\n                targetCheckbox.checked = opts.target === '_blank';\n              }\n\n              // If we have a custom class checkbox, we want it to be checked/unchecked\n              // based on whether an existing link already has the class\n              if (buttonCheckbox) {\n                var classList = opts.buttonClass ? opts.buttonClass.split(' ') : [];\n                buttonCheckbox.checked = (classList.indexOf(this.customClassOption) !== -1);\n              }\n            },\n\n            // Called by core when tearing down medium-editor (destroy)\n            destroy: function () {\n              if (!this.form) {\n                return false;\n              }\n\n              if (this.form.parentNode) {\n                this.form.parentNode.removeChild(this.form);\n              }\n\n              delete this.form;\n            },\n\n            // core methods\n\n            getFormOpts: function () {\n              // no notion of private functions? wanted `_getFormOpts`\n              var targetCheckbox = this.getAnchorTargetCheckbox(),\n                buttonCheckbox = this.getAnchorButtonCheckbox();\n              var opts = {};\n\n              switch(this.action) {\n                case 'rdfa':\n                  opts.about = this.getInput().about.value;\n                  opts.rel = this.getInput().rel.value;\n                  opts.href = this.getInput().href.value;\n                  opts.typeOf = this.getInput().typeOf.value;\n                  opts.resource = this.getInput().resource.value;\n                  opts.property = this.getInput().property.value;\n                  opts.content = this.getInput().content.value;\n                  opts.datatype = this.getInput().datatype.value;\n                  break;\n                case 'article': case 'approve': case 'disapprove': case 'specificity':\n                  opts.content = this.getInput().content.value;\n                  var aLS = this.getInput().annotationLocationService;\n                  DO.C.User.UI['annotationLocationService'] = { checked: false }\n                  if(aLS) {\n                    DO.C.User.UI.annotationLocationService.checked = opts.annotationLocationService = aLS.checked;\n                  }\n                  var aLPS = this.getInput().annotationLocationPersonalStorage;\n                  DO.C.User.UI['annotationLocationPersonalStorage'] = { checked: false }\n                  if(aLPS) {\n                    DO.C.User.UI.annotationLocationPersonalStorage.checked = opts.annotationLocationPersonalStorage = aLPS.checked;\n                  }\n                  opts.license = this.getInput().license.value;\n                  break;\n                case 'note':\n                  opts.content = this.getInput().content.value;\n                  opts.tagging = this.getInput().tagging.value;\n                  opts.license = this.getInput().license.value;\n                  break;\n                case 'cite':\n                  opts.citationType = this.getInput().citationType.value;\n                  opts.citationRelation = this.getInput().citationRelation.value;\n                  opts.url = this.getInput().url.value;\n                  opts.content = this.getInput().content.value;\n                  break;\n                case 'bookmark':\n                  opts.content = this.getInput().content.value;\n                  opts.tagging = this.getInput().tagging.value;\n                  break;\n                case 'sparkline':\n                  opts.search = this.getInput().search.value;\n                  opts.select = this.getInput().select.value;\n                  opts.sparkline = this.getInput().sparkline.innerHTML;\n                  opts.selectionDataSet = this.getInput().selectionDataSet.value;\n                  opts.selectionRefArea = this.getInput().selectionRefArea.value;\n                  break;\n                default:\n                  opts.url = this.getInput().value;\n                  break;\n\n              }\n\n              if (typeof opts.license !== 'undefined') {\n                DO.C.User.UI['License'] = opts.license;\n              }\n\n              storage.updateStorageProfile(DO.C.User);\n\n              opts.target = '_self';\n              if (targetCheckbox && targetCheckbox.checked) {\n                opts.target = '_blank';\n              }\n\n              if (buttonCheckbox && buttonCheckbox.checked) {\n                opts.buttonClass = this.customClassOption;\n              }\n\n              Object.keys(opts).forEach(function(key) {\n                if(typeof opts[key] === 'string') {\n                  opts[key] = opts[key].trim();\n                }\n              });\n\n              return opts;\n            },\n\n            doFormSave: function () {\n              var opts = this.getFormOpts();\n              this.completeFormSave(opts);\n            },\n\n            completeFormSave: function (opts) {\n              var _this = this;\n// console.log(opts);\n// console.log('completeFormSave() with this.action: ' + this.action);\n              this.base.restoreSelection();\n              var range = MediumEditor.selection.getSelectionRange(this.document);\n              var selectedParentElement = this.base.getSelectedParentElement();\n// console.log('getSelectedParentElement:');\n// console.log(selectedParentElement);\n\n              //Mark the text which the note was left for (with reference to the note?)\n              this.base.selectedDocument = this.document;\n              this.base.selection = MediumEditor.selection.getSelectionHtml(this.base.selectedDocument); //.replace(DO.C.Editor.regexEmptyHTMLTags, '');\n// console.log('this.base.selection:');\n// console.log(this.base.selection);\n\n              var exact = this.base.selection;\n              var selectionState = MediumEditor.selection.exportSelection(selectedParentElement, this.document);\n              var start = selectionState.start;\n              var end = selectionState.end;\n              var prefixStart = Math.max(0, start - DO.C.ContextLength);\n// console.log('pS ' + prefixStart);\n              var prefix = selectedParentElement.textContent.substr(prefixStart, start - prefixStart);\n// console.log('-' + prefix + '-');\n              prefix = DO.U.htmlEntities(prefix);\n\n              var suffixEnd = Math.min(selectedParentElement.textContent.length, end + DO.C.ContextLength);\n// console.log('sE ' + suffixEnd);\n              var suffix = selectedParentElement.textContent.substr(end, suffixEnd - end);\n// console.log('-' + suffix + '-');\n              suffix = DO.U.htmlEntities(suffix);\n\n              var datetime = util.getDateTimeISO();\n              var id = DO.U.generateAttributeId();\n              var refId = 'r-' + id;\n              // var noteId = 'i-' + id;\n\n              var resourceIRI = uri.stripFragmentFromString(document.location.href);\n              var containerIRI = window.location.href;\n\n              var selectorIRI = resourceIRI + '#selector(type=TextQuoteSelector,prefix=' + encodeURIComponent(prefix) + ',exact=' + encodeURIComponent(exact) + ',suffix=' + encodeURIComponent(suffix) +')';\n\n              var contentType = 'text/html';\n              var noteIRI, noteURL;\n              var profile, options;\n              var annotationDistribution = [] , aLS = {};\n\n              if((opts.annotationLocationPersonalStorage && DO.C.User.Outbox) || (!opts.annotationLocationPersonalStorage && !opts.annotationLocationService && DO.C.User.Outbox)) {\n                containerIRI = DO.C.User.Outbox[0];\n\n                var fromContentType = 'text/html';\n                // contentType = 'application/ld+json';\n                contentType = fromContentType;\n\n                noteURL = noteIRI = containerIRI + id;\n                var contextProfile = {\n                  '@context': [\n                    'https://www.w3.org/ns/activitystreams',\n                    { 'oa': 'http://www.w3.org/ns/oa#', 'schema': 'http://schema.org/' }\n                  ],\n                  // 'subjectURI': noteIRI,\n                  'profile': 'https://www.w3.org/ns/activitystreams'\n                };\n                aLS = { 'id': id, 'containerIRI': containerIRI, 'noteURL': noteURL, 'noteIRI': noteIRI, 'fromContentType': fromContentType, 'contentType': contentType };\n                if (typeof DO.C.User.Storage === 'undefined') {\n                  aLS['canonical'] = true;\n                }\n\n                aLS = Object.assign(aLS, contextProfile)\n\n                annotationDistribution.push(aLS);\n              }\n\n              //XXX: Use this as the canonical if available. Note how noteIRI is treated later\n              if((opts.annotationLocationPersonalStorage && DO.C.User.Storage) || (!opts.annotationLocationPersonalStorage && !opts.annotationLocationService && DO.C.User.Storage)) {\n                containerIRI = DO.C.User.Storage[0];\n\n                var fromContentType = 'text/html';\n                // contentType = 'text/html';\n                contentType = fromContentType;\n\n                noteURL = noteIRI = containerIRI + id;\n                var contextProfile = {\n                  // 'subjectURI': noteIRI,\n                };\n                aLS = { 'id': id, 'containerIRI': containerIRI, 'noteURL': noteURL, 'noteIRI': noteIRI, 'fromContentType': fromContentType, 'contentType': contentType, 'canonical': true };\n\n                annotationDistribution.push(aLS);\n              }\n\n              if(opts.annotationLocationService && typeof DO.C.AnnotationService !== 'undefined') {\n                containerIRI = DO.C.AnnotationService;\n                var fromContentType = 'text/html';\n                // contentType = 'application/ld+json';\n                contentType = fromContentType;\n\n                var contextProfile = {\n                  '@context': [\n                    'http://www.w3.org/ns/anno.jsonld',\n                    { 'as': 'https://www.w3.org/ns/activitystreams#', 'schema': 'http://schema.org/' }\n                  ],\n                  // 'subjectURI': noteIRI,\n                  'profile': 'http://www.w3.org/ns/anno.jsonld'\n                };\n\n                if(!opts.annotationLocationPersonalStorage && opts.annotationLocationService) {\n                  noteURL = noteIRI = containerIRI + id;\n                  aLS = { 'id': id, 'containerIRI': containerIRI, 'noteURL': noteURL, 'noteIRI': noteIRI, 'fromContentType': fromContentType, 'contentType': contentType, 'canonical': true };\n                }\n                else if(opts.annotationLocationPersonalStorage) {\n                  noteURL = containerIRI + id;\n                  aLS = { 'id': id, 'containerIRI': containerIRI, 'noteURL': noteURL, 'noteIRI': noteIRI, 'fromContentType': fromContentType, 'contentType': contentType };\n                }\n                else {\n                  noteURL = noteIRI = containerIRI + id;\n                  aLS = { 'id': id, 'containerIRI': containerIRI, 'noteURL': noteURL, 'noteIRI': noteIRI, 'fromContentType': fromContentType, 'contentType': contentType, 'canonical': true };\n                }\n\n                aLS = Object.assign(aLS, contextProfile)\n\n                annotationDistribution.push(aLS);\n              }\n\n// console.log(annotationDistribution);\n\n              //XXX: Defaulting to id but overwritten by motivation symbol\n              var refLabel = id;\n\n              var parentNodeWithId = selectedParentElement.closest('[id]');\n              var targetIRI = (parentNodeWithId) ? resourceIRI + '#' + parentNodeWithId.id : resourceIRI;\n\n              //Role/Capability for Authors/Editors\n              var ref = '', refType = ''; //TODO: reference types. UI needs input\n              //TODO: replace refId and noteIRI IRIs\n\n              //This class is added if it is only for display purposes e.g., loading an external annotation for view, but do not want to save it later on (as it will be stripped when 'do' is found)\n              var doClass = '';\n\n              //TODO: oa:TimeState's datetime should equal to hasSource value. Same for oa:HttpRequestState's rdfs:value\n              // <span about=\"[this:#' + refId + ']\" rel=\"oa:hasState\">(timeState: <time typeof=\"oa:TimeState\" datetime=\"' + datetime +'\" datatype=\"xsd:dateTime\"property=\"oa:sourceDate\">' + datetime + '</time>)</span>\\n\\\n\n              var noteData = {};\n              var note = '';\n              var licenseIRI = '';\n              var motivatedBy = 'oa:replying';\n\n              var createNoteData = function(annotation) {\n                var id = annotation.id;\n                var note = '';\n                var mode = '';\n\n                if (annotation && 'profile' in annotation && annotation.profile == 'https://www.w3.org/ns/activitystreams') {\n                  mode = 'object'\n                }\n                else {\n                  mode = 'write'\n                }\n\n                switch(_this.action) {\n                  case 'sparkline':\n                    var figureIRI = DO.U.generateAttributeId(null, opts.selectionDataSet);\n                    ref = '<span rel=\"schema:hasPart\" resource=\"#figure-' + figureIRI + '\">\\n\\\n                    <a href=\"' + opts.select + '\" property=\"schema:name\" rel=\"prov:wasDerivedFrom\" resource=\"' + opts.select + '\" typeof=\"qb:DataSet\">' + opts.selectionDataSet + '</a> [' + DO.U.htmlEntities(DO.C.RefAreas[opts.selectionRefArea]) + ']\\n\\\n                    <span class=\"sparkline\" rel=\"schema:image\" resource=\"#' + figureIRI + '\">' + opts.sparkline + '</span></span>';\n                    break;\n\n                  //External Note\n                  case 'article': case 'approve': case 'disapprove': case 'specificity':\n                    if (DO.U.Editor.MediumEditor.options.id === 'review') {\n                      motivatedBy = 'oa:assessing';\n                      refLabel = DO.U.getReferenceLabel(motivatedBy);\n                    }\n\n                    ref = _this.base.selection;\n                    licenseIRI = opts.license;\n\n                    noteData = {\n                      \"type\": _this.action,\n                      \"mode\": mode,\n                      \"motivatedByIRI\": motivatedBy,\n                      \"id\": id,\n                      \"canonical\": 'urn:uuid:' + id,\n                      \"refId\": refId,\n                      \"refLabel\": refLabel,\n                      // \"iri\": noteIRI, //e.g., https://example.org/path/to/article\n                      \"creator\": {},\n                      \"datetime\": datetime,\n                      \"target\": {\n                        \"iri\": targetIRI,\n                        \"source\": resourceIRI,\n                        \"selector\": {\n                          \"exact\": exact,\n                          \"prefix\": prefix,\n                          \"suffix\": suffix\n                        }\n                        //TODO: state\n                      },\n                      \"body\": opts.content,\n                      \"license\": {}\n                    };\n                    if (DO.C.User.IRI) {\n                      noteData.creator[\"iri\"] = DO.C.User.IRI;\n                    }\n                    if (DO.C.User.Name) {\n                      noteData.creator[\"name\"] = DO.C.User.Name;\n                    }\n                    if (DO.C.User.Image) {\n                      noteData.creator[\"image\"] = DO.C.User.Image;\n                    }\n                    if (DO.C.User.URL) {\n                      noteData.creator[\"url\"] = DO.C.User.URL;\n                    }\n                    if (opts.license.length > 0) {\n                      noteData.license[\"iri\"] = opts.license;\n                    }\n                    // note = DO.U.createNoteDataHTML(noteData);\n                    break;\n\n                  //Internal Note\n                  case 'note':\n                    motivatedBy = \"oa:commenting\";\n                    refLabel = DO.U.getReferenceLabel(motivatedBy);\n                    docRefType = '<sup class=\"ref-comment\"><a rel=\"cito:isCitedBy\" href=\"#' + id + '\">' + refLabel + '</a></sup>';\n                    noteType = 'note';\n                    noteData = {\n                      \"type\": noteType,\n                      \"mode\": \"read\",\n                      \"motivatedByIRI\": motivatedBy,\n                      \"id\": id,\n                      \"refId\": refId,\n                      \"refLabel\": refLabel,\n                      // \"iri\": noteIRI, //e.g., https://example.org/path/to/article\n                      \"creator\": {},\n                      \"datetime\": datetime,\n                      \"target\": {\n                        \"iri\": targetIRI,\n                        \"source\": resourceIRI,\n                        \"selector\": {\n                          \"exact\": exact,\n                          \"prefix\": prefix,\n                          \"suffix\": suffix\n                        }\n                        //TODO: state\n                      },\n                      \"body\": {\n                        \"purpose\": {\n                          \"describing\": {\n                            \"text\": opts.content\n                          },\n                          \"tagging\": {\n                            \"text\": opts.tagging\n                          }\n                        }\n                      },\n                      \"license\": {}\n                    };\n                    if (DO.C.User.IRI) {\n                      noteData.creator[\"iri\"] = DO.C.User.IRI;\n                    }\n                    if (DO.C.User.Name) {\n                      noteData.creator[\"name\"] = DO.C.User.Name;\n                    }\n                    if (DO.C.User.Image) {\n                      noteData.creator[\"image\"] = DO.C.User.Image;\n                    }\n                    if (DO.C.User.URL) {\n                      noteData.creator[\"url\"] = DO.C.User.URL;\n                    }\n                    if (opts.license.length > 0) {\n                      noteData.license[\"iri\"] = opts.license;\n                    }\n\n                    // note = DO.U.createNoteDataHTML(noteData);\n\n                    ref = DO.U.getTextQuoteHTML(refId, exact, docRefType);\n                    break;\n\n                  case 'cite': //footnote reference\n                    switch(opts.citationType) {\n                      case 'ref-footnote': default:\n                        motivatedBy = \"oa:describing\";\n                        refLabel = DO.U.getReferenceLabel(motivatedBy);\n                        docRefType = '<sup class=\"' + opts.citationType + '\"><a rel=\"cito:isCitedBy\" href=\"#' + id + '\">' + refLabel + '</a></sup>';\n                        noteData = {\n                          \"type\": opts.citationType,\n                          \"mode\": mode,\n                          \"motivatedByIRI\": motivatedBy,\n                          \"id\": id,\n                          \"refId\": refId,\n                          \"refLabel\": refLabel,\n                          // \"iri\": noteIRI,\n                          \"datetime\": datetime,\n                          \"body\": opts.content,\n                          \"citationURL\": opts.url\n                        };\n\n                        // note = DO.U.createNoteDataHTML(noteData);\n                        break;\n\n                      case 'ref-reference':\n                        refLabel = DO.U.getReferenceLabel('oa:describing');\n                        docRefType = '<span class=\"' + opts.citationType + '\">' + DO.C.RefType[DO.C.DocRefType].InlineOpen + '<a href=\"#' + id + '\">' + refLabel + '</a>' + DO.C.RefType[DO.C.DocRefType].InlineClose + '</span>';\n                        break;\n                    }\n\n                    ref = DO.U.getTextQuoteHTML(refId, exact, docRefType);\n                    break;\n                  // case 'reference':\n                  //   ref = '<span class=\"ref\" about=\"[this:#' + refId + ']\" typeof=\"dctypes:Text\"><span id=\"'+ refId +'\" property=\"schema:description\">' + this.base.selection + '</span> <span class=\"ref-reference\">' + DO.C.RefType[DO.C.DocRefType].InlineOpen + '<a rel=\"cito:isCitedBy\" href=\"#' + id + '\">' + refLabel + '</a>' + DO.C.RefType[DO.C.DocRefType].InlineClose + '</span></span>';\n  //                  break;\n\n                  case 'rdfa':\n                    //TODO: inlist, prefix\n                    //TODO: lang/xmlllang\n                    noteData = {\n                      about: opts.about,\n                      typeOf: opts.typeOf,\n                      rel: opts.rel,\n                      href: opts.href,\n                      resource: opts.resource,\n                      property: opts.property,\n                      content: opts.content,\n                      datatype: opts.datatype,\n                      textContent: _this.base.selection\n                      // lang: '' and/or xmllang: ''\n                    };\n                    ref = DO.U.createRDFaHTML(noteData, 'expanded');\n                    break;\n\n                  case 'bookmark':\n                    noteType = 'bookmark';\n                    motivatedBy = \"oa:bookmarking\";\n                    refLabel = DO.U.getReferenceLabel(motivatedBy);\n                    docRefType = '';\n                    noteData = {\n                      \"type\": noteType,\n                      \"mode\": mode,\n                      \"motivatedByIRI\": motivatedBy,\n                      \"id\": id,\n                      \"canonical\": 'urn:uuid:' + id,\n                      \"refId\": refId,\n                      \"refLabel\": refLabel,\n                      // \"iri\": noteIRI, //e.g., https://example.org/path/to/article\n                      \"creator\": {},\n                      \"datetime\": datetime,\n                      \"target\": {\n                        \"iri\": targetIRI,\n                        \"source\": resourceIRI,\n                        \"selector\": {\n                          \"exact\": exact,\n                          \"prefix\": prefix,\n                          \"suffix\": suffix\n                        }\n                        //TODO: state\n                      },\n                      \"body\": {\n                        \"purpose\": {\n                          \"describing\": {\n                            \"text\": opts.content\n                          },\n                          \"tagging\": {\n                            \"text\": opts.tagging\n                          }\n                        }\n                      },\n                      \"license\": {}\n                    };\n                    if (DO.C.User.IRI) {\n                      noteData.creator[\"iri\"] = DO.C.User.IRI;\n                    }\n                    if (DO.C.User.Name) {\n                      noteData.creator[\"name\"] = DO.C.User.Name;\n                    }\n                    if (DO.C.User.Image) {\n                      noteData.creator[\"image\"] = DO.C.User.Image;\n                    }\n                    if (DO.C.User.URL) {\n                      noteData.creator[\"url\"] = DO.C.User.URL;\n                    }\n                    // note = DO.U.createNoteDataHTML(noteData);\n                    ref = DO.U.getTextQuoteHTML(refId, exact, docRefType, { 'do': true });\n                    break;\n                }\n\n                var selectionUpdated = ref;\n                MediumEditor.util.insertHTMLCommand(_this.base.selectedDocument, selectionUpdated);\n\n                return noteData;\n              }\n\n              var createNotificationData = function(annotation, options) {\n                options = options || {};\n                var notificationType, notificationObject, notificationContext, notificationTarget, notificationStatements;\n\n                var noteIRI = (options.relativeObject) ? '#' + id : annotation['noteIRI'];\n\n                notificationStatements = '    <dl about=\"' + noteIRI + '\">\\n\\\n  <dt>Object type</dt><dd><a about=\"' + noteIRI + '\" typeof=\"oa:Annotation\" href=\"' + DO.C.Vocab['oaannotation']['@id'] + '\">Annotation</a></dd>\\n\\\n  <dt>Motivation</dt><dd><a href=\"' + DO.C.Prefixes[motivatedBy.split(':')[0]] + motivatedBy.split(':')[1] + '\" property=\"oa:motivation\">' + motivatedBy.split(':')[1] + '</a></dd>\\n\\\n</dl>\\n\\\n';\n\n                switch(_this.action) {\n                  default: case 'article': case 'specificity':\n                    notificationType = ['as:Create'];\n                    notificationObject = noteIRI;\n                    notificationTarget = targetIRI;\n                    break;\n                  case 'approve':\n                    notificationType = ['as:Like'];\n                    notificationObject = targetIRI;\n                    notificationContext = noteIRI;\n                    break;\n                  case 'disapprove':\n                    notificationType = ['as:Dislike'];\n                    notificationObject = targetIRI;\n                    notificationContext = noteIRI;\n                    break;\n                  case 'bookmark':\n                    notificationType = ['as:Add'];\n                    notificationObject = noteIRI;\n                    notificationTarget = annotation['containerIRI'];\n                    break;\n                }\n\n                var notificationData = {\n                  \"type\": notificationType,\n                  \"slug\": id,\n                  \"object\": notificationObject,\n                  \"license\": opts.license\n                };\n\n                if(typeof notificationContext !== 'undefined') {\n                  notificationData['context'] = notificationContext;\n                }\n\n                if(typeof notificationTarget !== 'undefined') {\n                  notificationData['target'] = notificationTarget;\n                }\n\n                notificationData['statements'] = notificationStatements;\n\n                return notificationData;\n              }\n\n              var positionActivity = function(annotation) {\n                if (!annotation['canonical']) {\n                  return Promise.resolve();\n                }\n\n                if ('profile' in annotation && annotation.profile == 'https://www.w3.org/ns/activitystreams') {\n                  return DO.U.showActivities(annotation['noteIRI'])\n                    .catch(() => {\n                      return Promise.resolve()\n                    })\n                }\n                else {\n                  return DO.U.positionInteraction(annotation[ 'noteIRI' ], document.body)\n                    .catch(() => {\n                      return Promise.resolve()\n                    })\n                }\n              }\n\n              var sendNotification = function(annotation) {\n                if (!annotation['canonical']) {\n                  return Promise.resolve();\n                }\n// console.log(annotation)\n\n                return inbox.getEndpoint(DO.C.Vocab['ldpinbox']['@id'])\n                  .catch(error => {\n                    console.log('Error fetching ldpinbox endpoint:', error)\n                    throw error\n                  })\n                  .then(inboxes => {\n                    // TODO: resourceIRI for getEndpoint should be the\n                    // closest IRI (not necessarily the document).\n\n                    if (inboxes.length > 0) {\n                      var notificationData = createNotificationData(annotation);\n\n                      notificationData['inbox'] = inboxes[0];\n\n                      // notificationData['type'] = ['as:Announce'];\n// console.log(annotation)\n                      return inbox.notifyInbox(notificationData)\n                        .catch(error => {\n                          console.log('Error notifying the inbox:', error)\n                        })\n                    }\n                  })\n              }\n\n              switch(this.action) {\n                case 'article': case 'approve': case 'disapprove': case 'specificity': case 'bookmark':\n                  annotationDistribution.forEach(annotation => {\n                    var data = '';\n\n                    var notificationData = createNotificationData(annotation, { 'relativeObject': true });\n\n                    var noteData = createNoteData(annotation)\n\n                    if ('profile' in annotation && annotation.profile == 'https://www.w3.org/ns/activitystreams') {\n                      notificationData['statements'] = DO.U.createNoteDataHTML(noteData);\n                      note = DO.U.createActivityHTML(notificationData);\n                    }\n                    else {\n                      note = DO.U.createNoteDataHTML(noteData);\n                    }\n\n                    data = DO.U.createHTML('', note);\n// console.log(data)\n// console.log(annotation)\n\n                    fetcher.postActivity(annotation['containerIRI'], id, data, annotation)\n                      .catch(error => {\n                        // console.log('Error serializing annotation:', error)\n                        console.log(error)\n                        throw error  // re-throw, break out of promise chain\n                      })\n\n                      .then(response => {\n                        var location = response.headers.get('Location')\n\n                        if (location) {\n                          location = uri.getAbsoluteIRI(annotation['containerIRI'], location)\n                          annotation['noteIRI'] = annotation['noteURL'] = location\n                        }\n\n// console.log(annotation)\n                        return positionActivity(annotation)\n                       })\n\n                      .then(() => {\n                        if (this.action != 'bookmark') {\n                          return sendNotification(annotation)\n                        }\n                      })\n\n                      .catch(() => {  // catch-all\n                        // suppress the error, it was already logged to the console above\n                        // nothing else needs to be done, the loop will proceed\n                        // to the next annotation\n                      })\n                  })\n                  break;\n\n                case 'note':\n                  var noteData = createNoteData({'id': id})\n                  note = DO.U.createNoteDataHTML(noteData);\n                  var nES = selectedParentElement.nextElementSibling;\n                  var asideNote = '\\n\\\n<aside class=\"note\">\\n\\\n'+ note + '\\n\\\n</aside>';\n                  var asideNode = DO.U.fragmentFromString(asideNote);\n                  var parentSection = MediumEditor.util.getClosestTag(selectedParentElement, 'section');\n                  parentSection.appendChild(asideNode);\n\n                  DO.U.positionNote(refId, refLabel, id);\n                  break;\n\n                case 'selector':\n                  window.history.replaceState({}, null, selectorIRI);\n                  DO.U.showActionMessage(document.documentElement, 'Copy URL from address bar')\n                  // util.copyTextToClipboard(encodeURI(selectorIRI));\n                  break;\n\n                case 'cite': //footnote reference\n                  //TODO: Refactor this what's in positionInteraction\n\n                  var noteData = createNoteData({'id': id})\n                  note = DO.U.createNoteDataHTML(noteData);\n\n                  switch(opts.citationType) {\n                    case 'ref-footnote': default:\n                      var nES = selectedParentElement.nextElementSibling;\n                      var asideNote = '\\n\\\n<aside class=\"note\">\\n\\\n'+ note + '\\n\\\n</aside>';\n                      var asideNode = DO.U.fragmentFromString(asideNote);\n                      var parentSection = MediumEditor.util.getClosestTag(selectedParentElement, 'section');\n                      parentSection.appendChild(asideNode);\n\n                      DO.U.positionNote(refId, refLabel, id);\n                      break;\n\n                    case 'ref-reference':\n                      var options = opts;\n                      options['citationId'] = opts.url;\n                      options['refId'] = refId;\n\n                      DO.U.getCitation(opts.url, options).then(function(citationGraph) {\n                        var citationURI = '';\n                        if(opts.url.match(/^10\\.\\d+\\//)) {\n                          citationURI = 'http://dx.doi.org/' + opts.url;\n                          options.citationId = citationURI;\n                        }\n                        //FIXME: subjectIRI shouldn't be set here. Bug in RDFaProcessor (see also SimpleRDF ES5/6). See also: https://github.com/linkeddata/dokieli/issues/132\n                        else if (opts.url.toLowerCase().indexOf('//dx.doi.org/') >= 0) {\n                          citationURI = opts.url;\n                          if (opts.url.toLowerCase().startsWith('https:')) {\n                            citationURI = opts.url.replace(/^https/, 'http');\n                          }\n                        }\n                        else if (uri.stripFragmentFromString(options.citationId) !== uri.getProxyableIRI(options.citationId)) {\n                          citationURI = window.location.origin + window.location.pathname;\n                        }\n                        else {\n                          citationURI = options.citationId;\n                        }\n\n                        var citation = DO.U.getCitationHTML(citationGraph, citationURI, options);\n\n                        var r = document.querySelector('#references ol');\n                        if (!r) {\n                          var nodeInsertLocation = DO.U.selectArticleNode(document);\n                          var section = '<section id=\"references\"><h2>References</h2><div><ol></ol></div></section>';\n                          nodeInsertLocation.insertAdjacentHTML('beforeend', section);\n                          r = document.querySelector('#references ol');\n                        }\n                        var citationHTML = '<li id=\"' + id + '\">' + citation + '</li>';\n                        r.insertAdjacentHTML('beforeend', citationHTML);\n\n                        DO.U.showRobustLinks();\n\n// console.log(options.url);\n                        var s = citationGraph.child(citationURI);\n                        if(s.ldpinbox._array.length == 0) {\n                          s = citationGraph.child(options.citationId);\n                        }\n\n                        if (s.ldpinbox._array.length > 0) {\n                          var inboxURL = s.ldpinbox.at(0);\n// console.log(inboxURL);\n\n                          var citedBy = location.href.split(location.search||location.hash||/[?#]/)[0] + '#' + options.refId;\n\n                          var notificationStatements = '    <dl about=\"' + citedBy + '\">\\n\\\n      <dt>Action</dt><dd>Citation</dd>\\n\\\n      <dt>Cited by</dt><dd><a href=\"' + citedBy + '\">' + citedBy + '</a></dd>\\n\\\n      <dt>Cites</dt><dd><a href=\"' + options.url + '\" property=\"' + options.citationRelation + '\">' + options.url + '</a></dd>\\n\\\n      <dt>Citation type</dt><dd><a href=\"' + options.url + '\">' + DO.C.Citation[options.citationRelation] + '</a></dd>\\n\\\n    </dl>\\n\\\n';\n\n                          var notificationData = {\n                            \"type\": ['as:Announce'],\n                            \"inbox\": inboxURL,\n                            \"object\": citedBy,\n                            \"target\": options.url,\n                            \"statements\": notificationStatements\n                          };\n\n                          inbox.notifyInbox(notificationData).then(\n                            function(s){\n                              console.log('Sent Linked Data Notification to ' + inboxURL);\n                            });\n                        }\n                      });\n                      break;\n                  }\n                  break;\n\n                case 'rdfa':\n                  //This only updates the DOM. Nothing further. The 'id' is not used.\n                  var noteData = createNoteData({'id': id});\n                  break;\n              }\n\n              this.window.getSelection().removeAllRanges();\n              this.base.checkSelection();\n            },\n\n            checkLinkFormat: function (value) {\n              var re = /^(https?|ftps?|rtmpt?):\\/\\/|mailto:/;\n              return (re.test(value) ? '' : 'http://') + value;\n            },\n\n            doFormCancel: function () {\n              this.base.restoreSelection();\n              this.base.checkSelection();\n            },\n\n            // form creation and event handling\n            attachFormEvents: function (form) {\n              var close = form.querySelector('.medium-editor-toolbar-close'),\n                save = form.querySelector('.medium-editor-toolbar-save');\n\n              this.on(form, 'click', this.handleFormClick.bind(this));\n              this.on(close, 'click', this.handleCloseClick.bind(this));\n              this.on(save, 'click', this.handleSaveClick.bind(this), true);\n            },\n\n            createForm: function () {\n              var doc = this.document,\n                form = doc.createElement('div');\n\n              // Anchor Form (div)\n              form.className = 'medium-editor-toolbar-form';\n              //FIXME\n              form.id = 'medium-editor-toolbar-form-textarea-' + this.getEditorId();\n              form.innerHTML = this.getTemplate();\n              this.attachFormEvents(form);\n\n              return form;\n            },\n\n            getInput: function () {\n              var r = {};\n              switch(this.action) {\n                case 'rdfa':\n                  r.about = this.getForm().querySelector('#rdfa-about.medium-editor-toolbar-input');\n                  r.rel = this.getForm().querySelector('#rdfa-rel.medium-editor-toolbar-input');\n                  r.href = this.getForm().querySelector('#rdfa-href.medium-editor-toolbar-input');\n                  r.typeOf = this.getForm().querySelector('#rdfa-typeof.medium-editor-toolbar-input');\n                  r.resource = this.getForm().querySelector('#rdfa-resource.medium-editor-toolbar-input');\n                  r.property = this.getForm().querySelector('#rdfa-property.medium-editor-toolbar-input');\n                  r.content = this.getForm().querySelector('#rdfa-content.medium-editor-toolbar-input');\n                  r.datatype = this.getForm().querySelector('#rdfa-datatype.medium-editor-toolbar-input');\n                  break;\n                case 'article':\n                  r.content = this.getForm().querySelector('#article-content.medium-editor-toolbar-textarea');\n                  r.annotationLocationService = this.getForm().querySelector('#annotation-location-service');\n                  r.annotationLocationPersonalStorage = this.getForm().querySelector('#annotation-location-personal-storage');\n                  r.license = this.getForm().querySelector('#article-license.medium-editor-toolbar-select');\n                  break;\n                case 'note':\n                  r.content = this.getForm().querySelector('#article-content.medium-editor-toolbar-textarea');\n                  r.tagging = this.getForm().querySelector('#bookmark-tagging.medium-editor-toolbar-input');\n                  r.license = this.getForm().querySelector('#article-license.medium-editor-toolbar-select');\n                  break;\n                case 'approve':\n                  r.content = this.getForm().querySelector('#approve-content.medium-editor-toolbar-textarea');\n                  r.annotationLocationService = this.getForm().querySelector('#annotation-location-service');\n                  r.annotationLocationPersonalStorage = this.getForm().querySelector('#annotation-location-personal-storage');\n                  r.license = this.getForm().querySelector('#approve-license.medium-editor-toolbar-select');\n                  break;\n                case 'disapprove':\n                  r.content = this.getForm().querySelector('#disapprove-content.medium-editor-toolbar-textarea');\n                  r.annotationLocationService = this.getForm().querySelector('#annotation-location-service');\n                  r.annotationLocationPersonalStorage = this.getForm().querySelector('#annotation-location-personal-storage');\n                  r.license = this.getForm().querySelector('#disapprove-license.medium-editor-toolbar-select');\n                  break;\n                case 'specificity':\n                  r.content = this.getForm().querySelector('#specificity-content.medium-editor-toolbar-textarea');\n                  r.annotationLocationService = this.getForm().querySelector('#annotation-location-service');\n                  r.annotationLocationPersonalStorage = this.getForm().querySelector('#annotation-location-personal-storage');\n                  r.license = this.getForm().querySelector('#specificity-license.medium-editor-toolbar-select');\n                  break;\n                case 'cite':\n                  r.citationType = this.getForm().querySelector('input[name=\"citation-type\"]:checked');\n                  r.citationRelation = this.getForm().querySelector('#citation-relation.medium-editor-toolbar-select');\n                  r.url = this.getForm().querySelector('#citation-url.medium-editor-toolbar-input');\n                  r.content = this.getForm().querySelector('#citation-content.medium-editor-toolbar-textarea');\n                  break;\n                case 'bookmark':\n                  r.content = this.getForm().querySelector('#bookmark-content.medium-editor-toolbar-textarea');\n                  r.tagging = this.getForm().querySelector('#bookmark-tagging.medium-editor-toolbar-input');\n                  break;\n                case 'sparkline':\n                  r.search = this.getForm().querySelector('#sparkline-search.medium-editor-toolbar-input');\n                  r.select = this.getForm().querySelector('#sparkline-select');\n                  r.sparkline = this.getForm().querySelector('#sparkline-graph .sparkline');\n                  r.selectionDataSet = this.getForm().querySelector('#sparkline-selection-dataset');\n                  r.selectionRefArea = this.getForm().querySelector('#sparkline-selection-refarea');\n                  break;\n\n                default:\n                  r = this.getForm().querySelector('textarea.medium-editor-toolbar-textarea');\n                  break;\n              }\n\n              return r;\n            },\n\n            getAnchorTargetCheckbox: function () {\n              return this.getForm().querySelector('.medium-editor-toolbar-textarea-target');\n            },\n\n            getAnchorButtonCheckbox: function () {\n              return this.getForm().querySelector('.medium-editor-toolbar-textarea-button');\n            },\n\n            handleTextboxKeyup: function (event) {\n              // For ENTER -> create the anchor\n              if (event.keyCode === MediumEditor.util.keyCode.ENTER) {\n                event.preventDefault();\n                this.doFormSave();\n                return;\n              }\n\n              // For ESCAPE -> close the form\n              if (event.keyCode === MediumEditor.util.keyCode.ESCAPE) {\n                event.preventDefault();\n                this.doFormCancel();\n              }\n            },\n\n            handleFormClick: function (event) {\n              // make sure not to hide form when clicking inside the form\n              event.stopPropagation();\n            },\n\n            handleSaveClick: function (event) {\n              // Clicking Save -> create the anchor\n              event.preventDefault();\n              this.doFormSave();\n            },\n\n            handleCloseClick: function (event) {\n              // Click Close -> close the form\n              event.preventDefault();\n              this.doFormCancel();\n            }\n          });\n        }\n      })()\n\n    }, //DO.U.Editor\n\n    init: function() {\n      if(document.body) {\n        DO.U.initUser();\n        DO.U.initCurrentStylesheet();\n        DO.U.setPolyfill();\n        DO.U.setDocRefType();\n        DO.U.showRefs();\n        DO.U.buttonClose();\n        DO.U.highlightItems();\n        DO.U.initDocumentActions();\n        DO.U.getResourceInfo();\n        DO.U.showTextQuoteSelector();\n        DO.U.showDocumentInfo();\n        DO.U.showFragment();\n        DO.U.showRobustLinks();\n        DO.U.setDocumentMode();\n        DO.U.showInboxNotifications();\n        DO.U.initMath();\n      }\n    }\n\n  } //DO.U\n}; //DO\n\n  if (document.addEventListener) {\n    document.addEventListener('DOMContentLoaded', function(){ DO.U.init(); });\n  }\n}\n\nmodule.exports = DO\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/dokieli.js\n// module id = 9\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_10__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fetch\"\n// module id = 10\n// module chunks = 0","'use strict'\n\nconst util = require('./util')\nconst doc = require('./doc')\nconst uri = require('./uri')\nconst graph = require('./graph')\nconst fetcher = require('./fetcher')\nconst Config = require('./config')\n\nmodule.exports = {\n  getEndpoint,\n  getEndpointFromHead,\n  getEndpointFromRDF,\n  notifyInbox,\n  sendNotifications\n}\n\nfunction sendNotifications (tos, note, iri, shareResource) {\n  return new Promise((resolve, reject) => {\n    var notificationData = {\n      'type': ['as:Announce'],\n      'object': iri,\n      'summary': note,\n      'license': 'https://creativecommons.org/licenses/by/4.0/'\n    }\n\n    let data = doc.getDocument()\n\n    let options = {\n      'contentType': 'text/html',\n      'subjectURI': iri\n    }\n    var spo = {\n      'subject': iri,\n      'predicate': Config.Vocab['rdftype']['@id']\n    }\n\n    graph.getMatchFromData(data, spo, options)\n      .then(supplementalData => {\n        if (typeof supplementalData !== 'undefined' && supplementalData._array.length > 0) {\n          notificationData['objectTypes'] = supplementalData._array\n        }\n\n        let spo = {\n          'subject': iri,\n          'predicate': Config.Vocab['schemalicense']['@id']\n        }\n\n        return graph.getMatchFromData(data, spo, options)\n          .then(data => {\n            if (typeof data !== 'undefined' && data.length > 0) {\n              notificationData['objectLicense'] = data\n            }\n          })\n      })\n      .then(() => {\n        tos.forEach(to => {\n          notificationData['to'] = to\n\n          var toInput = shareResource.querySelector('[value=\"' + to + '\"]') ||\n            shareResource.querySelector('#share-resource-to')\n\n          toInput.parentNode.insertAdjacentHTML('beforeend',\n            '<span class=\"progress\" data-to=\"' + to +\n            '\"><i class=\"fa fa-circle-o-notch fa-spin fa-fw\"></i></span>')\n\n          inboxResponse(to, toInput)\n\n            .then(inboxURL => {\n              notificationData['inbox'] = inboxURL\n\n              notifyInbox(notificationData)\n\n                .catch(error => {\n                  console.log('Error in notifyInbox:', error)\n                  toInput\n                    .parentNode\n                    .querySelector('.progress[data-to=\"' + to + '\"]')\n                    .innerHTML = '<i class=\"fa fa-times-circle fa-fw \"></i> Unable to notify. Try later.'\n                })\n\n                .then(response => {\n                    var location = response.headers.get('Location')\n\n                    if (location) {\n                      location = uri.getAbsoluteIRI(inboxURL, location)\n\n                      toInput\n                        .parentNode\n                        .querySelector('.progress[data-to=\"' + to + '\"]')\n                        .innerHTML = '<a target=\"_blank\" href=\"' +\n                        location + '\"><i class=\"fa fa-check-circle fa-fw\"></i></a>'\n                    }\n                  }\n                )\n            })\n        })\n      })\n  })\n}\n\nfunction inboxResponse (to, toInput) {\n  return getEndpoint(Config.Vocab['ldpinbox']['@id'], to)\n    .then(inboxes => inboxes[0])\n\n    .catch(error => {\n      console.log('Error in inboxResponse:', error)\n\n      toInput\n        .parentNode\n        .querySelector('.progress[data-to=\"' + to + '\"]')\n        .innerHTML = '<i class=\"fa fa-times-circle fa-fw\"></i> Inbox not responding. Try later.'\n    })\n}\n\nfunction notifyInbox (o) {\n  var slug, inboxURL\n\n  if ('slug' in o) {\n    slug = o.slug\n  }\n  if ('inbox' in o) {\n    inboxURL = o.inbox\n  }\n\n  if (!inboxURL) {\n    return Promise.reject(new Error('No inbox to send notification to'))\n  }\n\n  //TODO title\n  var title = '';\n  var data = DO.U.createActivityHTML(o)\n\n  data = DO.U.createHTML(title, data, { 'prefixes': Config.Prefixes })\n\n  var options = {\n    'contentType': 'text/html',\n    'profile': 'https://www.w3.org/ns/activitystreams'\n  }\n\n  var pIRI = uri.getProxyableIRI(inboxURL)\n  return fetcher.postActivity(pIRI, slug, data, options)\n}\n\nfunction getEndpoint (property, url) {\n  if (url) {\n    return getEndpointFromHead(property, url)\n      .catch(() => getEndpointFromRDF(property, url))\n  } else {\n    var subjectURI = window.location.href.split(window.location.search || window.location.hash || /[?#]/)[0]\n\n    var options = {\n      'contentType': 'text/html',\n      'subjectURI': subjectURI\n    }\n\n    return graph.getGraphFromData(doc.getDocument(), options)\n      .then(function (result) {\n          // TODO: Should this get all of the inboxes or a given subject's?\n          var endpoints = result.match(subjectURI, property).toArray()\n          if (endpoints.length > 0) {\n            return endpoints.map(function(t){ return t.object.nominalValue })\n          }\n\n// console.log(property + ' endpoint was not found in message body')\n          return getEndpointFromHead(property, subjectURI)\n        })\n      .catch(() => getEndpointFromHead(property, subjectURI))\n  }\n}\n\nfunction getEndpointFromHead (property, url) {\n  var pIRI = uri.getProxyableIRI(url);\n\n  return fetcher.getResourceHead(pIRI, {'header': 'Link'}).then(\n    function (i) {\n      var linkHeaders = fetcher.parseLinkHeader(i.headers)\n\n      if (property in linkHeaders) {\n        return linkHeaders[property]\n      }\n      return Promise.reject({'message': property + \" endpoint was not found in 'Link' header\"})\n    },\n    function (reason) {\n      return Promise.reject({'message': \"'Link' header not found\"})\n    }\n  );\n}\n\nfunction getEndpointFromRDF (property, url, subjectIRI) {\n  url = url || window.location.origin + window.location.pathname\n  subjectIRI = subjectIRI || url\n\n  return fetcher.getResourceGraph(subjectIRI)\n    .then(function (i) {\n        var s = i.child(subjectIRI)\n\n        switch (property) {\n          case Config.Vocab['ldpinbox']['@id']:\n            if (s.ldpinbox._array.length > 0){\n// console.log(s.ldpinbox._array)\n              return [s.ldpinbox.at(0)]\n            }\n            break\n          case Config.Vocab['oaannotationService']['@id']:\n            if (s.oaannotationService._array.length > 0){\n// console.log(s.oaannotationService._array)\n              return [s.oaannotationService.at(0)]\n            }\n            break\n          default:\n            if (s[property]._array.length > 0) {\n              return [s[property].at(0)]\n            }\n            break\n        }\n\n        throw new Error(property + ' endpoint was not found in message body')\n      }\n    )\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/inbox.js\n// module id = 11\n// module chunks = 0","'use strict'\n\nconst Config = require('./config')\nconst fetcher = require('./fetcher')\nconst util = require('./util')\nconst uri = require('./uri')\nconst storage = require('./storage')\n\n// const { OIDCWebClient } = require('@trust/oidc-web')\n\nmodule.exports = {\n  afterSignIn,\n  enableDisableButton,\n  getAgentImage,\n  getAgentName,\n  getAgentURL,\n  getAgentStorage,\n  getAgentOutbox,\n  getAgentInbox,\n  getAgentKnows,\n  getAgentSupplementalInfo,\n  getAgentSeeAlso,\n  getUserContacts,\n  getUserHTML,\n  getUserSignedInHTML,\n  setUserInfo,\n  showUserIdentityInput,\n  showUserSigninSignout,\n  submitSignIn,\n  processSameAs\n}\n\n\nfunction getUserHTML () {\n  let userName = Config.SecretAgentNames[Math.floor(Math.random() * Config.SecretAgentNames.length)]\n\n  if (Config.User.Name) {\n    // XXX: We have the IRI already\n    userName = '<span about=\"' + Config.User.IRI + '\" property=\"schema:name\">' +\n      Config.User.Name + '</span>'\n  }\n\n  let userImage = ''\n\n  if ('Image' in Config.User && typeof Config.User.Image !== 'undefined' && Config.User.Image.length > 0) {\n    userImage = '<img alt=\"\" height=\"48\" rel=\"schema:image\" src=\"' +\n      Config.User.Image + '\" width=\"48\" /> '\n  }\n\n  let user = ''\n\n  if ('IRI' in Config.User && Config.User.IRI !== null && Config.User.IRI.length > 0) {\n    user = '<span about=\"' + Config.User.IRI + '\" typeof=\"schema:Person\">' +\n      userImage + '<a rel=\"schema:url\" href=\"' + Config.User.IRI + '\"> ' +\n      userName + '</a></span>'\n  } else {\n    user = '<span typeof=\"schema:Person\">' + userName + '</span>'\n  }\n\n  return user\n}\n\nfunction getUserSignedInHTML() {\n  return getUserHTML() + '<button class=\"signout-user\" title=\"Live long and prosper\"><i class=\"fa fa-hand-spock-o\"></i></button>'\n}\n\n\n\nfunction showUserSigninSignout (node) {\n  var userInfo = document.getElementById('user-info');\n\n  if (!userInfo) {\n    var s = ''\n\n    solid.auth.trackSession(session => {\n      var webId = session ? session.webId : null;\n\n      if (webId && webId != Config.User.IRI) {\n        setUserInfo(webId, true)\n          .then(() => {\n            showUserSigninSignoutEnd(node);\n          })\n      } else {\n         showUserSigninSignoutEnd(node);\n      }\n    })\n  }\n}\n\n\nfunction showUserSigninSignoutEnd (node) {\n  var s = ''\n\n  if (Config.User.IRI) {\n    s = getUserSignedInHTML()\n  }\n  else {\n    s = '<button class=\"signin-user\" title=\"Sign in to authenticate\"><i class=\"fa fa-user-secret fa-2x\"></i>Sign in</button>'\n  }\n\n  node.insertAdjacentHTML('beforeend', '<section id=\"user-info\">' + s + '</section>')\n\n  var userInfo = document.getElementById('user-info')\n\n  userInfo.addEventListener('click', function(e) {\n    e.preventDefault()\n    e.stopPropagation()\n\n    if (Config.User.OIDC && solid && solid.auth) {\n      solid.auth.logout();\n    }\n\n    if (e.target.closest('.signout-user')) {\n      storage.removeStorageProfile()\n\n      Config.User = {\n        IRI: null,\n        Role: null,\n        UI: {}\n      }\n\n      util.removeChildren(node);\n\n      showUserSigninSignout(document.querySelector('#document-menu header'))\n    }\n  });\n\n  var su = document.querySelector('#document-menu button.signin-user')\n  if (su) {\n    su.addEventListener('click', showUserIdentityInput)\n  }\n\n  var rA = document.querySelector('#document-menu .resource-activities')\n  if(rA) { rA.setAttribute('disabled', 'disabled') }\n\n}\n\n\nfunction showUserIdentityInput (e) {\n  if (typeof e !== 'undefined') {\n    e.target.disabled = true\n  }\n\n  var webid = Config.User.WebIdDelegate ? Config.User.WebIdDelegate : \"\";\n  var code = '<aside id=\"user-identity-input\" class=\"do on\">' + DO.C.Button.Close + '<h2>WebID-TLS Authentication</h2><label>WebID:</label> <input id=\"webid\" type=\"text\" placeholder=\"http://csarven.ca/#i\" value=\"'+webid+'\" name=\"webid\"/> <button class=\"signin\">Login</button>';\n  if (window.location.protocol === \"https:\")\n    code += ' <h2>WebID-OIDC Authentication</h2> <button class=\"signin_oidc\">Select Identity Provider</button>';\n\n  code += ' </aside>';\n\n  document.documentElement.appendChild(DO.U.fragmentFromString(code))\n\n  var buttonSignIn = document.querySelector('#user-identity-input button.signin')\n  if (! Config.User.WebIdDelegate)\n    buttonSignIn.setAttribute('disabled', 'disabled')\n\n  document.querySelector('#user-identity-input').addEventListener('click', e => {\n    if (e.target.closest('button.close')) {\n      var signinUser = document.querySelector('#document-menu button.signin-user')\n      if (signinUser) {\n        signinUser.disabled = false\n      }\n    }\n  })\n\n  var inputWebid = document.querySelector('#user-identity-input input#webid')\n\n  buttonSignIn.addEventListener('click', submitSignIn)\n\n  let events = ['keyup', 'cut', 'paste', 'input']\n\n  events.forEach(eventType => {\n    inputWebid.addEventListener(eventType, e => { enableDisableButton(e, buttonSignIn) })\n  })\n\n  var buttonSignInOIDC = document.querySelector('#user-identity-input button.signin_oidc')\n  buttonSignInOIDC.addEventListener('click', submitSignInOIDC)\n\n  inputWebid.focus()\n}\n\n\n// TODO: Generalize this further so that it is not only for submitSignIn\nfunction enableDisableButton (e, button) {\n  var delay = (e.type === 'cut' || e.type === 'paste') ? 250 : 0\n  var input\n\n  window.setTimeout(function () {\n    input = e.target.value\n    if (input.length > 10 && input.match(/^https?:\\/\\//g)) {\n      if (typeof e.which !== 'undefined' && e.which === 13) {\n        if (!button.getAttribute('disabled')) {\n          button.setAttribute('disabled', 'disabled')\n          e.preventDefault()\n          e.stopPropagation()\n          submitSignIn()\n        }\n      } else {\n        button.removeAttribute('disabled')\n      }\n    } else {\n      if (!button.getAttribute('disabled')) {\n        button.setAttribute('disabled', 'disabled')\n      }\n    }\n  }, delay)\n}\n\n// FIXME: This parameter value can be an event or a string\nfunction submitSignIn (url) {\n  var userIdentityInput = document.getElementById('user-identity-input')\n\n  if (typeof url !== 'string') {\n    if (userIdentityInput) {\n      userIdentityInput.insertAdjacentHTML('beforeend',\n        '<i class=\"fa fa-circle-o-notch fa-spin fa-fw\"></i>')\n    }\n\n    url = userIdentityInput.querySelector('input#webid').value.trim()\n  }\n\n  if (!url) {\n    console.log('submitSignIn - no user url input')\n    return Promise.resolve()\n  }\n\n  return setUserInfo(url, false)\n    .then(() => {\n      var uI = document.getElementById('user-info')\n      if (uI) {\n        util.removeChildren(uI);\n        uI.insertAdjacentHTML('beforeend', getUserSignedInHTML());\n      }\n\n      if (userIdentityInput) {\n        userIdentityInput.parentNode.removeChild(userIdentityInput)\n      }\n\n      afterSignIn()\n    })\n}\n\n\nfunction submitSignInOIDC (url) {\n  var userIdentityInput = document.getElementById('user-identity-input')\n\n  var popupUri = Config.OidcPopupUrl;\n\n  if (solid && solid.auth) {\n    solid.auth\n      .popupLogin({ popupUri })\n      .then((session) => {\n         if (session && session.webId) {\n           console.log(\"Connected:\", session.webId);\n           setUserInfo(session.webId, true)\n            .then(() => {\n              var uI = document.getElementById('user-info')\n              if (uI) {\n                util.removeChildren(uI);\n                uI.insertAdjacentHTML('beforeend', getUserSignedInHTML());\n              }\n\n              if (userIdentityInput) {\n                userIdentityInput.parentNode.removeChild(userIdentityInput)\n              }\n\n              afterSignIn()\n            })\n         }\n      }).catch((err) => {\n        console.log('submitSignInOIDC - '+err);\n        return Promise.resolve();\n      });\n  }\n}\n\n/**\n * @param userIRI {string}\n *\n * @returns {Promise}\n */\nfunction setUserInfo (userIRI, oidc) {\n  if (!userIRI) {\n    return Promise.reject(new Error('Could not set user info - no user IRI'))\n  }\n\n  return fetcher.getResourceGraph(userIRI)\n    .then(g => {\n      var s = g.child(userIRI)\n\n      Config.User.Graph = s\n      Config.User.IRI = userIRI\n      Config.User.Name = getAgentName(s)\n      Config.User.Image = getAgentImage(s)\n      Config.User.URL = getAgentURL(s)\n      Config.User.OIDC = oidc ? true : false;\n\n      Config.User.Contacts = {}\n      Config.User.Knows = getAgentKnows(s)\n      Config.User.SameAs = []\n      Config.User.SeeAlso = []\n\n      Config.User.Storage = getAgentStorage(s)\n      Config.User.Outbox = getAgentOutbox(s)\n      Config.User.Inbox = getAgentInbox(s)\n\n      var preferredProxy = getAgentPreferredProxy(s)\n      Config.ProxyURL = (preferredProxy) ? preferredProxy : Config.ProxyURL\n\n      if (s.preferencesFile && s.preferencesFile.length > 0) {\n        Config.User.PreferencesFile = s.preferencesFile\n\n        // TODO: Reconsider if/where to use this.\n        // setUserWorkspaces(Config.User.PreferencesFile)\n      }\n      return Config.User\n    })\n}\n\nfunction afterSignIn () {\n  var promises = [];\n\n  promises.push(getAgentSupplementalInfo(Config.User.IRI))\n\n  promises.push(getAgentSeeAlso(Config.User.Graph))\n\n  Promise.all(promises)\n    .then(function(results) {\n      var uI = document.getElementById('user-info')\n      if (uI) {\n        uI.innerHTML = getUserSignedInHTML()\n      }\n\n      return storage.updateStorageProfile(Config.User)\n    })\n    .catch(function(e) {\n      return Promise.resolve();\n    });\n\n  var rA = document.querySelector('#document-menu .resource-activities')\n  if(rA) { rA.removeAttribute('disabled') }\n\n  var user = document.querySelectorAll('aside.do article *[rel~=\"schema:creator\"] > *[about=\"' + Config.User.IRI + '\"]')\n  for (let i = 0; i < user.length; i++) {\n    var article = user[i].closest('article')\n    article.insertAdjacentHTML('afterbegin', '<button class=\"delete\"><i class=\"fa fa-trash\"></i></button>')\n  }\n\n  var buttonDelete = document.querySelectorAll('aside.do blockquote[cite] article button.delete')\n\n  for (let i = 0; i < buttonDelete.length; i++) {\n    buttonDelete[i].addEventListener('click', function (e) {\n      e.preventDefault()\n      e.stopPropagation()\n      var article = e.target.closest('article')\n      var refId = 'r-' + article.id\n      var noteIRI = article.closest('blockquote[cite]')\n      noteIRI = noteIRI.getAttribute('cite')\n\n      fetcher.deleteResource(noteIRI)\n        .then(() => {\n          var aside = e.target.closest('aside.do')\n          aside.parentNode.removeChild(aside)\n          var span = document.querySelector('span[resource=\"#' + refId + '\"]')\n          span.outerHTML = span.querySelector('mark').textContent\n          // TODO: Delete notification or send delete activity\n        })\n    })\n  }\n}\n\nfunction getAgentSupplementalInfo(iri) {\n  if (iri == Config.User.IRI) {\n    return processSameAs(Config.User.Graph, getAgentSupplementalInfo);\n  }\n  else {\n    return fetcher.getResourceGraph(iri).then(\n      function(g){\n        if(typeof g._graph == 'undefined') {\n          return Promise.resolve([]);\n        }\n        var s = g.child(iri);\n\n        Config.User.Name = Config.User.Name || getAgentName(s);\n\n        Config.User.Image = Config.User.Image || getAgentImage(s);\n\n        var storage = getAgentStorage(s) || [];\n        var outbox = getAgentOutbox(s) || [];\n        var knows = getAgentKnows(s) || [];\n\n        if (storage.length > 0) {\n          Config.User.Storage = (Config.User.Storage)\n            ? util.uniqueArray(Config.User.Storage.concat(storage))\n            : storage;\n        }\n\n        if (outbox.length > 0) {\n          Config.User.Outbox = (Config.User.Outbox)\n            ? util.uniqueArray(Config.User.Outbox.concat(outbox))\n            : outbox;\n        }\n\n        if (knows.length > 0) {\n          Config.User.Knows = (Config.User.Knows)\n            ? util.uniqueArray(Config.User.Knows.concat(knows))\n            : knows;\n        }\n\n        return processSameAs(s, getAgentSupplementalInfo);\n      },\n      function(reason){\n        return Promise.resolve([]);\n      });\n  }\n}\n\nfunction getAgentSeeAlso(g, baseURI, subjectURI) {\n  if (!g) { return; }\n\n  subjectURI = baseURI = baseURI || g.iri().toString();\n\n  var seeAlso = g.child(baseURI).rdfsseeAlso;\n\n  if (seeAlso && seeAlso._array.length > 0) {\n    var iris = [];\n    var promises = [];\n\n    seeAlso._array.forEach(function(iri){\n      if (Config.User.SeeAlso.indexOf(iri) < 0) {\n        iris.push(iri)\n      }\n    });\n\n    iris.forEach(function(iri){\n      Config.User.SeeAlso = util.uniqueArray(Config.User.SeeAlso.concat(iri));\n\n      fetcher.getResourceGraph(iri)\n        .then(g => {\n\n          var s = g.child(subjectURI)\n\n          var knows = getAgentKnows(s) || [];\n\n          if (knows.length > 0) {\n            Config.User.Knows = (Config.User.Knows)\n              ? util.uniqueArray(Config.User.Knows.concat(knows))\n              : knows;\n          }\n\n          promises.push(getAgentSeeAlso(g, iri, subjectURI))\n        })\n    });\n\n    Promise.all(promises)\n      .then(function(results) {\n        return Promise.resolve([]);\n      })\n      .catch(function(e) {\n        return Promise.resolve([]);\n      });\n  }\n  else {\n    return Promise.resolve([])\n  }\n}\n\nfunction getUserContacts(iri) {\n  var fyn = function(iri){\n    if ((iri == Config.User.IRI) && Config.User.Graph) {\n      return processSameAs(Config.User.Graph, getUserContacts);\n    }\n    else {\n      return fetcher.getResourceGraph(iri).then(\n        function(g){\n          if(typeof g._graph == 'undefined') {\n            return Promise.resolve([]);\n          }\n\n          var s = g.child(iri);\n\n          var knows = getAgentKnows(s) || [];\n\n          if (knows.length > 0) {\n            Config.User.Knows = (Config.User.Knows)\n              ? util.uniqueArray(Config.User.Knows.concat(knows))\n              : knows;\n          }\n\n          return processSameAs(s, getUserContacts);\n        },\n        function(reason){\n          return Promise.resolve([]);\n        });\n    }\n  }\n\n  return fyn(iri).then(function(i){ return Config.User.Knows || []; });\n}\n\nfunction processSameAs(s, callback) {\n  if (s.owlsameAs && s.owlsameAs._array.length > 0){\n    var iris = s.owlsameAs._array;\n    var promises = [];\n    iris.forEach(function(iri){\n// console.log(iri);\n      if(iri != Config.User.IRI && Config.User.SameAs.indexOf(iri) < 0) {\n        Config.User.SameAs = util.uniqueArray(Config.User.SameAs.concat(iri));\n\n        if (typeof callback !== 'undefined') {\n          promises.push(callback(iri));\n        }\n        else {\n          promises.push(Promise.resolve(Config.User.SameAs));\n        }\n      }\n    });\n\n    return Promise.all(promises)\n      .then(function(results) {\n        return Promise.resolve([]);\n      })\n      .catch(function(e) {\n        return Promise.resolve([]);\n      });\n  }\n  else {\n    return Promise.resolve([]);\n  }\n}\n\nfunction getAgentPreferredProxy (s) {\n  return s.solidpreferredProxy || undefined\n}\n\nfunction getAgentImage (s) {\n  return s.foafimg || s.schemaimage || s.vcardphoto || s.vcardhasPhoto || s.asimage ||\n    s.siocavatar || s.foafdepiction || undefined\n}\n\nfunction getAgentName (s) {\n  var name = s.foafname || s.schemaname || s.vcardfn || s.asname || s.rdfslabel || undefined\n  if (typeof name === 'undefined') {\n    if (s.schemafamilyName && s.schemafamilyName.length > 0 && s.schemagivenName && s.schemagivenName.length > 0) {\n      name = s.schemagivenName + ' ' + s.schemafamilyName\n    } else if (s.foaffamilyName && s.foaffamilyName.length > 0 && s.foafgivenName && s.foafgivenName.length > 0) {\n      name = s.foafgivenName + ' ' + s.foaffamilyName\n    } else if (s.vcardfamilyname && s.vcardfamilyname.length > 0 && s.vcardgivenname && s.vcardgivenname.length > 0) {\n      name = s.vcardgivenname + ' ' + s.vcardfamilyname\n    } else if (s.foafnick && s.foafnick.length > 0) {\n      name = s.foafnick\n    } else if (s.vcardnickname && s.vcardnickname.length > 0) {\n      name = s.vcardnickname\n    }\n  }\n  return name\n}\n\nfunction getAgentURL (s) {\n    return s.foafhomepage || s.foafweblog || s.schemaurl || s.vcardurl || undefined\n}\n\nfunction getAgentStorage (s) {\n  return (s.pimstorage && s.pimstorage._array.length > 0)\n    ? s.pimstorage._array\n    : undefined\n}\n\nfunction getAgentOutbox (s) {\n  return (s.asoutbox && s.asoutbox._array.length > 0)\n    ? s.asoutbox._array\n    : undefined\n}\n\nfunction getAgentInbox (s) {\n  return (s.ldpinbox && s.ldpinbox._array.length > 0)\n    ? s.ldpinbox._array\n    : undefined\n}\n\nfunction getAgentKnows (s) {\n  var knows = [];\n\n  if(s.foafknows && s.foafknows._array.length > 0){\n    knows = knows.concat(s.foafknows._array);\n  }\n  if(s.schemaknows && s.schemaknows._array.length > 0){\n    knows = knows.concat(s.schemaknows._array);\n  }\n\n  knows = util.uniqueArray(knows);\n\n  return (knows.length > 0) ? knows : undefined;\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/auth.js\n// module id = 12\n// module chunks = 0"],"sourceRoot":""}